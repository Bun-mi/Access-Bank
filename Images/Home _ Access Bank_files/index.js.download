!function(e){function t(e){void 0!==As&&null!=As?console.log(e):"function"==typeof consolelog&&consolelog(e)}function i(e){return e&&e.length>1&&"#"==e.charAt(0)?document.getElementById(e.substr(1)):document.querySelector(e)}function n(e){return e&&e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/\n/g,"<br/>")}function a(){let e=Array.prototype.slice.call(arguments,0);var t=e.shift();t&&"[object Function]"=={}.toString.call(t)&&t.apply(null,e)}function o(e,i,n){let a=n||window.location.search.substring(1);"/"==a.charAt(a.length-1)&&(a=a.substring(0,a.length-1)),t("query_param: "+e);let o,r=a.split("&");for(let i=0;i<r.length;i++){let n=r[i].split("=");if(n[0]==e&&(o=decodeURIComponent(n[1].replace(/\+/g," "))),"eparam"==n[0])try{let t=JSON.parse(ne(r[i].substr(7)));t.hasOwnProperty(e)&&(o="send"==e?decodeURIComponent(JSON.stringify(t[e][0]).replace(/\+/g," ")):decodeURIComponent(t[e].replace(/\+/g," ")))}catch(e){t("query_parm: Ignore eparam.  Parsing error.")}}return null==o?void 0===i?null:i:o}function r(e,i){let n=i||window.location.search.substring(1);"/"==n.charAt(n.length-1)&&(n=n.substring(0,n.length-1)),t("query_param_list: "+e);let a=[],o=n.split("&");for(let i=0;i<o.length;i++){let n=o[i].split("=");if(n[0]==e&&a.push(decodeURIComponent(n[1]).replace(/\+/g," ")),"eparam"==n[0])try{let t=JSON.parse(ne(o[i].substr(7)));if(t.hasOwnProperty(e))if("send"==e)for(let e=0;e<t.send.length;e++)a.push(decodeURIComponent(JSON.stringify(t.send[e]).replace(/\+/g," ")));else a.push(decodeURIComponent(t[e].replace(/\+/g," ")))}catch(e){t("query_param_list: Ignore eparam. Parsing error")}}return 0==a.length?null:a}function s(e){let i=e||window.location.search.substring(1);"/"==i.charAt(i.length-1)&&(i=i.substring(0,i.length-1)),t("query_param_all: "+e);let n=i.split("&"),a=[];for(let e=0;e<n.length;e++)if(n[e]){let i=n[e].split("=");if(2==i.length)if("eparam"==i[0])try{let t=JSON.parse(ne(n[e].substr(7)));for(let e in t)if("send"==e)for(let i=0;i<t.send.length;i++)a.push({name:e,value:decodeURIComponent(JSON.stringify(t[e][i]).replace(/\+/g," "))});else a.push({name:e,value:decodeURIComponent(t[e].replace(/\+/g," "))})}catch(e){t("query_param_all: Ignore eparam.  Parsing error")}else a.push({name:i[0],value:decodeURIComponent(i[1].replace(/\+/g," "))})}return a}function c(e,t){var i=document.createEvent("Event");for(var n in i.initEvent(e.type,!0,!0),e)"type"!=n&&(i[n]=e[n]);(t||window).dispatchEvent(i)}function l(e,i,n){if(n!==i){let a=null!=i?typeof i:i;if(null==a||"boolean"==a||"number"==a||"string"==a&&i.length<256)try{document.body.setAttribute(e,""+i)}catch(e){t("ignore exception "+e.message)}c({type:"propertyChange",property:e,oldValue:n,newValue:i})}return i}function d(){return"chrome-extension:"==window.location.protocol||"gopher:"==window.location.protocol||"file:"==window.location.protocol&&void 0!==window.chrome}function u(){return!!window.cordova}function p(e){if(e){if("android"==e.toLowerCase())return!!navigator.userAgent.match(/android/i);if("ios"==e.toLowerCase())return!(!navigator.userAgent.match(/iphone|ipad|ipod/i)||window.MSStream)}var t,i=!1;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(i=!0),i}function f(){try{return window!==window.parent||void 0!==Xl&&"native"!=Xl}catch(e){return!0}}function h(e){t("opening external link: "+e);let i=e&&e.includes(":")?e.split(":")[0]:"";if("tel"!=i&&"sms"!=i||(e=e.replace(/\s/g,"")),void 0===h.handlers[i]){if("popup"==i){let t=e.substr(6).split("|");return void window.open(t[0],"_blank",t.length>1?t[1]:"width=400,height=600")}if("data"==i){let t='<body style="margin: 0; padding: 0;"><iframe frameborder="0" style="position: absolute; width: 100%; height: 100%;" src="'+e+'"></iframe>';var n;if(u())Ye("Cannot open captured image in external browser, so opening in embedded browser.","Info"),(n=window.open("about:blank","_blank")).addEventListener("loadstop",(()=>{n.executeScript({code:"document.write("+JSON.stringify(t)+");"})}));else(n=window.open("","_blank")).document.write(t),n.document.close();return}if(u())window.open(e,"_system");else{let t=document.createElement("a");t.href=e,t.setAttribute("target","_blank"),t.style.display="none",document.body.append(t),t.click(),document.body.removeChild(t)}}else t("calling registered handler for "+i),a(h.handlers[i],e)}function g(e,t){h.handlers[e]=t}function v(e,t){let i=function(i){let n={start:{x:0,y:0},end:{x:0,y:0}};"mousedown"==i.type?(n.start.x=i.screenX,n.start.y=i.screenY):i.touches.length>0&&(n.start.x=i.touches[0].screenX,n.start.y=i.touches[0].screenY);var o=function(i){if(null==n)return;let r=!1;"mousemove"==i.type||"mouseup"==i.type?(n.end.x=i.screenX,n.end.y=i.screenY):i.touches.length>0&&(n.end.x=i.touches[0].screenX,n.end.y=i.touches[0].screenY);let s=(n.end.x||n.start.x)-n.start.x,c=(n.end.y||n.start.y)-n.start.y,l="";Math.abs(s)+Math.abs(c)>100&&(l=Math.abs(s)>Math.abs(c)?s>0?"right":"left":c>0?"down":"up",void 0!==t[l]&&(r=!0)),(r||"mouseup"==i.type||"touchend"==i.type)&&(document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",o),document.addEventListener("touchmove",o),document.addEventListener("touchend",o),n=null),r&&void 0!==t[l]&&a(t[l],{currentTarget:e})};"mousedown"==i.type?(document.addEventListener("mousemove",o),document.addEventListener("mouseup",o)):(document.addEventListener("touchmove",o),document.addEventListener("touchend",o))};return p()?e.addEventListener("touchstart",i,{passive:!0}):e.addEventListener("mousedown",i),{stop:function(){e.removeEventListener("mousedown",i),e.removeEventListener("touchstart",i)}}}function m(e,t){return(e=e.replace(/^\((\d+)\)\s?(\d{3})[\s-]?(\d{4})$/,"+1$1$2$3"))&&"+"!=e.charAt(0)&&(e="+"+e),(t||"tel:")+e}function y(){return([1e7]+1e3+4e3+8e3+1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)))}function b(e){if(i("body div.body div.confirmoverlay"))return!1;var t="";for(var n in e.buttons)t+='<div class="confirm button '+e.buttons[n].class+'" tabindex="0">'+n+"</div>",e.buttons[n].action||(e.buttons[n].action=function(){});var a=[' <div id="confirm-dialog" class="confirmdialog">','  <div id="confirm-header" class="confirmheader"></div>','  <div id="confirm-container" class="confirmcontainer">','    <div id="confirm-icon" class="confirmicon" style="background: url('+(e.icon||Pd())+') no-repeat center center; background-size: contain;"> </div>','    <div id="confirm-content" class="confirmcontent">','      <p id="confirm-title" class="confirmtitle">',e.title,"</p>",'      <p id="confirm-message" class="confirmmessage">',e.message,"</p></div></div>",'  <div id="confirm-buttons" class="confirmbuttons"> ',t,"</div></div>"].join(""),o=document.createElement("div");o.id="confirm-overlay",o.className="confirmoverlay",o.innerHTML=a,i("body div.body").appendChild(o);var r=document.querySelectorAll("div.confirmoverlay div.confirmdialog div.confirmbuttons div.button");for(let t=0;t<r.length;t++){0==t&&r[t].focus();var s=function(t){if(t.keyCode&&13!=t.keyCode)return;let n=t.target||t.srcElement;for(let t in e.buttons)if(n.innerHTML==t)return i("div.confirmoverlay").remove(),e.buttons[t].action(),!1;i("div.confirmoverlay").remove()};r[t].addEventListener("click",s),r[t].addEventListener("keyup",s)}}function w(){return null!=navigator.languages?navigator.languages[0]:null!=navigator.language?navigator.language:null!=navigator.browserLanguage?navigator.browserLanguage:null}function x(e,t="*"){f()&&window.parent.postMessage(e,t);try{var i=window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.kpdMessageHandler||("undefined"==typeof kpdMessageHandler?void 0:kpdMessageHandler);i&&i.postMessage(JSON.stringify(e),t)}catch(e){}try{window.ReactNativeWebView&&window.ReactNativeWebView.postMessage(JSON.stringify(e))}catch(e){}}function _(e){let t=document.createElement("canvas");t.width=t.height=36;let i=t.getContext("2d");return i.font="bold 15px Arial",i.fillStyle="white",i.globalAlpha=1,i.textAlign="center",i.textBaseline="middle",i.fillText(e,t.width/2,t.height/2),t.toDataURL()}h.handlers={},String.prototype.startsWith||function(){"use strict";let e=function(){try{let t={},i=Object.defineProperty;var e=i(t,t,t)&&i}catch(e){}return e}(),{toString:t}={},i=function(e){if(null==this)throw new TypeError;let i=String(this);if(e&&"[object RegExp]"==t.call(e))throw new TypeError;let n=i.length,a=String(e),o=a.length,r=arguments.length>1?arguments[1]:void 0,s=r?Number(r):0;s!=s&&(s=0);let c=Math.min(Math.max(s,0),n);if(o+c>n)return!1;let l=-1;for(;++l<o;)if(i.charCodeAt(c+l)!=a.charCodeAt(l))return!1;return!0};e?e(String.prototype,"startsWith",{value:i,configurable:!0,writable:!0}):String.prototype.startsWith=i}();var k={aa:"Afar",ab:"Abkhazian",ae:"Avestan",af:"Afrikaans",ak:"Akan",am:"Amharic",an:"Aragonese",ar:"Arabic",as:"Assamese",av:"Avaric",ay:"Aymara",az:"Azerbaijani",ba:"Bashkir",be:"Belarusian",bg:"Bulgarian",bh:"Bihari languages",bm:"Bambara",bi:"Bislama",bn:"Bengali",bo:"Tibetan",br:"Breton",bs:"Bosnian",ca:"Catalan; Valencian",ce:"Chechen",ch:"Chamorro",co:"Corsican",cr:"Cree",cs:"Czech",cu:"Church Slavic; Old Slavonic; Church Slavonic; Old Bulgarian; Old Church Slavonic",cv:"Chuvash",cy:"Welsh",da:"Danish",de:"German",dv:"Divehi; Dhivehi; Maldivian",dz:"Dzongkha",ee:"Ewe",el:"Greek, Modern (1453-)",en:"English",eo:"Esperanto",es:"Spanish; Castilian",et:"Estonian",eu:"Basque",fa:"Persian",ff:"Fulah",fi:"Finnish",fj:"Fijian",fo:"Faroese",fr:"French",fy:"Western Frisian",ga:"Irish",gd:"Gaelic; Scottish Gaelic",gl:"Galician",gn:"Guarani",gu:"Gujarati",gv:"Manx",ha:"Hausa",he:"Hebrew",hi:"Hindi",ho:"Hiri Motu",hr:"Croatian",ht:"Haitian; Haitian Creole",hu:"Hungarian",hy:"Armenian",hz:"Herero",ia:"Interlingua (International Auxiliary Language Association)",id:"Indonesian",ie:"Interlingue; Occidental",ig:"Igbo",ii:"Sichuan Yi; Nuosu",ik:"Inupiaq",io:"Ido",is:"Icelandic",it:"Italian",iu:"Inuktitut",ja:"Japanese",jv:"Javanese",ka:"Georgian",kg:"Kongo",ki:"Kikuyu; Gikuyu",kj:"Kuanyama; Kwanyama",kk:"Kazakh",kl:"Kalaallisut; Greenlandic",km:"Central Khmer",kn:"Kannada",ko:"Korean",kr:"Kanuri",ks:"Kashmiri",ku:"Kurdish",kv:"Komi",kw:"Cornish",ky:"Kirghiz; Kyrgyz",la:"Latin",lb:"Luxembourgish; Letzeburgesch",lg:"Ganda",li:"Limburgan; Limburger; Limburgish",ln:"Lingala",lo:"Lao",lt:"Lithuanian",lu:"Luba-Katanga",lv:"Latvian",mg:"Malagasy",mh:"Marshallese",mi:"Maori",mk:"Macedonian",ml:"Malayalam",mn:"Mongolian",mr:"Marathi",ms:"Malay",mt:"Maltese",my:"Burmese",na:"Nauru",nb:"Bokmål, Norwegian; Norwegian Bokmål",nd:"Ndebele, North; North Ndebele",ne:"Nepali",ng:"Ndonga",nl:"Dutch; Flemish",nn:"Norwegian Nynorsk; Nynorsk, Norwegian",no:"Norwegian",nr:"Ndebele, South; South Ndebele",nv:"Navajo; Navaho",ny:"Chichewa; Chewa; Nyanja",oc:"Occitan (post 1500)",oj:"Ojibwa",om:"Oromo",or:"Oriya",os:"Ossetian; Ossetic",pa:"Panjabi; Punjabi",pi:"Pali",pl:"Polish",ps:"Pushto; Pashto",pt:"Portuguese",qu:"Quechua",rm:"Romansh",rn:"Rundi",ro:"Romanian; Moldavian; Moldovan",ru:"Russian",rw:"Kinyarwanda",sa:"Sanskrit",sc:"Sardinian",sd:"Sindhi",se:"Northern Sami",sg:"Sango",si:"Sinhala; Sinhalese",sk:"Slovak",sl:"Slovenian",sm:"Samoan",sn:"Shona",so:"Somali",sq:"Albanian",sr:"Serbian",ss:"Swati",st:"Sotho, Southern",su:"Sundanese",sv:"Swedish",sw:"Swahili",ta:"Tamil",te:"Telugu",tg:"Tajik",th:"Thai",ti:"Tigrinya",tk:"Turkmen",tl:"Tagalog",tn:"Tswana",to:"Tonga (Tonga Islands)",tr:"Turkish",ts:"Tsonga",tt:"Tatar",tw:"Twi",ty:"Tahitian",ug:"Uighur; Uyghur",uk:"Ukrainian",ur:"Urdu",uz:"Uzbek",ve:"Venda",vi:"Vietnamese",vo:"Volapük",wa:"Walloon",wo:"Wolof",xh:"Xhosa",yi:"Yiddish",yo:"Yoruba",za:"Zhuang; Chuang",zh:"Chinese",zu:"Zulu"};var T=["pending","underlivered","delivered","read","deleted","failed"];function E(e){for(var t,i,n,a,o,r,s,c=[],l=0;l<e.length;)t=e[l++],i=e[l++],n=e[l++],t&=255,isNaN(i)||(i&=255),isNaN(n)||(n&=255),a=t>>2&63,o=63&((3&t)<<4|i>>4),r=63&((15&i)<<2|n>>6),s=63&n,isNaN(i)?r=s=64:isNaN(n)&&(s=64),c.push(Base64_keyStr.charAt(a),Base64_keyStr.charAt(o),Base64_keyStr.charAt(r),Base64_keyStr.charAt(s));return c.join("")}function A(e){var t,i,n,a,o,r,s=[],c=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<e.length;)t=Base64_keyStr.indexOf(e.charAt(c++))<<2|(a=Base64_keyStr.indexOf(e.charAt(c++)))>>4,i=(15&a)<<4|(o=Base64_keyStr.indexOf(e.charAt(c++)))>>2,n=(3&o)<<6|(r=Base64_keyStr.indexOf(e.charAt(c++))),s.push(t),64!=o&&s.push(i),64!=r&&s.push(n);return new Uint8Array(s)}function L(e){return window.btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)})))}Base64_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var N=0;function C(e){return I(O(M(e)))}function S(e){for(var t=C(e),i=new Uint8Array(16),n=0;n<16;++n)i[n]=parseInt(t.substr(2*n,2),16);return i}function O(e){return P(H(j(e),8*e.length))}function I(e){for(var t,i=N?"0123456789ABCDEF":"0123456789abcdef",n="",a=0;a<e.length;a++)t=e.charCodeAt(a),n+=i.charAt(t>>>4&15)+i.charAt(15&t);return n}function M(e){for(var t,i,n="",a=-1;++a<e.length;)t=e.charCodeAt(a),i=a+1<e.length?e.charCodeAt(a+1):0,55296<=t&&t<=56319&&56320<=i&&i<=57343&&(t=65536+((1023&t)<<10)+(1023&i),a++),t<=127?n+=String.fromCharCode(t):t<=2047?n+=String.fromCharCode(192|t>>>6&31,128|63&t):t<=65535?n+=String.fromCharCode(224|t>>>12&15,128|t>>>6&63,128|63&t):t<=2097151&&(n+=String.fromCharCode(240|t>>>18&7,128|t>>>12&63,128|t>>>6&63,128|63&t));return n}function j(e){for(var t=Array(e.length>>2),i=0;i<t.length;i++)t[i]=0;for(i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<i%32;return t}function P(e){for(var t="",i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>i%32&255);return t}function H(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var i=1732584193,n=-271733879,a=-1732584194,o=271733878,r=0;r<e.length;r+=16){var s=i,c=n,l=a,d=o;i=D(i,n,a,o,e[r+0],7,-680876936),o=D(o,i,n,a,e[r+1],12,-389564586),a=D(a,o,i,n,e[r+2],17,606105819),n=D(n,a,o,i,e[r+3],22,-1044525330),i=D(i,n,a,o,e[r+4],7,-176418897),o=D(o,i,n,a,e[r+5],12,1200080426),a=D(a,o,i,n,e[r+6],17,-1473231341),n=D(n,a,o,i,e[r+7],22,-45705983),i=D(i,n,a,o,e[r+8],7,1770035416),o=D(o,i,n,a,e[r+9],12,-1958414417),a=D(a,o,i,n,e[r+10],17,-42063),n=D(n,a,o,i,e[r+11],22,-1990404162),i=D(i,n,a,o,e[r+12],7,1804603682),o=D(o,i,n,a,e[r+13],12,-40341101),a=D(a,o,i,n,e[r+14],17,-1502002290),i=F(i,n=D(n,a,o,i,e[r+15],22,1236535329),a,o,e[r+1],5,-165796510),o=F(o,i,n,a,e[r+6],9,-1069501632),a=F(a,o,i,n,e[r+11],14,643717713),n=F(n,a,o,i,e[r+0],20,-373897302),i=F(i,n,a,o,e[r+5],5,-701558691),o=F(o,i,n,a,e[r+10],9,38016083),a=F(a,o,i,n,e[r+15],14,-660478335),n=F(n,a,o,i,e[r+4],20,-405537848),i=F(i,n,a,o,e[r+9],5,568446438),o=F(o,i,n,a,e[r+14],9,-1019803690),a=F(a,o,i,n,e[r+3],14,-187363961),n=F(n,a,o,i,e[r+8],20,1163531501),i=F(i,n,a,o,e[r+13],5,-1444681467),o=F(o,i,n,a,e[r+2],9,-51403784),a=F(a,o,i,n,e[r+7],14,1735328473),i=U(i,n=F(n,a,o,i,e[r+12],20,-1926607734),a,o,e[r+5],4,-378558),o=U(o,i,n,a,e[r+8],11,-2022574463),a=U(a,o,i,n,e[r+11],16,1839030562),n=U(n,a,o,i,e[r+14],23,-35309556),i=U(i,n,a,o,e[r+1],4,-1530992060),o=U(o,i,n,a,e[r+4],11,1272893353),a=U(a,o,i,n,e[r+7],16,-155497632),n=U(n,a,o,i,e[r+10],23,-1094730640),i=U(i,n,a,o,e[r+13],4,681279174),o=U(o,i,n,a,e[r+0],11,-358537222),a=U(a,o,i,n,e[r+3],16,-722521979),n=U(n,a,o,i,e[r+6],23,76029189),i=U(i,n,a,o,e[r+9],4,-640364487),o=U(o,i,n,a,e[r+12],11,-421815835),a=U(a,o,i,n,e[r+15],16,530742520),i=z(i,n=U(n,a,o,i,e[r+2],23,-995338651),a,o,e[r+0],6,-198630844),o=z(o,i,n,a,e[r+7],10,1126891415),a=z(a,o,i,n,e[r+14],15,-1416354905),n=z(n,a,o,i,e[r+5],21,-57434055),i=z(i,n,a,o,e[r+12],6,1700485571),o=z(o,i,n,a,e[r+3],10,-1894986606),a=z(a,o,i,n,e[r+10],15,-1051523),n=z(n,a,o,i,e[r+1],21,-2054922799),i=z(i,n,a,o,e[r+8],6,1873313359),o=z(o,i,n,a,e[r+15],10,-30611744),a=z(a,o,i,n,e[r+6],15,-1560198380),n=z(n,a,o,i,e[r+13],21,1309151649),i=z(i,n,a,o,e[r+4],6,-145523070),o=z(o,i,n,a,e[r+11],10,-1120210379),a=z(a,o,i,n,e[r+2],15,718787259),n=z(n,a,o,i,e[r+9],21,-343485551),i=q(i,s),n=q(n,c),a=q(a,l),o=q(o,d)}return Array(i,n,a,o)}function R(e,t,i,n,a,o){return q((r=q(q(t,e),q(n,o)))<<(s=a)|r>>>32-s,i);var r,s;
/*
 * RC4 symmetric cipher encryption/decryption
 * https://gist.github.com/farhadi/2185197
 * Modified by kundan to use hexkey instead of string
 * 
 * This file is also used by portal, appdesigner, provider.
 * 
 * @license Public Domain
 * @param string hexkey - secret key in hex for encryption/decryption
 * @param string str - string to be encrypted/decrypted
 * @return string
 */}function D(e,t,i,n,a,o,r){return R(t&i|~t&n,e,t,a,o,r)}function F(e,t,i,n,a,o,r){return R(t&n|i&~n,e,t,a,o,r)}function U(e,t,i,n,a,o,r){return R(t^i^n,e,t,a,o,r)}function z(e,t,i,n,a,o,r){return R(i^(t|~n),e,t,a,o,r)}function q(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function J(e,t){for(var i,n=new Uint8Array(256),a=0,o=new Uint8Array(t.length),r=0;r<256;r++)n[r]=r;for(r=0;r<256;r++)a=(a+n[r]+e[r%e.length])%256,i=n[r],n[r]=n[a],n[a]=i;r=0,a=0;for(var s=0;s<t.length;s++)a=(a+n[r=(r+1)%256])%256,i=n[r],n[r]=n[a],n[a]=i,o[s]=t[s]^n[(n[r]+n[a])%256];return o}function W(e){if("undefined"!=typeof TextEncoder)return new TextEncoder("utf-8").encode(e);for(var t=[],i=0;i<e.length;i++){var n=e.charCodeAt(i);n<128?t.push(n):n>127&&n<2048?t.push(n>>6|192,63&n|128):t.push(n>>12|224,n>>6&63|128,63&n|128)}return new Uint8Array(t)}function B(e){if("undefined"!=typeof TextDecoder)return new TextDecoder("utf-8").decode(e);for(var t=[],i=0,n=c1=c2=0;i<e.length;)(n=e[i])<128?(t.push(String.fromCharCode(n)),i++):n>191&&n<224?(c2=e[i+1],t.push(String.fromCharCode((31&n)<<6|63&c2)),i+=2):(c2=e[i+1],c3=e[i+2],t.push(String.fromCharCode((15&n)<<12|(63&c2)<<6|63&c3)),i+=3);return t.join("")}var G,$,V="797c60d5f1ddd8f49b6519cfbfde7f90",K=!1,Y=!1,X="server1.koopid.io",Z=!0;function Q(e,t,i){if(t=JSON.stringify(t),i||Y){var n=(""+Math.random()).substr(2,8),a=S(X+"|"+V+"|"+n+"|"+e);return JSON.stringify({e:E(J(a,W(t))),n:n})}return t}function ee(e,i,n){if(i=JSON.parse(i),n||Y){if(i.e&&i.n){var a=i.n,o=S(X+"|"+V+"|"+a+"|"+e);return JSON.parse(B(J(o,A(i.e))))}if(n||Z)return t("warning: failed to parse encrypted response in strict mode "+JSON.stringify(i)),null}return i}function te(e){var t=void 0!==On&&On||"device";return e&&JSON.parse(Q("localstore:"+t,e,!0))}function ie(e){return e&&ee("localstore:"+(void 0!==On&&On||"device"),JSON.stringify(e),!0)}function ne(e,t,i){if(t||G){null==t&&(t=G,i=$);var n=S(i+"|"+t+"|"+e.split(":")[1]);return e&&B(J(n,A(e.split(":")[0])))}return e}var ae,oe,re=!0,se=!0;function ce(e,t){if(t){var i=[];for(var n in t)i.push(n+(null!==t[n]?"="+encodeURIComponent(t[n]):""));e+=i.length>0?(e.indexOf("?")<0?"?":"&")+i.join("&"):""}return e}function le(e,i,n,r,s,c,l,d,u,p){if(function(){if(!se){se=!0;try{("true"==o("x-auth")||window.parent!=window&&"true"==o("x-auth",void 0,window.parent.location.search.substr(1))||window.parent.parent!=window.parent&&"true"==o("x-auth",void 0,window.parent.parent.location.search.substr(1)))&&(re=!0)}catch(e){}}}(),void 0===u&&(u=3e4),n&&"function"==typeof n)throw new Error("data is a function, did you forget to use null as data?");var f=new XMLHttpRequest;if(void 0!==r||void 0!==s){var h=null,g=null;u&&u>0&&(h=setTimeout((function(){null!=g&&(clearTimeout(g),g=null),4!=f.readyState&&(t("ajax - request timedout for "+e+" "+i),f.responded=!0,f.abort(),a(s,"408 Request Timeout"))}),u)),f.onreadystatechange=function(){if(4==f.readyState)if(null!=h&&(clearTimeout(h),h=null),null!=g&&(clearTimeout(g),g=null),f.status>=200&&f.status<300){if(void 0!==c)return K||t("ajax - response received"),void a(r,f.response);K||t("ajax - response "+(f.responseText&&f.responseText.substr(0,100)));var e={};try{f.responseText&&(e=JSON.parse(f.responseText))}catch(e){return t("error parsing response as JSON: "+e+"\nresponseText="+f.responseText),void a(s,"failed to parse response")}a(r,e)}else{e=null;var n="N/A",o="N/A";try{n=f.status}catch(e){}try{o=f.statusText}catch(e){}if(0==n&&f.responded);else{if(0!=n||o)try{if(void 0===c&&f.responseText){var l=JSON.parse(f.responseText);l.reason&&(n="",o=l.reason),e=l.entity||null}}catch(e){t("ajax - failed to extract status from response text")}else hostname=i.match(/^https?:\/\/([^\/]+)/im),o="failed "+(hostname&&hostname[1]||i);o=(n?n+" ":"")+o;e?e.toString=function(){return o}:e=o,t("ajax - failed - "+e),a(s,e)}}}}try{f.open(e,i,!0),f.withCredentials=!0}catch(n){return t("Failed to call ajax method "+e+" on URL "+i+", exception: "+n),a(s,"Exception in open request"),null}if(c&&("xml"==c?(f.response_type="document",f.overrideMimeType("text/xml")):f.responseType=c),d&&d.length>0&&d.length%2==0)for(var v=0;v<d.length;v+=2)f.setRequestHeader(d[v],d[v+1]),re&&"authorization"==d[v].toLowerCase()&&f.setRequestHeader("X-"+d[v],d[v+1]);return n?l&&"application/json"!=l?"ignore"!=l&&f.setRequestHeader("Content-Type",l):(f.setRequestHeader("Content-Type","application/json"),n=JSON.stringify(n),K||t("ajax - request "+i.substr(0,100)+"\n"+n.substr(0,100))):K||t("ajax - request "+i.substr(0,100)),f.send("GET"==e?null:n||""),f}function de(e){var i=this._server="https://app.koopid.io",n=i.match(/^https?:\/\/((\d+\.\d+\.\d+\.\d+)|(localhost))(:\d+)?$/)?"vm":"cloud";for(var a in this._default="vm"==n?{web:i+"/kpd-static",api:i+"/KoopidServer/api",files:i+"/KoopidServer/api/File",message:"ws://"+i.match(/^https?:\/\/([^\/:]*).*/)[1]+":8083/mqtt"}:{web:i+"/static",api:i+"/api",files:i+"/files/",message:"wss://"+i.match(/^https?:\/\/([^\/:]*).*/)[1]+"/message/"},this._default.fingerprint=!1,this._value={},this._default)this._value[a]=this._default[a];var o=function(e,t){Object.defineProperty(e,t,{__proto__:null,get:function(){return e._value[t]},enumerable:!0})};for(var r in this._value)o(this,r);this._location={type:"geolocation",latitude:40.6664289,longitude:74.432};var s=this;if(Object.defineProperty(s,"location",{__proto__:null,get:function(){return s._location},set:function(e){return s._location=e},enumerable:!0}),this.myprofile=null,e=void 0===e?kd("localstore"):""+e,this._local_store=f()&&(!e||"false"==e)||!f()&&"false"==e?{}:null,!this._local_store&&!d())try{window.localStorage["koopid.testing"]="true",delete window.localStorage["koopid.testing"]}catch(e){t("failed to use local storage - "+e+" disabling state storage"),this._local_store={}}this._prefix="koopid.",e&&"true"!=e&&"false"!=e&&(this._prefix+=e+".")}function ue(){this.opts=Object.assign({serialize:JSON.stringiy,deserialize:JSON.parse,ttl:0}),this.store={}}function pe(){this.auth=null,this._refresh_timer=null,this._refresh_data=null}de.prototype.upgrade=function(e){e&&void 0!==e.widgets&&void 0===e.web&&(e.web=e.widgets.replace(/\/widgets$/,"").replace(/:9080/,":8000"),delete e.api1,delete e.widgets),e&&void 0===e.fingerprint&&(e.fingerprint=!1)},de.prototype.auto_settings=function(e,i){var n={web:"",api:"",files:"",message:"",fingerprint:!1};if(e||!window.location.hostname||"http:"!=window.location.protocol&&"https:"!=window.location.protocol||!window.location.hostname.match(/^(localhost)|(\d+\.\d+\.\d+\.\d+)$/))if(e||"http:"!=window.location.protocol&&"https:"!=window.location.protocol)if(e)if(e.match(/^https?:\/\/.*/)&&e.match(/^https?:\/\/(localhost)|(\d+\.\d+\.\d+\.\d+)(:\d+)?\//)){t("configuring native app with VM/server URL");var a=e.match(/^((https?:)\/\/([^\/:]*)(:\d+)?)\/?/);n.web=e.replace(/\/$/,""),n.api=a[1]+"/KoopidServer/api",n.files=a[1]+"/KoopidServer/api/File",n.message=("https:"==a[2]?"wss:":"ws:")+"//"+a[3]+":8083/mqtt"}else if(e.match(/^https?:\/\/.*/)){t("configuring native app with nginx proxy");a=e.match(/^(https?:)\/\/(.*)?\//);n.web=e.replace(/\/$/,""),n.api=n.web.replace(/\/static/,"")+"/api",n.files=n.web.replace(/\/static/,"")+"/files/",n.message=("https:"==a[1]?"wss:":"ws:")+"//"+a[2]+"/message/"}else e.match(/^((\d+\.\d+\.\d+\.\d+)|(localhost))(:\d+)?$/)?(t("configuring native app with VM/server host"),n.web="http://"+e+"/kpd-static",n.api="http://"+e+"/KoopidServer/api",n.files="http://"+e+"/KoopidServer/api/File",n.message="ws://"+e.split(":")[0]+":8083/mqtt"):e.match(/^[a-z0-9\.\-\_]+(:\d+)?$/)?(t("configuring native app with nginx proxy"),n.web="https://"+e+"/static",n.api="https://"+e+"/api",n.files="https://"+e+"/files/",n.message="wss://"+e+"/message/"):t("failed to do any configuration");else for(var o in t("configuring native app with default server"),this._default)n[o]=this._default[o];else{t("configuring webapp on nginx proxy"),void 0===i&&(i=window.location.pathname);var r=window.location.origin+i.replace(/\/(kpd-)?client.*$/,"");n.web=r+"/static",n.api=r+"/api",n.files=r+"/files/",n.message=("https:"==window.location.protocol?"wss:":"ws:")+"//"+window.location.host+"/message/"}else t("configuring webapp on VM/server"),n.web=window.location.origin+"/kpd-static",n.api=window.location.origin+"/KoopidServer/api",n.files=window.location.origin+"/KoopidServer/api/File",n.message=("https:"==window.location.protocol?"wss:":"ws:")+"//"+window.location.hostname+":8083/mqtt";return n},de.prototype.update=function(e){if(e)for(var t in this._value)this._value[t]=e[t]||this._default[t]},de.prototype.store=function(e,i,n){if("login"==e&&(i=te(i)),!n&&this._local_store)this._local_store[e]=i;else if(d()&&chrome.storage.local)if(t("state.store "+e+" "+JSON.stringify(i)),i){var a={};a[e]=JSON.stringify(i),chrome.storage.local.set(a)}else chrome.storage.local.remove(e);else if(i)try{localStorage[this._prefix+e]=JSON.stringify(i)}catch(e){t("state.store - localStorage failed - cannot store state "+e)}else try{delete localStorage[this._prefix+e]}catch(e){}},de.prototype.load=function(e,t,i){var n=function(i){"login"==e&&(i=ie(i)),t&&t(i)};if(!i&&this._local_store){var a=void 0!==this._local_store[e]?this._local_store[e]:null;n(a)}else if(d()&&chrome.storage.local)chrome.storage.local.get(e,(function(t){n(void 0===t[e]?null:JSON.parse(t[e]))}));else try{a=JSON.parse(localStorage[this._prefix+e]||"null");n(a)}catch(e){n(null)}},de.prototype.resolve=function(e){return"http:"==e.substr(0,5)||"https:"==e.substr(0,6)?e:e&&(e.startsWith("/kpd-widgets/")||e.startsWith("/widgets")||e.startsWith("widgets")||e.startsWith("/images")||e.startsWith("images"))?(e&&e.startsWith("/kpd-widgets/")&&(e=e.substr("/kpd-widgets".length)),t("WARN: move path to kpd-static: "+e),Kl.web.replace("/kpd-static","/kpd-widgets").replace("/static","/kpd-widgets")+("/"==e.substr(0,1)?"":"/")+e):(e&&e.startsWith("/kpd-static/")?e=e.substr("/kpd-static".length):e&&e.startsWith("/static/")&&(e=e.substr("/static".length)),Kl.web+("/"==e.substr(0,1)?"":"/")+e)},ue.prototype.set=function(e,t,i){void 0===i&&(i=this.opts.ttl);var n=[];n[0]=t,n[1]=0==i?0:Math.round(Date.now()/1e3)+i,this.store[e]=n},ue.prototype.get=function(e){if(null!=e){var t=this.store[e];if(void 0!==t){if(!(0!=t[1]&&Math.round(Date.now()/1e3)>t[1]))return t[0];delete this.store[e]}}},ue.prototype.delete=function(e){this.store.hasOwnProperty(e)&&delete this.store[e]};try{ae=new ue,oe=new ue}catch(e){function fe(){}fe.prototype.set=function(e,t,i){},fe.prototype.get=function(e){},fe.prototype.delete=function(e){},ae=new fe,oe=new fe,t("unable to locate keyv.  Caching of values disabled...")}function he(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}return!0}function ge(e,t){if(e)for(var i in"string"==typeof t&&(t=t.split(" ")),e)t.indexOf(i)<0&&delete e[i]}function ve(e,t){if(e){"string"==typeof t&&(t=t.split(" "));for(var i=0;i<t.length;++i)void 0===e[t[i]]&&(e[t[i]]="")}}function me(e){e.user_token&&(e.token=e.user_token),void 0===e.expires&&(e.expires=""),ge(e,"email expires providerId token user_id");var t=Object.keys(e).sort().join(" ");he("email expires token user_id"==t||"email expires providerId token user_id"==t),he(e.user_id&&e.token&&e.email),he("string"==typeof e.user_id),he("string"==typeof e.expires)}pe.prototype.login=function(e,t,i,n){var a=null;a=e&&t?{username:e,password:t}:{use_credentials:!1},this.login_alt(a,i,n)},pe.prototype.login_alt=function(e,t,i){var n=this,o={action:"login"},r=null;for(var s in!1!==e.use_credentials&&e.username&&e.password?(r=["Authorization","Basic "+L(e.username+":"+e.password)],o.type="jwt"):!1!==e.use_credentials&&e.jwt&&(r=["Authorization","Bearer "+e.jwt],o.type="jwt"),"string"==typeof On&&(o.device=On),"string"==typeof In&&""!==In.trim()&&(o.referrer=In),(kd("*")||[]).filter((function(e){return"login-"==e.name.substr(0,6)})).forEach((function(e){o[e.name.substr(6)]=e.value})),e)["type","use_credentials","username","password","jwt"].indexOf(s)<0&&(o[s]=e[s]);this.ajax("POST",Kl.api+"/login",o,(function(i){n.auth=i=i.entity,i.providerprofile&&ae.set(i.providerprofile.id,{entity:i.providerprofile},120),i.userprofile&&ae.set(i.userprofile.id,{entity:i.userprofile},120),me(i),a(t,n.auth),i.expires&&e.username&&e.password&&(n._refresh_data={username:e.username,password:e.password},n._refresh_login())}),i,void 0,void 0,r)},pe.prototype.relogin=function(e,t){var i=this,n=null;this.auth&&this.auth.token&&(n=["Authorization","Bearer "+this.auth.token]),this.ajax("POST",Kl.api+"/login",{action:"login",type:"jwt"},(function(t){i.auth=t=t.entity,me(t),a(e,i.auth),t.expires&&i._refresh_login()}),t,void 0,void 0,n)},pe.prototype._refresh_login=function(){var e=this;this._refresh_timer&&(clearTimeout(this._refresh_timer),this._refresh_timer=null);var i=parseInt(this.auth.expires);isNaN(i)||((i-=(new Date).getTime())>=2e4&&(i-=1e4),i<1e4&&(i=1e4),i>2147483647&&(i=2147483647),t("api.refresh-login timeout="+i),e._refresh_timer=setTimeout((function(){t("api.refresh-login timedout"),e._refresh_timer&&(clearTimeout(e._refresh_timer),e._refresh_timer=null),e.login(e._refresh_data.username,e._refresh_data.password)}),i))},pe.prototype.logout=function(e,t,i,n){var o=this;setTimeout((function(){o.auth=null}),0),this._refresh_timer&&(clearTimeout(this._refresh_timer),this._refresh_timer=null);var r="useraction="+(n||"false");this.ajax("DELETE",Kl.api+"/login?"+r+(i?"&permanent=false":""),null,(function(t){!function(e){ge(e,[]),he(!e||!Object.keys(e).join(" "))}(t),a(e)}),t)},pe.prototype.forgot_password=function(e,t,i){this.ajax("POST",Kl.api+"/Account/ForgotPassword",{action:"forgot",email:e},(function(e){e=e.entity,a(t,e)}),i)},pe.prototype.reset_password=function(e,t,i,n,a,o){this.ajax("POST",Kl.api+"/Account/ResetPassword",{action:"reset",email:e,nonce:t,token:i,password:n},a,o)},pe.prototype.signup_email=function(e,t,i,n){this.ajax("POST",Kl.api+"/signup",{action:"signup_email",email:e,phone:t},i,n)},pe.prototype.signup_token=function(e,t,i,n,a){var o=C(e+":localhost:"+i);this.ajax("POST",Kl.api+"/signup",{action:"signup_token",email:e,token:t,hash:o},n,a)},pe.prototype.signup_profile=function(e,t,i){this.ajax("PUT",Kl.api+"/Customer/"+this.auth.user_id+"/Profile",e,t,i)},pe.prototype.signup_business_profile=function(e,t,i){this.ajax("PUT",Kl.api+"/Provider/"+this.auth.user_id+"/Profile",e,t,i)},pe.prototype.signup_import_contacts=function(e,t){Ye("signup_import_contacts() not implemented","Error")},pe.prototype.change_password=function(e,t,i,n){this.ajax("POST",Kl.api+"/Account/Password",{action:"change",current:e,new:t},i,n)},pe.prototype.set_password=function(e,t,i,n,a){this.ajax("POST",Kl.api+"/Account/ResetPassword",{action:"change",current:e,new:t,user_id:i},n,a)},pe.prototype.accesslogin=function(e,t,i,n){var o=Kl.api.match(/^(https?:\/\/[^\/]+)/),r="username="+encodeURIComponent(e)+"&password="+encodeURIComponent(t)+"&target="+encodeURIComponent("/");le("POST",o[1]+"/login",r,(function(e){a(i)}),(function(e){a(n,e)}),"text","application/x-www-form-urlencoded")};var ye=-1;function be(e){void 0!==e.website&&(e.web=e.website),void 0===e.isBot&&(e.isBot=!1),(e.roles&&e.roles.indexOf("bot")>=0||"bot"==e.html)&&(e.isBot=!0),"null"==e.phone&&(e.phone=""),ge(e,"email isBot isEmployee location name phone picture providerId status title web"),void 0!==e.isEmployee&&ve(e,"email location name phone picture providerId status title web");var t=Object.keys(e).sort().join(" ");he("email isBot isEmployee location name phone picture status title web"==t||"email isBot isEmployee location name phone picture providerId status title web"==t),he(e.email&&e.name&&"string"==typeof e.phone),he(!e.web||e.web.match(/^https?:\/\/.*/)||e.web.indexOf(":")<0&&"/"!=e.web.charAt(0))}pe.prototype.get_customer_profile=function(e,i,n){var o=this,r=function(t){ae.set(e,t,120),t=t.entity,ye=-1,be(t),a(i,t)},s=function(e){ye=-1,a(n,e)};!function i(){let n=ae.get(e);if(n)return t("cached - get_customer_profile: "+e),void r(n);ye!=e?(ye=e,o.ajax("GET",Kl.api+"/Customer/"+e+"/Profile",null,r,s)):setTimeout(i,50)}()},pe.prototype.put_customer_profile=function(e,t,i,n){var o={entity:t};this.ajax("PUT",Kl.api+"/Customer/"+e+"/Profile",o,(function(t){ae.set(e,t,120),be(t=t.entity),a(i,t)}),n)},pe.prototype.get_customer_extra_profile=function(e,t,i){var n=this;this.ajax("GET",Kl.api+"/Customer/"+e+"/Profile",null,(function(i){be(i=i.entity),n.ajax("GET",Kl.api+"/Customer/"+e+"/ExtraProfile",null,(function(e){for(var n in e)i[n]=e[n];a(t,i)}),(function(e){a(t,i)}))}),i)},pe.prototype.get_my_iplocation=function(e,t){this.ajax("GET",Kl.api+"/Customer/Location",null,(function(t){a(e,t.entity)}),t)},pe.prototype.get_provider_profile=function(e,i,n){var o=function(t){ae.set(e,t,120),function(e){void 0!==e.website&&(e.web=e.website),"number"==typeof e.id&&(e.id=""+e.id),void 0===e.config&&(e.config={}),void 0===e.config.sneak_peek&&(e.config.sneak_peek=!1),e.config.agent_load_history&&Et&&(e.config.load_history=e.config.agent_load_history,delete e.config.agent_load_history),void 0===e.config.load_history?e.config.load_history="hidden":"boolean"==typeof e.config.load_history&&(e.config.load_history=e.config.load_history?"always":"hidden"),void 0===e.config.close_messages&&(e.config.close_messages=[]),"boolean"==typeof e.branding&&(e.branding=e.branding?"koopid":""),void 0===e.config.agent_show_chats_of_state&&(e.config.agent_show_chats_of_state="all"),"boolean"==typeof e.config.agent_lang_translation&&Et&&(e.config.lang_translation=e.config.agent_lang_translation,delete e.config.agent_lang_translation),"boolean"==typeof e.config.agent_read_receipt&&Et&&(e.config.send_read_receipt=e.config.agent_read_receipt,delete e.config.agent_read_receipt),"317"==e.id&&!0===e.config.sneak_peek&&(e.config.sneak_peek="hide-customer");ge(e,"address branding config email html id name phone picture rating status web externalprovid extvendor enabled"),ve(e,"address branding config email html id name phone picture status web"),he(["address","branding","config","email","html","id","name","phone","picture","rating","status","web"].every((function(t){return Object.keys(e).indexOf(t)>=0}))),he(e.email&&e.name&&e.web&&e.phone),void 0!==e.id&&he("string"==typeof e.id);he(void 0===e.branding||"string"==typeof e.branding),void 0!==e.config&&(he(void 0===e.config.sneak_peek||"boolean"==typeof e.config.sneak_peek||"number"==typeof e.config.sneak_peek||"string"==typeof e.config.sneak_peek),he(void 0===e.config.load_history||"string"==typeof e.config.load_history),he(void 0===e.config.close_messages||"object"==typeof e.config.close_messages&&void 0!==e.config.close_messages.length),he(void 0!==e.config.agent_show_chats_of_state&&"string"==typeof e.config.agent_show_chats_of_state&&["all","active"].indexOf(e.config.agent_show_chats_of_state)>-1))}(t=t.entity),a(i,t)},r=ae.get(e);void 0===r?this.ajax("GET",Kl.api+"/Provider/"+e+"/Profile",null,o,n):(t("cached - get_provider_profile: "+e),o(r))},pe.prototype.put_provider_profile=function(e,t,i,n){this.ajax("PUT",Kl.api+"/Provider/"+e+"/Profile",t,i,n)};var we=[],xe=[],_e=[];function ke(e){e.sort((function(e,t){return e.ts==t.ts?0:e.ts>t.ts?-1:1}))}function Te(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){ge(e,"id path state");var t=Object.keys(e).sort().join(" ");he("path"==t||"id path"==t||"path state"==t||"id path state"==t),he(!e.id||"string"==typeof e.id)}))}pe.prototype.get_customer_type=function(e,i,n){we.includes(e)?a(i,"bot"):xe.includes(e)?a(i,"agent"):_e.includes(e)?a(i,"customer"):this.get_customer_profile(e,(function(t){var n="customer";t.isBot?(we.push(e),n="bot"):t.isEmployee?(xe.push(e),n="agent"):_e.push(e),a(i,n)}),(function(e){t(e),a(n,"")}))},pe.prototype.get_customer_business_profile=function(e,t,i,n){this.ajax("GET",Kl.api+"/Customer/"+e+"/BusinessIdentity/Provider/"+t,null,(function(e){(function(e){console.log(e),e.hasOwnProperty("phone")||(e.phone="");ge(e,"email name phone"),ve(e,"email name phone"),he("email name phone"==Object.keys(e).sort().join(" ")),he(e.email&&e.name)})(e=e.entity),a(i,e)}),n)},pe.prototype.get_customer_business_profiles=function(e,t,i,n){this.ajax("GET",Kl.api+"/Customer/"+e+"/BusinessIdentity/Provider/"+t+"?idtype=all",null,(function(e){e=e.entity,Array.isArray(e)&&(e.forEach((function(t,i){t.hasOwnProperty("channeltype")||e.splice(i,1)})),a(i,e))}),n)},pe.prototype.get_or_create_customer_business_profile=function(e,t,i,n,o,r){var s={channeltype:t,customersocialid:i,profile:n};this.ajax("POST",Kl.api+"/SocialChannel/Customer/"+e,s,(function(e){e=e.entity,a(o,e)}),r)},pe.prototype.put_customer_business_profile=function(e,t,i,n,a){this.ajax("PUT",Kl.api+"/Customer/"+e+"/BusinessIdentity/Provider/"+t,i,n,a)},pe.prototype.get_suggestions=function(e,t,i){return this.ajax("GET",ce(Kl.api+"/search",{typing:e}),null,(function(e){!function(e){(void 0===e||"object"==typeof e&&e.error)&&(e=[]);he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){!e.html&&e.text&&(e.html=n(e.text)),!e.action&&e.text&&(e.action={path:"search/"+e.text}),ge(e,"action html text"),he("action html text"==Object.keys(e).sort().join(" "))}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.search=function(e,t,i){var n=JSON.stringify({text:e,location:Kl.location});return this.ajax("GET",ce(Kl.api+"/search",{data:n}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){if(e.actions||(e.actions={default:e.action||null}),e.actions.default||(e.enabled&&e.id?e.actions.default={path:"frontpage/"+e.id}:e.phone&&(e.actions.default={url:m(e.phone)})),!e.actions.click&&e.contact&&(e.actions.click={path:"contacts/"+e.contact}),e.contact=!!(e.contact&&"string"==typeof e.contact&&!Et&&void 0!==e.id&&Ct.indexOf(e.id)>=0),!e.context)if(e.last_visited)e.context="Last visited on "+new Date(e.last_visited).toDateString();else{var t=e.html.split("<br/>",2);e.html=t[0],e.context=t.length>1?t[1]:""}e.enabled=!!e.enabled,void 0===e.config&&(e.config={}),ge(e,"actions address config contact context cost distance enabled html name phone picture rating status tags web"),ve(e,"address context html name phone picture status web"),he("actions address config contact context cost distance enabled html name phone picture rating status tags web"==Object.keys(e).sort().join(" ")),he("string"==typeof e.cost),he("string"==typeof e.distance),he("number"==typeof e.rating),he("boolean"==typeof e.enabled),he("boolean"==typeof e.contact),he("object"==typeof e.tags&&void 0!==e.tags.length)}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.search_chats=function(e,t,i,n,o,r,s){if((Qt||ni)&&ti){for(var c=ti.slice(0),l=c.length,d=[],u=null,p=function(){--l<=0&&(ke(d),a(r,d))};c.length>0;)u=this.search_chats_internal(e,c.pop(),void 0,void 0,void 0,void 0,(function(e,t){e.forEach((function(e){d.push(e)})),p()}),(function(e){p()}));return u}return this.search_chats_internal(e,Qt||ni,t,i,n,o,(function(e,t){ke(e),a(r,e,t)}),s)},pe.prototype.search_chats_internal=function(e,t,i,n,o,r,s,c){var l={with:this.auth.user_id,text:e,deep:2},d=e.match(/(\sin\snames|\sin\ssocial\shandle|\sin\sphone|\sin\semail)/g);return d&&(l.businessid=e.replace(d,""),l.text="",delete l.with),"routefailure"==l.text&&(l.end=(new Date).getTime(),l.start=l.end-6048e5,delete l.with),t&&(l.providerFilter=t),o?(l.path=o,l.deep=4,delete l.text):void 0!==i&&void 0!==n&&(l.offset=i,l.limit=n),void 0!==r&&(l.state=r),l=JSON.stringify(l),this.ajax("GET",ce(Kl.api+"/Conversation",{data:l}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){e.conversationid&&(e.chat=e.conversationid,void 0===e.status&&(e.status="available"),void 0===e.html&&(e.html="")),!e.action&&e.actions&&e.actions.default&&(e.action=e.actions.default),!e.action&&e.chat&&(e.action={path:"chat/"+e.chat}),e.ts||(e.ts=null),e.names||(e.names=[]),void 0===e.count&&(e.count=0),void 0!==e.state&&"started"!=e.state||(e.state="inactive"),ge(e,"action chat count employeeid html logo name names path participants picture state status ts channel businessidentity"),ve(e,"channel html logo name participants picture state status employeeid participants"),he("action businessidentity channel chat count employeeid html logo name names participants path picture state status ts"==Object.keys(e).sort().join(" ")),he("string"==typeof e.chat),he(null==e.ts||"string"==typeof e.ts),he("object"==typeof e.names&&void 0!==e.names.length),he("number"==typeof e.count),he("string"==typeof e.state&&["active","inactive"].indexOf(e.state)>-1)}))}(e.entity);var t=null;void 0===i||o||(t={count:e.count||void 0,offset:i,limit:n}),a(s,e.entity,t)}),c)},pe.prototype.get_provider_related_chats=function(e,t,i,n){var o=JSON.stringify({with:e,providerFilter:t,deep:1});return this.ajax("GET",ce(Kl.api+"/Conversation",{data:o}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){!e.chat&&e.id&&(e.chat=e.id),!e.action&&e.chat&&(e.action={path:"chat/"+e.chat}),ge(e,"action chat lastMessage participants"),he("action chat lastMessage participants"==Object.keys(e).sort().join(" ")||"action chat participants"==Object.keys(e).sort().join(" ")),he("string"==typeof e.chat)}))}(e.entity),a(i,e.entity)}),n)},pe.prototype.search_customer_contacts=function(e,t,i){var n=JSON.stringify({deep:deep,sort:"name",filter:{name:e}});return this.ajax("GET",ce(Kl.api+"/Customer/"+this.auth.user_id+"/Favorite",{data:n}),null,(function(e){e.entity.sort((function(e,t){return(e.name||"").toLocaleLowerCase().localeCompare((t.name||"").toLocaleLowerCase())})),a(t,e.entity)}),i)},pe.prototype.get_customer_top_contacts=function(e,i){var n=JSON.stringify({deep:2,level:1,sort:"name"});return this.ajax("GET",ce(Kl.api+"/Customer/"+this.auth.user_id+"/Favorite",{data:n}),null,(function(i){i.entity&&i.entity.forEach((function(e){e.picture&&e.picture.startsWith("images/")&&t("WARN: move contacts picture to kpd-static: "+e.picture)})),i.entity&&i.entity.sort((function(e,t){return(e.name||"").toLocaleLowerCase().localeCompare((t.name||"").toLocaleLowerCase())})),function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){if(!e.action&&e.id&&(e.action={path:"frontpage/"+e.id}),e.action&&e.action.path){var t=e.action.path.match(/^chat\/(\d+)(\/(\d+))?$/);t&&!t[2]?e.action.path="chatwith/"+t[1]:t&&t[2]&&(e.action.path="chat/"+t[3])}"number"==typeof e.id&&(e.id=""+e.id),void 0===e.config&&(e.config={}),ge(e,"action config enabled html id name phone picture"),ve(e,"html name picture"),he("action config enabled html id name phone picture"==Object.keys(e).sort().join(" ")),he("string"==typeof e.id),he("boolean"==typeof e.enabled)}))}(i.entity),a(e,i.entity)}),i)},pe.prototype.get_customer_sub_contacts=function(e,t,i){var n=JSON.stringify({deep:2,level:2,parent:e});return this.ajax("GET",ce(Kl.api+"/Customer/"+this.auth.user_id+"/Favorite",{data:n}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){if(!e.action&&e.id&&(e.action={path:"profile/"+e.id}),e.action&&e.action.path){var t=e.action.path.match(/^chat\/(\d+)(\/(\d+))?$/);t&&!t[2]?e.action.path="chatwith/"+t[1]:t&&t[2]&&(e.action.path="chat/"+t[3])}e.status||(e.status=""),"number"==typeof e.id&&(e.id=""+e.id),ge(e,"action html id name picture status"),ve(e,"html name picture status"),he("action html id name picture status"==Object.keys(e).sort().join(" ")),he("string"==typeof e.id)}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.get_customer_contacts=function(e,t){var i={deep:1};return Qt&&(i.providerFilter=Qt),i=JSON.stringify(i),this.ajax("GET",ce(Kl.api+"/Customer/"+this.auth.user_id+"/Favorite",{data:i}),null,(function(t){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){he("string"==typeof e)}))}(t.entity),a(e,t.entity)}),t)},pe.prototype.post_customer_contact=function(e,t,i){var n={user_id:e};return this.ajax("POST",Kl.api+"/Customer/"+this.auth.user_id+"/Favorite",{entity:n},t,i)},pe.prototype.delete_customer_contact=function(e,t,i){return this.ajax("DELETE",Kl.api+"/Customer/"+this.auth.user_id+"/Favorite/"+e,null,t,i)},pe.prototype.get_provider_contacts=function(e,t){return this.ajax("GET",Kl.api+"/Provider/"+this.auth.user_id+"/Contacts",null,(function(t){t.entity&&t.entity.sort((function(e,t){return(e.name||"").toLocaleLowerCase().localeCompare((t.name||"").toLocaleLowerCase())})),function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){"number"==typeof e.id&&(e.id=""+e.id),he("string"==typeof e.id),he("string"==typeof e.email),he("string"==typeof e.name),he("string"==typeof e.phone),he("string"==typeof e.picture)}))}(t.entity),a(e,t.entity)}),t)},pe.prototype.get_provider_canned_messages=function(e,t){var i=Kl.api+"/CannedMessage/Provider/"+this.auth.user_id;return void 0!==Hn&&Hn&&(i=ce(i,{data:JSON.stringify({chatid:Hn})})),this.ajax("GET",i,null,(function(t){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){void 0===e.text&&void 0!==e.msg&&(e.text=e.msg),void 0===e.type&&"string"==typeof e.text&&(e.type="chat"),ge(e,"text type"),ve(e,"text type"),he("string"==typeof e.text),he("chat"==e.type)}))}(t.entity),a(e,t.entity)}),t)},pe.prototype.get_provider_agents=function(e,t,i){return this.ajax("GET",Kl.api+"/Provider/"+e+"/Employee",null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){"number"==typeof e.id&&(e.id=""+e.id),ge(e,"id name picture skills status"),he("string"==typeof e.id),he("string"==typeof e.name),he(!e.picture||"string"==typeof e.picture),he(!e.skills||"object"==typeof e.skills&&void 0!==e.skills.length),he(!e.status||"string"==typeof e.status)}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.get_customer_subscription=function(e,t){return this.ajax("GET",Kl.api+"/Subscription/"+this.auth.user_id,null,(function(t){var i=t.entity.map((function(e){return{id:e.id,provider:e.providerId,type:e.notification_type,topic:e.topic}}));a(e,i)}),t)},pe.prototype.post_customer_subscription=function(e,t,i){e.type&&(e.notification_type=e.type,delete e.type),e.id&&(e.user_id=e.id,delete e.id);return this.ajax("POST",Kl.api+"/Subscription/"+this.auth.user_id,{entity:e},(function(e){a(t,e.id)}),i)},pe.prototype.delete_customer_subscription=function(e,t,i){return this.ajax("DELETE",Kl.api+"/Subscription/"+this.auth.user_id+"/"+e,null,t,i)},pe.prototype.get_customer_alerts=function(e,t){var i={};return(Qt||ni)&&(i.data=JSON.stringify({providerFilter:Qt||ni})),this.ajax("GET",ce(Kl.api+"/Notification/"+this.auth.user_id,i),null,(function(t){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){"number"==typeof e.id&&(e.id=""+e.id),void 0===e.allowdelete&&(e.allowdelete=!0),ge(e,"action allowdelete html id logo name picture"),ve(e,"html allowdelete logo name picture"),he("action allowdelete html id logo name picture"==Object.keys(e).sort().join(" ")),he("string"==typeof e.id),he("boolean"==typeof e.allowdelete)}))}(t.entity),a(e,t.entity)}),t)},pe.prototype.delete_customer_alert=function(e,t,i){return this.ajax("DELETE",Kl.api+"/Notification/"+this.auth.user_id+"/"+e,null,t,i)},pe.prototype.get_provider_presence=function(e,t){var i=this.auth.user_id,n=Kl.myprofile.providerId;return this.ajax("GET",Kl.api+"/Presence/"+i+"/Provider/"+n,null,(function(t){!function(e){he("string"==typeof e.status),he("available away busy".split(" ").indexOf(e.status)>=0)}(t.entity),Kl.myprofile.status=t.entity.status,a(e,t.entity)}),t)},pe.prototype.set_provider_presence=function(e,t,i){var n=this.auth.user_id,o=Kl.myprofile.providerId,r={status:e};return he("available away busy".split(" ").indexOf(r.status)>=0),this.ajax("PUT",Kl.api+"/Presence/"+n+"/Provider/"+o,{entity:r},(function(i){Kl.myprofile.status=e,At=l("presencestate",e,At),a(t)}),i)},pe.prototype.get_chat_paths=function(e,t){var i=this,n=function(t){var n={with:i.auth.user_id,deep:0,state:"active"};Qt&&(n.providerFilter=Qt),n=JSON.stringify(n),i.ajax("GET",ce(Kl.api+"/Conversation",{data:n}),null,(function(i){var n=t.concat(i.entity);Te(n),a(e,n)}),(function(){Te(t),a(e,t)}))};n([{path:"notification/+/+/"+i.auth.user_id+"/#"}])},pe.prototype.get_chat_path_with=function(e,t,i){var n={with:this.auth.user_id,target:e,create:"true",limit:1,deep:1};try{Pa&&(n.channelid=Pa,n.channelvendor="dialpad",n.channeltype="webchat")}catch(e){}var o=JSON.stringify(n);this.ajax("GET",ce(Kl.api+"/Conversation",{data:o}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),he(1==e.length),e.forEach((function(e){ge(e,"id path state"),he("id path state"==Object.keys(e).sort().join(" ")),he("string"==typeof e.id)}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.get_chat_path=function(e,t,i){var n=JSON.stringify({id:e,with:this.auth.user_id,deep:1});this.ajax("GET",ce(Kl.api+"/Conversation",{data:n}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),he(1==e.length),e.forEach((function(e){ge(e,"id path"),he("id path"==Object.keys(e).sort().join(" ")),he("string"==typeof e.id)}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.get_chat_id=function(e,t,i){var n=JSON.stringify({path:e,deep:1});this.ajax("GET",ce(Kl.api+"/Conversation",{data:n}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),he(1==e.length),e.forEach((function(e){ge(e,"id path"),he("id path"==Object.keys(e).sort().join(" ")),he("string"==typeof e.id)}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.post_chat_status=function(e,t,i,n,a){var o={status:t,with:this.auth.user_id,flag:i};this.ajax("POST",Kl.api+"/Conversation/"+e+"/State",o,n,a)},pe.prototype.post_chat_message=function(e,t,i,n){},pe.prototype.post_chat_path=function(e,t,i,n){},pe.prototype.get_chat_messages=function(e,t,i,n){var o={id:e,deep:3};if(t)for(var r in t)o[r]=t[r];this.ajax("GET",ce(Kl.api+"/Conversation",{data:JSON.stringify(o)}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){"string"==typeof e.ts&&(e.ts=parseInt(e.ts)),ge(e,"action allow blob channelinfo className data flag id mediatype message replace sender senderName style text ts type tz url widgetInfo"),he(!e.sender||"string"==typeof e.sender),he(!e.ts||"number"==typeof e.ts),he(!e.id||"string"==typeof e.id)}))}(e.entity),a(i,e.entity)}),n)},pe.prototype.get_customer_chat_info=function(e,t,i){var n=JSON.stringify({id:e,with:this.auth.user_id,deep:1});this.ajax("GET",ce(Kl.api+"/Conversation",{data:n}),null,(function(e){!function(e){void 0!==(e=e[0]).providerId&&(e.provider=e.providerId);void 0!==e.customerId&&(e.customer=e.customerId);void 0===e.customer&&e.participants&&e.participants.length>0&&(e.customer=e.participants.filter((function(e){return e!=Yl.auth.user_id}))[0]);e.participants_detailed&&(e.customer=e.participants_detailed.filter((function(e){return"customer"==e.usertype}))[0].id);void 0===e.sequence&&(e.sequence=!1);e.channelinfo||(e.channelinfo={});ge(e,"channel channelinfo customer participants provider sequence state"),he("channel channelinfo customer participants provider sequence state"==Object.keys(e).sort().join(" ")),he("string"==typeof e.provider),he("object"==typeof e.participants&&void 0!==e.participants.length);for(var t=0;t<e.participants.length;++t)he("string"==typeof e.participants[t]);he("boolean"==typeof e.sequence)}(e.entity),a(t,e.entity[0])}),i)},pe.prototype.get_provider_chat_info=function(e,t,i){var n=JSON.stringify({id:e,with:this.auth.user_id,deep:2});this.ajax("GET",ce(Kl.api+"/Conversation",{data:n}),null,(function(e){!function(e,t){t&&(e=e[0]);"number"==typeof e.customer.id&&(e.customer.id=""+e.customer.id),"string"==typeof e.active&&(e.active="true"==e.active),"string"==typeof e.attachment&&(e.attachment="true"==e.attachment),"string"==typeof e.newcount&&(e.newcount=parseInt(e.newcount||"0")),"string"==typeof e.message.ts&&(e.message.ts=parseInt(e.message.ts||"0"));ge(e,"active attachment customer message newcount"),he("active attachment customer message newcount"==Object.keys(e).sort().join(" ")),ge(e.customer,"id name picture status"),he("id name picture status"==Object.keys(e.customer).sort().join(" ")),ge(e.message,"text ts"),he("text ts"==Object.keys(e.message).sort().join(" ")),he("string"==typeof e.customer.id),he("number"==typeof e.message.ts),he("boolean"==typeof e.active),he("boolean"==typeof e.attachment),he("number"==typeof e.newcount)}(e.entity,!0),a(t,e.entity[0])}),i)},pe.prototype.get_active_chats=function(e,t,i,n){this.ajax("GET",Kl.api+"/Customer/"+e+"/ActiveSessions/"+t,null,(function(e){e&&e.entity&&i(e.entity)}),n)},pe.prototype.get_chat_tags=function(e,t,i){var n={deep:1};Qt&&(n.providerFilter=Qt),n=JSON.stringify(n),this.ajax("GET",ce(Kl.api+"/Conversation/"+e+"/Tag",{data:n}),null,(function(e){!function(e){if(void 0!==e.length){for(var t={},i=e.length-1;i>=0;--i)void 0!==t[e[i]]?e.splice(i,1):t[e[i]]=!0;e.reverse()}he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){he("string"==typeof e)}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.get_provider_chat_tags=function(e,t,i){var n={deep:2};Qt&&(n.providerFilter=Qt),n=JSON.stringify(n),this.ajax("GET",ce(Kl.api+"/Conversation/"+e+"/Tag",{data:n}),null,(function(e){!function(e){void 0!==e.length&&e.reverse();he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){he("object"==typeof e),ge(e,"id tag"),he("string"==typeof e.id),he("string"==typeof e.tag)}))}(e.entity),a(t,e.entity)}),i)},pe.prototype.add_provider_chat_tag=function(e,t,i,n){var o={conversationId:e,authorId:this.auth.user_id,tag:t};this.ajax("POST",Kl.api+"/Conversation/"+e+"/Tag",{entity:o},(function(e){!function(e){e.tagId&&!e.id&&(e.id=e.tagId);ge(e,"id"),he("string"==typeof e.id)}(e),a(i,e)}),n)},pe.prototype.delete_provider_chat_tag=function(e,t,i,n){this.ajax("DELETE",Kl.api+"/Conversation/"+e+"/Tag/"+t,null,i,n)},pe.prototype.get_chat_rating=function(e,t,i){this.ajax("GET",Kl.api+"/Conversation/"+e+"/Rating",null,(function(e){var i={rating:e.entity.starRating,review:e.entity.reviewText};a(t,i)}),i)},pe.prototype.post_chat_rating=function(e,t,i,n,a){var o={userId:this.auth.user_id,starRating:t,visibility:!0};void 0!==i&&(o.reviewText=i||""),this.ajax("PUT",Kl.api+"/Conversation/"+e+"/Rating",{data:o},n,a)},pe.prototype.post_customer_provider_context=function(e,t,i,n,a){"this"==e&&(e=this.auth.user_id),"this"==t&&(t=this.auth.user_id),this.ajax("POST",Kl.api+"/CustomerContext/Customer/"+e+"/Provider/"+t,{entity:i},n,a)},pe.prototype.get_customer_provider_context=function(e,t,i,n,o){"this"==e&&(e=this.auth.user_id),"this"==t&&(t=this.auth.user_id),this.ajax("GET",ce(Kl.api+"/CustomerContext/Customer/"+e+"/Provider/"+t,{type:i}),null,(function(e){var t;he("string"==typeof(t=e.entity).type),he("object"==typeof t.context&&void 0!==t.context.length),a(n,e.entity)}),o)},pe.prototype.set_guest_customer_name=function(e,t,i,n){var a={name:t};this.ajax("PUT",Kl.api+"/Customer/"+e+"/Profile",{entity:a},i,n)},pe.prototype.get_provider_widgets=function(e,t){var i=Kl.api+"/Widget/Provider/"+this.auth.user_id;void 0!==Hn&&Hn&&(i=ce(i,{data:JSON.stringify({chatid:Hn})})),this.ajax("GET",i,null,(function(t){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){ge(e,"description icon messages name"),he(e.messages&&void 0!==e.messages.length),e.messages.forEach((function(e){ge(e,"allow data htmlText replace src style text type"),he("info"==e.type&&(e.text||e.htmlText)||("widget"==e.type||"inlinewidget"==e.type)&&e.src||"htmlwidget"==e.type&&(e.src||e.htmlText)),he(void 0===e.allow||"object"==typeof e.allow&&void 0!==e.allow.length),he(!e.data||"object"==typeof e.data),he(!e.replace||"object"==typeof e.replace)}))}))}(t.entity),a(e,t.entity)}),t)},pe.prototype.get_chatmenu=function(e,t,i,n){"Chat"==e&&(e="Conversation");var o=JSON.stringify({with:this.auth.user_id});this.ajax("GET",ce(Kl.api+"/Menu/"+e+"/"+t,{data:o}),null,(function(e){!function(e){he("object"==typeof e&&void 0!==e.length),e.forEach((function(e){ge(e,"action button text")}))}(e.entity),a(i,e.entity)}),n)},pe.prototype.do_chat_transfer=function(e,t,i,n){var o=JSON.stringify({add:t,with:this.auth.user_id});this.ajax("GET",ce(Kl.api+"/Conversation/"+e+"/Assign",{data:o}),null,(function(e){a(i,e.entity)}),n)},pe.prototype.do_provider_chat_assign=function(e,t,i,n,o){var r=JSON.stringify({with:t,drop:this.auth.user_id,add:i});this.ajax("GET",ce(Kl.api+"/Conversation/"+e+"/Assign",{data:r}),null,(function(e){a(n,e.entity)}),o)},pe.prototype.do_provider_chat_reopen=function(e,t,i,n,o){var r=JSON.stringify({with:t,drop:i,add:this.auth.user_id,reopen:!0});this.ajax("GET",ce(Kl.api+"/Conversation/"+e+"/Assign",{data:r}),null,(function(e){a(n,e.entity)}),o)},pe.prototype.do_provider_chat_initiate=function(e,t,i,n){var o={withParticipant:e,toParticipant:this.auth.user_id,provId:Qt,channel:t};this.ajax("POST",Kl.api+"/Conversation/Initiate",o,(function(e){a(i,e)}),n)},pe.prototype.send_provider_transcript_email=function(e,t,i,n,a,o){var r={chatId:e,providerId:t,agentId:i,customerId:n};this.ajax("POST",Kl.api+"/Email/Transcript",r,a,o)},pe.prototype.call_connect=function(e,t,i,n){var a={targets:e};for(var o in"chat"==page&&Hn&&(a.chat=Hn),t)a[o]=t[o];this.ajax("POST",Kl.api+"/Call/Connect",a,i,n)},pe.prototype.get_twilio_token=function(e,t){this.ajax("GET",Kl.api+"/Call/Out/Token",null,(function(t){a(e,t.entity)}),t)},pe.prototype.post_call_state=function(e,t,i,n,a){var o={state:t};"chat"==page&&Hn&&(o.chat=Hn),void 0!==i&&(o.transcribe=i),this.ajax("POST",Kl.api+"/Call/Out/State/"+e,o,n,a)},pe.prototype.get_customcss=function(e,i,n,o,r){var s=function(n){!function(e){he("object"==typeof e&&void 0===e.length),ge(e,"url")}(n.entity),n.entity.url&&(n.entity.url.startsWith("/widgets/profiles/customcss")||n.entity.url.startsWith("/kpd-widgets/widgets/profiles/customcss"))&&t("WARN: move provider "+e+" customcss to kpd-static: "+n.entity.url),r&&n.entity.customerurl?n.entity.url=Kl.resolve(n.entity.customerurl):n.entity.url=Kl.resolve(n.entity.url),a(i,n.entity)};let c=oe.get("customcss"),l=oe.get("brandingconfig");o&&l&&l[o]&&l[o].customcss&&(c=l[o].customcss),c?s({entity:c}):this.ajax("GET",Kl.api+"/Customization/"+e+"/customer",null,s,n,void 0,void 0,void 0,void 0,void 0,void 0,!!Qt&&Qt==e)},pe.prototype.get_frontdoor=function(e,t,i,n){var o=this;o.get_frontdoor_data(e,(function(r){o.get_frontdoor_page(e,t,(function(e){for(var t in e)r[t]=e[t];a(i,r)}),n)}),n)},pe.prototype.get_frontdoor_data=function(e,t,i){var n=function(e){!function(e){he("object"==typeof e&&void 0===e.length),ge(e,"config"),e.config&&he("object"==typeof e.config)}(e.entity),a(t,e.entity)};let o=oe.get("frontdoor");o?n({entity:o}):this.ajax("GET",Kl.api+"/FrontDoor/"+e+"/Data",null,n,i,void 0,void 0,void 0,void 0,1e3,void 0,!!Qt&&Qt==e)},pe.prototype.get_frontdoor_page=function(e,t,i,n){var o=JSON.stringify({since:t,user:this.auth?this.auth.user_id:null});this.ajax("GET",ce(Kl.api+"/FrontDoor/"+e+"/Page",{data:o}),null,(function(e){!function(e){he("object"==typeof e&&void 0===e.length),ge(e,"expires item update version"),he(e.item&&!e.update||!e.item&&e.update),e.item&&(he("object"==typeof e.item),he("string"==typeof e.item.src||"string"==typeof e.item.htmlText));e.update&&he("object"==typeof e.update);e.expires&&he("string"==typeof e.expires);e.version&&he("number"==typeof e.version)}(e.entity),e.entity&&e.entity.item&&e.entity.item.src&&(e.entity.item.src=Kl.resolve(e.entity.item.src)),a(i,e.entity)}),n,void 0,void 0,void 0,void 0,1e3)},pe.prototype.add_device_binding=function(e,t,i,n){var o={user:Yl.auth.user_id,token:t,provider:Qt};this.ajax("PUT",Kl.api+"/DeviceBindings/"+e,o,(function(e){a(i,e&&e.entity)}),n)},pe.prototype.remove_device_binding=function(e,t,i,n){var o={user:Yl.auth.user_id,token:t};this.ajax("DELETE",Kl.api+"/DeviceBindings/"+e,o,(function(e){a(i,e&&e.entity)}),n)},pe.prototype.send_device_notification=function(e,t,i,n,o,r,s,c){var l={text:t,title:i,chat:{id:n},provider:Qt};null!=o&&(l.sendertype=o),null!=r&&(l.channelinfo=r),this.ajax("POST",Kl.api+"/DeviceNotification/"+e,l,(function(e){a(s,e&&e.entity)}),c)},pe.prototype.get_chat_segment=function(e,t,i,n){var o=JSON.stringify({deep:2});this.ajax("GET",ce(Kl.api+"/Conversation/"+e+"/Segment/"+t,{data:o}),null,(function(e){!function(e){he("object"==typeof e&&void 0===e.length),ge(e,"action messages picture title"),he(void 0===e.title||"string"==typeof e.title),he("object"==typeof e.action),he("object"==typeof e.messages&&void 0!==e.messages.length),he(!e.picture||"string"==typeof e.picture),e.messages.forEach((function(e){ge(e,"allow channelinfo className data id mediatype picture position replace sender senderName style text type url ts"),he(void 0===e.allow||"object"==typeof e.allow&&void 0!==e.allow.length),he("chat"==e.type||"info"==e.type||"media"==e.type||"htmlwidget"==e.type||"updatehtmlwidget"==e.type||"location"==e.type||"whisper"==e.type),he(!e.position||"left"==e.position||"right"==e.position),he(!e.sender||"string"==typeof e.sender),he(!e.senderName||"string"==typeof e.senderName),he("text"==e.mediatype||"html"==e.mediatype||"url"==e.mediatype||"location"==e.mediatype||"markdown"==e.mediatype),he(!e.picture||"string"==typeof e.picture),he("chat"!=e.type||e.position||e.sender)}))}(e.entity),a(i,e.entity)}),n)},pe.prototype.close_chat_segment=function(e,t,i,n){this.ajax("POST",Kl.api+"/Conversation/"+e+"/Segment/Current",{action:"close",cause:t||"undefined"},i,n)},pe.prototype.post_chat_segment_feedback=function(e,t,i,n,a){this.ajax("POST",Kl.api+"/Conversation/"+e+"/Segment/"+t,{action:"feedback",value:i},n,a)},pe.prototype.schedule=function(e,t,i){this.ajax("POST",Kl.api+"/Schedule",e,t,i)},pe.prototype.postrequest=function(e,t,i,n){this.ajax("POST",Kl.api+e,t,i,n)},pe.prototype.postrequest.allowed_paths={"/Schedule":{page:["chat","profile"]},"/Conversation/{chat}/Segment/Current":{page:["chat"]},"/Conversation/{chat}/Assign":{page:["chat"]},"/Call/Connect":{page:["chat","profile","frontpage"]}},pe.prototype.resolve_action=function(e,t,i){var n={target:e,provider:Qt};this.ajax("GET",ce(Kl.api+"/ResolveAction",n),null,(function(e){a(t,e&&e.entity)}),i)},pe.prototype.ajax=function(e,i,n,o,r,s,c,l,d,u,p,f){if(!Kl.api||!i.startsWith(Kl.api))throw new Error("this.ajax() called for non-api, use just ajax()");if(s||c)throw new Error("this.ajax() called with custom response or request body type, use just ajax()");var h=this,g=function(g){!f||!g||(g+"").startsWith("No provider specific")||(g+"").startsWith("404")?a(r,g):(t("ajax - will retry request after "+(f=!0===f?2e3:Math.min(3e5,2*f))+" ms, because required is true"),Ye("Failed "+i+". Please check your connection. Will retry in "+Math.round(f/1e3)+"s","Warning"),setTimeout((function(){t("ajax - retrying previously failed request, because required is true"),h.ajax(e,i,n,o,r,s,c,l,d,u,p,f)}),f-1e3+Math.round(2e3*Math.random())))};this.auth&&this.auth.token&&(l||(l=[]),l.indexOf("Authorization")<0&&(l.push("Authorization"),l.push("Bearer "+this.auth.token)));var v=function(e,t,i){if(K){var n=Kl.api.replace(/api$/,"e"),a={method:e,path:t.substr(Kl.api.length),body:i},o=(""+Math.random()).substr(2,8);return{method:"POST",url:n,body:{e:E(J(S(X+"|"+V+"|"+o),W(JSON.stringify(a)))),n:o}}}return{method:e,url:t,body:i}}(e,i,n);return le(v.method,v.url,v.body,(function(e){var i=function(e){if(K){if(e.e&&e.n){var i=e.n,n=S(X+"|"+V+"|"+i),a=JSON.parse(B(J(n,A(e.e))));return{status:a.status,body:a.body}}if(Z)return t("warning: failed to parse encrypted response in strict mode "+JSON.stringify(e)),null}return e}(e);if(null!=i.status)if("success"==i.status)a(o,i.body);else{var n=i.body,r="";try{"string"==typeof i.body&&(n="error response",n=JSON.parse(i.body)),i.error&&t("ajax - response - error object is not used."),"object"==typeof n&&void 0!==n.reason?r=n.reason:i.reason&&(r=i.reason),"object"==typeof n&&(n=n.entity||null),n||(n=r),"object"==typeof n&&(n.toString=function(){return r})}catch(e){t("ajax - response - failed to parse response as JSON\n"+i.body)}g(n)}else a(o,i)}),(function(e){g(e)}),void 0,void 0,l,d)},pe.prototype.configure=function(e,i,n,o,r,s,c,l){le("GET",Kl.api+"/Config?fields=frontdoor,customcss,branding"+(n?"&clientkey="+encodeURIComponent(n):o?"&providerid="+o:"")+(c?"&target=customer":"")+(l?"&channelid="+l:""),null,(function(n){var o;o=n.entity.obfuscate,X=X,K=o.api,Y=o.message,Z=o.strict,r&&n.entity.feature&&r(n.entity.feature),s&&(n.entity.brandingconfig||n.entity.channel)&&s(n.entity.brandingconfig||n.entity.channel),void 0!==i?i(n.entity.version,e,!0):a(e,!0),t("configure: caching customcss and frontdoor values"),n.entity.customcss&&oe.set("customcss",n.entity.customcss),n.entity.frontdoor&&oe.set("frontdoor",n.entity.frontdoor),n.entity.brandingconfig&&oe.set("brandingconfig",n.entity.brandingconfig)}),(function(t){void 0!==i?i(null,e,t):a(e,t)}))},pe.prototype.getEncryptionConfig=function(e,i){this.ajax("GET",Kl.api+"/Customization/Config/"+i+"/encryption",null,(function(i){var n;i&&i.entity&&(n=i.entity,t("setting data encryption keys"),G=n.encryption_config.key,$=n.encryption_config.realm),a(e,!0)}),(function(t){a(e,t)}))},pe.prototype.get_idpconf=function(e,t,i){this.ajax("GET",Kl.api+"/Provider/ConfiguredIDP/"+e,null,(function(e){e&&e.entity&&a(t,e.entity)}),(function(e){a(i,e)}))},pe.prototype.get_oauth2path=function(e,t,i,n,o,r){this.ajax("GET",Kl.api+"/oauth2path?idprovider="+e+"&authprovider="+t+"&deviceid="+i+"&state="+n+"&dpcompanyid=&source=client",null,(function(e){a(o,e.entity)}),r)},pe.prototype.get_dialpad_selfservice_config=function(e,t,i){this.ajax("GET",Kl.api+"/Customization/Config/"+e+"/DialpadSelfService?configtype=all",null,(function(e){e&&e.entity&&a(t,e.entity)}),(function(e){a(i,e)}))};var Ee={},Ae={};pe.prototype.set_src=function(e,i,n,o){if("null"==i&&(t('Warning: profile picture or some other picture is "null" instead of null'),i=null),i)if("blob:"==i.substr(0,5)||"data:"==i.substr(0,5))e&&(e.src=i),a(n,i);else if(i.endsWith(":providers/0/images/profile.png")){let o=i.split(":")[0],r=function(e){let t=new RegExp(/(\p{L}{1})\p{L}*/,"gu"),i=[...e.matchAll(t)]||[];return i=((i.shift()?.[1]||"")+(i.pop()?.[1]||"")).toUpperCase(),i||"#"}(o);void 0!==Ee[r]&&Ee[r].expires<(new Date).getTime()&&delete Ee[r],null==Ee[r]&&(t("Creating a custome avatar for user: "+o),Ee[r]={expires:(new Date).getTime()+36e5,data:_(r)}),e&&(e.src=Ee[r].data),a(n,i)}else{if(i&&i.substr(0,8).indexOf(":")<0&&Kl.web&&(i=Kl.resolve(i)),void 0!==Ee[i]&&Ee[i].expires<(new Date).getTime()){if((r=Ee[i]).data)try{(window.URL||window.webkitURL).revokeObjectURL(r.data)}catch(e){t("failed to revokeObjectURL "+r.data)}delete Ee[i]}var r;if(void 0===Ee[i])if(void 0===Ae[i]){Ae[i]=[{image:e,success_callback:n,error_callback:o}];var s=function(e){if(void 0!==Ae[e]){var i=Ae[e];t("completed - "+e+" - "+i.length+" items"),delete Ae[e];for(var n=Ee[e].error||null,o=Ee[e].data||null,r=0;r<i.length;++r){var s=i[r];n?(s.image&&(s.image.src=e),a(s.error_callback,n)):o&&(s.image&&(s.image.src=o),a(s.success_callback,o))}}},c=le("GET",i,null,(function(e){var t=new Blob([e],{type:c.getResponseHeader("content-type")||"image/jpeg"}),n=(window.URL||window.webkitURL).createObjectURL(t);Ee[i]={expires:(new Date).getTime()+36e5,data:n},s(i)}),(function(e){Ee[i]={expires:(new Date).getTime()+6e5,error:e},s(i)}),"arraybuffer")}else t("pending - "+i),Ae[i].push({image:e,success_callback:n,error_callback:o});else t("cached - "+i),(r=Ee[i]).data?(e&&(e.src=r.data),a(n,r.data)):(e&&i&&(e.src=i),a(o,r.error))}else e&&(e.src="assets/cleardot.gif"),a(o,"missing image source");return null},pe.prototype.get_translation=function(e,t,i,n,o){var r={text:t};i&&(r.targetlang=i),this.ajax("GET",ce(Kl.api+"/Language/"+e+"/TranslateLanguage",r),null,(function(e){a(n,e.entity)}),o)},pe.prototype.get_channel_properties=function(e,t,i,n,o,r){var s={channelId:n};this.ajax("GET",ce(Kl.api+"/SocialChannel/Properties/"+e+"/"+t+"/"+i,s),null,(function(e){a(o,e.entity)}),r)};var Le={},Ne=[],Ce=[];function Se(e,i,n,a){if(void 0===i&&(i=[]),t("take-client-action "+JSON.stringify(e)+" allowed="+JSON.stringify(i)),e.path&&i.indexOf("path")>=0){let o=function(){Sd("#"+e.path,!n),e.next&&(["chat","chatwith"].indexOf(e.path.split("/")[0])>=0?(t("storing the next action for after chat is started "+JSON.stringify(e.next)),Ce.push([e.next,i])):setTimeout((function(){Ie(e.next,i,!0)}),0))};Et||"chatwith"!=e.path.substr(0,8)||a?o():Yl.get_chat_path_with(e.path.substr(9),(function(i){if(i.length&&"active"==i[0].state){o();var n={type:"notification",name:"",html:"You have a new conversation."};n.action={path:"chat/"+i[0].id},so({type:"notification",message:n,allow:["agent"]},i[0].path),xs("send",i[0].path,{type:"action"})}else t("take-client-action - no active session with this target: "+e.path+".  Ignore client-action")}),(function(i){t("take-client-action - unable to verify chatwith id "+e.path.substr(0,8)+"..ignoring client-action. Error: "+i)}))}else if(e.popup&&i.indexOf("popup")>=0){if("string"==typeof e.popup){var o=e.popup.split("|");window.open(o[0],"_blank",o.length>1?o[1]:"width=400,height=600")}else t("not implemented popup without url and options");Ie(e.next,i,!1)}else e.url&&i.indexOf("url")>=0?"tel:"==e.url.substr(0,4)?(h(m(e.url.substr(4))),Ie(e.next,i,!0)):"http:"==e.url.substr(0,5)||"https:"==e.url.substr(0,6)?(h(e.url),Ie(e.next,i,!0)):"providers/"==e.url.substr(0,10)?(h(Kl.resolve(e.url)),Ie(e.next,i,!0)):"mailto:"==e.url.substr(0,7)?(h(e.url),Ie(e.next,i,!0)):(t("do not know how to handle this action url "+e.url),h(e.url),Ie(e.next,i,!1)):e.invoke&&i.indexOf("invoke")>=0?Me(e,(function(t){Oe(!0,t,e.next),Ie(e.next,i,!0)}),(function(t){Oe(!1,{reason:t},e.next),Ie(e.next,i,!1)})):(t("missing or invalid action or allowed"),Ie(e.next,i,!1))}function Oe(e,i,n){if(void 0!==i&&n){var a=n.complete||e&&n.success||!e&&n.error||{},o={value:!1},r=function(e){if(e&&"string"==typeof e&&e.indexOf("{")>=0)(n=e.match(/{.*?}/g))&&n.length>0&&n.forEach((function(t){var n=t.substr(1,t.length-2);void 0!==i[n]&&(e=e.replace(new RegExp(t,"g"),""+i[n]),o.value=!0)}));else if(e&&"object"==typeof e)for(var t in e){var n,a=e[t];(n=a.match(/{.*?}/g))&&n.length>0&&n.forEach((function(e){var t=e.substr(1,e.length-2);void 0!==i[t]&&(a=a.replace(new RegExp(e,"g"),""+i[t]),o.value=!0)})),e[t]=a}return e};if(a.path&&(a.path=r(a.path)),a.url&&(a.url=r(a.url)),a.popup&&(a.popup=r(a.popup)),a.args&&a.args.length>0)for(var s=0;s<a.args.length;++s)a.args[s]=r(a.args[s]);o.value&&t("substitute-invoke-response "+JSON.stringify(a))}}function Ie(e,i,n){if(e){var a=e.complete||n&&e.success||e.error;a?Se(a,i):t("missing next attribute complete, success or error, result="+n)}}function Me(e,o,r){var s=e.invoke,c=s.split("/",1)[0],d=s.length>c.length+1?s.substr(c.length+1):"";if("chatclose"==c)"chats"==page||"chat"==page||"profile"==page?function(e){Et&&El(!1);"this"==e||Hn==e?Qo():e!=Hn&&en("")}((p=e.args||d.split("/"))[0]):(t("ignoring chatclose, allowed only on chat or profile page"),a(r,"chatclose allowed only on chat or profile page"));else if("chatupdate"==c)if("chat"==page){var p=e.args||d.split("/");Hn==p[0]?a(o):(t("ignoring chatupdate, not the right chat id"),a(r,"invalid chat-id"))}else t("ignoring chatupdate, allowed only on chat page"),a(r,"chatupdate allowed only on chat");else if("chathistory"==c){if("chat"==page)if((p=e.args)&&p.length>0&&("this"==p[0]||p[0]==Hn)){var f=p.length>1?p[1]:null;Er(),io(f,void 0,(function(){a(o)}),(function(){Rr(),a(o)}))}else t("ignoring chatupdate, not the right chat id"),a(r,"invalid chat-id");else t("ignoring chathistory, allowed only on chat page"),a(r,"chathistory allowed only on chat")}else if("onlogin"!=c||Et)if("schedule"!=c||Et)if("segmentclose"==c)t("WARN: action invoke="+c+" is deprecated, use invoke=postrequest"),"chat"==page?Yl.close_chat_segment(Hn,"action-close",o,r):(t("ignoring segmentclose, allowed only on chat page"),a(r,"segmentclose allowed only on chat page"));else if("showwidgetclose"==c)"chat"==page&&$s?(Ks=l("showwidgetclose",!0,Ks),a(o)):(t("ignoring showwidgetclose, allowed only on chat page when a full size widget is shown"),a(r,"showwidgetclose allowed only on chat page with widget open"));else if("displaycontrol"==c){(L=e.args&&e.args[0]||null)&&bi(L),a(o)}else if("clearscreen"==c)"chat"==page?(To("clear",!0),a(o)):(t("ignoring attach, allowed only on chat page"),a(r,"attach allowed only on chat page"));else if("attach"==c)"chat"==page?(i("div.page.chat div.input div.button.attach").click(),a(o)):(t("ignoring attach, allowed only on chat page"),a(r,"attach allowed only on chat page"));else if("download"==c){L=e.args&&e.args[0]||d;var h=e.args&&e.args[1]||void 0;ht(L,h,o,r)}else if("notify"==c){Ye((p=e.args||d.split("/",2)).length>0?p[0]:"",p.length>1?p[1]:"Notification"),a(o)}else if("parent"==c){p=e.args||d.split("/");if(Le["client-api-as-action"]&&p.length>0)for(var g=0;g<p.length;++g)x("string"==typeof p[g]?p[g]:JSON.stringify(p[g]),"*");else a(r,"not allowed or not embedded app or no value")}else if("screenshot"==c){p=e.args||[];u()?navigator.screenshot.URI((function(e,i){e?(t("failed to get screenshot: "+e),a(r,"failed to get screenshot")):(t("captured screenshot: "+i.URI.length),a(o,{url:i.URI}))}),p[0]||50):(t("ignoring screenshot, not allowed in web app"),a(r,"not allowed in web app"))}else if("wait"==c)try{var v=e.args?e.args[0]:parseFloat(d);isNaN(v)||v<0||v>60?a(r,"wait with invalid timeout"):setTimeout((function(){a(o)}),Math.ceil(1e3*v))}catch(e){a(r,"wait exception")}else if("transfer"!=c||Et)if("callwith"==c){if("chat"==page||"profile"==page||"frontpage"==page||"dialer"==page)(p=e.args||d.split("/"))&&0!=p.length||(p=qo()),Pe(p,o,r);else t("ignoring callwith, allowed only on chat, profile, frontpage or dialer page"),a(r,"callwith allowed only on chat, profile, frontpage or dialer page")}else if("callend"==c)Gc(),ol(),a(o);else if("subscribe"==c){L=e.args&&e.args[0]||d;Cn.isConnected()&&jn.indexOf(L)<0?(jn.push(L),t("chat-subscribe "+L),Cn.subscribe(L,{qos:2}),Et&&tn("",L),a(o)):(t("ignoring subscribe, either not connected or already subscribed"),Et&&setTimeout((function(){tn("",L)}),2e3),a(r,"not connected or already subscribed"))}else if("unsubscribe"==c){L=e.args&&e.args[0]||d;if(Cn.isConnected()&&jn.indexOf(L)>=0){var m=jn.indexOf(L);jn.splice(m,1),t("chat-unsubscribe "+L),Cn.unsubscribe(L),un(L,void 0),a(o)}else t("ignoring unsubscribe, either not connected or not subscribed"),a(r,"not connected or not subscribed")}else if("subscription"!=c||Et)if("senddigits"==c){(L=e.args&&e.args[0]||d)&&"active"==Hc&&"twilio"==Rc&&L.match(/^[0-9#\,\w\*]+$/)?$c(L.replace(/,/g,"w")):t("ignoring senddigits, only allows digits and in active twilio call")}else if("send"==c)if("chat"==page){if(!(L=e.args&&e.args[0])){var y=d.split("/",1)[0];L=y&&["chat","info","hidden","progress","placeholder","htmlwidget"].indexOf(y)>=0?{type:y,text:d.substr(y.length+1)}:{type:"info",text:d}}if(L.text&&L.substitute&&(L.text=je(L.text,L.substitute),delete L.substitute),["chat","info","progress"].indexOf(L.type)>=0&&(L.text||L.htmlText)||"hidden"==L.type&&(L.text||L.htmlText||L.data)||"htmlwidget"==L.type&&(L.htmlText||L.src)||"placeholder"==L.type||"media"==L.type&&L.url&&("image"==L.media||L.data)||Et&&!1!==Le["send-url-from-agent"]){so(L),a(o);var b={type:L.type,size:(L.htmlText||L.text||"").length};"htmlwidget"==b.type&&(delete b.size,b.src=L.src),ys("send by action",b)}else t("ignoring send, allow only with type of chat, info, hidden, htmlwidget, placeholder or progress with valid text, htmlText, src or data as applicable"),a(r,"send only with type of chat, info, hidden, htmlwidget, placeholder or progress")}else t("ignoring send, allowed only on chat page"),a(r,"send allowed only on chat page");else if("received"==c){if("chat"==page)(L=e.args&&e.args[0]||{type:"info",text:d}).text&&L.substitute&&(L.text=je(L.text,L.substitute),delete L.substitute),["chat","info","htmlwidget"].indexOf(L.type)>=0&&(L.text||L.htmlText)||"hidden"==L.type&&(L.text||L.htmlText||L.data)||"htmlwidget"==L.type&&(L.htmlText||L.src)||"placeholder"==L.type||"media"==L.type&&"image"==L.media&&L.url?(fo(L),a(o)):(t("ignoring received, allow only with type of chat, info, hidden, htmlwidget, placeholder or media with valid text, htmlText, src, url or data as applicable"),a(r,"received only with type chat, info, hidden, htmlwidget or placeholder"));else t("ignoring received, allowed only on chat page"),a(r,"received allowed only on chat page")}else if("widget"==c)if("chat"==page||"chatwith"==page){L=e.args&&e.args[0]||d;var w=e.args&&e.args.length>1?e.args[1]:"";L?(sc(w?{src:L,style:w}:{src:L}),a(o)):a(r,"no widget path in this action")}else t("ignoring widget, allowed only on chat page"),a(r,"widget allowed only on chat page");else if("inlinewidget"==c)if("chat"==page){L="",w="";e.args?(L=e.args[0],w=e.args[1]):(w=d.split("/",1)[0],L=d.length>w.length+1?d.substr(w.length+1):""),L?(dc({src:L,style:w},!1),To("last",!0),a(o)):a(r,"no inlinewidget path in this action")}else t("ignoring inlinewidget, allowed only on chat page"),a(r,"inlinewidget allowed only on chat page");else if("htmlwidget"==c)if("chat"==page){L="",A=null;if(e.args)L=e.args[0],A=e.args[1],replace=e.args[2];else{if(parts=d.split("/"),A=parts[0],replace=parts[1],L=d.length>A.length+replace.length+2?d.substr(A.length+replace.length+2):"",A)try{A=JSON.parse(A)}catch(e){}if(replace)try{replace=JSON.parse(replace)}catch(e){}}hc({src:L,data:A,replace:replace},!1,!1,void 0,rd),a(o)}else t("ignoring htmlwidget, allowed only on chat page"),a(r,"htmlwidget allowed only on chat page");else if("postcontext"!=c||Et)if("postrequest"!=c||Et)if("savescreen"==c)try{!function(){t("savescreen()");var e="<html><head>\n"+[].slice.call(document.querySelectorAll("link[rel='stylesheet'], style")).map((function(e,t){var i="";if("LINK"==e.nodeName&&(i=e.getAttribute("href"))){var n=i.lastIndexOf("/");n>=0&&(i=i.substr(0,n+1))}var a,o=document.styleSheets[t];try{var r=o.rules||o.cssRules;a=[].slice.call(r).map((function(e){return(e.cssText||"").replace(/url\("?(.*?)"?\)/g,(function(e,t,n,a){var o=t;return o.startsWith("/")||o.startsWith("http")||(o=i+o),'url("'+o+'")'}))})).join("\n")}catch(e){if(document.styleSheets.length<t)return console.log("Exception in reading "+document.styleSheets[t].href),'<link href="'+document.styleSheets[t].href+'" rel="stylesheet">';console.log("Exception in save_screen exceeded index")}return'<style type="text/css">\n'+a+"\n</style>"})).join("\n")+"\n</head>\n"+document.body.outerHTML+"</html>",n="chat"==page?i("div.page.chat div.history").scrollTop:0;try{localStorage["koopid.save-screen"]=e,localStorage["koopid.save-screen-scroll"]=""+n,localStorage["koopid.save-screen-dataurl"]=JSON.stringify(La)}catch(e){console.error(e)}}(),a(o)}catch(e){a(r,"savescreen failed with exception")}else if("preclose"==c)if("chats"==page||"chat"==page){let i=e.args&&e.args[0]||d;t("preclose: marking "+i+" as disconnecting"),un(void 0,i),a(o)}else t("Ignoring preclose request, allowed only on chat or chats page"),a(r,"preclose allowed only on chat/chats page");else t("ignoring unknown invoke "+c),a(r,"ignoring unknown invoke");else try{var _=function(e,t){var i=Yl.postrequest.allowed_paths[e];if(void 0===i)throw new Error("403 forbidden path");if(i.page&&i.page.indexOf(page)<0)throw new Error("403 not allowed on this screen");if(e=e.replace(/{chat}/g,Hn).replace(/{user}/g,Yl.auth.user_id),t=JSON.parse(JSON.stringify(t||{}).replace(/"{chat}"/g,Hn).replace(/"{user}"/g,Yl.auth.user_id)),!e||!e.match(/^\/[\/a-zA-Z0-9\-\_\.]+$/))throw new Error("404 invalid path");return{path:e,entity:t}}(e.args[0],e.args[1]);Yl.postrequest(_.path,_.entity,o,r)}catch(e){t("ignoring postrequest, due to exception "+e),a(r,"postrequest is not allowed or failed")}else{if("chat"==page)if("location"==(L=e.args&&e.args[0]||d)&&Ln){var k=Ln.id,T=Kl.location;Et||!0!==Le["use-customer-ip-location"]||(T=Kl.iplocation);var E={type:"location",context:[T]};Yl.post_customer_provider_context("this",k,E,o,r)}else t("ignoring postcontext, invalid context type: "+L),a(r,"invalid context type: "+L);else t("ignoring postcontext, allowed only on chat page"),a(r,"postcontext allowed only on chat page")}else{if(3==(p=e.args||d.split("/")).length){var A={type:p[0],id:p[1],value:p[2]};Yl.post_customer_subscription(A,(function(){a(o)}),r)}else t("ignoring subscription, must have exactly three arguments."),a(r,"invalid arguments")}else{if("chat"==page)!function(e,i,o,r){t("chat-transfer "+e+", "+i),e&&"this"!=e||(e=Hn);var s={type:"notification",name:"Transfer",html:Kl.myprofile.name+" is transfered from "+(Dn.length>0?n(Dn.join(", ")):"Anonymous")};Yl.do_chat_transfer(e,i,(function(e){!Et&&e.id&&e.path&&(Sd("#chat/"+e.id,!1),s.action={path:"chat/"+e.id},so({type:"notification",message:s,allow:["agent"]},e.path),xs("send",e.path,{type:"action"})),a(o,e)}),r)}((p=e.args||d.split("/"))[0],p[1],o,r);else t("ignoring transfer, allowed only on chat page"),a(r,"transfer allowed only on chat page")}else if(t("WARN: action invoke="+c+" is deprecated, use invoke=postrequest"),"chat"==page||"profile"==page){var L=e.args&&e.args[0]||{};Yl.schedule(L,o,r)}else t("ignoring schedule, allowed only on chat or profile page"),a(r,"schedule allowed only on chat or profile page");else if(e.args&&e.args.length>=1){var L=e.args&&e.args[0]||{},N=e.args&&e.args.length>1&&e.args[1]||{};Ne.length>0&&Ne.splice(0,Ne.length),!L.path&&!L.url||L.next?(t("ignoring onlogin, only path or url actions are allowed with no next"),a(r,"ignoring onlogin, only path or url actions allowed with no next")):(Ne.push(L),N.email&&(i("div.page.login input.email").value=N.email),N.password&&(i("div.page.login input.password").value=N.password),N.auto&&setTimeout((function(){Ft()}),1e3))}else t("ignoring onlogin, missing argument"),a(r,"ignoring onlogin, missing argument")}function je(e,t){for(var i=0;t.length&&i<t.length;++i){var n=t[i],a="";n&&"data-"==n.substr(0,5)?a=kd(n,""):"chat"==n?a=Hn:"user"==n?a=Yl.auth.user_id:"name"==n?a=Kl.myprofile.name:"phone"==n?a=Kl.myprofile.phone:"email"==n&&(a=Kl.myprofile.email),e=e.replace(new RegExp("{"+n+"}","g"),""+a)}return e}function Pe(e,n,o){var r={};if(e&&e.length>0&&["persistent"].indexOf(e[e.length-1])>=0&&(r.persistent="persistent"==e.pop()),e&&e.length>0&&["transcribe","no-transcribe"].indexOf(e[e.length-1])>=0&&(r.transcribe="transcribe"==e.pop()),e&&e.length>0&&["record","no-record"].indexOf(e[e.length-1])>=0&&(r.record="record"==e.pop()),e&&e.length>0&&["video"].indexOf(e[e.length-1])>=0&&(e.length>=2&&"webrtccall"==e[0]?r.video="video"==e.pop():e.pop()),e.length>=2&&"webrtccall"==e[0]){if(e[1].match(/^\d+$/))e[1]="user:"+e[1];else if("this"==e[1])if("chat"==page){if(!((s=na.filter((function(e){return e!=Sn})))&&s.length>0))return void a(o,"failed to find other participant");e[1]="user:"+s[0]}else{if("profile"!=page)return void a(o,"invoked on wrong screen "+page);e[1]="user:"+qs}e.length>2&&(r.subject=e[2]),"chat"==page&&(r.chat=Hn),e[1]&&"user:"==e[1].substr(0,5)?nl(e[1].substr(5),r,n,o):a(o,"failed to invite "+e[1]+", only user: is allowed")}else if(e.length>=2&&"twiliocall"==e[0]){if("this"==e[1])if("chat"==page){var s;if(!((s=na.filter((function(e){return e!=Sn})))&&s.length>0))return void a(o,"failed to find other participant");e[1]=(Rn[s[0]]||{}).phone}else{if("profile"!=page)return void a(o,"invoked on wrong screen "+page);e[1]=(zs||{}).phone}e[1]=He(e[1]);var c={callsid:null};!function(e,n,o,r,s){if("idle"!=Hc&&"ready"!=Hc)Ye("previous call is not yet cleaned up","error"),a(r,"Previous call is not yet cleaned up");else if("https:"==window.location.protocol||"http:"==window.location.protocol&&("localhost"==window.location.hostname||"127.0.0.1"==window.location.hostname)||("gopher:"==window.location.protocol||"file:"==window.location.protocol)&&u()){if(Rc=l("calltype","twilio",Rc),e.indexOf(",")<0)Dc=e,Fc=null;else{var c=e.indexOf(",");Dc=e.substr(0,c),Fc=e.substr(c),t("separated target="+Dc+" and digits="+Fc)}Jc=n,Uc=o,zc=r,qc=s;var d=i("#twilio-min-js");d?Wc():((d=document.createElement("script")).id="twilio-min-js",d.setAttribute("type","text/javascript"),d.setAttribute("src",u()?"js/tcPlugin.js":"assets/twilio.min.js"),document.head.appendChild(d),setTimeout(Wc,2e3))}else t("WebRTC call not supported on window.location.protocol="+window.location.protocol+", use https:"),Ye("In app call is supported only on secure web app","error"),a(r,"In app call is supported only on secure web app")}(e[1],r,(function(e){c.callsid=e||null,c.callsid?Yl.post_call_state(c.callsid,"active"):(t("failed to get the call sid"),Ye("Failed to get call id, call may still go through","Warning")),a(n)}),o,(function(){c.callsid&&Yl.post_call_state(c.callsid,"ended",r.transcribe)}))}else{if(e.length>=1&&"this"==e[0]&&(e[0]="user:"+Sn),e.length>=2&&"this"==e[1])if("chat"==page)e[1]="chat:"+Hn;else{if("profile"!=page)return void a(o,"invoked on wrong screen "+page);e[1]="user:"+qs}e=e.map((function(e){return He(e)})),Yl.call_connect(e,r,n,(function(e){Ye("Failed to call: "+e,"Error"),a(o,"failed to call: "+e)}))}}function He(e){return e.match(/^\d+$/)?"tel:+"+e:e&&"+"==e.charAt(0)?"tel:"+e:e}function Re(e){var i=e.currentTarget;if(i.hasAttribute("action")){var n=function(e,i){var n={};if(e&&"{"==e.substr(0,1))try{n=JSON.parse(e)}catch(i){t("error parsing action attribute as JSON: "+e)}else if("send"==e)i?i.innerText?n.invoke="send/chat/"+i.innerText.trim():i.value&&"string"==typeof i.value?n.invoke="send/chat/"+i.value.trim():i.textContent&&(n.invoke="send/chat/"+i.textContent.trim()):t("invalid link in parse-chat-link-action for value of send");else{var a=e.split("="),o=a.shift(),r=a.join("=");n[o]=r}return n}(i.getAttribute("action"),i),a=i.getAttribute("group");if(a){for(var o=i;!(o instanceof HTMLDivElement)&&"history"!=o.parentNode.className;)o=o.parentNode;De(o,a)}hs("chat action",{action:n}),Se(n,["path","invoke","popup","url"],void 0,!0)}else t("missing action attribute in the link")}function De(e,t){if(e instanceof HTMLAnchorElement)e.hasAttribute("action")&&e.getAttribute("group")==t&&e.removeAttribute("action");else for(var i=e.children,n=0;n<i.length;++n)1==i[n].nodeType&&De(i[n],t)}var Fe=!1,Ue="default",ze=!1,qe=[],Je={},We={},Be={},Ge=[],$e=null,Ve=null;function Ke(){if(ze=l("hassound","true"==kd("alertsound",ze)),i("div.notification > div.close").addEventListener("click",(function(e){hs("internal notify close button",{id:e.currentTarget.parentNode.getAttribute("notify-id")}),function(e){Ze(e),et(e),at(e)}(e.currentTarget.parentNode.getAttribute("notify-id"))})),i("div.notification").addEventListener("click",(function(e){e.target!=i("div.notification > div.close")&&(hs("internal notify",{id:e.currentTarget.getAttribute("notify-id")}),function(e){t("clicked"),Ze(e),et(e),nt(e)}(e.currentTarget.getAttribute("notify-id")))})),u()&&(cordova.plugins.notification.local.on("click",(function(e,t){hs("external notify",{id:e.id}),it(e.id)})),cordova.plugins.notification.local.on("clear",(function(e,t){tt(e.id,!0)}))),"http:"==window.location.protocol||"https:"==window.location.protocol){var e=function(){try{if(document.removeEventListener("click",e),!window.Notification||!Notification.requestPermission)return;Notification.requestPermission((function(e){"denied"!=e&&"default"!=e||t("failed to get notification permissions.")}))}catch(e){t(e)}};document.addEventListener("click",e),window.addEventListener("blur",(function(e){Gl=l("windowforeground",!1,Gl)})),window.addEventListener("focus",(function(e){Gl=l("windowforeground",!0,Gl),function(){var e=[];for(var t in Be)e.push(t),Be[t].onclick=null,Be[t].onclose=null;for(var i=0;i<e.length;++i)Ze(e[i])}()}))}}function Ye(e,t,i,n){t&&(t=(t=""+t).substr(0,1).toUpperCase()+t.substr(1)),e&&(e=(e=""+e).substr(0,1).toUpperCase()+e.substr(1)),n&&(Ue=l("notifyposition",n,Ue));var a=Xe(!0,!1,t,e,"default");return setTimeout((function(){et(a),n&&(Ue=l("notifyposition","default",Ue))}),i||5e3),a}function Xe(e,i,n,a,o,r,s,c,l){var d=null;return s&&void 0!==We[s]?d=We[s]:(d=(""+Math.random()).substr(2,10),s&&(We[s]=d)),c&&(Je[d]={target:s,state:c}),i&&function(e,i,n){if(u())Bl||cordova.plugins.notification.local.schedule({id:e,icon:"assets/logo-48.png",title:i,text:n});else if(("http:"==window.location.protocol||"https:"==window.location.protocol)&&(console.log("document.hasFocus(): "+document.hasFocus()),!document.hasFocus()))try{if(void 0!==Be[e]){var a=Be[e];delete Be[e];try{a.onclick=null,a.onclose=null,a.close()}catch(e){}}if(Le["send-notification-to-parent"]&&Et&&f())x({type:"notification",notification:{name:i,icon:Pd(),message:n,id:e}},"*");else if(window.Notification&&"granted"==Notification.permission){let t=!1;Et&&(t=!!Le["notification-require-interaction"]);var o=new Notification(i,{body:n,icon:Pd(),data:e,requireInteraction:t});Be[e]=o,o.onclick=function(t){it(e)},o.onclose=function(t){tt(e)}}}catch(e){t(e)}}(d,n,a),e&&function(e,t,i){Ge.push({id:e,title:t,body:i}),Qe()}(d,n,a),l&&setTimeout((function(){t("hideafter "+d),et(d)}),"number"==typeof l?l:6e4),!r||!ze||Gl&&Bl||function(e,t){var i=document.createElement("audio");i.loop=!!t,i.src=e;try{var n=i.play();void 0!==n&&n.catch((function(e){}))}catch(e){}}(newmessage_src),d}function Ze(e){if(u()&&cordova.plugins.notification.local.cancel(e,(function(){})),void 0!==Be[e]){var t=Be[e];delete Be[e];try{t.close()}catch(e){}}}function Qe(){if(Ge.length>=1){var e=Ge[Ge.length-1];i("div.notification").setAttribute("notify-id",e.id),i("div.notification span.title").innerHTML=n(e.title),i("div.notification span.body").innerHTML=n(e.body).replace(/\n/g,"<br/>"),Fe=l("hasnotification",!0,Fe)}}function et(e){Fe&&i("div.notification").getAttribute("notify-id")==e&&(i("div.notification").setAttribute("notify-id",""),Fe=l("hasnotification",!1,Fe));for(var t=Ge.length-1;t>=0;--t){Ge[t].id==e&&Ge.splice(t,1)}Ge.length>=1&&setTimeout((function(){Ge.length>=1&&Qe()}),300)}function tt(e,t){t&&(et(e),at(e))}function it(e){!function(){try{window.focus()}catch(e){}}(),Ze(e),et(e),nt(e)}function nt(e){t("notify "+e+" clicked");var i=Je[e];i&&(delete Je[e],i.state&&(i.state.action?Se(i.state.action,["invoke","path","url","popup"],!0):i.state.notification?(Se(i.state.notification.action,["invoke","path","url","popup"],!0),setTimeout((function(){}),1e3)):i.state.webrtccall&&function(e){"invited"==Hc&&"webrtc"==Rc?"incoming"==e.type?e.callid==Xc&&e.senderId==Yc?(Hc=l("callstate","active",Hc),Zc=(new Date).getTime(),fl(),pl(Yc,{type:"answer",callid:Xc}),function(){il&&il.video&&(Vc=l("hasvideo",!0,Vc));sl(!1),rl((function(){dl()}),(function(e){"invalid call"!=e&&(Ye("Failed to get user media, terminating","Error"),ol())}))}()):t("webrtccall: failed to answer as not the same call"):t("webrtccall: ignoring click in invited, not incoming"):"idle"==Hc?"missed"==e.type?nl(e.senderId,e.params):t("webrtccall: ignoring click in idle, not missed"):t("webrtccall: ignoring click in "+Hc)}(i.state.webrtccall)),i.target&&delete Be[i.target])}function at(e){t("notify "+e+" closed");var i=Je[e];delete Je[e],i&&i.state&&i.state.webrtccall&&function(e){"invited"==Hc&&"webrtc"==Rc?"incoming"==e.type?e.callid==Xc&&e.senderId==Yc?(Hc=l("callstate","idle",Hc),Rc=l("calltype","",Rc),Vc=l("hasvideo",!1,Vc),fl("declined",!0),pl(Yc,{type:"decline",callid:Xc,reason:"declined"}),Yc=null,Xc=null):t("webrtccall: failed to decline as not the same call"):t("webrtccall: ignoring close in invited, not incoming"):t("webrtccall: ignoring close in "+Hc)}(i.state.webrtccall),i&&i.target&&delete Be[i.target]}function ot(e){var t=$e;$e=e,Tt&&Ve&&t!=e&&(t&&Yl.remove_device_binding(Ve,t),e&&Yl.add_device_binding(Ve,e))}function rt(e){t("take_notification_action "+JSON.stringify(e)),e.chat&&"string"==typeof e.chat&&(e.chat=JSON.parse(e.chat)),e.action&&"string"==typeof e.action&&(e.action=JSON.parse(e.action));var i=e.action;if(!i&&e.chat&&e.chat.id&&(i={path:"chat/"+e.chat.id}),i)if(e.tap)Se(i,["path","url","popup","invoke"],!0);else{var n={action:i};Xe(!0,!1,e.title||e.aps&&e.aps.alert.title||"",e.body||e.aps&&e.aps.alert.body||"",0,!0,i.path,n)}}var st=!1,ct=null,lt=null,dt={},ut=null;function pt(e,n){var o=e.capture,r=e.accept,s=e.allowupload;t("select-files() called with "+JSON.stringify(e)),u()?(dt=e,lt=n,i("div.selectfiles > div.button.left").onclick=function(){!function(){if(st)if(ut&&dt)xt(yt,dt.accept,ut);else{st=l("selectfiles",!1,st);var e=lt;lt=null,ct=null,dt=null,ut=null,a(e)}}()},o&&!1!==s?navigator.notification.confirm("Do you want to capture media from device or upload an existing media file?",(function(t){2==t?bt(yt,r,o):1==t?bt(yt,r,"photos"):3==t?(dt=e||{},lt=n,st=l("selectfiles",!0,st),wt(yt,r)):(dt=null,lt=null,a(n))}),"Select",["Photos","Camera","Files","Cancel"]):o?bt(yt,r,o):!1!==s?(dt=e||{},lt=n,st=l("selectfiles",!0,st),wt(yt,r)):(t("select-files() no capture and no allowupload, ignoring"),a(yt))):(s&&p("ios")&&!u()&&(o=null),function(e,i,n){var o=document.createElement("input");o.setAttribute("type","file"),i&&o.setAttribute("accept",i);n&&o.setAttribute("capture",n);o.onchange=function(i){o.onchange=o.onerror=null;var n=i.currentTarget.files;n&&n.length>0?a(e,n):t("select-files() none selected")},o.onerror=function(i){t("select-files() error"),o.onchange=o.onerror=null,a(e)},document.body.onblur=function(){document.body.onfocus=function(){document.body.onblur=null,document.body.onfocus=null,setTimeout((function(){o.onchange&&(!o.files||o.files.length<=0)&&(t("select-files() no file selected on regain focus"),t(o.files),o.onchange=o.onerror=null,a(e))}),2e3)}},o.click()}((function(i){if(i&&0!=i.length)if(e.returnfiles)t("select-files() returning files"),t(i),a(n,i);else{for(var o=[],r=0;r<i.length;++r){var s=i[r];o.push({name:s.name,size:s.size,type:s.type,url:mt(s)})}t("select-files() returning metadata "+JSON.stringify(o)),a(n,o)}else t("select-files() no files"),a(n)}),r,o))}function ft(e,i,n,o){if(u()){i||(i=(""+Math.random()).substr(2,10)+".bin"),t("saveFile filename="+(i=i.replace(/[^a-zA-Z0-9\.\-\_]/g,"")));var r=function(e){t("saveFile failed"),t(e),Ye("Failed to save file","Error"),a(o,"Failed to save file")};window.requestFileSystem(LocalFileSystem.PERSISTENT,0,(function(o){o.root.getDirectory("Koopid",{create:!0,exclusive:!1},(function(o){o.getFile(i,{create:!0},(function(i){i.createWriter((function(o){o.onwriteend=function(e){t("saveFile done "+e.error+" "+e.target.length),Ye("Saved to "+i.fullPath,"Downloaded"),a(n)},o.onerror=function(e){t("writer error"),r(e)},o.write(e)}),r)}),r)}),r)}),r)}else{var s=mt(e),c=document.createElement("a");c.href=s,i&&(c.download=i),c.setAttribute("target","_blank"),c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c),a(n),setTimeout((function(){t("saveFile revoking after 1min "+s),(window.URL||window.webkitURL).revokeObjectURL(s)}),6e4)}}function ht(e,t,i,n){if(e)if("data:"!=e.substr(0,5)&&"http:"!=e.substr(0,5)&&"https:"!=e.substr(0,6)&&(e=Kl.resolve(e)),"data:"!=e.substr(0,5))gt(e,void 0,(function(o){o?ht(o,t,i,n):(Ye("failed to download from "+(e&&e.substr(0,1024)),"Error"),a(n,"Failed to download"))}));else{if(!t){var o=e.indexOf(",");if(o>=0){var r=e.substring(5,o).split(";")[0];["image","audio","video"].indexOf(r.split("/")[0])>=0?t="download."+r.split("/")[1]:"text/plain"==r?t="download.txt":"text/html"==r&&(t="download.html")}}ft(vt(e),t,i,n)}else a(n,"No URL supplied")}function gt(e,i,n){var o=new XMLHttpRequest;o.withCredentials=!0,o.open("GET",e+"?r="+(""+Math.random()).substr(2,10),!0),o.responseType="arraybuffer",o.onload=function(){if(200==o.status){var e=o.response;if(e){if(!i){var r=o.getResponseHeader("content-type");t("using type="+(i=r?r.split(";")[0].trim().toLowerCase():"application/octet-stream"))}var s=new Blob([e],{type:i}),c=mt(s),l=new FileReader;l.onload=function(e){a(n,e.target.result,c)},l.readAsDataURL(s)}else t("downloadFile failed to receive arraybuffer"),a(n,null,null)}},o.onerror=function(i){t("downloadFile failed to download "+e),t(i),a(n,null,null)},t("downloadFile url="+e+" type="+i),o.send(null)}function vt(e){var t=";base64,";if(-1==e.indexOf(t)){var i=(a=e.split(","))[0].split(":")[1],n=decodeURIComponent(a[1]);return new Blob([n],{type:i})}i=(a=e.split(t))[0].split(":")[1];for(var a,o=(n=window.atob(a[1])).length,r=new Uint8Array(o),s=0;s<o;++s)r[s]=n.charCodeAt(s);return new Blob([r],{type:i})}function mt(e){return(window.URL||window.webkitURL).createObjectURL(e)}function yt(e){if(lt){st&&(st=l("selectfiles",!1,st));var i=lt,n=dt.returnfiles;if(ct=null,dt=null,ut=null,e&&0!=e.length)if(n)for(var o=[],r=e.length,s=function(e,n){--r,e&&o.push(n),r<=0&&(t("select-files() returning files"),t(o),a(i,o))},c=0;c<e.length;++c){var d=e[c];d.url&&"data:"==d.url.substr(0,5)?s(!0,d):window.resolveLocalFileSystemURL(d.url,(function(e){e.file((function(e){!e.type&&d.type&&(e.type=d.type),s(!0,e)}),(function(e){t(e),s(!1)}))}),(function(e){t(e),s(!1)}))}else t("select-files() returning metadata "+JSON.stringify(e)),a(i,e);else t("select-files() no files"),a(i)}}function bt(e,i,n){"camera"!=n&&"photos"!=n?({camera:navigator.device.capture.captureImage,camcorder:navigator.device.capture.captureVideo,microphone:navigator.device.capture.captureAudio}[n]||navigator.device.capture.captureImage)((function(i){if(i&&i.length>0){for(var n=[],o=0;o<i.length;++o){var r=i[o];n.push({name:r.name,size:r.size,type:r.type,url:r.localURL})}if(n.length>0){var s=n.length;n.forEach((function(t){resolveLocalFileSystemURL(t.url,(function(i){t.url=i.toURL(),0==--s&&a(e,n)}))}))}else a(e,n)}else t("select-files() non selected"),a(e)}),(function(i){t("select-files() failed to captureImage: "+i.code),a(e)})):function(e,i,n){if("photos"==n&&p("android")){var o={destinationType:0,sourceType:0};navigator.camera.getPicture((function(t){var i={name:"photo",type:"image/jpeg",size:Math.floor(3*t.length/4),url:"data:image/jpeg;base64,"+t};a(e,[i])}),(function(i){t("select-files() failed to capture file "+i),a(e,[])}),o)}else o={destinationType:1,sourceType:"camera"==n?1:0},navigator.camera.getPicture((function(i){resolveLocalFileSystemURL(i,(function(t){var i={name:(t.name||"").replace(/:/g,"_"),size:t.size,type:"image/jpeg",url:t.toURL()};a(e,[i])}),(function(n){t("select-files() failed to resolve file "+i),a(e,[])}))}),(function(i){t("select-files() failed to capture file "+i),a(e,[])}),o)}(e,0,n)}function wt(e,t){st||(st=l("selectfiles",!0,st)),xt((function(t){i("div.selectfiles > div.folders").innerHTML="",i("div.selectfiles > div.files").innerHTML="",a(e,t)}),t)}function xt(e,i,n){n?window.resolveLocalFileSystemURL(n,(function(t){_t(e,i,{root:t})}),(function(i){t("select-files() error in resolveLocalFileSystemURL("+n+") "+JSON.stringify(i)),a(e)})):window.requestFileSystem(LocalFileSystem.PERSISTENT,0,(function(t){_t(e,i,t)}),(function(i){t("select-files() error in requestFileSystem "+JSON.stringify(i)),a(e)}))}function _t(e,o,r){i("div.selectfiles > div.path").innerHTML=n(r.root.fullPath),ct=r,r.root.createReader().readEntries((function(r){!function(e,o,r){i("div.selectfiles > div.folders").innerHTML="",i("div.selectfiles > div.files").innerHTML="",""!=ct.root.name&&"/"!=ct.root.fullPath?window.resolveLocalFileSystemURL(ct.root.nativeURL,(function(e){e.getParent((function(e){ut=e.nativeURL}),(function(e){console.log("select-files() getParent error "+JSON.stringify(e)),ut=null}))}),(function(e){console.log("select-files() resolveLocalFileSystemURL error "+JSON.stringify(e)),ut=null})):ut=null;r.sort((function(e,t){return e.name.toLowerCase()<t.name.toLowerCase()?-1:1}));for(var s=0;s<r.length;++s){var c=r[s];if(c.name&&"."!=c.name.charAt(0)){var l=document.createElement("div");if(l.setAttribute("data-path",c.nativeURL),l.data=c,c.isDirectory&&(l.innerHTML=n(c.name),l.addEventListener("click",(function(t){xt(e,o,t.currentTarget.getAttribute("data-path"))})),i("div.selectfiles > div.folders").appendChild(l)),c.isFile){var d="",u=c.name.lastIndexOf(".");if(u>=0){var p=c.name.substr(u+1).toLowerCase(),f=["jpg","jpeg","png","gif","tif"];d=p&&p.length<5&&f.indexOf(p)>=0?'<img src="'+c.nativeURL+'" />':p}l.innerHTML="<div>"+d+"</div><div>"+n(c.name)+"</div>",l.addEventListener("click",(function(i){resolveLocalFileSystemURL(i.currentTarget.data.nativeURL,(function(i){t("select-files() selected"),t(i);var n={name:i.name,type:i.type,size:i.size,url:i.nativeURL};a(e,[n])}),(function(n){t("select-files() error in resolveLocalFileSystemURL "+i.currentTarget.data.nativeURL+" "+JSON.stringify(n)),a(e)}))})),i("div.selectfiles > div.files").appendChild(l)}}}}(e,o,r)}),(function(i){t("select-files() error in readEntries "+JSON.stringify(i)),a(e)}))}var kt,Tt=!1,Et=!1,At="available",Lt=!1,Nt=!0,Ct=[],St=!1,Ot=!1,It="",Mt="",jt=null,Pt=!1,Ht=0;function Rt(){if(i("div.page.reset-password input.button.change-password").addEventListener("click",(function(e){hs("reset-password change-password button"),function(){if(!i("div.page.reset-password input.text.password").value||i("div.page.reset-password input.text.password").value!=i("div.page.reset-password input.text.password-again").value)return void Ye("missing password or retyped password does not match","Error");if(!i("div.page.reset-password input.text.authcode").value)return void Ye("missing auth code (OTP)","Error");Cd(!0);var e=i("div.page.reset-password input.text.email").value,t=i("div.page.reset-password input.text.password").value,n=i("div.page.reset-password input.text.nonce").value||void 0,a=i("div.page.reset-password input.text.authcode").value||void 0;Yl.reset_password(e,n,a,t,(function(e){Cd(!1),i("div.page.login input.text.email").value=i("div.page.reset-password input.text.email").value,i("div.page.login input.text.password").value=i("div.page.reset-password input.text.password").value,i("div.page.reset-password input.text.nonce").value="",i("div.page.reset-password input.text.authcode").value="",i("div.page.reset-password input.text.password").value="",Sd("#login")}),(function(e){Cd(!1),Ye(e,"Error")}))}()})),i("div.page.reset-password span.link.back").addEventListener("click",(function(e){Ht=0,hs("reset-password back button"),Sd("#forgot-password")})),i("div.page.forgot-password input.button.send-email").addEventListener("click",(function(e){hs("forgot-password send-email button"),Cd(!0),Yl.forgot_password(i("div.page.forgot-password input.text.email").value,(function(e){Cd(!1),Ye(e.message||"please check your email for reset instruction","Info"),e&&e.nonce&&(i("div.page.reset-password input.text.email").value=i("div.page.forgot-password input.text.email").value,i("div.page.reset-password input.text.nonce").value=e.nonce,e.token&&(i("div.page.reset-password input.text.authcode").value=e.token),Sd("#reset-password"))}),(function(e){Cd(!1),Ye(e,"Error")}))})),i("div.page.forgot-password span.link.login").addEventListener("click",(function(e){hs("forgot-password login button"),Sd("#login")})),i("div.page.login input.button.login").addEventListener("click",(function(e){Ht=0,hs("login button"),Ft()})),i("div.page.login input.text.password").addEventListener("keyup",(function(e){Ht=0,13==(e.which||e.keyCode)&&(hs("login button via enter"),Ft())})),i("div.page.login span.link.forgot-password").addEventListener("click",(function(e){Ht=0,hs("login forgot-password button"),Sd("#forgot-password")})),i("div.page.login span.link.signup").addEventListener("click",(function(e){hs("login signup button"),Sd("#signup")})),i("div.page.login-token span.link.back").addEventListener("click",(function(e){hs("login-token back button"),jt=null,Ht=0,Sd("#login")})),i("div.page.login-token input.button.submit").addEventListener("click",(function(e){hs("login-token submit button"),Ht=0,function(){Cd(!0);var e=i("div.page.login-token input.text.authcode").value;i("div.page.login-token input.text.authcode").value="";var t=jt;t.mfa=e,jt=null,Ft(t)}()})),i("div.page.signup input.button.next").addEventListener("click",(function(e){hs("signup next button"),Cd(!0),Yl.signup_email(i("div.page.signup input.text.email").value,i("div.page.signup input.text.phone").value,(function(e){Cd(!1),e&&e.token&&(e.message&&Ye(e.message,"Info"),i("div.page.signup-token input.text.authcode").value=e.token),Sd("#signup-token")}),(function(e){Cd(!1),Ye(e,"Error")}))})),i("div.page.signup span.link.back").addEventListener("click",(function(e){hs("signup back button"),Sd("#login")})),i("div.page.signup-token input.button.next-user").addEventListener("click",(function(e){hs("signup-token next-user button"),zt()})),i("div.page.signup-token input.button.next-business").addEventListener("click",(function(e){hs("signup-token next-business button"),zt(!0)})),i("div.page.signup-token span.link.back").addEventListener("click",(function(e){hs("signup-token back button"),Sd("#signup")})),i("div.page.user-profile img.picture").addEventListener("click",(function(e){Nt&&(hs("user-profile picture"),qt("profile"))})),i("div.page.user-profile input.button.next").addEventListener("click",(function(e){hs("user-profile next button"),function(){if(!i("div.page.user-profile input.text.name").value||!i("div.page.user-profile input.text.email").value||!i("div.page.user-profile input.text.phone").value)return void Ye("missing name, email or phone","Error");Cd(!0);var e={name:i("div.page.user-profile input.text.name").value||null,email:i("div.page.user-profile input.text.email").value||null,phone:i("div.page.user-profile input.text.phone").value||null,location:i("div.page.user-profile input.text.location").value||null};It&&(e.picture=It);Yl.put_customer_profile(Yl.auth.user_id,e,(function(e){Kl.myprofile=e,Cd(!1),Tt?Sd("#landing"):(Tt=l("loggedin",!0,Tt),Sd("#login")),It&&(Yl.set_src(i("div.header div.settings img.picture"),It),It="")}),(function(e){Cd(!1),Ye("failed to update profile: "+e,"Error")}))}()})),i("div.page.business-profile img.picture").addEventListener("click",(function(e){hs("business-profile picture"),qt("business")})),i("div.page.business-profile input.button.next").addEventListener("click",(function(e){hs("business-profile next button"),do_signup_business()})),i("div.page.change-password input.button.change-password").addEventListener("click",(function(e){hs("change-password button"),function(){if(!i("div.page.change-password input.text.password-current").value||!i("div.page.change-password input.text.password-new").value||i("div.page.change-password input.text.password-new").value!=i("div.page.change-password input.text.password-again").value)return void Ye("missing password or retyped password does not match","Error");Cd(!0);var e=function(e){if(Cd(!1),Ye("Account password updated","Info"),i("div.page.login input.text.password").value=i("div.page.change-password input.text.password-new").value,i("div.page.change-password input.text.password-current").value="",i("div.page.change-password input.text.password-new").value="",i("div.page.change-password input.text.password-again").value="",Tt)Od();else{var t=jt;jt=null,delete t.user_id,Ft(t)}},t=function(e){Cd(!1),Ye(e,"Error")},n=i("div.page.change-password input.text.password-current").value,a=i("div.page.change-password input.text.password-new").value,o=!Tt&&jt?jt.user_id:null;o?Yl.set_password(n,a,o,e,t):Yl.change_password(n,a,e,t)}()})),i("div.page.change-password span.link.back").addEventListener("click",(function(e){hs("change-password back button"),i("div.page.change-password input.text.password-current").value="",i("div.page.change-password input.text.password-new").value="",i("div.page.change-password input.text.password-again").value="",Tt?Od():(jt=null,Sd("#login"))})),i("div.page.import-contacts input.button.import").addEventListener("click",(function(e){hs("import-contacts import button")})),i("div.page.import-contacts span.link.skip").addEventListener("click",(function(e){hs("import-contacts skip button")})),i("div.page.login div.hotspot").addEventListener("click",(function(e){Ht++>=7&&(Ht=0,hs("login hotspot"),Sd("#connect-settings"))})),i("div.page.connect-settings div.fingerprint").addEventListener("click",(function(e){hs("connect-settings fingerprint button"),Jt((function(){Ye((Lt=l("hasfingerprint",!Lt,Lt))?"Fingerprint ID is enabled for this app":"Fingerprint ID is disabled for this app","Info")}),(function(e){("Not available"==e||e.match(/Not available/i))&&(e="please set fingerprint ID in your device settings"),Ye("Fingerprint ID not available - "+e,"Error")}))})),i("div.page.accesslogin input.button.login").addEventListener("click",(function(e){hs("accesslogin login button"),function(){Cd(!0);var e=i("div.page.accesslogin input.text.username").value,t=i("div.page.accesslogin input.text.password").value,n=Mt;Mt="",Yl.accesslogin(e,t,(function(){Cd(!1),Sd(n||"#connect-settings")}),(function(e){Cd(!1),Ye(e,"Error")}))}()})),i("div.page.accesslogin span.link.login").addEventListener("click",(function(e){hs("accesslogin next button"),Sd("#login")})),i("div.page.accesslogin span.link.settings").addEventListener("click",(function(e){hs("accesslogin settings button"),Sd("#connect-settings")})),i("div.page.connect-settings input.text.web").value=Kl.web,i("div.page.connect-settings input.text.api").value=Kl.api,i("div.page.connect-settings input.text.message").value=Kl.message,i("div.page.connect-settings input.text.files").value=Kl.files,Lt=l("hasfingerprint",!!Kl.fingerprint,Lt),i("div.page.connect-settings input.button.save-connect-settings").addEventListener("click",(function(e){hs("connect-settings save button");var t={web:i("div.page.connect-settings input.text.web").value,api:i("div.page.connect-settings input.text.api").value,message:i("div.page.connect-settings input.text.message").value,files:i("div.page.connect-settings input.text.files").value,fingerprint:Lt};St=!1,Kl.update(t),Kl.store("connect",t),Sd("#login")})),i("div.page.connect-settings span.link.back").addEventListener("click",(function(e){hs("connect-settings back button"),Sd("#login")})),i("div.page.connect-settings span.link.auto").addEventListener("click",(function(e){var t,n;hs("connect-settings auto button"),t=i("div.page.connect-settings input.text.web").value,n=Kl.auto_settings(t),i("div.page.connect-settings input.text.web").value=n.web,i("div.page.connect-settings input.text.api").value=n.api,i("div.page.connect-settings input.text.message").value=n.message,i("div.page.connect-settings input.text.files").value=n.files,n.fingerprint=Lt})),"false"==kd("editprofile")&&(Nt=l("editprofile",!1,Nt),i("div.page.user-profile input.text.name").setAttribute("readonly","true"),i("div.page.user-profile input.text.phone").setAttribute("readonly","true")),"agent"==o("localstore")){Et=l("isprovider",!0,Et);let e=kd("provider")||o("login-providerId");e?Yl.get_idpconf(e,(n=>{t("login getExternalAuth: "+n),redirect_to_idp=function(e,i){client_redirect_uri=encodeURIComponent(window.location.origin+window.location.pathname+window.location.search),Yl.get_oauth2path(e,i,On,client_redirect_uri,(e=>{t("oauthpath: Redirecting to "+e.redirect_url),Kl.store("idp_login",{idp:i,redirect_url:e.redirect_url}),window.location.replace(e.redirect_url)}),(e=>{t("Unable to login using ID Provider "+i+".  No path configured. "+e)}))},n.length&&(i("div.page.login div.externalauth").style.visibility="visible",n.includes("AAD")&&(i("div.page.login div.externalauth button.azureauth").style.display="flex",i("div.page.login div.externalauth button.azureauth").addEventListener("click",(function(t){redirect_to_idp(e,"AAD")}))),n.includes("OKTA")&&(i("div.page.login div.externalauth button.oktaauth.oauth").style.display="flex",i("div.page.login div.externalauth button.oktaauth.oauth").addEventListener("click",(function(t){redirect_to_idp(e,"OKTA")}))),n.includes("DIALPAD")&&(i("div.page.login div.externalauth button.dialpadauth.oauth").style.display="flex",i("div.page.login div.externalauth button.dialpadauth.oauth").addEventListener("click",(function(t){redirect_to_idp(e,"DIALPAD")}))))}),(e=>{i("div.page.login div.externalauth").style.visibility="hidden",t("No external authentication configuration found for provider "+provider+", error: "+e)})):Kl.store("idp_login")}}function Dt(){try{i("div.page.change-password input.text.password-current").value="",i("div.page.change-password input.text.password-new").value="",i("div.page.change-password input.text.password-again").value="",i("div.page.reset-password input.text.password").value="",i("div.page.reset-password input.text.password-again").value="",i("div.page.signup-token input.text.password").value="",i("div.page.signup-token input.text.password-again").value=""}catch(e){}}function Ft(e,n,r){if(e||(e={}),jt=null,St){Dt(),Cd(!0);var s=!1;Kl.load("idp_token",(function(n){n&&n.idp_email&&n.idp_authtoken?(e.username=n.idp_email,e.password=n.idp_authtoken):Kl.load("idp_login",(function(n){n?(t("Attempting to relogin using "+n.idp),client_redirect_uri=encodeURIComponent(window.location.origin+window.location.pathname+window.location.search),Yl.get_oauth2path(Qt,n.idp,On,client_redirect_uri,(e=>{t("oauthpath: Redirecting to "+e.redirect_url),window.location.replace(e.redirect_url)}),(e=>{t("Unable to login using ID Provider "+n.idp+".  No path configured. "+e)})),s=!0):!1!==e.use_credentials&&(e.username=i("div.page.login input.text.email").value,e.password=i("div.page.login input.text.password").value)}))})),s||Yl.login_alt(e,(function(){i("div.page.change-password input.text.email").value=Yl.auth.email,Kl.load("idp_token",(function(e){e?Kl.store("idp_token"):(Kl.store("login",{username:i("div.page.login input.text.email").value,password:i("div.page.login input.text.password").value}),Kl.store("idp_login"))})),Yl.auth.providerId&&Yl.get_provider_profile(Yl.auth.providerId,(function(e){i("div.body > div.content div.page.container.chats > div.title > div.state").innerText=e.config.agent_show_chats_of_state,Yi=l("showchatsofstate",e.config.agent_show_chats_of_state,Yi),e.name&&Md(e.name),e.externalprovid&&e.extvendor&&(kt=l("extvendor",e.extvendor,kt))}),(function(e){i("div.body > div.content div.page.container.chats > div.title > div.state").innerText="all",Yi=l("showchatsofstate","all",Yi)})),Yl.get_customer_profile(Yl.auth.user_id,(function(e){Kl.myprofile=e,At=l("presencestate",Kl.myprofile.status,At),Et=1==e.isEmployee?l("isprovider",!0,Et):l("isprovider",!1,Et),e.providerId&&!Qt&&(Qt=l("frontdoor_id",e.providerId,Qt),Yl.configure((function(i){t("do_login: reloading client features for provider "+e.providerId),Et&&mi(Kl.myprofile&&Kl.myprofile.providerId)}),void 0,void 0,e.providerId,Ad,Ld,!Et));var o=function(){Cd(!1),Tt=l("loggedin",!0,Tt),Sd("#loggedin"),x({type:"login",id:Yl.auth.user_id,email:e.email||"",name:e.name||"",isemployee:e.isEmployee},"*"),Es("login: "+Yl.auth.user_id+", email: "+(e.email||"")+", name: "+(e.name||"")+" agent: "+e.isEmployee),Et&&x({type:"presence",message:{data:{userid:Yl.auth.user_id,status:Kl.myprofile.status}}},"*"),a(n)};i("div.page.user-profile input.text.name").value=e.name||"",i("div.page.user-profile input.text.email").value=e.email||"",i("div.page.user-profile input.text.phone").value=e.phone||"",i("div.page.user-profile input.text.location").value=e.location||"",i("div.header div.presence").innerText=Kl.myprofile.status,i("div.header div.identity").innerText=e.email||"",i("div.header div.identity").setAttribute("title",e.name+" "+e.email),Yl.set_src(i("div.page.user-profile img.picture"),e.picture),Yl.set_src(i("div.header div.settings img.picture"),e.picture),Yl.set_src(i("div.header div.profile.picture img"),e.picture),Et?(mi(Kl.myprofile&&Kl.myprofile.providerId),o(),"available"!=Kl.myprofile.status&&"readonly"!=jl&&(wi=l("showmenu",!0,wi))):(Ct.splice(0,Ct.length),o(),ps("client",{userid:Yl.auth.user_id,useremail:e.email,deviceid:On,clienturl:window.location.href}))}),(function(e){Cd(!1),i("div.page.user-profile input.text.email").value=Yl.auth.email,Sd(""),Sd("#user-profile"),a(r,e)}))}),(function(t){Cd(!1),"mfa"==t.type?(Ye(t+" - requires multi-factor authentication to proceed","Info"),(jt=e).user_id=t.user_id,Sd("#login-token")):"reset-password"==t.type?(Ye(t+" - requires password change to proceed","Info"),(jt=e).user_id=t.user_id,i("div.page.login-password input.text.email").value=e.username||"",Sd("#login-password")):!1!==e.use_credentials&&Ye(t,"Error"),Kl.store("idp_token"),a(r,t)}))}else Yl.configure((function(t){St=!0,!0===t?Qt?(ui(Qt),setTimeout((function(){Ft(e,n,r)}),2e3)):Ft(e,n,r):Sd("#connect-settings")}),Ed,!u()&&o("clientkey")||void 0,Qt,Ad,Ld)}function Ut(e,i,n){Ud(),Cd(!0),e||Kl.store("login"),Tt=l("loggedin",!1,Tt),wi=l("showmenu",!1,wi);var a=function(t){Va(),Cd(!1),Et="agent"==o("localstore")?l("isprovider",!0,Et):l("isprovider",!1,Et),Qt=l("frontdoor_id",void 0,Qt),Le={},yi(),e||(t&&Ye(t,"Error"),Sd("#login")),Kl.myprofile={},Kl.store("idp_login"),"close"==i&&x({type:"close"},"*")};Yl.logout((function(){a()}),(function(e){a(e)}),void 0,n);try{document.cookie&&(document.cookie="user_token=;Path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="user_id=;Path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT")}catch(e){t("do-logout exception: "+e)}Dt()}function zt(e){void 0===e&&(e=!1),i("div.page.signup-token input.text.password").value&&i("div.page.signup-token input.text.password").value==i("div.page.signup-token input.text.password-again").value?(Cd(!0),Yl.signup_token(i("div.page.signup input.text.email").value,i("div.page.signup-token input.text.authcode").value,i("div.page.signup-token input.text.password").value,(function(t){i("div.page.login input.text.email").value=i("div.page.user-profile input.text.email").value=i("div.page.business-profile input.text.email").value=i("div.page.signup input.text.email").value,i("div.page.login input.text.password").value=i("div.page.signup-token input.text.password").value,i("div.page.user-profile input.text.phone").value=i("div.page.business-profile input.text.phone").value=t.phone,Yl.login_alt({username:i("div.page.login input.text.email").value,password:i("div.page.login input.text.password").value},(function(t){Cd(!1),Sd(e?"#business-profile":"#user-profile")}),(function(e){Cd(!1),Sd("#login")}))}),(function(e){Cd(!1),Ye(e,"Error")}))):Ye("missing password or retyped password does not match","Error")}function qt(e){pt({accept:"image/*",capture:"camera",allowupload:!0},(function(n){n&&n.length>0&&function(e,i,n){var o=i.split("x"),r=parseInt(o[0]),s=parseInt(o[1]),c=document.createElement("img");c.src=e,c.onload=function(e){t("resizeImage "+c.naturalWidth+"x"+c.naturalHeight+" => "+r+"x"+s);var i=Math.min(c.naturalWidth,c.naturalHeight),o=document.createElement("canvas");o.setAttribute("width",""+r),o.setAttribute("height",""+s),o.getContext("2d").drawImage(c,c.naturalWidth/2-i/2,c.naturalHeight/2-i/2,i,i,0,0,r,s);var l=o.toDataURL("image/jpeg",.9);a(n,l)},c.onerror=function(e){t("resizeImage() failed to load"),a(n,"about:blank")}}(n[0].url,"140x140",(function(t){It=t,"business"==e?Yl.set_src(i("div.page.business-profile img.picture"),t):Yl.set_src(i("div.page.user-profile img.picture"),t)}))}))}function Jt(e,t){Ot?confirm("Is Fingerprint ID available?")?a(e):a(t,"Not available"):"undefined"==typeof Fingerprint?a(t,"Available only on mobile app"):Fingerprint.isAvailable((function(){a(e)}),(function(e){a(t,""+e)}))}function Wt(e){Lt=l("hasfingerprint",!1,Lt),Bt(e)}function Bt(e){Kl.load("connect",(function(t){!t&&Lt&&(t={}),t&&(t.fingerprint=Lt,Kl.store("connect",t)),a(e)}))}function Gt(e,t){Ot?confirm("Verify Fingerprint ID?")?(Pt=!0,a(e)):(Pt=!1,a(t,"Cancelled")):"undefined"==typeof Fingerprint?(Pt=!1,a(t,"Fingerprint ID is available only on mobile app","Error")):Fingerprint.show({clientId:"KoopidMobileApp",clientSecret:"password",localizedReason:"Requires fingerprint ID to continue using this app"},(function(){Pt=!0,a(e)}),(function(e){Pt=!1,a(t,e||"invalid")}))}function $t(e,t){var i,n={type:"fingerprint",response:!1};"isavailable"==e.request?Jt((function(){Lt=l("hasfingerprint",!0,Lt),n.response=!0,a(t,n)}),(function(e){Lt=l("hasfingerprint",!1,Lt),n.reason=e,a(t,n)})):"verify"==e.request?Gt((function(){n.response=!0,a(t,n)}),(function(e){n.reason=e,a(t,n)})):"enable"==e.request?(i=function(){n.response=!0,a(t,n)},Lt=l("hasfingerprint",!0,Lt),Bt(i)):"disable"==e.request?Wt((function(){n.response=!0,a(t,n)})):(n.reason="unsupported request "+e.request,a(t,n))}var Vt=!1,Kt=!1,Yt=!1,Xt="",Zt=!0,Qt=null,ei=null,ti=null,ii="#welcome",ni=null,ai={},oi=null,ri=null,si=null,ci=null,li={};function di(e){Qt?(Vt=l("frontdoor",!0,Vt),ui(Qt,e)):a(e)}function ui(e,i){ii="#frontpage/"+Qt,mi(Qt,(function(){Yl.get_frontdoor_data(e,(function(e){(function(e){e.logo&&e.logo;e.config&&function(e){t("frontdoor-load-config "+JSON.stringify(e)),e.landing&&e.landing.path&&(ii="#"+e.landing.path);e.providers&&(ti=e.providers);if(e.urlhandler)for(var i in e.urlhandler)"#dialer"==e.urlhandler[i]&&(Oc=l("hasdialer",!0,Oc),g(i,pi));e.loginpage&&"login"==page&&(Xs=l("hasoverlay",!0,Xs),pc({src:e.loginpage}))}(e.config)})(ei=e||{}),a(i)}),(function(e){t("failed to get frontdoor: "+e),a(i)}),void 0,!Et)}))}function pi(e){e&&"tel:"==e.substr(0,4)&&("+"==(e=e.substr(4)).substr(0,1)&&(e=e.substr(1)),Sd("#dialer/"+e))}function fi(){var e=document.createElement("span");e.innerHTML=n("Click to continue if the page doesn't refresh..."),e.addEventListener("click",(function(e){hs("front door error message"),Sd("#welcome")})),i("div.page.frontpage > div").innerHTML="",i("div.page.frontpage > div").appendChild(e)}function hi(e){if(fi(),oi=null,Kt=l("frontpage",!!(ni=e!=Qt?e:null),Kt),mi(e),Qt&&ei&&ei.config&&ei.config.frontpage)return Xs=l("hasoverlay",!0,Xs),pc({src:ei.config.frontpage}),void Yl.get_provider_profile(Qt,(function(e){e.branding&&Vt&&Qt==e.id&&zr(e.branding),e.name&&Md(e.name)}));var n=function(){Yl.get_frontdoor_page(e,oi,(function(n){ai=n||{},oi=n.version,function(e){e.item&&function(e){fi();var t=i("div.page.frontpage > div");gi(e,t)}(e.item);e.update&&function(e){if(!e.data||e.src||e.replace)(e.src||e.replace)&&frondoor_load_page(e);else{var t=i("div.page.frontpage > div");t.data=e.data,yc(t,e.data)}}(e.update)}(ai),n.expires&&"+"==n.expires.substr(0,1)&&(t("schedule frontpage refresh after "+n.expires.substr(1)+"s"),setTimeout((function(){t("refreshing frontpage"),hi(e)}),Math.min(2147483647,1e3*parseInt(n.expires.substr(1)))))}),(function(e){t("failed to get frontdoor: "+e)}))};Yl.get_provider_profile(e,(function(t){t.branding&&Vt&&Qt==t.id&&zr(t.branding),t.name&&Md(t.name),t.config&&t.config.openaction?(Kt=l("frontpage",!!(ni=null),Kt),Se(t.config.openaction,["url","path","invoke","popup"]),setTimeout((function(){!function(e){for(var t=ed.length-1;t>=0;--t)ed[t]==e&&ed.splice(t,1)}("#frontpage/"+e)}),100)):n()}),(function(e){n()}))}function gi(e,n){if(e.src)return t("fetching HTML widget code from "+e.src),le("GET",Kl.resolve(e.src),null,(function(i){t("fetched HTML widget code from "+e.src),e.htmlText=i,delete e.src,gi(e,n)}),(function(i){t("failed to get html widget from src "+e.src),n.className="htmlwidget"}),"text"),n;e.htmlText=gc(e.htmlText,e.replace),e.htmlText&&e.htmlText.indexOf("background-image: url(/kpd-static/")&&(e.htmlText=e.htmlText.replace(/background-image: url\(\/kpd-static\//g,"background-image: url("+Kl.web+"/"));var a=vc(e.htmlText);if(!a)return t("failed to render this page"),n.className="htmlwidget",n;if(n.setAttribute("active","true"),n.innerHTML="",n.data=e.data,yc(a,e.data),n.className="htmlwidget"+(a.className&&" "+a.className||""),n.setAttribute("style",e.style||a.getAttribute("style")||""),n.innerHTML=a.innerHTML,mc(n),n.id){var o=i("#"+n.id+" input");o&&o.focus()}return setTimeout((function(){t("frontpage menu="+i("div.page.frontpage .widget-button.widget-menu")),Si&&i("div.page.frontpage .widget-button.widget-alerts span.widget-count")&&i("div.page.frontpage .widget-button.widget-alerts span.widget-count").setAttribute("value",Si)}),200),n}function vi(e,i,n){if(n.function){var a=n.function,o=n.arguments;if("open"==a)o.length>1&&(Xn=[o[1]]),t("message to send "+JSON.stringify(Xn)),Se({path:o[0]},["path"]);else if("path"==a)Se({path:o[0]},["path"]);else if("invoke"==a){Se({invoke:o.shift(),args:o},["invoke"])}else if("url"==a)Se({url:o[0]},["url"]);else if("popup"==a)Se({popup:o[0]},["popup"]);else if("showmenu"==a)wi=l("showmenu",!wi,wi),xi=l("showsuggest",!1,xi);else if("back"!=a||Vt||"frontpage"!=page)if("callwith"==a){Se({invoke:"callwith",args:o},["invoke"])}else"callend"==a?(Gc(),ol()):t("func "+a+" not supported in frontpage");else Od(),ni=null,Kt=l("frontpage",!1,Kt),yi()}else t("missing function in frontpage action")}function mi(e,n){ri=e;var o=i("link#customcss").getAttribute("data");if(t("populate-customcss id="+e),Et&&!o||Vt&&!o||Vt&&e!=o||!Et&&!Vt&&o!=e){t("loading customcss for "+e),Yt=l("customcss",!0,Yt),i("link#customcss").setAttribute("data",e),i("link#channelcss").setAttribute("data",e),null!=si&&(clearTimeout(si),si=null);let r=function(){fd["--main-color"]&&(i("link#channelcss").onload=function(){t("Completed loading customcss "+fd.customcss+".  Applying styles"),Object.entries(fd).forEach((([e,t])=>{e.startsWith("--")&&document.querySelector(":root").style.setProperty(e,t)})),fd["brand-logo"]&&document.querySelector(":root").style.setProperty("--brand-logo",'url("'+fd["brand-logo"]+'")'),fd["bot-icon"]&&document.querySelector(":root").style.setProperty("--bot-icon",'url("'+fd["bot-icon"]+'")'),fd["--splashscreen"]&&document.querySelector(":root").style.setProperty("--splashscreen",'url("'+fd["--splashscreen"]+'")')}),i("link#channelcss").setAttribute("href",fd.customcss)},s=function(o){o&&i("link#customcss").getAttribute("data")==e?(Vt&&Qt==e&&(ci=o),fd.customcss&&(i("link#customcss").onload=function(){t("Complted loading customcss.  Attempting to load channel customization"),r()}),i("link#customcss").setAttribute("href",o)):t("ignoring loaded customcss, mismatch in id "+e+" != "+i("link#customcss").getAttribute("data")+", url="+o),a(n)};Ml&&fd.customcss?s(Kl.resolve("/kpd-static/providers/"+e+"/customcss/"+fd.customcss)):Yl.get_customcss(e,(function(e){s(e.url)}),(function(){ri=null,Yt=l("customcss",!1,Yt),Vt&&Qt==o||(i("link#customcss").removeAttribute("data"),i("link#customcss").removeAttribute("href")),a(n)}),void 0,!Et)}else ri=null,a(n)}function yi(e){Et||(ri=null,Yt=l("customcss",!1,Yt),null!=si&&(clearTimeout(si),si=null),si=setTimeout((function(){si=null,function(){if(null==ri){var e=i("link#customcss").getAttribute("data");Et||(Vt&&e!=Qt?(t("unloading customcss, reloading frontdoor css"),i("link#customcss").setAttribute("data",Qt),i("link#customcss").setAttribute("href",ci)):Vt||(t("unloading customcss"),i("link#customcss").setAttribute("data",""),i("link#customcss").removeAttribute("href")))}}()}),e||Rl&&500||10))}function bi(e){if(void 0!==e["*"])for(var t in li)li[t]=!!e["*"];for(var t in e)void 0!==li[t]&&(li[t]=!!e[t]);for(var t in li){var n=li[t],a="disable-display-"+t;n?document.body.removeAttribute(a):document.body.setAttribute(a,"true"),rd||"input"!=t||(i("div.page.chat div.textarea > textarea").disabled=!n),Et||n||"input"!=t&&"autosuggest"!=t||Jr(),Et&&"input"==t&&Wr()}e.clearscreen&&"chat"==page&&To("clear",!0)}["input","attach","phone","person","menu","workflow","action","widget","autosuggest"].forEach((function(e){li[e]=!0}));var wi=!1,xi=!1,_i=!1,ki=!1,Ti=null,Ei=null;function Ai(){i("div.header div.button.search").addEventListener("click",(function(){hs("search button"),wi=l("showmenu",!1,wi),_i=l("showsearch",!_i,_i)})),i("div.controls div.header div.button.left").addEventListener("click",(function(){hs("search back button"),_i?(_i=l("showsearch",!1,_i),function(){"alerts"!=page&&"contacts"!=page||Sd("alerts"==page?"#alerts":"#contacts"+(Hi?"/"+Hi:""),!0,!0);i("div.header input.text.search").value=""}()):ni&&Sd("#frontpage/"+ni)})),i("div.header input.text.search").addEventListener("keydown",(function(e){return 13!=(e.which||e.keyCode)||(gs("enter","search input"),setTimeout((function(){Li()}),0),e.preventDefault(),!1)})),i("div.header input.text.search").addEventListener("input",(function(e){gs("input","search input",{value:i("div.header input.text.search").value}),xi=l("showsuggest",!0,xi),Ni(e)})),i("div.header input.text.search").addEventListener("click",(function(e){hs("search input"),wi=l("showmenu",!1,wi),xi=l("showsuggest",!0,xi),Ni()})),i("div.header input.text.search").addEventListener("blur",(function(e){setTimeout((function(){xi=l("showsuggest",!1,xi)}),10)})),i("div.header div.close").addEventListener("click",(function(e){hs("search close button"),i("div.header input.text.search").value="",setTimeout((function(){i("div.header input.text.search").focus(),Li()}),100)}),!0),i("div.page.search > div.title").addEventListener("click",(function(e){Ci(i("div.header input.text.search").value)}))}function Li(){var e=i("div.header input.text.search").value;!function(e){if(e&&e.startsWith("token:")&&Et){var i="telephony/providerId:"+Kl.myprofile.providerId+",token:"+e.substr(6);return Yl.resolve_action(i,(function(e){Se(e,["path","url","popup","invoke"])}),(function(e){t("failed to resolve action from param "+i+": "+e)})),!0}return!1}(e)?Sd("alerts"==page||"contacts"==page||"frontpage"==page||"profile"==page||"dialer"==page?"alerts"==page?"#alerts/?filter="+e:"#contacts/"+(Hi?Hi+"/":"")+"?filter="+e:"chats"==page||"chat"==page||"chatwith"==page?"#chats/"+e:"#search/"+e,!0,!0):t("custom search"),i("div.header input.text.search").blur()}function Ni(e){var t=i("div.header input.text.search").value;ki=l("hassearch",!!t,ki),Ti&&(Ti.abort(),Ti=null),Ei&&(clearTimeout(Ei),Ei=null);var n=function(e){i("div.controls div.suggestions ul").innerHTML="",e=e||[];var t=function(e,t){return{text:e+" in "+t,html:'Find <span class="term">'+e+"</span> in "+t,action:{path:"search/"+e+" in "+t}}};Hn&&aa&&Rn&&Rn[aa]&&Rn[aa].businessProfiles&&Rn[aa].businessProfiles.forEach((i=>{if("Guest User"!=i.name){var n=t(i.name,"names");e.forEach((e=>{n&&e.text==n.text&&(n=null)})),n&&e.push(n)}i.email&&!/^guest-(.*)$/.test(i.email)&&e.push(t(i.email,"email")),i.phone&&e.push(t(i.phone,"phone")),i.channeltype&&["instagram","twitter","twitter-dm"].indexOf(i.channeltype)>=0&&i.otherdata&&i.otherdata.screen_name&&e.push(t(i.otherdata.screen_name,"social handle"))})),e.push({text:"routefailure in conversations",html:'Find <span class="term">Route Failed</span> conversations',action:{path:"search/routefailure in conversations"}});for(var n=0;n<e.length;++n){var a=e[n],o=document.createElement("li");o.innerHTML=a.html||"",o.data=a,o.addEventListener("click",(function(e){var t=e.currentTarget.data;hs("search dropdown item",t);let n=t.text.match(/(\sin\snames|\sin\ssocial\shandle|\sin\sphone|\sin\semail)$/g);i("div.header input.text.search").value=n?t.text.substr(0,t.text.length-n[0].length):t.text,i("div.header input.text.search").blur(),setTimeout((function(){Se(t.action,["path"])}),300)})),i("div.controls div.suggestions ul").appendChild(o)}};"alerts"==page||"contacts"==page?"alerts"==page||Fi(!1,(Hi||"")+"/?filter="+t):Ei=setTimeout((function(){var e=i("div.header input.text.search").value;ki=l("hassearch",!!e,ki),Ti=Yl.get_suggestions(e,(function(e){Ti=Ei=null,n(e)}),(function(e){Ti=Ei=null,n(null)}))}),400)}function Ci(e){t("do-search text="+e),Ye("Directory is no longer available","Error")}var Si=0,Oi=!1,Ii=[];function Mi(){var e=Ii.reduce((function(e,t){return e+(t.count||1)}),0);i("span.todocount").setAttribute("value",""+e)}function ji(e){var t=Ii.indexOf(e);t>=0&&Ii.splice(t,1),Mi();for(var n=i("div.todomenu").children,a=n.length-1;a>=0;--a)n[a].data==e&&i("div.todomenu").removeChild(n[a])}function Pi(e,t,a){if(void 0===e.count&&(e.count=t?1:0),!a){for(var o=null,r=0;r<Ii.length;++r){var s=Ii[r];if(s.type==e.type&&s.id==e.id){o=s;break}}o&&(t&&(e.count+=o.count,e.count>99&&(e.count=99)),!e.picture&&o.picture&&(e.picture=o.picture),ji(o))}Ii.push(e),Mi();var c,d,p=document.createElement("div");if(p.data=e,p.className="item",p.innerHTML='<img class="picture" src="assets/user.jpg"/><span class="title">'+n(e.title)+'</span><span class="subtitle">'+n((c=e.subtitle,d=100,!c||c.length<=d?c:c.substr(0,d-3)+"..."))+'</span><span class="badge" value="'+e.count+'"></span></div>',i("div.todomenu").appendChild(p),e.picture&&!u()&&Yl.set_src(p.children[0],e.picture),i("div.todomenu").scrollTop=i("div.todomenu").scrollHeight,e.action){p.addEventListener("click",(function(e){var t=e.currentTarget.data;hs("todo item",t),Oi=l("showtodomenu",!1,Oi),ji(t),setTimeout((function(){Se(t.action,["path","url","invoke","popup"])}),500)}));var f=function(e){ji(e.currentTarget.data)};v(p,{right:f,left:f})}}var Hi=null,Ri="",Di=null;function Fi(e,t){if(Et){var n=t.split("?"),a=n[0]&&n[0].split("/")[0]||"",o=n.length>=2?n[1].split("&").map((function(e){return e.split("=",2)})).reduce((function(e,t,i){return e[t[0]]=t.length>1?decodeURIComponent(t[1]):null,e}),{}):{};if(old_selected=Hi,Hi=a||null,Ri=o.filter||"",Di=Ri?new RegExp(Ri,"i"):null,Ri!=i("div.header input.text.search").value&&(i("div.header input.text.search").value=Ri),xi=l("showsuggest",!1,xi),ki=l("hassearch",!!Ri,ki),Ri&&!_i&&(_i=l("showsearch",!0,_i)),Hi||!Qt&&!ni||(Hi=Qt||ni),Et)Cd(!0),Yl.get_provider_contacts((function(e){Cd(!1),i("div.page.contacts > div.list").innerHTML="";for(var t=0;t<e.length;++t){var n=e[t],a=qi(n);a.data=n,a.setAttribute("selected","false"),a.setAttribute("filtered",Ui(n)?"true":"false"),i("div.page.contacts > div.list").appendChild(a),n.picture&&Yl.set_src(i("div#contacts-result-"+n.id+" div.picture img"),n.picture),a.addEventListener("click",(function(e){e&&hs("contacts item",e.currentTarget.data),Wi(e.currentTarget,e.currentTarget.data)}))}Vi(i("div.page.contacts > div.list"))}),(function(e){Cd(!1),Ye("Get contacts failed: "+e,"Error")}));else if(e)Cd(!0),Yl.get_customer_top_contacts((function(e){Cd(!1),i("div.page.contacts > div.list").innerHTML="";for(var t=0;t<e.length;++t){var n=e[t],a=qi(n);a.data=n,a.setAttribute("selected",Hi&&n.id==Hi?"true":"false"),a.setAttribute("filtered",Ui(n)?"true":"false"),Hi&&n.id==Hi&&a.setAttribute("filtered",!1),Qt&&n.id!=Qt&&(!ti||ti.indexOf(n.id)<0)&&a.setAttribute("filtered",!0),i("div.page.contacts > div.list").appendChild(a),n.picture&&Yl.set_src(i("div#contacts-result-"+n.id+" div.picture img"),n.picture),a.addEventListener("click",(function(e){e&&hs("contacts top item",e.currentTarget.data),Wi(e.currentTarget,e.currentTarget.data)})),a.children[2].addEventListener("click",(function(e){return e&&hs("contacts top item picture",e.currentTarget.parentNode.data),e.preventDefault(),e.stopImmediatePropagation(),$i(e.currentTarget.parentNode,e.currentTarget.parentNode.data),!1})),(Hi&&n.id==Hi||Qt&&n.id==Qt)&&Bi(a,n)}Vi(i("div.page.contacts > div.list"))}),(function(e){Cd(!1),Ye("Get contacts failed: "+e,"Error")}));else{for(var r=i("div.page.contacts > div.list").children,s=null,c=0;c<r.length;++c){var d=(p=r[c]).data;p.setAttribute("filtered",Ui(d)?"true":"false"),p.setAttribute("selected",Hi&&d.id==Hi?"true":"false"),Hi&&d.id==Hi&&(s=p,p.setAttribute("filtered",!1)),Qt&&d.id!=Qt&&(!ti||ti.indexOf(d.id)<0)&&p.setAttribute("filtered",!0),Hi&&d.id==Hi&&old_selected!=Hi&&Bi(p,d)}if(s){var u=s.children[4].children;for(c=0;c<u.length;++c){var p;d=(p=u[c]).data;p.setAttribute("filtered",zi(d)?"true":"false")}}Vi(i("div.page.contacts > div.list"))}}else Ye("Customer contacts is no longer available","Error")}function Ui(e){return Di&&!((e.name||"").match(Di)||(e.html||"").match(Di)||(e.address||"").match(Di))||ni&&!(""+e.id).match(ni)}function zi(e){return Di&&!((e.name||"").match(Di)||(e.desc||"").match(Di))}function qi(e){var t=document.createElement("div");t.className="contacts-result item",t.data=e,t.id="contacts-result-"+e.id,t.setAttribute("selected","false");var i=e.html||"";return i||(i=Et?'<span class="email">'+n(Ji("email",e.email))+'</span><span class="phone">'+n(Ji("phone",e.phone))+"</span>":"no description available"),t.setAttribute("hasmessage",""+!!e.enabled),t.setAttribute("hasphone",""+!!e.phone),t.innerHTML='<div class="name">'+n(e.name||"Anonymous")+'</div><div class="desc">'+i+'</div><div class="picture"><img src="assets/cleardot.gif"/></div><div class="message"></div><div class="items"></div>',t}function Ji(e,t){return t="email"==e?t.replace(/....@..../,"xxxx@xxxx"):"phone"==e?t.substr(0,1)+"X".repeat(t.length-5)+t.substr(t.length-4):"X".repeat(t.length)}function Wi(e,t){Et?Sd("#chatwith/"+t.id):t.config&&t.config.openaction?Se(t.config.openaction,["url","path","invoke","popup"]):"desktop"==ql||t.config&&t.config.contacts?"true"==e.getAttribute("selected")?Sd("#contacts"):Sd("#contacts/"+t.id):Sd("#frontpage/"+t.id)}function Bi(e,t){Cd(!0),Yl.get_customer_sub_contacts(t.id,(function(n){Cd(!1),e.children[4].innerHTML="";for(var a=0;a<n.length;++a){var o=n[a],r=Gi(t.id,o);r.data=o,e.children[4].appendChild(r),o.picture&&Yl.set_src(i("div#subcontacts-result-"+t.id+"-"+o.id+" div.picture img"),o.picture),r.setAttribute("filtered",zi(o)?"true":"false"),r.addEventListener("click",(function(e){return e&&hs("contacts sub item",e.currentTarget.data),e.preventDefault(),e.stopImmediatePropagation(),$i(e.currentTarget,e.currentTarget.data),!1}))}}),(function(e){Cd(!1),Ye("Get subcontacts failed: "+e,"Error")}))}function Gi(e,t){var i=document.createElement("div");return i.className="item",i.data=t,i.id="subcontacts-result-"+e+"-"+t.id,i.setAttribute("status",t.status||""),i.innerHTML='<div class="name">'+n(t.name||"Unknown")+'</div><div class="desc">'+(t.html||"")+'</div><div class="picture"><img src="assets/cleardot.gif"/></div>',i}function $i(e,t){Se(t.action,["path","url"])}function Vi(e){for(var t=0,i=0;i<e.children.length;++i){var n=e.children[i];n.hasAttribute("filtered")&&"false"!=n.getAttribute("filtered")||++t}e.setAttribute("count",t)}var Ki,Yi="all",Xi={},Zi={},Qi=0;function en(e){if(t("do-chats text="+e),(e=e?decodeURIComponent(e):e)!=i("div.header input.text.search").value){let t=e.match(/(\sin\snames|\sin\ssocial\shandle|\sin\sphone|\sin\semail)$/g);i("div.header input.text.search").value=t?e.substr(0,e.length-t[0].length):e}xi=l("showsuggest",!1,xi),ki=l("hassearch",!!e,ki),e&&!_i&&(_i=l("showsearch",!0,_i)),Ti&&(Ti.abort(),Ti=null),Ei&&(clearTimeout(Ei),Ei=null),Qi=0,tn(e)}function tn(e,n){Cd(!0),t("populate_chats_items-> text: "+e+", pathfilter: "+n),clearTimeout(Ki),Ki=void 0,Yl.search_chats(e,Qi,20,n,"active"==Yi?"active":void 0,(function(a,o){Cd(!1),Qi||n?0==a.length&&Ye("No more items found","Info"):i("div.page.chats > div.list").innerHTML="",t("populate_chats_items->values: "+a.length);for(var r=0;r<a.length;++r){var s=a[r];t("populate_chats_items-> value.chat: "+s.chat),n&&Es("populate_chats_items after chat-subscribe-> value.chat: "+s.chat+", path: "+n),Et&&"active"==s.state&&s.chat==Hn&&s.employeeid&&s.employeeid==Yl.auth.user_id&&(oa=s.state,i("div.page.chat > div.input").setAttribute("state",oa));var c=i('div.page.chats div.list > div.item[chat="'+s.chat+'"]');if(c){var l=i("div.page.chats div.list").children[0];if(s.path==n){let e=c.getAttribute("state");"disconnecting"==e&&"active"==s.state||c.setAttribute("state",s.state),"active"==s.state&&"disconnecting"!=e&&c!==l&&i("div.page.chats div.list").insertBefore(c,l)}try{let e=s.participants.filter((function(e){return"agent"!==e.usertype})),t="";try{if("businessidentity"in s&&s.businessidentity.length>0){t=s.businessidentity;let i=e[0],n=i?.name;for(let e of t)e.name&&void 0!==e.name&&(n.startsWith("Guest User")||"Agent Created"===e.channeltype)&&(n=e.name.split("@").shift());i&&i.id&&n&&n!=c.getElementsByClassName("name")[0].childNodes[0].data&&(c.getElementsByClassName("name")[0].childNodes[0].data=n,Fa.get(i.id).name=n,yo(c.getElementsByClassName("picture user")[0],i.id))}}catch(e){}x({type:"chat",chat:{channel:s.channel,chat:s.chat,participants:e,businessidentity:t,lastmessage:s.html||"",name:s.name||"",state:s.state}},"*")}catch(e){t("Error while constructing window postmessage for existing chat."+s.chat)}c.data=s;continue}const[e,o]=nn(s,r);if(e.addEventListener("click",(function(e){if(za)Ye("Chat close in progress, please wait","info",2e3),us("chat-close-in-progress",{value:e.currentTarget.data});else{e.currentTarget;var t=e.currentTarget.data;e&&hs("chats item",t),x({type:"chatswitch",id:t.chat}),Es("chatswitch: "+t.chat),Sd("#chat/"+t.chat)}})),n){l=i("div.page.chats > div.list > div.item:nth-child(1)");i("div.page.chats > div.list").insertBefore(e,l||null)}else i("div.page.chats > div.list").appendChild(e);Qi+=1,s.picture&&Yl.set_src(i("div#chats-result-"+r+" div.picture img"),o),s.logo&&Yl.set_src(i("div#chats-result-"+r+" div.picture.logo img"),s.logo);try{let e=s.participants.filter((function(e){return"agent"!==e.usertype})),t="";"businessidentity"in s&&s.businessidentity.length>0&&(t=s.businessidentity),x({type:"chat",chat:{channel:s.channel,chat:s.chat,participants:e,businessidentity:t,lastmessage:s.html||"",name:s.name||"",state:s.state}},"*")}catch(e){t("Error while constructing window postmessage for chat."+s.chat)}}if(o&&(t("pageinfo="+JSON.stringify(o)),a.length>=20&&(void 0===o.count||o.offset+a.length<o.count))){var d=document.createElement("div");d.className="more",d.innerText="Load More >>",d.addEventListener("click",(function(e){i("div.page.chats > div.list").removeChild(d),tn(i("div.header input.text.search").value)})),i("div.page.chats > div.list").appendChild(d)}an(e),Vi(i("div.page.chats > div.list"))}),(function(e){Cd(!1),Qi?(Qi=0,Ye("No more items found","Info")):Ye("Search failed: "+e,"Error")}))}function nn(e,t){var i=document.createElement("div");i.className="search-result item chat",i.data=e,i.id="chats-result-"+t,i.setAttribute("status",e.status||"available"),i.setAttribute("path",e.path),i.setAttribute("chat",e.chat),Et&&i.setAttribute("state",e.state);var a,o=e.name.split("@"),r=o.length>0?"@"+o.join("@"):"",s="",c=0,l="",d="";let u,p,f,h;for(let t of e.participants)switch(t.usertype){case"customer":e.picture=t.picture||"providers/0/images/profile.png",a=t.name||o.shift(),u=Fa.get(t.id)||t,f=t.id;break;case"agent":case"bot":d=t.id!=Yl.auth.user_id?t.name:"","agent"==t.usertype&&(p=Fa.get(t.id)||t,h=t.id)}if("businessidentity"in e&&e.businessidentity.length>0)for(let t of e.businessidentity)t.name&&void 0!==t.name&&(a.startsWith("Guest User")||"Agent Created"===t.channeltype)&&(a=t.name.split("@").shift()),t.channeltype===e.channel&&(l=t.name.split("@").shift()),"Agent Created"!=t.channeltype&&(t.businesskey&&(u.businesskey=t.businesskey),t.phone&&(u.phone=t.phone),t.email&&(u.email=t.email));u.name=a,u.picture=e.picture||u.picture,f&&Fa.set(f,u,3600),h&&Fa.set(h,p,3600);let g=u.picture.endsWith("providers/0/images/profile.png")?a+":providers/0/images/profile.png":u.picture;!0===Le["show-interactions-count"]&&(c=e.count||0),!0===Le["require-agent-name"]&&(s=e.names?e.names.join(", "):"");var v=e.channel?e.channel:"",m=e.ts?bo(new Date(parseInt(e.ts))):"",y='<div class="name">'+n(a||"Unknown")+'<span class="business">'+n(r)+'</span><span class="channelidentity">'+n(l)+'</span><span class="names">'+n(s)+'</span></div><div class="timestamp">'+n(m)+'</div><div class="desc" dir="auto">'+(Ao(e.html,!0)||"no description available")+'</div><div class="picture user"><img src="'+e.picture+'" aria-label="User Profile Picture"/></div><div class="channelinfo" data="'+v+'"></div><div class="status extra" value="'+(e.status||"available")+'"></div><div class="picture logo"><img src="assets/cleardot.gif" aria-label="Business Logo"/></div><div class="count" data="'+c+'"></div><div class="badge" data="0"></div><div class="agentname" >'+d+"</div>";return i.innerHTML=y,[i,g]}function an(e="",t=!1){for(var n=null,a=i("div.page.chats div.list").children,o=!1,r=0;r<a.length;++r){var s=a[r];if(s.data&&s.data.chat==Hn){if(Et&&""==e&&"active"==Yi&&"active"!=s.getAttribute("state")){s.removeAttribute("selected"),sn(Hn),Hn=null,n="#chats";continue}s.setAttribute("selected","true"),"active"==s.getAttribute("state")&&Et&&"readonly"!=jl&&"email"!=Ca&&bi({input:!0,attach:!0}),"desktop"==ql&&s.scrollIntoView(),o=!0}else s.removeAttribute("selected");Et&&s.data&&s.data.path&&ln(s.data.path)}Hn&&Et&&""==e&&!t&&(a.length<1||!o)&&"readonly"!=jl&&"sessionpanel"!=Ml&&"toolspanel"!=Ml&&(n="#chats"),Et&&n&&Sd(n)}function on(e,t){var n=Xi[e]={};n.received_messages=[],n.last_chatwith_id=Gn,n.last_chatwith_path=$n,n.chat_participants=na,na=[],n.chat_customer_id=aa,n.chat_customer_lang=ra,ra="en",n.chat_state=oa,n.chat_id=Hn,n.chat_item=Ln,Ln=null,n.chat_path=Pn,n.chat_sneak_peek=ca,n.userscount=mn,n.chat_subscribed=Qn,n.chat_started=ta,n.chat_loaded=ea,n.chat_message_sequence=fa,n.chat_message_pending=ha,n.pending_received_messages=Jn,Jn=null,n.chat_useractivity_messages=ga,ga=[],n.chat_input_history=Vn,Vn=[],n.chat_input_history_index=Kn,Kn=0,n.chat_users_names=Dn,Dn=[],n.chat_users=Rn,Rn={},n.chat_my_picture=Fn,n.chat_sneak_peek_timeout=da,n.chat_sneak_peek_type=ua,n.chat_blobs=Nn,Nn=[],n.first_time_send=Xn,n.chat_last_message_text=ya,n.current_snippet_div=va,va=null,n.chat_items_menu=xa,xa=[],n.chat_items_widgets=wa,wa=[],n.chat_items_suggested=ba,ba=[],n.chat_items_tags=_a,_a=[],n.chat_lastdate=ka,n.bloburl_to_dataurl=La,La={},n.profilestatus=Ps,n.ismultiuser=vn,n.chat_channel_type=Ca,Ca="koopid",n.chat_channel_vendor=Sa,Sa="koopid",n.chat_channel_user_id=Oa,Oa=null,n.chat_channel_provider_id=Ia,Ia=null,n.chat_channel_prop=Ma,Ma=null,ja=[],n.chat_scroll_to_segment=qa,jo(),i("div.mask").click(),gn&&(i("div.page.chat div.textarea > textarea").value="",so({type:"typing",value:gn=l("istyping",!1,gn)})),n.view_name=i("div.page.chat div.header div.name").innerHTML,n.view_tags=i("div.page.chat div.header div.tags").innerHTML;var a=document.createElement("div");a.className="history";var o=i("div.page.chat div.history");n.scrollTop=o.scrollTop,t?(i("div.page.chat").insertBefore(a,o),i("div.page.chat").removeChild(o),i("div.chat-stash").appendChild(o),o.setAttribute("chat-id",e)):setTimeout((function(){i("div.page.chat").insertBefore(a,o),i("div.page.chat").removeChild(o),i("div.chat-stash").appendChild(o),o.setAttribute("chat-id",e)}),300)}function rn(e,n){if(Hn&&Ln&&"readonly"!=jl)return on(Hn,!0),Hn=null,void rn(e,!0);var a=Xi[e];if(!a)throw new Error("cannot load chat-tab for "+e);Gn=a.last_chatwith_id,$n=a.last_chatwith_path,na=a.chat_participants,aa=a.chat_customer_id,ra=void 0===a.chat_customer_lang?"en":a.chat_customer_lang,oa=a.chat_state,Hn=a.chat_id,Ln=a.chat_item,Pn=a.chat_path,ca=a.chat_sneak_peek,mn=a.userscount,Qn=a.chat_subscribed,ta=a.chat_started,ea=a.chat_loaded,fa=a.chat_message_sequence,ha=a.chat_message_pending,Jn=a.pending_received_messages,ga=a.chat_useractivity_messages,Vn=a.chat_input_history,Kn=a.chat_input_history_index,Dn=a.chat_users_names,Rn=a.chat_users,Fn=a.chat_my_picture,da=a.chat_sneak_peek_timeout,ua=a.chat_sneak_peek_type,Nn=a.chat_blobs,Xn=a.first_time_send,ya=a.chat_last_message_text,va=a.current_snippet_div,xa=a.chat_items_menu,wa=a.chat_items_widgets,ba=a.chat_items_suggested,_a=a.chat_items_tags,ka=a.chat_lastdate,La=a.bloburl_to_dataurl,Ca=a.chat_channel_type,Sa=a.chat_channel_vendor,Oa=a.chat_channel_user_id,Ia=a.chat_channel_provider_id,Ma=a.chat_channel_prop,ja=[],qa=a.chat_scroll_to_segment,Ps=l("profilestatus",a.profilestatus,Ps),vn=l("ismultiuser",a.ismultiuser,vn),gn=l("istyping",!1,gn),i("div.mask").click(),i("div.page.chat div.header div.name").innerHTML=a.view_name,i("div.page.chat div.header div.tags").innerHTML=a.view_tags,Et&&Wr();var o=i('div.chat-stash div[chat-id="'+e+'"]'),r=i("div.page.chat div.history");o.removeAttribute("chat-id"),i("div.chat-stash").removeChild(o),n?(o.style.opacity="0.0",o.style.webkitTransition=o.style.transition="opacity .5s",o.style.mozTransition="opacity .5s",i("div.page.chat").insertBefore(o,r),setTimeout((function(){o.style.opacity="1.0"}),0),setTimeout((function(){i("div.page.chat").removeChild(r),o.style.opacity="",o.style.webkitTransition=o.style.transition="",o.style.mozTransition=""}),500)):(i("div.page.chat").insertBefore(o,r),i("div.page.chat").removeChild(r)),o.scrollTop=a.scrollTop,dn(a.chat_path);for(var s=a.received_messages,c=0;c<s.length;++c){var d=s[c];fo(d,!1,!0),yr(d)}var u=i('div.page.chats div.list > div.item[path="'+Pn+'"]');u?(chat_state_in_list=u.getAttribute("state"),chat_state_in_list!=oa&&(t("WARN: saved chat state: "+oa+", state in list: "+chat_state_in_list),oa=chat_state_in_list)):t("WARN: unable to locate selected chat ("+Pn+") in the chat list"),na.includes(Yl.auth.user_id)?i("div.page.chat > div.input").setAttribute("state",oa):i("div.page.chat > div.input").setAttribute("state","inactive")}function sn(e){if(Et){var t=i('div.page.chats div.item[chat="'+e+'"]');t&&t.setAttribute("state","inactive")}delete Xi[e]}function cn(e,n){var a=null;for(var o in Xi){var r;(r=Xi[o]).chat_path==n&&(a=r)}(a&&a.received_messages.push(e),Et&&"typing"!=e.type)&&((r=i('div.page.chats div.item[path="'+n+'"]'))&&"disconnecting"!=r.getAttribute("state")&&(r.setAttribute("state","active"),t("Setting state of "+r.getAttribute("id")+" to active")))}function ln(e){var t=i('div.page.chats div.list > div.item[path="'+e+'"] div.badge');t&&void 0!==Zi[e]&&t.setAttribute("data",""+Zi[e])}function dn(e){delete Zi[e];var t=i('div.page.chats div.list > div.item[path="'+e+'"] div.badge');t&&t.setAttribute("data","0")}function un(e,n){var a=i(e?'div.page.chats div.list > div.item[path="'+e+'"]':'div.page.chats div.list > div.item[chat="'+n+'"]');a&&"active"==a.getAttribute("state")&&(x({type:"chat-disconnecting",id:e?a.getAttribute("chat"):n},"*"),t("chat_set_inactive: setting inactive "+(e||n)),a.setAttribute("state","disconnecting"),Et&&(Ki=setTimeout((function(){tn("",a.getAttribute("path"))}),1e4)),"true"==a.getAttribute("selected")&&bi({input:!1,attach:!1}));Et||"agent"==document.body.getAttribute("chatsendertype")||(bi({input:!1,attach:!1}),Sc(),uc())}var pn,fn,hn,gn=!1,vn=!1,mn=0,yn=!1,bn=!1,wn=!1,xn=!1,_n=!1,kn=!1,Tn=!1,En="callconnect",An=new showdown.Converter({emoji:!0,simpleLineBreaks:!0,parseImgDimensions:!0,simplifiedAutoLink:!0,openLinksInNewWindow:!0}),Ln=null,Nn=[],Cn=null,Sn="",On="",In="",Mn="",jn=[],Pn=null,Hn=null,Rn={},Dn=[],Fn=null,Un=null,zn=.5,qn=0,Jn=null,Wn=null,Bn=null,Gn="",$n=null,Vn=[],Kn=0,Yn={},Xn=null,Zn=!1,Qn=!1,ea=!1,ta=!1,ia={},na=[],aa="",oa="",ra="en",sa=null,ca=!1,la=null,da=200,ua="show",pa=!1,fa=!1,ha=[],ga=[],va=null,ma=!0,ya="",ba=null,wa=null,xa=null,_a=null,ka="",Ta=!1,Ea=null,Aa=null,La={},Na=null,Ca="koopid",Sa="koopid",Oa=null,Ia=null,Ma=null,ja=[],Pa=null,Ha=0,Ra=5e3,Da=!1,Fa=new ue,Ua=void 0,za=!1,qa=void 0;function Ja(){i("div.page.chat div.header div.button.back").addEventListener("click",oo),i("div.page.chat div.header div.button.home").addEventListener("click",Fo),i("div.page.chat div.header div.button.phone").addEventListener("click",zo),i("div.page.chat div.header div.button.hangup").addEventListener("click",Jo),i("div.controls div.header div.button.hangup").addEventListener("click",Jo),i("div.page.chat div.header div.button.person").addEventListener("click",Uo),i("div.page.chat div.header div.button.menu").addEventListener("click",Wo),i("div.page.chat div.input div.button.attach").addEventListener("click",Ho),i("div.page.chat div.input div.button.send").addEventListener("click",So),i("div.page.chat div.input div.button.reply").addEventListener("click",Tl),i("div.page.chat div.input div.button.close").addEventListener("click",nr),i("div.chatmenu div.item.save").addEventListener("click",Xo),i("div.chatmenu div.item.screenshot").addEventListener("click",Zo),i("div.chatmenu div.item.exit").addEventListener("click",Qo),i("div.chatmenu div.item.minimize").addEventListener("click",er),i("div.chatmenu div.item.closesegment").addEventListener("click",ir),i("div.chatmenu div.item.email").addEventListener("click",tr),i("div.chatmenu div.item.assign").addEventListener("click",dr),i("div.chatmenu div.item.suggestion").addEventListener("click",dr),i("div.chatmenu div.item.widget").addEventListener("click",dr),i("div.chatmenu div.item.related").addEventListener("click",dr),i("div.chatmenu div.item.tags").addEventListener("click",dr),i("div.chatmenu div.item.useractivity").addEventListener("click",dr),i("div.chatmenu div.item.urlhistory").addEventListener("click",dr),i("div.chatmenu div.item.customerinfo").addEventListener("click",dr),i("div.content > div.button.minimize").addEventListener("click",er),i("div.content > div.button.minimize").addEventListener("keyup",er),i("div.content > div.button.chatclose").addEventListener("click",oo),i("div.content > div.button.chatclose").addEventListener("keyup",oo);var e=function(e){sa&&(clearTimeout(sa),sa=null),sa=setTimeout(Bo,1e3)},n=function(e){sa&&(clearTimeout(sa),sa=null)};p()?(i("div.page.chat div.header div.button.phone").addEventListener("touchstart",e,{passive:!0}),i("div.page.chat div.header div.button.phone").addEventListener("touchend",n)):(i("div.page.chat div.header div.button.phone").addEventListener("mousedown",e),i("div.page.chat div.header div.button.phone").addEventListener("mouseup",n)),i('div.callmenu div.item[data="callconnect"]').addEventListener("click",Go),i('div.callmenu div.item[data="twiliocall"]').addEventListener("click",Go),i('div.callmenu div.item[data="webrtccall"]').addEventListener("click",Go),i('div.callmenu div.item[data="enablerecord"]').addEventListener("click",$o),i('div.callmenu div.item[data="enabletranscribe"]').addEventListener("click",Vo),i('div.callmenu div.item[data="enablevideo"]').addEventListener("click",Ko),i("div.callmenu div.item.close").addEventListener("click",Yo),function(){if(i("div.page.chat div.textarea > textarea").addEventListener("click",(function(e){t("received textarea click"),e&&hs("chat input"),"Type message here"==e.currentTarget.value&&(e.currentTarget.value="",e.currentTarget.select()),u()&&To("input")})),i("div.page.chat div.textarea > textarea").addEventListener("focus",(function(e){t("received textarea focus"),"Type message here"==e.currentTarget.value&&(e.currentTarget.value="",e.currentTarget.select());let n=i("div.page.chat div.textarea > textarea"),a=i("body[isProvider=true] div.page.chat div.textarea"),o=i("body[isProvider=true] div.page.chat div.input"),r=i("body[isProvider=true] div.page.chat div.history");if(n.scrollHeight>60){o?.setAttribute("style","height:auto;");let e=n.scrollHeight>90?90:n.scrollHeight;a?.setAttribute("style","z-index:30; height:"+e+"px;"),r?.setAttribute("style","bottom:"+(e+10)+"px;"),e>90&&o?.setAttribute("style","height:"+e+"px;"),n.scrollHeight>90&&n.setAttribute("style","overflow-y:scroll;");let t=i("div.input div.clipboard-image"),s=document.querySelector("body").getAttribute("isProvider");s&&"true"==s&&t.setAttribute("style","bottom:"+e+"px;")}else r?.setAttribute("style","bottom:60px;");!Ta&&u()&&p("ios")&&setTimeout((function(){t("scrollTop="+document.body.scrollTop),document.body.scrollTop>0&&(t("show virtual keyboard"),bd(!0),setTimeout((function(){i("div.page.chat div.textarea > textarea").scrollIntoView(!1)}),0))}),0)})),i("div.page.chat div.textarea > textarea").addEventListener("blur",(function(e){if(t("received textarea blur"),!Ta&&u()&&p("ios")&&setTimeout((function(){0==document.body.scrollTop&&(t("hide virtual keyboard"),bd(!0))}),0),i("div.page.chat div.textarea").setAttribute("style",""),i("div.page.chat div.input").setAttribute("style",""),i("body[isProvider=true] div.page.chat div.history")?.setAttribute("style","bottom:60px"),ja.length){let e=i("div.input div.clipboard-image"),t=document.querySelector("body").getAttribute("isProvider");t&&"true"==t&&e.setAttribute("style","bottom:60px;")}this.scrollTop=this.scrollHeight})),i("div.page.chat div.textarea > textarea").addEventListener("input",Co),i("div.page.chat div.textarea > textarea").addEventListener("keydown",Mo),i("div.page.chat div.textarea > textarea").addEventListener("paste",Po),p()||"undefined"==typeof EmojiButton)"undefined"!=typeof EmojiButton&&i("div.page.chat div.input div.button.emoji").setAttribute("style","display: none;");else{const e=new EmojiButton({theme:"auto",zIndex:10,emojiVersion:5});e.on("emoji",(e=>{i("div.page.chat div.textarea > textarea").value+=e})),i("div.page.chat div.input div.button.emoji").addEventListener("click",(()=>{e.togglePicker(i("div.page.chat div.input div.button.emoji"))}))}}();var a=function(e){e&&hs("overlay mask"),Bn?(Bn.removeAttribute("selected"),Bn=null,yn=l("selectedmessage",!1,yn)):wi||bn||wn||Us||xn||Oi?(wi=l("showmenu",!1,wi),bn=l("showchatmenu",!1,bn),wn=l("showcallmenu",!1,wn),Us=l("showpresencemenu",!1,Us),xn=l("expandchattitle",!1,xn),Oi=l("showtodomenu",!1,Oi)):"desktop"!=ql&&Kr&&(Kr=l("chattab","",Kr))};i("div.mask").addEventListener("click",a),i("div.chatmask").addEventListener("click",a),i("div.page.chat div.header div.name").addEventListener("click",wr),i("div.page.chat div.header div.tags").addEventListener("click",wr),i("div.page.chat div.expanded input.addtag").addEventListener("keyup",hr),i("div.page.chat div.expanded input.editname").addEventListener("keyup",vr),i("div.page.chat div.workflowcontrol > div.close").addEventListener("click",Fr),v(i("div.page.chat div.header"),{down:Tr,left:xr,right:_r}),v(i("div.controls > div.header"),{down:Tr,right:kr}),Xn=r("send");var o=r("hide")||[];document.body.setAttribute("hide",o.join(" ")),o=r("show")||[],document.body.setAttribute("show",o.join(" ")),o.indexOf("chat-selected")>=0&&(Tn=!0)}function Wa(){if(null!=Cn&&Cn.isConnected())t("WARN: chat-connect called when already connected");else{if(Et&&"dialpad"==kt){const e=document.getElementById("page-chat");e&&!e.classList.contains("dialpad-chat")&&e.classList.add("dialpad-chat")}Sn=""+Yl.auth.user_id,Mn||(Mn="-"+(""+Math.random()).substr(2,8)),t("chat-connect "+Kl.message+" "+Sn+"-"+On+Mn),(Cn=new Paho.Client(Kl.message,Sn+"-"+On+Mn)).onConnectionLost=$a,Cn.onMessageArrived=lo,Cn.connect({onSuccess:Ba,onFailure:Ga,keepAliveInterval:10,timeout:15,cleanSession:!1})}}function Ba(){t("on-chat-connect-success"),_s(),zn=.5;var e=function(e){for(var i=0;i<e.length;++i){var n=e[i];"notification///"!=n.substr(0,15)?(Y||t("subscribe_to_chatpaths "+n),us("chatpath-subscribe",{path:n}),Cn.subscribe(n,{qos:2})):t("ignoring subscribe to /// without /+/+/")}},i=function(t){for(var i=[],n=0;n<t.length;++n){var a=t[n].path;jn.indexOf(a)<0&&(i.push(a),jn.push(a))}Qn||(i=jn),e(i),Qn=!0,qn=0,ro(),no((function(){Ur("success")}))};1==Et?Yl.get_chat_paths(i,(function(i){t("failed to get chat paths - "+i+", chat_subsribed: "+Qn+", chat_paths: "+jn.length),0==Qn&&jn.length&&e(jn),Qn=!0,ro(),no((function(){Ur("success")}))})):i([{path:"notification/+/+/"+Yl.auth.user_id+"/#"}])}function Ga(e){5==qn?(Ye("Cannot connect to chat server.  Check your network connection.","Error"),qn=0):t("Cannot connect to chat server.  Check your network connection. Retry counter: "+ ++qn),t("on-chat-connect-failure"),t(e),us("chatpath-connect-failure",{retry_pending:qn,error:e?e.errorMessage:"undefined"}),Cn&&Ka()}function $a(e){t("on-chat-disconnect"),us("chatpath-disconnect",{error:e?e.errorMessage:"undefined"}),Cn?(t(e&&e.errorMessage||"error is undefined"),setTimeout((function(){Cn&&Cn.isConnected()||5!=qn?t("Disconncted from chat server. Check your network connection: retry remaining: "+ ++qn):(Ye("Disconnected from chat server.  Check your network connection.","Error"),qn=0)}),2e3),Ka()):t("disconnected the connection")}function Va(){if(null!=Cn){us("chatpath-disconnect",{function:"chat-disconnect",message:"shutting down"}),t("chat-disconnect");var e=Cn;if(e.isConnected())try{_s()}catch(e){}Cn=null,e.isConnected()&&setTimeout((function(){try{e.disconnect()}catch(e){}}),100)}jn=[],lc(),Cd(!1),Un&&(clearTimeout(Un),Un=null)}function Ka(){Cd(!0),Un&&(clearTimeout(Un),Un=null),t("will retry in "+zn+" seconds"),Un=setTimeout(Xa,1e3*zn),zn=Math.min(2*zn,30)}function Ya(){t("in chat_attempt_to_reconnect after a network failure"),us("chatpath-reconnect",{function:"chat-attempt-to-reconenct",message:"Attempt to reconnect after the retry timer"}),Yl.configure((function(e){1==e?(t("in chat_attempt_to_reconnect.  api/configure succeeded. Verify path status. "),Yl.get_chat_paths((function(e){e.length<=1?(t("chat_attempt_to_connect: no active sessions on server. close client"),oo()):(t("chat_attempt_to_connect: Reconnect to  messaging channel."),Va(),Qn=!1,Wa())}),(function(e){t("in chat_attempt_to_reconnect. failed to retrieve paths for logged in user: "+e),Ga(e)}))):(t("in chat_attempt_to_reconnect: api/configure failed.  Retrying...., error: "+e),Ga(e))}),void 0,void 0,Qt,void 0)}function Xa(){Un=null,Cn&&(Bl?(t("retrying..."),Et?(Va(),Qn=!1,Wa()):Ya()):(Cd(!1),zn=.5,t("delaying retry because the app is not in foreground")))}function Za(e){e&&(Un||!Cn||Cn.isConnected()||(t("retrying connection on wakeup"),Cd(!0),Et?(Va(),Wa()):Ya()))}function Qa(e){let t="";switch(e){case"chatclose_message":t="Close this conversation?";break;case"chatassign_message":t="Assign this chat to %s?"}let i=w()?w().slice(0,2):"en";return hn&&hn[e]&&hn[e][i]?hn[e][i]:t}function eo(e){var n=e,a=e.split("/");if(a.length>0){var o=a.shift();e=a.length>0&&a[0].search("=")<0?a.join("/"):$n&&$n.chat_id==o?$n.path:"";var r=null;if(a.length>0&&a[0].search("=")>=0){var s=a[0].search("=");r={name:a[0].substr(0,s),value:a[0].substr(s+1)},t("scroll-to "+JSON.stringify(r))}Hn&&Ln&&ma&&Et&&"readonly"!=jl&&on(Hn,!0),Et&&!r&&void 0!==Xi[o]?(t("loading existing chat-tab"),function(e){for(var t=null,i=0;i<Ii.length;++i){var n=Ii[i];if("chat"==n.type&&n.id==e){t=n;break}}t&&ji(t)}(o),vs("load-saved-chat-tab",{chat_id_:o}),rn(o),"email"==Ca?(bi({input:!1,attach:!1}),El("active"===oa&&Ma.lastEmail&&!(!0===Ma.showComposer))):El(!1),mo(),cr("chat",o,xa),or(wa),sr(ba),pr(_a),an("",!0),Kr&&Zr(Kr),Ur("success")):e?(Cd(!0),Yl.get_customer_chat_info(o,(function(t){na=t.participants||[],aa,aa=t.customer||"",fa=t.sequence,oa=t.state||"active",ha.splice(0,ha.length),ga.splice(0,ga.length),Ca=t.channel,t.channelinfo&&t.channelinfo.providerChannelVendor&&t.channelinfo.providerChannelId&&t.channelinfo.userChannelId?(Sa=t.channelinfo.providerChannelVendor,Ia=t.channelinfo.providerChannelId,Oa=t.channelinfo.userChannelId):Ia=Oa=Ma=null,ps("conversation data",{customerid:aa,sequence:t.sequence,participants:t.participants||[]}),Yl.get_provider_profile(t.provider,(function(n){n.branding&&Vt&&Qt==n.id&&zr(n.branding),n.config&&n.config.input_textarea_placeholder&&function(e){if(lang=navigator.language.slice(0,2),e&&(placeholder=e[lang],placeholder&&""!=placeholder)){let e=i("div.page.profile div.textarea > textarea");e&&(Array.isArray(e)&&e.length>0?e[0].placeholder=placeholder:e.placeholder=placeholder)}}(n.config.input_textarea_placeholder),n.name&&Md(n.name),Cd(!1),to(o,e,n.id,t.participants,n,r)}),(function(t){Cd(!1),to(o,e,void 0,void 0,void 0,r)}))}),(function(t){Cd(!1),to(o,e,void 0,void 0,void 0,r)}))):(Et&&El(!1),Cd(!0),Yl.get_chat_path(o,(function(e){Cd(!1);var t=e[0];$n={chat_id:o,path:t.path},eo(n)}),(function(e){Cd(!1),Ye("failed to get chat context - "+e,"Error"),Gn&&Sd("#chatwith/"+Gn,void 0,!0)})))}else Ur("error","no chat argument found")}function to(e,a,r,s,c,d){for(var u in Ln=c,Hn=e,Pn=a,Vn.splice(0,Vn.length),Kn=0,ca=!1,da=200,ua="show",pa=!1,mn=0,Qn=!1,ea=!1,ta=!1,Jn=[],vs("chat starting",{path:Pn,isprovider:Et,channelid:Pa||void 0}),Et&&Wr(),Dn.splice(0,Dn.length),Rn)delete Rn[u];if(null==Fn&&Kl.myprofile&&Kl.myprofile.picture&&(Fn=Kl.myprofile.picture,Yl.set_src(null,Kl.myprofile.picture,(function(e){Fn=e,e&&e.startsWith("blob:")&&Le["use-dataurl-for-sender"]&&void 0===La[e]&&go(e,(function(t){La[e]=t}))}))),c&&c.config&&(c.config.sneak_peek&&(ca=!0,"number"==typeof c.config.sneak_peek?da=c.config.sneak_peek:"string"==typeof c.config.sneak_peek&&(ua=c.config.sneak_peek)),c.config.hidden_input&&fa&&!Et&&bi({input:!1,attach:!1}),pa=!(!c.config.autosuggest||!fa),c.config.widget_path&&function(e){if(Array.isArray(e)&&e.length>0){for(var i=0;i<e.length;i++)nc[i]=decodeURIComponent(e[i]);t("Configured widget path: "+nc)}}(c.config.widget_path),c.config.client_confirm_messages&&(hn=c.config.client_confirm_messages)),Js(c&&c.status||"available"),vn=l("ismultiuser",!1,vn),kn=l("editchatuserinfo",!1,kn),i("div.page.chat div.header div.name").innerHTML=n(c&&c.name||"nobody else"),i("div.page.chat div.header div.tags").innerHTML=(c&&c.tags||[]).map((function(e){return"<span>"+n(e)+"</span>"})).join(""),Er(),p("ios")||(i("div.page.chat div.textarea > textarea").select(),i("div.page.chat div.textarea > textarea").focus()),s.includes(Yl.auth.user_id)&&"readonly"!=jl?i("div.page.chat div.input").setAttribute("state",oa):i("div.page.chat div.input").setAttribute("state","inactive"),s.length>0)for(var f=0;f<s.length;++f)vo(s[f]);null!=Cn&&Cn.isConnected()?(jn.indexOf(Pn)<0&&(jn.push(Pn),Y||t("chat-subscribe "+Pn),Cn.subscribe(Pn,{qos:2})),Qn=!0,ro()):(t("add to chat_paths "+Pn),jn.push(Pn)),dn(a),an("",!0),i("div.page.chatside div.useractivity div.content").innerHTML="",chatside_useractivity_last="";var h=Ln.config.load_history;"transition"==h&&"true"!=o("loadscreen")&&(h="hidden");var g=function(){_o({type:"info",text:"Show History",action:{invoke:"chathistory",args:["this"]},className:"showhistory",style:"float: right; margin-right: 10px; margin-bottom: 20px;"})};if("always"==h||"segment"==h||Zl&&!Ua||"hidden"==h&&d){var v=null;("segment"==h||Zl)&&(t("Setting to transition to load history for sticky session"),v={load_history:"transition"}),("segment"==h||Zl&&"never"!=h)&&g();var m=function(){no((function(){Ur("success")}))};io(v,d,(function(){m()}),(function(){io(v,d,(function(){m()}),(function(){Rr(),m()}))}))}else ea=!0,ro(),no((function(){Ur("success")})),"never"!=h&&g();Et||function(e){var i=kd("trackhistory");if(i&&"true"==i&&e)try{var n=JSON.parse(localStorage["koopid.url_tracker_"+e]||"null");n?Yl.post_customer_provider_context("this",e,n,void 0,(function(i){t("post-customer-url-history failed for id="+e+" error="+i)})):t("post-customer-url-history empty for id="+e)}catch(i){t("post-customer-url-history exception for id="+e+" exception="+i)}}(r),Et&&(cr("chat",e),or(),sr()),c&&c.id&&mi(c.id),Et&&Kr&&setTimeout((function(){Zr(Kr)}),500),"desktop"!=ql||i('div.page.chats > div.list > div.item[path="'+Pn+'"]')||en(""),Et&&"email"==Ca&&Il(Hn)}function io(e,i,n,o){Cd(!0),Yl.get_chat_messages(Hn,e,(function(e){if(Cd(!1),ea=!0,e.length<=0)return t("No messages received to load history for chat: "+Hn),ro(),void a(o);if("email"!=Ca){for(var r=-1,s=[],c=null,l=0;l<e.length;++l){var d=e[l];if(d.data&&d.data.displaycontrols&&d.data.displaycontrols.map&&(c=d.data.displaycontrols.map),i&&(d[i.name]==i.value||"segment"==i.name&&"segment"==d.type&&d.data&&d.data.next==i.value)&&(r=l),"htmlwidget"!=d.type&&"widget"!=d.type&&"inlinewidget"!=d.type||l==e.length-1){var u=Gr(d);s.push(u),fo(u,r<0&&l==e.length-1,!0,l)}}!Et&&c&&bi(c),function(e){if(t("pending_received_messages="+(Jn&&Jn.length)),Qn&&ea&&Jn&&Jn.length>0)for(;Jn.length>0;){var i=null;if(e)try{i=e[e.length-Jn.length]}catch(e){t(e)}var n=Jn.shift(),a=n[0],o=n[1],r=n[2],s=n[3];i&&i.type==a.type&&Math.round(i.timestamp/100)==Math.round(a.timestamp/100)&&i.htmlText==a.htmlText&&i.text==a.text||(null!=Wn?Wn.push([a,o,r,s]):a&&("typing"==a.type||"chat"==a.type)&&a.senderId&&a.senderId!=Sn&&void 0===Rn[a.senderId]?(Wn=[[a,o,r,s]],ho()):_o(a,o,r,s))}}(s),ro(),r>=0&&To(r,!1,"segment"==i.name),a(n)}}),(function(e){Cd(!1),t("Unable to load history for chat: "+Hn+", error: "+e),Yl.post_chat_path(Hn,Pn),ea=!0,ro(),a(o||n)}))}function no(e){if(t("on-chat-started "+Hn+" chat-subscribed="+Qn+" chat-loaded="+ea+" chat-started="+ta+" channelid="+(Pa||"undefined")),Qn&&ea&&!ta){ta=!0;var i=!!Et||Zn;Zn=!1,!Et&&Zl&&(Ua&&Ua!=Hn||(i=!0),Ua=Hn),Yl.post_chat_status(Hn,"started",i,(function(){a(e),x({type:"chatstart",id:Hn,participant:Et?aa:Yl.auth.email,channelid:Pa||"undefined"},"*")}),(function(t){a(e)})),function(){var e=Object.keys(Rn).map((function(e){return{id:e,name:Rn[e].name,bot:Rn[e].bot}})),t=function(e){ps("chat",{chat:Hn,provider:{id:Ln.id,name:Ln.name},bot:e.filter((function(e){return e.bot})).length>0,users:e}),vs("user started chat",{})},i=na.filter((function(e){return e!=Sn}));if(0==e.length&&i.length>0){var n=i.length;e=[];for(var a=0;a<i.length;++a)Yl.get_customer_profile(i[a],(function(i){var a={bot:i.isBot,email:i.email,name:i.name,phone:i.phone};e.push(a),--n<=0&&t(e)}),(function(i){--n<=0&&t(e)}))}else t(e)}()}}function ao(e,t,i,n,a){t&&e&&Pi({title:i,type:"chat",id:t,sender:e,chat:t,subtitle:n,action:{path:"chat/"+t}},!0)}function oo(e){if(t("on-chat-close-click()"),!e||!e.keyCode||13==e.keyCode){var n=!1;this==i("div.content > div.button.chatclose")&&(n=!0,t("Logging off and closing session..."),hs("chat close button explicit",{id:Hn}));var a=function(){hs("chat close confirm",{id:Hn,sessionclose:n});var e=ma;ma=!0;var a=page;if(Od(),"chat"==a){e&&Et&&on(Hn),!e&&Et&&sn(Hn);let a=Hn,c=0;if(Hn&&Ln){Yl.post_chat_status(Hn,"stopped");var r=Yl.auth&&Yl.auth.email;Et&&(r=aa,Fa.delete(aa)),c=r,x({type:"chatstop",id:Hn,participant:r},"*"),n&&x({type:"chat-closed",id:Hn,participant:r},"*")}i("div.page.chatside div.useractivity div.content").innerHTML="",chatside_useractivity_last="",bn=l("showchatmenu",!1,bn),wn=l("showcallmenu",!1,wn),Us=l("showpresencemenu",!1,Us),gn=l("istyping",!1,gn),kn=l("editchatuserinfo",!1,kn),Hn=null,Ln=null,Pn=null,Qn=!1,ea=!1,ta=!1,ka="",fa=!1,qa=void 0,ha.splice(0,ha.length),ga.splice(0,ga.length),Jn=null,mn=0;for(let e in Rn)delete Rn[e];Dn.splice(0,Dn.length),vn=l("ismultiuser",!1,vn),Fn=null,an(),setTimeout((function(){"profile"!=page&&"chat"!=page&&(i("div.page.chat div.header div.name").innerHTML=""),!Et&&n?zd(void 0,!0):Er()}),200),Nn.forEach((function(e){try{(window.URL||window.webkitURL).revokeObjectURL(e)}catch(i){t("failed to revokeObjectURL "+e)}})),Nn.splice(0,Nn.length),Vn.splice(0,Vn.length),Kn=0,ca=!1,da=200,ua="show",pa=!1;for(let e in La)delete La[e];if(Sc(),Et)bi({"*":!0});else{bi({input:!1,attach:!1});var s=o("home");s&&!s.startsWith("frontpage")&&(i("body div.body").style.filter="opacity(0.3)"),n&&(i("div.content > div.button.minimize").removeEventListener("click",er),i("div.content > div.button.chatclose").removeEventListener("click",oo),i("div.content > div.button.chatclose").addEventListener("click",(function(){x({type:"chat-closed",id:a,participant:c},"*")})))}}else x({type:"chat-closed",id:Hn||"undefined",participant:r||"undefined"},"*");za=!1,lc()},r=!0;"chat-close-require-user-confirmation"in Le&&(r=Le["chat-close-require-user-confirmation"]),!Et&&r&&n?b({title:"",message:Qa("chatclose_message"),buttons:{Close:{class:"orange",action:a},Cancel:{class:"gray",action:void 0}}}):a()}}function ro(){if(Xn&&Xn.length>0&&Qn&&ea&&!Zl){var e=!0,i=null;for(Zn=!0;Xn&&Xn.length>0&&ea;){var n=Xn.shift();if(n){var a={type:"chat",text:n};if("{"==n.substr(0,1))try{a=JSON.parse(n)}catch(e){t("failed first-time-send JSON parse: "+n+": "+e)}if(Xn.length>0&&a.text&&a.data&&/assign/i.test(a.text)){if(!i){i=a.data;continue}i=a.data,a.data=i}else i&&(a.data=a.data||{},a.data.embeddedassign=i,i=null);e&&(a.data=a.data||{},a.data.abort=e,e=!1),so(a),ys("send first time",{type:a.type,size:(a.htmlText||a.text||"").length})}else t("warn: empty send param is deprecated")}0==Xn.length&&(Xn=null)}}function so(e,n){try{Et||"typing"==e.type||Jr(),Et&&"typing"!=e.type&&Wr(),void 0===e.senderName&&(e.senderName=Kl.myprofile?Kl.myprofile.name:Yl.auth.email),void 0===e.senderId&&(e.senderId=Sn),e.timestamp=(new Date).getTime(),"chat"!=e.type||e.data||(e.data={action:{path:"chat/"+Hn}});var a=Br(e);!Et&&Pa&&(a.channelinfo={type:"webchat",info:{userChannelId:Sn,userChannelName:Kl.myprofile?Kl.myprofile.name:Yl.auth.email,providerChannelId:Pa,providerChannelVendor:"dialpad"}});var o=!1;if(!fa||n&&n!=Pn||"typing"==a.type||"placeholder"==a.type||"ack"==a.type||"updatemessage"==a.type?"chat"==a.type||"info"==a.type?function(e,i){if(!e.id){var n=(""+Math.random()).substr(2,8);e.id=n}e.ack=!0;var a=i,o=null,r=null;e.senderName&&(r=e.senderName);e.senderId&&(o=e.senderId);ia[e.id]={};var s=Hn,c=na.slice(0);setTimeout((function(){if(e.id in ia){delete ia[e.id];var i={type:"updatemessage",id:e.id,data:{type:"replace",field:"delivery"}};r&&(i.senderName=r),o&&(i.senderId=o);let u="notifying";i.text=u,i.data.value={status:u},so(i,a);for(var n=0;n<c.length;++n){var l=c[n];if(l!=Sn){var d={providerChannelVendor:Sa};null!=Oa&&(d.userChannelId=Oa),null!=Ia&&(d.providerChannelId=Ia),Et&&ws("devicenotification",{senderName:e.senderName,message:e.text||"I sent an HTML message",chat:{id:s},provider:Qt,sendertType:"agent",channelinfo:{type:Ca,msgid:e.id,info:d}}),Yl.send_device_notification(l,e.senderName,e.text||"I sent an HTML message",s,Et?"agent":"customer",{type:Ca,msgid:e.id,info:d},(function(){let e="notified";i.text=e,i.data.value={status:e},so(i,a)}),(function(e){t("failed to send notification too");let n="failed";i.text=n,i.data.value={status:n},so(i,a)}))}}}}),25e3)}(a,n||Pn):"media"!=a.type&&"location"!=a.type||a.id||(a.id=(""+Math.random()).substring(2,8)):(!function(e){if(!e.id){var t=(""+Math.random()).substr(2,8);e.id=t}e.ack=!0,ia[e.id]={};var i=Hn;e.id,e.text;setTimeout((function(){i==Hn&&e.id in ia&&(Ye("We are having trouble with your current session. Please close the chat window, restart your browser, and relaunch your chat session.","Warning"),us("ack-pending",{text:"We are having trouble with your current session. Please close the chat window, restart your browser, and relaunch your chat session."}))}),35e3)}(a),o=!0),Y||t("chat-send "+(n||Pn)+" "+JSON.stringify(a).substr(0,1e3)),!n&&!Pn)throw new Error("missing chat path");o?(ha.push({topic:n||Pn,payload:Q(n||Pn,a)}),1==ha.length&&co()):(Cn.send(n||Pn,Q(n||Pn,a),2,!1),ys("message send",a)),"typing"!=e.type&&"progress"!=e.type&&(Yl.post_chat_message(Hn,a),"updatemessage"!=e.type&&function(e){if(Et&&e){var t=i('div.page.chats div.item[path="'+e+'"]');t&&t.setAttribute("state","active")}}(n||Pn))}catch(e){t(e),e&&e.toString().indexOf("not connected")&&(e="please wait for the connection to be re-established"),Ye("Cannot send - "+e,"Error")}}function co(){if(ha.length>0){var e=ha[0];Cn.send(e.topic,e.payload,2,!1),ys("message send sequenced",ee(e.topic,e.payload))}}function lo(e){try{var a=ee(e.destinationName,e.payloadString);if(Y||t("chat-received "+e.destinationName+" "+JSON.stringify(a||"").substr(0,1e3)),result=function(e,t,i){var n={};if(e.sender!==Sn&&("ack"==e.type||"updatemessage"==e.type&&e.data&&e.data.field&&"delivery"==e.data.field&&e.data.value)){let i=e.text,n=e.data&&e.data.errors?e.data.errors:null;"updatemessage"==e.type&&e.data.value.status&&(i=e.data.value.status,n=e.data.value[i]),delete ia[e.id],fa&&t==Pn?(br(e.id,"processed"==i?"delivered":"failed","failed"==i?n:null),ha.splice(0,1),co()):t==Pn?br(e.id,"processed"==i?"delivered":i,"failed"==i?n:null):cn(e,t),ws("processed"==i?"delivered":i,e)}else if(n.message=e,e.ack&&e.sender!==Sn){n.ack={},n.ack.path=!0===e.ack?t:e.ack;let a={status:i};e.data&&e.data.delivery&&e.data.delivery&&e.data.delivery.vendorMsgIds&&(a.vendorMsgIds=e.data.delivery.vendorMsgIds),n.ack.message={type:"updatemessage",id:e.id,text:i,data:{type:"replace",field:"delivery",value:a}}}return n}(a,e.destinationName,"delivered"),result.ack)so(result.ack.message,result.ack.path);if(result.message){var o=Gr(result.message);if("readonly"!=jl&&function(e,n){if("notification"==e.type){var a=e.message;if("action"==a.type)!e.allow||!Et&&e.allow.indexOf("customer")>=0||Et&&e.allow.indexOf("agent")>=0?Se(a.action,["path","url","popup","invoke"],!0):t("dropping action as not allowed");else if(a.webrtccall)!function(e,i,n){"invite"==n.type?al(e,i,n.callid,n.params):"answer"==n.type?(a=e,o=n.callid,"inviting"==Hc?a==Yc&&o==Xc?(Hc=l("callstate","active",Hc),Zc=(new Date).getTime(),fl(),pl(Yc,{type:"cancel",callid:Xc}),il&&il.video&&(Vc=l("hasvideo",!0,Vc)),rl((function(){sl(!0),dl(),u()?el.createOffer((function(e){t("webrtccall: offer from pc\n"+e.sdp),el.setLocalDescription(e,(function(){pl(Yc,{type:"signal",data:e})}),(function(e){t("webrtccall: failed to set local session description: "+e)}))}),(function(e){t("webrtccall: failed to create offer: "+e)}),{offerToReceiveAudio:1,offerToReceiveVideo:Vc?1:0,voiceActivityDetection:!1}):el.createOffer({offerToReceiveAudio:1,offerToReceiveVideo:Vc?1:0,voiceActivityDetection:!1}).then((function(e){return t("webrtccall: offer from pc\n"+e.sdp),el.setLocalDescription(e)})).then((function(){pl(Yc,{type:"signal",data:el.localDescription})})).catch((function(e){t("webrtccall: failed to create offer or set local description: "+e)}))}),(function(e){"invalid call"!=e&&(Ye("Failed to get user media, terminating","Error"),ol())}))):t("webrtccall: ignoring answer as not the same call"):t("webrtccall: ignoring answer in "+Hc)):"decline"==n.type?function(e,i,n){"inviting"==Hc?e==Yc&&i==Xc?(Rc=l("calltype","",Rc),Hc=l("callstate","idle",Hc),Vc=l("hasvideo",!1,Vc),Ye("call failed: "+n,"error"),pl(Yc,{type:"cancel",callid:Xc}),Yc=null,Xc=null):t("webrtccall: ignoring answer as not the same call"):t("webrtccall: ignoring decline in "+Hc)}(e,n.callid,n.reason):"cancel"==n.type?function(e,i,n){if("invited"==Hc){if(e==Yc&&n==Xc)Rc=l("calltype","",Rc),Hc=l("callstate","idle",Hc),Vc=l("hasvideo",!1,Vc),Xe(!0,!0,i,"Missed call. Click to answer or close to decline",0,!0,"webrtccall-"+e,{webrtccall:{type:"incoming",callid:n,senderId:e,senderName:i}},!1);else t("webrtccall: ignoring cancel as not the same call")}else t("webrtccall: ignoring cancel in "+Hc)}(e,i,n.callid):"bye"==n.type?function(e,i,n){"idle"!=Hc?e==Yc&&i==Xc&&(t("webrtccall: close the peer connection"),ul(),Ye(n||"Terminated by the other side","Call Closed")):t("webrtccall: ignoring bye in "+Hc)}(e,n.callid,n.reason):"signal"==n.type?"offer"==n.data.type||"answer"==n.data.type?function(e,i,n){"active"==Hc?null!=el?(t("webrtccall: received sdp\n"+JSON.stringify(n)),u()?el.setRemoteDescription(new RTCSessionDescription(n),(function(){"offer"==n.type?el.createAnswer((function(e){t("webrtccall: answer from pc\n"+e.sdp),el.setLocalDescription(e,(function(){pl(Yc,{type:"signal",data:e})}),(function(e){t("webrtccall: failed to set local session description: "+e)}))}),(function(e){t("webrtccall: failed to create answer: "+e)})):t("webrtccall: received answer from other side")}),(function(e){t("webrtccall: failed to set remote session description: "+e)})):el.setRemoteDescription(new RTCSessionDescription(n)).then((function(){"offer"==n.type?el.createAnswer().then((function(e){return t("webrtccall: answer from pc\n"+e.sdp),el.setLocalDescription(e)})).then((function(){pl(Yc,{type:"signal",data:el.localDescription})})).catch((function(e){t("webrtccall: failed to create answer or set local description: "+e)})):t("webrtccall: received answer from other side")})).catch((function(e){t("webrtccall: failed to set remote session description: "+e)}))):t("webrtccall: pc is null"):t("webrtccall: ignoring session description in "+Hc)}(0,n.callid,n.data):function(e,i,n){"active"==Hc?null!=el?u()?el.addIceCandidate(new RTCIceCandidate(n),(function(){t("webrtccall: add ice candidate success")}),(function(e){t("webrtccall: failed to add ice candidate: "+e)})):el.addIceCandidate(new RTCIceCandidate(n)).then((function(){t("webrtccall: add ice candidate success")})).catch((function(e){t("webrtccall: failed to add ice candidate: "+e)})):t("webrtccall: pc is null"):t("webrtccall: ignoring ice candidate in "+Hc)}(0,n.callid,n.data):"recording"==n.type&&webrtc_received_recording(e,i,n.callid,n.dataurl);var a,o}(e.senderId,e.senderName,a.webrtccall);else if(e.message&&e.message.html)if(!e.allow||!Et&&e.allow.indexOf("customer")>=0||Et&&e.allow.indexOf("agent")>=0)if(Et||"contact"!=e.message.type){var o={sender:e.senderId,notification:e.message},r=uo(e.message.html);Xe(!0,!0,e.message.name,r,0,!0,a.target,o,!Et||5e3)}else t("dropping notification of type contact: "+JSON.stringify(e));else t("dropping notification as not allowed");else"presence"==a.type?null!=a.data&&a.data.userid==Sn&&null!=a.data.status&&(i("div.controls div.header div.presence").innerText=a.data.status,At=l("presencestate",a.data.status,At)):t("failed to understand the notification message.")}else if(!("chat"!=e.type&&"media"!=e.type&&"location"!=e.type||"chat"==page&&Pn==n&&Bl&&Gl)){var s=!("chat"==page&&Pn==n);if(e.action||e.data&&e.data.action){var c=e.action||e.data&&e.data.action,d=(o={sender:e.senderId,action:c},r=e.text||uo(e.htmlText),e.channelinfo&&e.channelinfo.info.userChannelName?e.channelinfo.info.userChannelName:e.senderName);Xe(s,!0,d,r,0,!0,n,o,!!Et&&5e3),s&&Et&&c.path&&"chat/"==c.path.substr(0,5)&&ao(e.senderId,c.path.split("/")[1],e.senderName,r)}else Yl.get_chat_id(n,(function(i){if(i&&1==i.length&&i[0].id){var a={path:"chat/"+i[0].id},o={sender:e.senderId,action:a},r=null;function c(a){!e.allow||!Et&&(e.allow.indexOf("customer")>=0||e.allow.indexOf("guest")>=0)||Et&&e.allow.indexOf("agent")>=0?Xe(s,!0,a,r,0,!0,n,o,!!Et&&5e3):t("dropping action as not allowed"),s&&Et&&ao(e.senderId,i[0].id,e.senderName,r)}r="location"==e.type?"Location":"media"==e.type?"Media":e.text||uo(e.htmlText);let l=Fa.get(e.senderId);l?c(l.name):Yl.get_customer_business_profile(e.senderId,Yl.auth.providerId,(function(t){Fa.set(e.senderId,t,300),c(t.name)}),(function(t){c(e.channelinfo&&e.channelinfo.info.userChannelName?e.channelinfo.info.userChannelName:e.senderName)}))}else Ye("invalid response for chat id","Error")}),(function(e){Ye("failed to get the chat id from path","Error")}))}}(o,e.destinationName),"notification"!=o.type&&"chat"==page&&Pn==e.destinationName){if(Et&&null!=o.channelinfo&&o.channelinfo.info){var r=o.channelinfo.type,s=o.channelinfo.info.providerChannelVendor;null!=r&&null!=s&&(Ca=r,Sa=s,void 0!==o.channelinfo.info.userChannelId&&(Oa=o.channelinfo.info.userChannelId),void 0!==o.channelinfo.info.providerChannelId&&(Ia=o.channelinfo.info.providerChannelId))}fo(o),yr(o)}else"notification"!=o.type&&cn(o,e.destinationName);"notification"!=o.type&&"typing"!=o.type&&function(e,n){var a=i('div.page.chats div.list > div.item[path="'+n+'"]');if(a){if(Le["show-interactions-count"])try{var o=a.querySelector("div.count");o.setAttribute("data",""+(parseInt(o.getAttribute("data"))+1))}catch(e){}if(Le["require-agent-name"]&&e.senderName&&"Guest User"!=e.senderName&&"senderName"!=e.senderName&&a.data&&!a.data.name.startsWith(e.senderName+"@")){var r=a.data.names;r&&r.indexOf(e.senderName)<0&&r.splice(0,0,e.senderName),a.querySelector("div.name span.names").innerText=r?r.join(", "):""}}else t("chat_interaction_received-> path: "+n),tn("",n)}(o,e.destinationName),"notification"!=o.type&&(!o.allow||!Et&&o.allow.indexOf("customer")>=0||Et&&o.allow.indexOf("agent")>=0)&&function(e,a,o){if(["chat","info","widget","inlinewidget","htmlwidget","media","location"].indexOf(e.type)>=0||"segment"==e.type&&e.data&&e.data.segment){if(!o){void 0===Zi[a]?Zi[a]=1:Zi[a]=Zi[a]+1;var r=i('div.page.chats div.list > div.item[path="'+a+'"] div.badge');r&&r.setAttribute("data",""+Zi[a])}var s=i('div.page.chats div.list > div.item[path="'+a+'"] div.timestamp');if(s){var c=new Date(e.timestamp);s.innerHTML="Today, "+c.toLocaleTimeString()}var l=i('div.page.chats div.list > div.item[path="'+a+'"] div.desc');l&&(e.htmlText||e.text)&&(l.innerHTML=Ao(e.htmlText||"",!0)||n(e.text));var d=i('div.page.chats div.list > div.item[path="'+a+'"] div.channelinfo');""!=e.senderId&&d&&Yl.get_customer_type(e.senderId,(function(t){"customer"===t&&e.channelinfo&&(d.setAttribute("data",""+e.channelinfo.type),i('div.page.chats div.list > div.item[path="'+a+'"] div.name span.channelidentity').innerHTML=e.channelinfo.info.userChannelName)}));var u=i('div.page.chats div.list > div.item[path="'+a+'"]'),p=i("div.page.chats div.list").children[0];u&&u!==p&&i("div.page.chats div.list").insertBefore(u,p),u&&"inactive"==u.getAttribute("state")&&(u.setAttribute("state","active"),oa="active",Et&&o&&"email"==Ca&&Il(Hn),na.includes(Yl.auth.user_id)?i("div.page.chat div.input").setAttribute("state",oa):i("div.page.chat div.input").setAttribute("state","inactive"),t("Setting status of chat "+u.getAttribute("id")+" to active")),u&&setTimeout((function(){u.scrollIntoView(!1)}),0)}}(o,e.destinationName,"chat"==page&&Pn==e.destinationName),Et||"autosuggest"!=o.type||Da||ja.length||function(e){var t=null;try{t=JSON.parse(e)}catch(e){}var n=i("div.page.chat div.textarea > textarea").value;if(null==n||""===n.trim())return;var a=i("div.page.chat > div.autosuggest");if(a.innerHTML="",t||t.length>0){t.sort((function(e,t){return t.score-e.score}));var o=document.createElement("div");o.className="list",t.forEach((function(e){if(e.phrase){var t=document.createElement("div");t.className="suggestion",t.innerHTML=e.phrase,o.appendChild(t),t.addEventListener("click",qr)}})),a.appendChild(o),a.setAttribute("state","active")}else a.setAttribute("state","inactive")}(o.htmlText),o.senderId!=Sn&&("notification"==o.type?function(e,t,i){var n=t.split("/");n.length>=4&&"notification"==n[0]?(i.provider=n[1],i.sender=n[2],i.receiver=n[3],ks({type:"notify",text:e,data:i})):bs(e,t,i)}("receive",e.destinationName,{type:"action"==o.message.type?"action":"other",sender:o.senderId}):["chat","info"].indexOf(o.type)>=0?bs("receive",e.destinationName,{type:o.type,size:(o.htmlText||o.text||"").length}):["widget","inlinewidget","htmlwidget","updatehtmlwidget"].indexOf(o.type)>=0?bs("receive widget",e.destinationName,{type:o.type,src:ms(o.src)}):"segment"==o.type&&o.data&&o.data.segment&&bs("receive segment",e.destinationName,{type:o.type}))}}catch(e){t(e)}}function uo(e){return e.replace(/<(?:.|\n)*?>/gm,"").replace(/&amp;/gm,"&").replace(/&lt;/gm,"<").replace(/&gt;/gm,">").replace(/&.*?;/gm,"")}function po(e,t){var i=[];t&&i.push("historical"),i.push(e==Sn?"mine":"yours");var n=!Et&&e==Sn||Et&&e==aa;return i.push(n?"customer":"agent"),i.push(!Et&&n||Et&&!n?"right":"left"),n||i.push(void 0!==Rn[e]?Rn[e].className:"zero"),i.join(" ")}function fo(e,i,n,a){e&&"unknown"==e.senderId?t("ignoring message with senderId=unknown"):e&&Qn&&!ea?(t("add to pending_received_messages"),Jn?Jn.push([e,i,n,a]):t("ignoring pending received message: null")):null!=Wn?(t("add to pending_add_messages"),Wn.push([e,i,n,a])):e&&("typing"==e.type||"chat"==e.type)&&e.senderId&&e.senderId!=Sn&&void 0===Rn[e.senderId]?(t("initialize pending_add_messages, senderId:"+e.senderId+" chat_client_id:"+Sn),Wn=[[e,i,n,a]],ho()):_o(e,i,n,a)}function ho(){if(Wn&&Wn.length>0){var e=Wn.shift(),t=e[0],i=e[1],n=e[2],a=e[3];t&&("typing"==t.type||"chat"==t.type)&&t.senderId&&t.senderId!=Sn&&void 0===Rn[t.senderId]?vo(t.senderId,(function(){_o(t,i,n,a),ho()})):(_o(t,i,n,a),ho())}else Wn&&0==Wn.length&&(Wn=null)}function go(e,i){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="blob",n.onload=function(n){if(200==this.status){var o=new FileReader;o.onload=function(e){a(i,e.target.result)},o.onerror=function(){t("faild to read dataurl from blob: "+e),a(i,null)},o.readAsDataURL(this.response)}else t("failed to get dataurl from bloburl: "+e+" "+this.status),a(i,null)},n.onerror=function(n){t("failed to get dataurl from bloburl: "+e),a(i,null)},n.send()}function vo(e,o){if(e&&e!=Sn&&void 0===Rn[e]){var r=function(r){var s=["zero","one","two","three"],c=mn<s.length?s[mn]:s[0],d=!!Rn[e];Rn[e]={index:mn,name:r.name||"",picture:r.picture||"",className:c,phone:r.phone,email:r.email,bot:r.isBot||!1},d||(Dn.push(r.name),mn=Dn.length,vn=l("ismultiuser",mn>1,vn),Et&&aa&&Rn[aa]?mo():i("div.page.chat div.header div.name").innerHTML=Dn.length>0?n(Dn.join(", ")):""),Et||(document.body.setAttribute("chatsendertype",Rn[e].bot?"bot":"agent"),"agent"==document.body.getAttribute("chatsendertype")&&bi({input:!0,attach:!0}));var u=function(t){try{Rn[e].picture=t}catch(e){}t&&t.startsWith("blob:")&&Le["use-dataurl-for-sender"]&&void 0===La[t]?go(t,(function(e){La[t]=e,a(o)})):a(o)};let p=r.isBot?fd["bot-icon"].startsWith("/kpd-static/")?fd["bot-icon"]:"/kpd-static/providers/"+r.providerId+"/images/"+fd["bot-icon"]:r.picture;t("Picture is: "+p),p.endsWith("providers/0/images/profile.png")?u(p):Yl.set_src(null,p,(function(e){u(e)}),(function(){t("bot profile picture chat-bubble.png not found. Trying default profile picture"),Yl.set_src(null,r.picture,(function(e){u(e)}),(function(){a(o)}))})),!Et||r.isBot||r.isEmployee||Yl.get_customer_business_profiles(e,Kl.myprofile.providerId,(function(t){if(t&&t.length>0){let i;Rn[e].businessProfiles=t;for(let n=0;n<t.length;n++)if("Agent Created"==t[n].channeltype){i=t[n].name,Fa.set(e,t[n],300);break}if(Et){let t=document.querySelectorAll("div.message.customer div.user-details");if(t&&t.length>0&&i)for(let n=0;n<t.length;n++){let a=t[n].querySelector("span.name");a&&"Guest User"==a.innerHTML&&(a.innerHTML=i,Rn[e].picture="providers/0/images/profile.png",yo(t[n],e))}}}}),(function(e){t("failed to get customer business profiles")}))};Yl.get_customer_profile(e,(function(e){r(e)}),(function(t){Yl.get_provider_profile(e,(function(e){r(e)}),(function(){a(o)}))}))}else a(o)}function mo(){var e=Rn[aa],t=(e&&e.name||"Anonymous")+(vn?" +":"");i("div.page.chat div.header div.name").innerHTML=n(t),Yl.set_src(i("div.page.chat div.expanded img"),e.picture),i("div.page.chat div.expanded span.name").innerHTML=n(t),i("div.page.chat div.expanded input.editname").value=t,i("div.page.chat div.expanded span.email").innerHTML=n(e.email),i("div.page.chat div.expanded span.phone").innerHTML=n(e.phone)}function yo(e,i){if(i==Sn)Yl.set_src(e.children[0],Fn);else{let n=Fa.get(i)?.picture||Rn[i]?.picture;if(n)if(n.endsWith("/0/images/profile.png"))Yl.set_src(e.children[0],(Fa.get(i)?.name||Rn[i].name)+":"+n);else if(n.endsWith("/0/images/fbbot.png")){let i=fd["bot-icon"].startsWith("/kpd-static")?fd["bot-icon"]:"/kpd-static/providers/"+Yl.auth.providerId+"/images/"+fd["bot-icon"];t("Bot icon is: "+i),Yl.set_src(e.children[0],i)}else Yl.set_src(e.children[0],n)}}function bo(e){var t=new Date;if(t.getFullYear()==e.getFullYear()){if(t.getMonth()==e.getMonth()&&t.getDate()==e.getDate())return"Today, "+e.toLocaleTimeString();try{return["January","February","March","April","May","June","July","August","September","October","November","December"][e.getMonth()]+" "+e.getDate()+", "+e.toLocaleTimeString()}catch(e){}}return e.toLocaleString()}function wo(e){try{return e.toLocaleTimeString().replace(/:\d\d\s((AM)|(PM)).*/," $1").toLowerCase()}catch(e){t(e)}return e.toLocaleTimeString()}function xo(e,t,i){e&&(t.setAttribute("hasstyle","true"),i.setAttribute("style",e))}function _o(e,a,r,s,c){var d=e.type;if(function(e,t){var i=e.allow||null;null===i&&("widget"==e.type||"inlinewidget"==e.type?i=["customer","guest"]:"progress"==e.type&&(i=["agent"]));if(null===i)return!0;void 0===t&&(t=Kl.myprofile&&Kl.myprofile.email?"guest-"==Kl.myprofile.email.substr(0,6)?"guest":Et?"agent":"customer":"anonymous");return i.indexOf(t)>=0}(e,c))if("typing"==d&&e.senderId&&e.senderId==Yl.auth.user_id)t("dropping own typing message");else if(/^updatemessage$/i.test(d)&&e.senderId!==Sn&&e.data&&e.data.field&&/^delivery$/i.test(e.data.field)&&e.data.value&&e.data.value.status){let t=e.data.value.status;br(e.id,t,e.data.value[t])}else if(Et&&Ln.config&&Ln.config.lang_translation&&["voice"].indexOf(Ca)<0&&/^updatemessage$/i.test(d)&&e.data&&e.data.field&&e.data.value)"translation"==e.data.field&&e.senderId&&e.id&&e.data.value.sourcelang&&e.data.value.translatedlang&&(ra="en"!=e.data.value.sourcelang?e.data.value.sourcelang:ra,e.data.value.sourcelang!=e.data.value.translatedlang?function(e,n,a){let o=i("div.page.chat div.history div.customer[senderid='"+e+"'][id='chat-"+n+"']");if(o&&0==o.getElementsByClassName("translated-text").length){let e=o.getElementsByClassName("translate-button");if(e[0]){let t=document.createElement("span");t.className="translated-text",t.setAttribute("dir","auto"),t.innerHTML=a,o.insertBefore(t,e[0]),o.removeChild(e[0])}else t("WARN: failed to find translate-button during append")}}(e.senderId,e.id,e.data.value.translatedtext):Nr(e.senderId,e.id));else{if("chat"!=d&&"inlinewidget"!=d&&"htmlwidget"!=d&&"widget"!=d&&"close"!=d||($s&&"desktop"==ql&&"close"!=d?Vs=l("showwidget","widget"==d,Vs):lc(!0)),("chat"==d||"info"==d)&&!e.style||"inlinewidget"==d||"htmlwidget"==d||"segment"==d&&e.data&&e.data.segment)(b=function(e){var t=e?new Date(e):new Date,i=t.toDateString();return ka&&i==ka?null:(ka=i,t)}(e.timestamp))&&((E=document.createElement("div")).className="info dateboundary",E.innerHTML='<span class="text">'+n(bo(b))+"</span>",Ir(E));if("email"==Ca&&/^chat$|^media$|^segment$/i.test(d)){if("segment"==d)return;Il(Hn)}else if(r||"typing"!=d)if("chat"==d){N=po(e.senderId,r);if(!(e.htmlText&&e.htmlText.trim()||e.text&&e.text.trim()))return;if(u()&&e.htmlText&&(e.htmlText.indexOf('src="/kpd-static/')>=0||e.htmlText.indexOf('src="{state.web}')>=0)&&(e.htmlText=e.htmlText.replace(/src="\/kpd-static\//g,'src="{state.web}/').replace(/\{state\.web\}/g,Kl.web)),e.data&&e.data.context&&e.data.context.html&&(e.htmlText=e.data.context.html,e.text=e.data.context.html),e.channelinfo&&e.channelinfo.type&&["facebook","instagram","twitter"].indexOf(e.channelinfo.type)>-1&&e.data&&e.data.context&&e.data.context.html&&(e.htmlText=e.data.context.html,e.text=e.data.context.html),"markdown"==e.mediatype&&(e.htmlText=An.makeHtml(e.text)),(g=Ao(e.htmlText)||n(e.text))&&!g.match(/<a\s+href\s*=\s*\"|<.*>+/g))g=anchorme({input:g,options:{attributes:{target:"_blank",rel:"noopener noreferer"},exclude:function(e){if(console.log("anchorme: "+e),e.startsWith("url="))return!0},protocol:function(e){return anchorme.validate.email(e)?"mailto:":"https://"},truncate:function(e){return anchorme.validate.email(e)?1/0:40},middleTruncation:!0}})||g;var f=(b=e.timestamp?new Date(e.timestamp):new Date).toLocaleString(),h=wo(b);E=null,A=Ar(e.senderId);let o=null,c=e.senderName;try{if(Et&&Fa.get(e.senderId)&&(c=Fa.get(e.senderId).name||e.senderName),(!c||"Guest User"==c)&&Rn[e.senderId]&&Rn[e.senderId].businessProfiles&&Rn[e.senderId].businessProfiles.length>0)for(let t of Rn[e.senderId].businessProfiles){if("Agent Created"===t.channeltype&&t.name){c=t.name;break}t.name&&e.channelinfo&&e.channelinfo.type===t.channeltype&&(c=t.name)}}catch(e){}let d=null,p=null;if(e.data)if(Et&&e.data.translation&&e.data.translation.sourcelang&&e.data.translation.translatedlang)ra="en"!=e.data.translation.sourcelang?e.data.translation.sourcelang:ra,e.data.translation.sourcelang!=e.data.translation.translatedlang&&(o=e.data.translation.sourcetext||e.data.translation.translatedtext);else if(e.data.delivery&&e.data.delivery.status){d=e.data.delivery.status;let t=mr(e.data);(Et&&/.*agent.*/.test(N)||!Et&&/.*customer.*/.test(N))&&(p=Et&&"dialpad"==kt?'<div class="'+d+'">'+(t||d)+"</div>":'<div class="invisible-div"></div><div class="'+d+'">'+(t||d)+"</div>")}A?((E=document.createElement("div")).setAttribute("ts",e.timestamp),d&&E.setAttribute("ack","dialpad"==kt?d+"dp":d),Et&&"dialpad"==kt?(E.innerHTML='<div class="user-details"><img src="assets/cleardot.gif" class="avatar" alt="" aria-label="Profile Picture" aria-hidden="true"/><span class="name">'+c+'</span><span class="timestamp">'+n(f)+'</span><span class="time">'+n(h)+'</span><span class="dialpad-invisible-div"></span><span class="ack">'+(Et&&p?p:"")+"</span></div><p "+(!Et&&rd?'tabindex="0"':"")+' class="text" dir="auto"><span>'+g+"</span></p>"+(o?"<span "+(!Et&&rd?'tabindex="0"':"")+' class="translated-text" dir="auto">'+o+"</span>":"")+'<div class="translate-button" style="display: none; visibility: hidden;">Translate</div>',N=N.replace(/right/,"left")):E.innerHTML='<img src="assets/cleardot.gif" aria-label="Profile Picture" aria-hidden="true"/><span>'+c+"</span><span>"+n(f)+"</span><span "+(!Et&&rd?'tabindex="0"':"")+' class="text" dir="auto">'+g+"</span>"+(o?"<span "+(!Et&&rd?'tabindex="0"':"")+' class="translated-text" dir="auto">'+o+"</span>":"")+'<div class="translate-button" style="display: none; visibility: hidden;">Translate</div><span class="time">'+n(h)+'</span><span class="ack">'+(Et&&p?p:"")+"</span>",E.className="message "+N,ko(E,e.className),xo(e.style,E,E),Or(A),Lr(N),Ir(E),yo(Et&&"dialpad"==kt?E.getElementsByClassName("user-details")[0]:E,e.senderId)):((E=document.createElement("div")).setAttribute("ts",e.timestamp),d&&E.setAttribute("ack","dialpad"==kt?d+"dp":d),Et&&"dialpad"==kt?(E.innerHTML='<div class="user-details"><img src="assets/cleardot.gif" class="avatar" alt="" aria-label="Profile Picture" aria-hidden="true"/><span class="name">'+c+'</span><span class="timestamp">'+n(f)+'</span><span class="time">'+n(h)+'</span><span class="dialpad-invisible-div"></span><span class="ack">'+(Et&&p?p:"")+"</span></div><p "+(!Et&&rd?'tabindex="0"':"")+' class="text" dir="auto">'+g+"</p>"+(o?"<span "+(!Et&&rd?'tabindex="0"':"")+' class="translated-text" dir="auto">'+o+"</span>":"")+'<div class="translate-button" style="display: none; visibility: hidden;">Translate</div>',N=N.replace(/right/,"left")):E.innerHTML='<img src="assets/cleardot.gif" aria-label="Profile Picture" aria-hidden="true"/><span>'+c+"</span><span>"+n(f)+"</span><span "+(!Et&&rd?'tabindex="0"':"")+' class="text" dir="auto">'+g+"</span>"+(o?"<span "+(!Et&&rd?'tabindex="0"':"")+' class="translated-text" dir="auto">'+o+"</span>":"")+'<div class="translate-button" style="display: none; visibility: hidden;">Translate</div><span class="time">'+n(h)+'</span><span class="ack">'+(Et&&p?p:"")+"</span>",E.className="message "+N,Lr(N),ko(E,e.className),xo(e.style,E,E),Ir(E),yo(Et&&"dialpad"==kt?E.getElementsByClassName("user-details")[0]:E,e.senderId));let v=E.getElementsByClassName("translate-button");v&&v[0]?Et&&Ln.config&&Ln.config.lang_translation&&["voice"].indexOf(Ca)<0&&(null!=o||void 0!==e.data&&void 0!==e.data.translation&&e.data.translation.sourcelang==e.data.translation.translatedlang||(v[0].addEventListener("click",(function(i){v[0].style.display="none",v[0].style.visibility="hidden",function(e){if(Et&&Ln.config&&Ln.config.lang_translation&&["voice"].indexOf(Ca)<0&&e&&e.type&&/^chat$/i.test(e.type)&&e.senderId==aa&&(e.text||e.htmlText)){if(e.data&&e.data.translation&&e.data.translation.sourcelang==e.data.translation.translatedlang)return;let i=Pn;Yl.get_translation(Yl.auth.providerId,e.text||e.htmlText,null,(function(n){if(!(n&&n.sourcelang&&n.translation))return void t("translation is empty");let a=null;for(let e=0;e<n.translation.length;e++){const t=n.translation[e];if(n.sourcelang!=t.lang){ra="en"!=n.sourcelang?n.sourcelang:ra,a={sourcelang:n.sourcelang,translatedlang:t.lang,translatedtext:t.text.replaceAll("< br>","<br>")};break}}a?so({type:"updatemessage",id:e.id,senderId:e.senderId,senderName:e.senderName,data:{type:"replace",field:"translation",value:a}},i):(Nr(e.senderId,e.timestamp),t("translation not available or same of agent language"))}),(function(e){t("translation failed")}))}}(e)})),v[0].removeAttribute("style"))):t("WARN: failed to find translate-button"),!Et&&rd&&E.getElementsByClassName("text").item(0).focus(),e.htmlText?Lo("dialpad"==kt&&Et?E.children[1]:E.children[3]):e.action&&Lo(E,e.action),E.setAttribute("senderId",""+e.senderId),e.id&&(E.id="chat-"+e.id),!r&&e.senderId==Sn&&e.id&&e.ack&&(Et&&"dialpad"==kt?E.setAttribute("ack",void 0!==ia[e.id]?"pendingdp":"delivereddp"):E.setAttribute("ack",void 0!==ia[e.id]?"pending":"delivered")),void 0!==s&&E.setAttribute("index",""+s),Tn&&E.addEventListener("click",(function(e){e&&hs("chat message"),e.currentTarget.hasAttribute("selected")?(yn=l("selectedmessage",!1,yn),e.currentTarget.removeAttribute("selected"),Bn=null,i("div.page.chat div.message-direct-link textarea").value=""):(Bn=e.currentTarget,e.currentTarget.setAttribute("selected","true"),yn=l("selectedmessage",!0,yn),i("div.page.chat div.message-direct-link textarea").value=function(e){var t="#chat/"+Hn+"/ts="+e,i="";i="http:"==window.location.protocol||"https:"==window.location.protocol?window.location.origin+window.location.pathname+t:"web+koopid:"+t;return i}(Bn.getAttribute("ts")))})),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!1!==a&&(ya=e.text||uo(e.htmlText||""),To("last",!r))}else if("hidden"==d)t("ignoring hidden messages in display");else if("info"==d){(E=document.createElement("div")).className="info",u()&&e.htmlText&&(e.htmlText.indexOf('src="/kpd-static/')>=0||e.htmlText.indexOf('src="{state.web}')>=0)&&(e.htmlText=e.htmlText.replace(/src="\/kpd-static\//g,'src="{state.web}/').replace(/\{state\.web\}/g,Kl.web));h=wo(b=e.timestamp?new Date(e.timestamp):new Date);"markdown"==e.mediatype&&(e.htmlText=An.makeHtml(e.text));var g=Ao(e.htmlText)||n(e.text);if(E.setAttribute("ts",b.getTime()),g?E.innerHTML="<span "+(!Et&&rd?'tabindex="0"':"")+' class="text" dir="auto">'+g+'</span><span class="time">'+n(h)+"</span>":E.className+=" empty",ko(E,e.className),xo(e.style,E,E.children[0]),e.id){var v=Cr(e.id);v&&Or(v)}Ir(E),!Et&&rd&&E.getElementsByClassName("text").item(0).focus(),e.htmlText?(Eo(E.children[0]),Lo(E.children[0])):e.action&&Lo(E.children[0],e.action),!r&&e.senderId==Sn&&e.id&&e.ack&&(E.id="chat-"+e.id,Et&&"dialpad"==kt?E.setAttribute("ack",void 0!==ia[e.id]?"pendingdp":"delivereddp"):E.setAttribute("ack",void 0!==ia[e.id]?"pending":"delivered")),void 0!==s&&E.setAttribute("index",""+s),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!1!==a&&(ya=e.text||uo(e.htmlText||""),To("last",!r))}else if(r||"placeholder"!=d)if(r||"widget"!=d)if("inlinewidget"==d){if(p()){try{i("div.page.chat div.input textarea").blur()}catch(e){}Wn=[],setTimeout((function(){var t=dc(e,r);t&&(ko(t,e.className),void 0!==s&&t.setAttribute("index",""+s),!1!==a&&To("last")),ho()}),500)}else{(E=dc(e,r))&&(ko(E,e.className),void 0!==s&&E.setAttribute("index",""+s),!1!==a&&To("last"))}e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!1!==a&&To("last")}else if("htmlwidget"==d){e.src&&(e.src=Kl.resolve(e.src)),ko(E=hc(e,r&&"true"!=o("loadscreen"),Et,void 0,rd),e.className),void 0!==s&&E.setAttribute("index",""+s),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!1!==a&&To("last")}else if("updatehtmlwidget"==d){(E=i("#widget-"+e.id))?hc(e,r&&"true"!=o("loadscreen"),Et,E,rd):t("did not find htmlwidget with id="+e.id),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e)}else if("segment"==d){if(e.data)if(e.data.chat&&e.data.segment)"markdown"==e.mediatype&&(e.htmlText=An.makeHtml(e.text)),ko(E=function(e,a,o,r){r||(r=Yl);var s=document.createElement("div");s.className="segment";var c="segment-"+a.chat+"-"+a.segment;i("#"+c)?(t("segment already exists id="+a.segment+", changing to use a random id"),s.id=c+"-"+(""+Math.random()).substr(2,8)):s.id=c;var l=document.createElement("div");l.className="title","dialpad"==kt&&(l.className=l.className+" segment-title");var d=document.createElement("div");d.className="button back",d.innerHTML='<img src="assets/cleardot.gif" aria-label="Back"/>',l.appendChild(d);var u=document.createElement("span");u.innerHTML=e,l.appendChild(u);var p=document.createElement("div");p.className="button expand",p.innerHTML='<img src="assets/cleardot.gif" aria-label="Expand"/>',l.appendChild(p),s.appendChild(l);var f=document.createElement("div");f.className="history",s.appendChild(f),l.addEventListener("click",(function(s){var c=s.currentTarget.parentNode;"true"==c.getAttribute("expanded")?(c.setAttribute("expanded","false"),f.innerHTML="",u.innerHTML=e):(c.setAttribute("expanded","true"),r.get_chat_segment(a.chat,a.segment,(function(e){f.innerHTML="",e.action&&(d.onclick=function(t){return t.stopPropagation(),Se(e.action,["path","url"]),!1}),e.title&&(u.innerHTML=e.title),e.picture&&r.set_src(d.children[0],e.picture,(function(){d.setAttribute("haspicture","true")}));var i=null;if(e.messages.forEach((function(e){var t=e.ts?new Date(parseInt(e.ts)):new Date;if(null==i||i.toDateString()!=t.toDateString()){i=t;var a=document.createElement("div");a.className="info dateboundary",a.innerHTML='<span class="text" dir="auto">'+n(bo(i))+"</span>",f.appendChild(a)}var o=Vr(e,!1,r);o&&f.appendChild(o)})),a.segment>1){c.setAttribute("segment-top",parseInt(a.segment)-1);var o=document.createElement("div");o.className="previous",f.insertBefore(o,f.firstChild),o.addEventListener("click",(function(e){var i=parseInt(c.getAttribute("segment-top"));r.get_chat_segment(a.chat,i,(function(e){var t=null,a=o;e.messages.forEach((function(e){var i=e.ts?new Date(parseInt(e.ts)):new Date;if(null==t||t.toDateString()!=i.toDateString()){t=i;var o=document.createElement("div");o.className="info dateboundary",o.innerHTML='<span class="text">'+n(bo(t))+"</span>",f.insertBefore(o,a.nextSibling),a=o}var s=Vr(e,!1,r);s&&(f.insertBefore(s,a.nextSibling),a=s)})),i>1?c.setAttribute("segment-top",i-1):f.removeChild(o)}),(function(e){t("failed to get previous segment messages")}))}))}if(parseInt(a.segment)>0){c.setAttribute("segment-bottom",parseInt(a.segment)+1);var s=document.createElement("div");s.className="next",f.appendChild(s),s.addEventListener("click",(function(e){var i=parseInt(c.getAttribute("segment-bottom"));r.get_chat_segment(a.chat,i,(function(e){var t=null,a=s;e.messages.forEach((function(e){var i=e.ts?new Date(parseInt(e.ts)):new Date;if(null==t||t.toDateString()!=i.toDateString()){t=i;var o=document.createElement("div");o.className="info dateboundary",o.innerHTML='<span class="text">'+n(bo(t))+"</span>",f.insertBefore(o,a)}var s=Vr(e,!1,r);s&&f.insertBefore(s,a)})),c.setAttribute("segment-bottom",i+1)}),(function(e){t("failed to get next segment messages"),f.removeChild(s)}))}))}}),(function(e){t("failed to get segment messages")})),o||setTimeout((function(){c.scrollIntoView(!1),i("div.page.chat div.input").scrollIntoView(!1)}),500))})),Jl&&l.click();o||Sr(s);return s}(g=Ao(e.htmlText)||n(e.text),e.data),e.className),void 0!==s&&E.setAttribute("index",""+s),!1!==a&&To("last"),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e);else if(e.data.previous||e.data.next){E=jr(e.data.previous,e.data.next,e.data.feedback);void 0!==s&&E.setAttribute("index",""+s),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!1!==a&&To("last"),document.querySelectorAll('div.htmlwidget[active="true"]').forEach((e=>{wc(e)})),uc()}else t("missing previous, next, chat id, segment id or topic in segment data");else if(e.text||e.htmlText){var m=i("div.page.chat div.snippet:last-of-type > div.lastitem div.topic");if(m){e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!1!==a&&To("last"),"markdown"==e.mediatype&&(e.htmlText=An.makeHtml(e.text));g=Ao(e.htmlText)||n(e.text);m.innerHTML=g,e.action?Lo(m,e.action):m.onclick=function(){}}}else t("missing data in segment")}else if(r||Et||"workflow"!=d)if(r||"close"!=d)if("media"!=d||r&&!Le["send-inline-media"])if("progress"==d)"user activity"==e.text&&e.data&&Et&&!0===Le["show-customer-activity"]?(ga.push(e),os(e)):t("ignoring message type="+d+", unsupported text="+e.text);else if("location"==d){let t=null;if(e.data&&e.data.latitude&&e.data.longitude){let i=null;if(e.data.url)i=anchorme({input:n(e.data.url),options:{attributes:{target:"_blank",rel:"noopener noreferer"},protocol:function(e){return"https://"},truncate:25,middleTruncation:!0}})||i;let a=Le.show_map;if(a&&a.vendor&&"google"==a.vendor&&a.config&&a.config.key&&["static","interactive"].indexOf(a.config.type)>-1&&a.config[a.config.type]){let o=a.config[a.config.type].replace(/{API_KEY}/g,a.config.key).replace(/{LATITUDE}/g,e.data.latitude).replace(/{LONGITUDE}/g,e.data.longitude);t="static"==a.config.type?'<img class="static" src="'+o+'">':'<iframe title="Location" class="interactive" src="'+o+'"></iframe>',e.data.name&&(t+='<span class="name">'+n(e.data.name)+"</span>"),e.data.address&&(t+='<span class="address">'+n(e.data.address)+"</span>"),i&&(t+=i),t='<div class="location">'+t+"</div>"}else t="Latitude: "+n(e.data.latitude)+"<br>Longitude: "+n(e.data.longitude),e.data.name&&(t+="<br>Name: "+n(e.data.name)),e.data.address&&(t+="<br>Address: "+n(e.data.address)),i&&(t+=i),t=Et&&"dialpad"==kt?'<p class="text" dir="auto">'+t+"</p>":'<span class="text">'+t+"</span>"}if(!t)return void console.log("droppin invalid location message");let i=e.senderName;try{if(Et&&Fa.get(e.senderId)&&(i=Fa.get(e.senderId).name||e.senderName),!i&&Rn[e.senderId]&&Rn[e.senderId].businessProfiles&&Rn[e.senderId].businessProfiles.length>0)for(let t of Rn[e.senderId].businessProfiles){if("Agent Created"===t.channeltype&&t.name){i=t.name;break}t.name&&e.channelinfo&&e.channelinfo.type===t.channeltype&&(i=t.name)}}catch(e){}N=po(e.senderId,r),f=(b=e.timestamp?new Date(e.timestamp):new Date).toLocaleString(),h=wo(b);(E=document.createElement("div")).className="message "+N,E.setAttribute("ts",e.timestamp),E.setAttribute("senderId",""+e.senderId);let o=null,c=null;if(e.data&&e.data.delivery&&e.data.delivery.status){o=e.data.delivery.status,Et&&"dialpad"==kt&&"delivered"==o?E.setAttribute("ack",o+"dp"):E.setAttribute("ack",o);let t=mr(e.data);(Et&&/.*agent.*/.test(N)||!Et&&/.*customer.*/.test(N))&&(c=Et&&"dialpad"==kt?'<div class="'+o+'">'+(t||o)+"</div>":'<div class="invisible-div"></div><div class="'+o+'">'+(t||o)+"</div>")}Et&&"dialpad"==kt?(E.innerHTML='<div class="user-details"><img src="assets/cleardot.gif" class="avatar" alt="" aria-label="Profile Picture" aria-hidden="true"/><span class="name">'+i+'</span><span class="timestamp">'+n(f)+'</span><span class="time">'+n(h)+'</span><span class="dialpad-invisible-div"></span><span class="ack">'+(Et&&c?c:"")+"</span></div>"+t,N=N.replace(/right/,"left")):E.innerHTML='<img src="assets/cleardot.gif"/><span>'+n(e.senderName)+"</span><span>"+n(f)+"</span>"+t+'<span class="time">'+n(h)+'</span><span class="ack"></span>',ko(E,e.className),xo(e.style,E,E),(A=Ar(e.senderId))&&Or(A),Ir(E),yo(E,e.senderId),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!r&&e.senderId==Sn&&e.id&&e.ack&&(E.id="chat-"+e.id,Et&&"dialpad"==kt?E.setAttribute("ack",void 0!==ia[e.id]?"pendingdp":"delivereddp"):E.setAttribute("ack",void 0!==ia[e.id]?"pending":"delivered")),void 0!==s&&E.setAttribute("index",""+s),!1!==a&&(ya="Location",To("last",!r))}else if("whisper"==d){if(!Et)return;if(!(e.data&&e.data.whisper&&e.data.whisper.type&&e.data.whisper.sender&&e.data.whisper.senderName))return void t("missing whisper sender details");var y=e.data.whisper;if("chat"==y.type||"info"==y.type){if(!(e.htmlText&&e.htmlText.trim()||e.text&&e.text.trim()))return;if(u()&&e.htmlText&&(e.htmlText.indexOf('src="/kpd-static/')>=0||e.htmlText.indexOf('src="{state.web}')>=0)&&(e.htmlText=e.htmlText.replace(/src="\/kpd-static\//g,'src="{state.web}/').replace(/\{state\.web\}/g,Kl.web)),(g=Ao(e.htmlText)||n(e.text))&&!g.match(/<a\s+href\s*=\s*\"|<.*>+/g))g=anchorme({input:g,options:{attributes:{target:"_blank",rel:"noopener noreferer"},exclude:function(e){if(console.log("anchorme: "+e),e.startsWith("url="))return!0},protocol:function(e){return anchorme.validate.email(e)?"mailto:":"https://"},truncate:function(e){return anchorme.validate.email(e)?1/0:40},middleTruncation:!0}})||g;var b;f=(b=e.timestamp?new Date(e.timestamp):new Date).toLocaleString(),h=wo(b),N=po(y.sender,r)+" whisper";(E=document.createElement("div")).setAttribute("ts",e.timestamp);let t=e.senderName;t=Fa.get(aa)?.name,t&&""!=t&&"sendername"!=t.toLowerCase()||(t="customer"),Et&&"dialpad"==kt?(E.innerHTML='<div class="whisper-hidden">This message is hidden from '+t+'</div><div class="user-details"><img src="assets/cleardot.gif" class="avatar" alt="" aria-label="Profile Picture" aria-hidden="true"/><span class="name">'+y.senderName+'</span><span class="timestamp">'+n(f)+'</span><span class="time">'+n(h)+'</span><span class="dialpad-invisible-div"></span></div><p '+(!Et&&rd?'tabindex="0"':"")+' class="text" dir="auto">'+g+"</p>",N=N.replace(/right/,"left")):E.innerHTML='<img src="assets/cleardot.gif" aria-label="Profile Picture" aria-hidden="true"/><span>'+y.senderName+"</span><span>"+n(f)+"</span><span "+(!Et&&rd?'tabindex="0"':"")+' class="text" dir="auto">'+g+'</span><span class="time">'+n(h)+"</span>",E.className="message "+N.replace(/yours/,"mine"),ko(E,e.className),xo(e.style,E,E),Lr(N),Ir(E),yo(Et&&"dialpad"==kt?E.getElementsByClassName("user-details")[0]:E,y.sender),e.htmlText?Lo("dialpad"==kt&&Et?E.children[1]:E.children[3]):e.action&&Lo(E,e.action),E.setAttribute("senderid",""+y.sender),!1!==a&&(ya=e.text||uo(e.htmlText||""),To("last",!r))}else t("ignoring  message whisper.type="+y.type)}else t("ignoring message type="+d);else{var w=e.url;if(!w&&e.blob&&(w=mt(e.blob),Nn.push(w)),!w&&e.data&&e.data.fileurl&&(w=e.data.fileurl),e.data&&(e.data.media&&(e.media=e.data.media.toLowerCase()),e.data.filename&&(e.filename=e.data.filename),e.data.filetype&&(e.filetype=e.data.filetype.toLowerCase()),e.data.filecaption&&(e.filecaption=e.data.filecaption)),!e.media&&w){var x=w.lastIndexOf(".");x>=0&&(".jpg"!=(x=w.substr(x).toLowerCase())&&".png"!=x||(e.media="image",e.filetype="image/"+(".png"==x?"png":"jpeg")))}if((E=document.createElement("div")).className="media "+e.media,ko(E,e.className),"image"==e.media&&w)E.innerHTML='<img src="'+w+'" aria-label="Shared Picture"'+(e.insert&&e.insert.rand?' rand="'+e.insert.rand+'"':"")+' id="item-media" >';else if("video"==e.media&&w)E.innerHTML='<video src="'+w+'" controls aria-label="Shared Video"'+(e.insert&&e.insert.rand?' rand="'+e.insert.rand+'"':"")+' id="item-media" ></video>';else if("audio"==e.media&&w)E.innerHTML='<audio src="'+w+'" controls aria-label="Shared Audio"'+(e.insert&&e.insert.rand?' rand="'+e.insert.rand+'"':"")+' id="item-media"></audio>';else if("document"==e.media&&w){var _=e.filecaption?e.filecaption:e.filename?e.filename:"Document Shared";/^.*\.(doc|docx|pdf|ppt|pptx|xls|xlsx)$/i.test(e.filecaption)&&(e.filename=_),E.innerHTML+='<div class="download-btn-container">             <a href="'+w+'" target="_blank" download class="download-btn">'+n(_)+'<span style="margin-left: 0.5rem;">             <i class="fas fa-download"></i></span><a/></div>'}else if("text"!=e.media&&"application"!=e.media||!w)if("unsupported"==e.media&&Et)E.innerHTML='<span class="alert">File not available, the sender\'s file type is unsupported'+(e.filetype?" - "+e.filetype:"")+"</span>";else if("toolarge"==e.media&&Et){var k=null;if(e.filesize)try{k=e.filesize/1048576}catch(i){t("error converting "+e.filesize+" bytes to MB")}E.innerHTML='<span class="alert">File not available, the sender\'s file size exceeded the maximum file size limit'+(k?" - "+k+" MB":"")+"</span>"}else{if("failed"!=e.media||!Et)return Ye("Cannot play this content type - "+e.media,"Error"),void(E.innerHTML="");E.innerHTML='<span class="alert">File not available, the system encountered an error while downloading the file from sender</span>'}else;if(["image","audio","video"].indexOf(e.media)>=0&&e.filecaption&&(E.innerHTML+='<br/><span class="text">'+n(e.filecaption)+"</span>"),e.insert&&e.insert.selector){var T=i(e.insert.selector);T&&("after"==e.insert.position?T.nextSibling?T.parentNode.insertBefore(E,T.nextSibling):T.parentNode.appendChild(E):T.insertBefore(E,T),To("last",!0,!1))}else Ir(E);if(["img","audio","video"].indexOf(E.children[0].nodeName.toLowerCase())>=0&&(E.children[0].onerror=function(t){Ye("failed to play media file "+e.filetype+", code "+(t.currentTarget.error&&t.currentTarget.error.code||"0"),"Error")}),void 0!==s&&E.setAttribute("index",""+s),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),e.insert&&e.insert.scrollTo)To(e.insert.scrollTo);else try{E.querySelector("#item-media").onload=function(){t("Media content - scrolling to bottom"),To("last",!0,!1)}}catch(e){}}else oo();else e.data?Dr(e.data):t("missing data in workflow");else{if(p()){try{i("div.page.chat div.input textarea").blur()}catch(e){}Wn=[],setTimeout((function(){sc(e),ho()}),500)}else sc(e);e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!1!==a&&To("last",!r)}else{"markdown"==e.mediatype&&(e.htmlText=An.makeHtml(e.text));var g=Ao(e.htmlText)||n(e.text),E=Cr(e.id);g?E?(E.innerHTML='<span class="text" dir="auto">'+g+"</span>",ko(E,e.className),xo(e.style,E,E.children[0]),Ir(E),e.htmlText?(Eo(E.children[0]),Lo(E.children[0])):e.action&&Lo(E.children[0],e.action)):((E=document.createElement("div")).className="info placeholder",E.id="chat-"+(e.id||(""+Math.random()).substr(2,8)),E.innerHTML='<span class="text" dir="auto">'+g+"</span>",ko(E,e.className),xo(e.style,E,E.children[0]),Ir(E),e.htmlText?(Eo(E.children[0]),Lo(E.children[0])):e.action&&Lo(E.children[0],e.action),!1!==a&&To("last",!r)):E&&Or(E),e?.data?.feedback?.enabled&&Mr(e.data.feedback,e),!1!==a&&To("last",!r)}else{var A=Ar(e.senderId);if(e.value){var L=ca&&("show"==ua||"hide-customer"==ua&&Et);if(A)A.style.visibility="visible";else{var N=po(e.senderId,r);(E=A=document.createElement("div")).className="message typing "+N,E.setAttribute("senderId",""+e.senderId),E.innerHTML='<img src="assets/cleardot.gif" aria-label="Profile Picture" aria-hidden="true"/><span>'+n(e.from)+'</span><span></span><span class="text">'+n(L?"":"typing...")+'</span><span class="ack"></span>',ko(E,e.className),xo(e.style,E,E),Sr(E),yo(E,e.senderId),!1!==a&&To("last",!0)}A.setAttribute("typing",ca||!!e.text),e.text&&L&&(A.children[3].innerHTML=n(e.text)),L||(void 0!==pn&&clearTimeout(pn),pn=setTimeout((function(){Or(A,!0)}),Ra))}else A&&Or(A)}}else t("dropping message "+d+", not allowed")}function ko(e,t){e&&t&&(e.className=(e.className?e.className+" ":"")+t.split(" ").map((function(e){return"chatitem-"+e})).join(" "))}function To(e,n,a){if(n){if(qa&&"number"!=typeof e)return;if("input"==e)i("div.page.chat div.input").scrollIntoView(!1);else if("last"==e||"clear"==e){var o=i("div.page.chat div.history"),r=o.scrollHeight-o.clientHeight;if("clear"==e)o.style.paddingBottom=o.offsetHeight+"px",o.scrollTop=r+o.offsetHeight,Na={height:o.offsetHeight,top:r+o.offsetHeight};else if(Na){var s=r-Na.top;s>=Na.height?(Na=null,o.style.paddingBottom="",o.scrollTop=o.scrollHeight-o.clientHeight):o.style.paddingBottom=Na.height-s}else o.style.paddingBottom="",o.scrollTop=r}else if("number"==typeof e&&e>=0){t("scroll-to-chat-item item="+e+" beginning="+a);var c=i('div.page.chat div.history div[index="'+e+'"]');c?(c.scrollIntoView(!!a),i("div.page.chat div.input").scrollIntoView(!1)):t("failed to scroll-to-chat-item item="+e)}else if("string"==typeof e&&["audio","image","video"].indexOf(e.split("-")[0])>=0){t("scroll-to-media-item rand="+e);var l=e.split("-")[0],d=i(("image"!=l?l:"img")+'[rand="'+e+'"]');d?d.scrollIntoView(!!a):t("failed to scroll-to-chat-item item="+e)}else t("invalid scroll-to-chat-item item="+e)}else setTimeout((function(){To(e,!0,a)}),500)}function Eo(e){for(var t=e.querySelectorAll("span.date"),i=0;i<t.length;++i){var a=new Date(t[i].innerHTML);a&&!isNaN(a.getTime())&&(t[i].innerHTML=n(a.toLocaleString()))}}function Ao(e,i){if(!e||e.length<=0)return e;e=e.replace(/\n/g,"<br/>");for(var n=(new DOMParser).parseFromString(e||"","text/html"),a=n.querySelectorAll("body *"),o=["SCRIPT","LINK","IFRAME","OBJECT","EMBED","FORM","FRAME"],r=a.length-1;r>=0;--r){var s=a[r];if(o.indexOf(s.nodeName)>=0)try{s.parentNode.removeChild(s)}catch(e){t(e)}i&&("A"==s.nodeName?s.removeAttribute("href"):"IMG"==s.nodeName&&(s.removeAttribute("src"),s.style.display="none"))}return n.body.innerHTML}function Lo(e,i){if(i)return e.setAttribute("hasaction","true"),e.action=i,void(e.onclick=function(e){hs("chat bubble",{action:e.currentTarget.action}),Se(e.currentTarget.action,["invoke","popup","url","path"])});var n=e.children;if(1!=n.length||1!=n[0].nodeType||"DIV"!=n[0].nodeName)for(var a=0;a<n.length;++a){var o=n[a];1==o.nodeType&&"A"==o.nodeName?o.onclick=function(e){try{e.preventDefault(),e.stopImmediatePropagation(),"action"==e.currentTarget.className||(e.currentTarget.className||"").match(/\baction\b/)?Re(e):"more"==e.currentTarget.className?No(e):Do(e),Jr()}catch(e){t(e)}return!1}:1!=o.nodeType||"SPAN"!=o.nodeName&&"P"!=o.nodeName||Lo(o)}else Lo(n[0])}function No(e){e&&hs("chat bubble more"),e.currentTarget.setAttribute("selected","true")}function Co(e){var t=i("div.page.chat div.textarea > textarea").value;let n=i("body[isProvider=true] div.page.chat div.textarea"),a=i("body[isProvider=true] div.page.chat div.input");if(i("div.page.chat div.textarea > textarea").setAttribute("style","bottom:auto;"),null!=t&&""===t.trim()){Et||Jr(),Et&&Wr(),gn&&(gn=l("istyping",!1,gn)),i("div.page.chat div.textarea").setAttribute("style",""),i("div.page.chat div.input").setAttribute("style","");let e=i("div.input div.clipboard-image"),t=document.querySelector("body").getAttribute("isProvider");return t&&"true"==t&&e?.setAttribute("style","bottom:60px;"),void(Da=!1)}if(Et&&Ln.config&&Ln.config.lang_translation&&/^!.*$/.test(t)){let e=ra;/^![a-z][a-z]\|.*$/i.test(t)&&(e=t.substr(1,2).toLowerCase());let n="Will translate to: "+e,a=k[o=e]?k[o]:null;a&&(n+=" ("+a+")"),i("div.page.chat div.targetlang").setAttribute("state","active"),i("div.page.chat div.targetlang").innerHTML=n}else Et&&Wr();var o,r=!1;t&&!gn?(gn=l("istyping",!0,gn),r=!0):!t&&gn&&(gn=l("istyping",!1,gn),r=!0),(ca||pa)&&function(){la&&(clearTimeout(la),la=null);la=setTimeout(Io,da)}(),clearTimeout(fn),(r||Ha<Date.now()-Ra)&&(so({type:"typing",value:gn}),Ha=Date.now()),fn=setTimeout((function(){gn&&(gn=l("istyping",!1,gn))}),Ra);let s=i("div.page.chat div.textarea > textarea"),c=i("body[isProvider=true] div.page.chat div.textarea"),d=i("body[isProvider=true] div.page.chat div.input"),u=i("body[isProvider=true] div.page.chat div.history");if(s?.scrollHeight>60){n?.setAttribute("style","z-index:30; height:auto;"),a?.setAttribute("style","height:auto;");let e=s.scrollHeight>90?90:s.scrollHeight;c?.setAttribute("style","z-index:30; height:"+e+"px;"),u?.setAttribute("style","bottom:"+(e+10)+"px;"),e>90&&d?.setAttribute("style","height:"+e+"px;"),s.scrollHeight>90&&s?.setAttribute("style","overflow-y:scroll;");let t=i("div.input div.clipboard-image"),o=document.querySelector("body").getAttribute("isProvider");o&&"true"==o&&t?.setAttribute("style","bottom:"+e+"px;"),Jr(),Da=!0}else u?.setAttribute("style","bottom:60px;")}function So(e){let n=i("body[isProvider=true] div.page.chat div.textarea"),a=i("body[isProvider=true] div.page.chat div.input"),o=i("body[isProvider=true] div.page.chat div.history");var r=i("div.page.chat div.textarea > textarea").value;if(ja&&ja.length&&(Cd(!0),Ro(Pn,ja,(function(){Cd(!1),ja=[],jo()}))),null==r||""!==r.trim()){var s=gn;if(gn=l("istyping",!1,gn),r=r.trim(),e&&hs("chat send button",{value:r}),Kn=0,Vn.splice(0,0,r),Vn.length>10&&Vn.splice(10,Vn.length-10),i("div.page.chat div.textarea > textarea").value="",i("div.page.chat div.textarea > textarea").focus(),Oo(),"active"==Hc&&"twilio"==Rc&&r.match(/^[0-9#\*]+$/))$c(r);else{var c=function(e){void 0!==e&&e?.text&&(Et||(e.data={inputbox:!0}),so(e),ys("send",{type:"chat",size:e.text.length}))};if(Et&&Ln.config&&Ln.config.lang_translation&&(/^![a-z][a-z]\|.*$/i.test(r)&&r.substr(4).trim().length>1||/^!.*$/.test(r)&&r.substr(1).trim().length>1)){let e=ra,i=r.substr(1).trim();/^![a-z][a-z]\|.*$/i.test(r)&&(i=r.substr(4).trim(),e=r.substr(1,2).toLowerCase()),Yl.get_translation(Yl.auth.providerId,i,e,(function(n){let a={type:"chat",text:i};if(n&&n.translation&&n.sourcelang||t("agent translation is empty"),n.sourcelang!=e&&n.sourcelang!=n.translation[0].lang){let e={sourcetext:i,sourcelang:n.sourcelang,translatedlang:n.translation[0].lang};a.text=n.translation[0].text,a.data={translation:e}}c(a)}),(function(e){c({type:"chat",text:i})}))}else c({type:"chat",text:r})}s&&so({type:"typing",value:!1}),Sc(),uc(),n?.setAttribute("style",""),a?.setAttribute("style",""),o?.setAttribute("style","bottom:60px")}}function Oo(){la&&(clearTimeout(la),la=null)}function Io(e){var t=i("div.page.chat div.textarea > textarea").value;so({type:"typing",value:!!t,text:t,data:{inputbox:!0}})}function Mo(e){i("div.page.chat div.textarea > textarea");let n=i("body[isProvider=true] div.page.chat div.textarea"),a=i("body[isProvider=true] div.page.chat div.input"),o=i("body[isProvider=true] div.page.chat div.history");var r=i("div.page.chat div.textarea > textarea").value;let s=i("div.input div.clipboard-image");if(!("13"!=e.keyCode||r&&r.trim().length))return ja&&ja.length&&(Cd(!0),Ro(Pn,ja,(function(){Cd(!1),ja=[],jo(),n?.setAttribute("style",""),a?.setAttribute("style","");let e=document.querySelector("body").getAttribute("isProvider");e&&"true"==e&&s?.setAttribute("style","bottom:60px;")}))),e.preventDefault(),!1;if("13"==e.keyCode&&!e.shiftKey){if(r&&r.trim().length){if(ja&&ja.length&&(Cd(!0),Ro(Pn,ja,(function(){Cd(!1),ja=[],jo()}))),n?.setAttribute("style",""),a?.setAttribute("style",""),o?.setAttribute("style","bottom:60px"),Da=!1,gn=l("istyping",!1,gn),r=r.trim(),e&&gs("enter","chat input",{value:r}),Kn=0,Vn.splice(0,0,r),Vn.length>10&&Vn.splice(10,Vn.length-10),i("div.page.chat div.textarea > textarea").value="",i("div.page.chat div.textarea > textarea").focus(),Oo(),"active"==Hc&&"twilio"==Rc&&r.match(/^[0-9#\*]+$/))$c(r);else{var c=!1;if(r.match(/^\{\{.*\}\}$/))try{var d=JSON.parse(r.substr(1,r.length-2));["chat","info","widget","htmlwidget","inlinewidget"].indexOf(d.type)>=0?((d=Gr(d)).senderName||(d.senderName=Kl.myprofile?Kl.myprofile.name:Yl.auth.email),d.senderId||(d.senderId=Sn),d.timestamp||(d.timestamp=(new Date).getTime()),_o(d),c=!0):(d.invoke||d.url||d.popup||d.path)&&(Se(d,["path","invoke","url","popup"]),c=!0)}catch(e){console.log(e)}if(!c)if(Et&&Ln.config&&Ln.config.lang_translation&&(/^![a-z][a-z]\|.*$/i.test(r)&&r.substr(4).trim().length>1||/^!.*$/.test(r)&&r.substr(1).trim().length>1)){let e=ra,i=r.substr(1).trim();/^![a-z][a-z]\|.*$/i.test(r)&&(i=r.substr(4).trim(),e=r.substr(1,2).toLowerCase()),Yl.get_translation(Yl.auth.providerId,i,e,(function(n){let a={type:"chat",text:i};if(n&&n.translation&&n.sourcelang||t("agent translation is empty"),n.sourcelang!=e&&n.sourcelang!=n.translation[0].lang){let e={sourcetext:i,sourcelang:n.sourcelang,translatedlang:n.translation[0].lang};a.text=n.translation[0].text,a.data={translation:e}}so(a)}),(function(e){so({type:"chat",text:i})}))}else{let e={type:"chat",mediatype:"htmltext",text:r};Et||(e.data={inputbox:!0}),so(e),ys("send",{type:"chat",size:r.length})}}so({type:"typing",value:!1}),Sc(),uc(),clearTimeout(fn),Ha=0}return e.preventDefault(),!1}if(e.shiftKey&&"13"==e.keyCode){t("Shift+enter pressed....");let e=i("div.page.chat div.textarea > textarea"),n=i("body[isProvider=true] div.page.chat div.textarea"),a=i("body[isProvider=true] div.page.chat div.input"),o=i("body[isProvider=true] div.page.chat div.history");if(e.scrollHeight>60){let t=e.scrollHeight>90?90:e.scrollHeight;n?.setAttribute("style","z-index:30; height:"+t+"px;"),o?.setAttribute("style","bottom:"+(t+10)+"px;"),t>90&&a?.setAttribute("style","height:"+t+"px;"),e.scrollHeight>90&&e?.setAttribute("style","overflow-y:scroll;");let r=i("div.input div.clipboard-image"),s=document.querySelector("body").getAttribute("isProvider");s&&"true"==s&&r?.setAttribute("style","bottom:"+t+"px;"),Jr(),Da=!0}else o?.setAttribute("style","bottom:60px;")}else if(Vn.length>0&&e.altKey&&("38"==e.keyCode||"40"==e.keyCode)){if(""!=(f=i("div.page.chat div.textarea > textarea").value).trim()){var u=!1,p=-1;for(let e=0;e<Vn.length;e++){if((r=Vn[e]).startsWith("LAST-DRAFT-MSG>>")&&(p=e),u=r.replace("LAST-DRAFT-MSG>>","").trim()==f.trim())break}u||(Vn.splice(p>=0?p:0,p>=0?1:0,"LAST-DRAFT-MSG>>"+f),Kn="38"==e.keyCode?1:Vn.length-1)}var f=Vn[Kn].replace("LAST-DRAFT-MSG>>","");Kn="38"==e.keyCode?(Vn.length+Kn+1)%Vn.length:(Vn.length+Kn-1)%Vn.length,i("div.page.chat div.textarea > textarea").value=f,setTimeout((function(){i("div.page.chat div.textarea > textarea").select(),i("div.page.chat div.textarea > textarea").selectionStart=i("div.page.chat div.textarea > textarea").selectionEnd}),0),e&&gs("arrowkey","chat input",{key:e.keyCode})}"Escape"==e.key&&(Jr(),Da=!0)}function jo(e){let t=i("div.page.chat div.input > div.clipboard-image");for(;t.firstChild;)t.removeChild(t.firstChild);ja=[],t.classList.remove("clipboard-image-display")}function Po(e){let n=e,a=i("div.page.chat div.input > div.clipboard-image");if(n.clipboardData&&n.clipboardData.items){let e=n.clipboardData.items;for(let n=0;n<e.length;n++)if(-1!==e[n].type.indexOf("image")){t("Pasting image: "+e[n].type);let o=e[n].getAsFile();ja=[o],Jr();let r=i("div.page.chat div.textarea > textarea"),s=i("div.input div.clipboard-image"),c=document.querySelector("body").getAttribute("isProvider");c&&"true"==c&&s?.setAttribute("style","bottom:"+r.height+"px;"),s?.classList.add("clipboard-image-display");let l=new FileReader;l.onload=function(e){let t=new Image;t.src=e.target.result,t.onload=function(){let e=document.createElement("canvas");e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(t,0,0);let n=e.toDataURL("image/png");a.innerHTML="<button id='close-clipboard-image' class='close-button image paste'>&times;</button><img src=\""+n+'" />',i("div.page.chat div.input > div.clipboard-image > button").addEventListener("click",jo)}},l.readAsDataURL(o)}}}function Ho(e){e&&hs("chat attach button"),pt({capture:"camera",accept:"text/plain, application/pdf, image/*",allowupload:!0,returnfiles:!0},(function(e){e&&e.length>0&&(Cd(!0),Ro(Pn,e,(function(){Cd(!1)})))}))}function Ro(e,i,n){for(var o=[],r=function(){var e=o.filter((function(e){return!e.url}));e.length>0&&Ye("failed to upload "+e.map((function(e){return e.name+(e.error?": "+e.error:"")})).join(", "),"Error");var t=o.filter((function(e){return!!e.url}));if(0==t.length)a(n);else if(!0===Le["send-inline-media"]&&!u()&&1==t.length&&t[0].type){var i=t[0];t[0].type.startsWith("image/")?so({type:"media",url:i.url,data:{media:"image",filename:i.name,filetype:i.type,fileurl:i.url}}):t[0].type.startsWith("audio/")?so({type:"media",url:i.url,data:{media:"audio",filename:i.name,filetype:i.type,fileurl:i.url}}):t[0].type.startsWith("video/")?so({type:"media",url:i.url,data:{media:"video",filename:i.name,filetype:i.type,fileurl:i.url}}):so({type:"media",url:i.url,data:{media:"document",filename:i.name,filetype:i.type,fileurl:i.url}}),ys("send file",{type:"chat",url:i.url,count:1}),a(n)}else{var r="I shared "+(1==t.length?"a file":"files")+" "+t.map((function(e){return'<a href="'+e.url+'" download="'+e.name+'" type="'+e.type+'">'+e.name+"</a>"})).join(", ");so({type:"chat",htmlText:r}),ys("send file",{type:"chat",size:r.length,count:t.length}),a(n)}},s=function(e){!function(e,i,n,o,r,s,c){t("uploadFile filename="+o);var l=function(e){return["http","https","data"].indexOf(e.split(":")[0])>=0?e:Kl.files+("/"==Kl.files.substr(Kl.files.length-1)?"":"/")+e};if(u()){var d=new FileUploadOptions;d.fileKey="file",d.fileName=o,d.mimeType=r.type;var p={};p.providerId=e,p.channelType=i,p.channelVendor=n,d.params=p;var f=Kl.files,h=new FileTransfer,g=r.localURL;r.url&&"data:"==r.url.substr(0,5)&&(g=r.url),h.upload(g,f,(function(e){if(e.responseCode>=200&&e.responseCode<300){let e=JSON.parse(m.responseText.trim());e.metaDataId?a(s,l(e.metaDataId)):a(c,e.reason||"failed to upload")}else a(c,"status "+e.responseCode)}),(function(e){var t="status "+(e.http_status||e.code);try{t=JSON.parse(e.body).reason}catch(e){}a(c,t)}),d)}else{var v=new FormData;v.append("file",r,o),v.append("providerId",e),v.append("channelType",i),v.append("channelVendor",n);var m=new XMLHttpRequest;m.withCredentials=!0,f=Kl.files,m.open("POST",f,!0),Yl.auth&&Yl.auth.token&&(m.setRequestHeader("Authorization","Bearer "+Yl.auth.token),m.setRequestHeader("X-Authorization","Bearer "+Yl.auth.token)),m.onload=function(){try{if(200==m.status){let e=JSON.parse(m.responseText.trim());e.metaDataId?a(s,l(e.metaDataId)):a(c,e.reason||"failed to upload")}else{var e=JSON.parse(m.responseText.trim()).reason;a(c,e||"status "+m.status)}}catch(e){a(c,"failed to upload")}},m.onerror=function(){a(c,"onerror")},m.send(v)}}(Et?Kl.myprofile.providerId:Qt||ni,Ca,Sa,e.name,e,(function(t){o.push({url:t,name:e.name,type:e.type}),o.length==i.length&&r()}),(function(n){t("failed to upload file "+n),o.push({name:e.name,type:e.type,error:n}),o.length==i.length&&r()}))},c=0;c<i.length;++c)s(i[c]);0==i.length&&a(n)}function Do(e){var n=e.currentTarget.getAttribute("href"),a=e.currentTarget.getAttribute("type"),o=e.currentTarget.getAttribute("download");if(!a){var r=(o||n).split(".").pop().toLowerCase();"jpeg"==r||"jpg"==r||"png"==r?("jpg"==r&&(r="jpeg"),a="image/"+r):a="mp4"==r||"3gpp"==r||"mov"==r?"video/"+r:"3gp"==r?"video/3gpp":"wav"==r||"mp3"==r?"audio/"+r:"txt"==r?"text/plain":"application/octetstream"}var s=function(e){return e&&e.parentElement?null==e.getAttribute("ts")?s(e.parentElement):e:null},c=s(e.currentTarget.parentElement);c&&(c={selector:'div[ts="'+c.getAttribute("ts")+'"].'+c.className.replaceAll(" ","."),position:"after"});var l=a.split("/")[0];if(hs("chat link",{url:n&&n.substr(0,256)||void 0,type:a,name:o||void 0}),"image"==l||"video"==l||"audio"==l){var d={};if(c){let n=e.currentTarget.getAttribute("rand");if(n&&i(("image"!=l?l:"img")+'[rand="'+n+'"]'))return t("media of type:"+l+" already exists with rand attribbute:"+n),void To(n);n=l+"-"+y().substr(20),e.currentTarget.setAttribute("rand",n),c.rand=c.scrollTo=n,e.currentTarget.innerText&&(d.filecaption=e.currentTarget.innerText)}if("data:"==n.substr(0,5)){var p=vt(n);u()?ft(p,o):fo({type:"media",media:l,blob:p,filename:o,filetype:a,data:d,insert:c})}else"audio"==l||"video"==l?fo({type:"media",media:l,url:n,filename:o,filetype:a,data:d,insert:c}):(n&&"http:"!=n.substr(0,5)&&"https:"!=n.substr(0,6)&&(n=Kl.resolve(n)),gt(n,a,(function(e){if(e){var t=vt(e);fo({type:"media",media:l,blob:t,filename:o,filetype:a,data:d,insert:c})}else Ye("failed to download media from "+(n&&n.substr(0,1024)),"Error"),h(n)})))}else n?h(n):t("missing href on link")}function Fo(e){e&&hs("chat home button"),Fs&&("#menu/exit"==Fs?Qo():"#menu/minimize"==Fs?er():sd==Fs||"#chat/"==sd.substr(0,6)&&Fs=="#chatwith/"+Gn||(oo(),Sd(Fs)))}function Uo(e){e&&hs("chat people button"),Yn.person?Se(Yn.person,["invoke","path","url","popup"]):Ye("Default escalation not found. Please select an item from the menu to transfer.","warning")}function zo(e){var t={invoke:"callwith",args:qo()};e&&hs("chat phone button",{action:t}),Se(t,["invoke","path","url","popup"])}function qo(){var e=["this","this"];return"callconnect"!=En&&(e[0]=En),ml&&e.push("video"),gl&&e.push("record"),vl&&e.push("transcribe"),e}function Jo(e){e&&hs("chat hangup button"),Gc(),ol(),"idle"!=Hc&&(Hc=l("callstate","idle",Hc))}function Wo(e){e&&hs("chat menu button"),bn=l("showchatmenu",!0,bn)}function Bo(e){gs("longpress","call menu"),sa=null,wn=l("showcallmenu",!0,wn)}function Go(e){var t=e.currentTarget.getAttribute("data");e&&hs("call menu mode item",t),t&&(En=l("callmode",t,En))}function $o(e){e&&hs("call menu record item"),gl=l("enablerecord",!gl,gl)}function Vo(e){e&&hs("call menu transcribe item"),vl=l("enabletranscribe",!vl,vl)}function Ko(e){ml=l("enablevideo",!ml,ml)}function Yo(e){e&&hs("call menu hide item"),wn=l("showcallmenu",!1,wn)}function Xo(e){e&&hs("chat menu save item"),bn=l("showchatmenu",!1,bn),u()?Ye("Saving transcript is not available on the mobile app","Error"):window.print()}function Zo(e){e&&hs("chat menu screenshot item"),bn=l("showchatmenu",!1,bn),setTimeout((function(){Se({invoke:"screenshot",next:{success:{url:"{url}"}}},["invoke","url"])}),500)}function Qo(e){e&&hs("chat menu exit item"),bn=l("showchatmenu",!1,bn),setTimeout((function(){ma=!1,Fs?(x({type:"close"},"*"),f()||Fo()):oo()}),300)}function er(e){e&&e.keyCode&&13!=e.keyCode||(e&&hs("chat menu minimize item"),bn=l("showchatmenu",!1,bn),x({type:"minimize"},"*"))}function tr(e){e&&hs("chat menu email transcript item"),Et&&(bn=l("showchatmenu",!1,bn),Yl.send_provider_transcript_email(Hn,Ln.id,Yl.auth.user_id,aa,(function(){Ye("Conversation transcript was sent via email","Info")}),(function(e){Ye("Failed to send transcript email to customer","Error")})))}function ir(e){e&&hs("chat menu close segment item"),bn=l("showchatmenu",!1,bn),ar("segment-close")}function nr(e){if(Et){let t=function(){e&&hs("chat input close button"),El(!1),i("div.page.chat div.input").setAttribute("state","inactive"),ar("agent-close")};1==Le["chat-close-require-confirmation"]?b({title:"Close Conversation",message:"You are about to close this chat session.  Continue?",buttons:{Close:{class:"orange",action:t},Cancel:{class:"gray"}}}):t()}}function ar(e){var i=function(){Yl.close_chat_segment(Hn,e,(function(){ma=!1,oo(null)}),(function(e){Ye("Failed to close this segment","Error"),za=!1}))};Et?(za=!0,Ln&&Kl.myprofile&&Ln.id==Kl.myprofile.providerId?Ln.config&&Ln.config.close_messages&&Ln.config.close_messages.length>0&&Ln.config.close_messages.forEach((function(e){so(e)})):t("ignoring chat-send-close-messages"),setTimeout((function(){i()}),1e3)):i()}function or(e){var t=function(){for(var e=i("div.chatmenu").children,t=e.length-1;t>=0;--t){var n=e[t];n.hasAttribute("widget")&&i("div.chatmenu").removeChild(n)}};e?t():Yl.get_provider_widgets((function(e){wa=e,t()}),(function(e){wa=[],t()}))}function rr(e){let n=i("div.page.chat div.input");if(Et&&n&&"active"!=n.getAttribute("state"))return t("ignore widget push for inactive chat"),void Ye("Widget push not supported for inactive chats and search results","Warning");hs("chatside widgets item",e),(e.messages||[]).forEach((function(e){"htmlwidget"==e.type&&(e.id=(""+Math.random()).substr(2,10)),so(e),"widget"!=e.type&&"inlinewidget"!=e.type&&"htmlwidget"!=e.type||ys("send widget",{type:e.type,src:ms(e.src)})}))}function sr(e){var t=function(){for(var e=i("div.chatmenu").children,t=e.length-1;t>=0;--t){var n=e[t];n.hasAttribute("suggestion")&&i("div.chatmenu").removeChild(n)}};e?t():Yl.get_provider_canned_messages((function(e){ba=e,t()}),(function(e){ba=[],t()}))}function cr(e,a,o){var r=function(){for(var e=i("div.chatmenu").children,t=e.length-1;t>=0;--t){var n=e[t];n.hasAttribute("dynamic")&&i("div.chatmenu").removeChild(n)}delete Yn.phone,delete Yn.person},s=function(e){for(var a=null,o=0;o<e.length;++o){var r=e[o];if(!Et&&r.text){var s=a=document.createElement("div");s.data=r,s.className="item subitem dynamic",s.setAttribute("dynamic","true"),s.innerHTML='<span class="icon"></span><span class="title" dir="auto">'+n(r.text)+"</span>",i("div.chatmenu").insertBefore(s,i("div.chatmenu div.item.suggestion")),s.addEventListener("click",lr)}else r.button&&("phone"==r.button?Yn.phone=r.action:"person"==r.button?Yn.person=r.action:t("ignoring button code "+r.button))}a&&(a.className+=" last"),"assign"==Kr&&Zr("assign")};if(o)r(),s(o);else{var c=e?e.substr(0,1).toUpperCase()+e.substr(1):"";Yl.get_chatmenu(c,a,(function(e){xa=e,r(),s(e)}),(function(e){r()}))}}function lr(e){e&&hs("chat menu item",e.currentTarget.data),bn=l("showchatmenu",!1,bn);var t=e.currentTarget.data.action;if(Et&&"transfer"==t.invoke&&t.args.length>1){var i=t.args[1],a=t.next||{};Yl.do_provider_chat_assign(Hn,aa,i,(function(){a&&a.success&&Ln&&Sn&&aa&&so({type:"info",htmlText:'Agent has transfered this conversation. <a class="action" action="'+n(JSON.stringify(a.success))+'">Open</a>'}),ma=!1,oo()}),(function(e){Ye("Failed to transfer the conversation","Error")}))}else t.path||t.popup?(oo(),setTimeout((function(){Se(t,["path","url","popup","invoke"])}),300)):Se(t,["path","url","popup","invoke"])}function dr(e){var t=e.currentTarget.getAttribute("data");t&&(e&&hs("chat menu "+t),bn=l("showchatmenu",!1,bn),"desktop"!=ql&&setTimeout((function(){i("div.page.chatside > div.navbar > div."+t).click()}),500))}function ur(e,t){var i={type:"notification",message:t},n="notification/"+Ln.id+"/"+Sn+"/"+aa+e;so(i,n),xs("send",n,{type:t.action?"action":"other"})}function pr(e){if(Et){var t=function(e){if(i("div.page.chat div.expanded div.tags").innerHTML="",e&&e.length>0)for(var t=0;t<e.length;++t)fr(e[t])};e?t(e):Yl.get_provider_chat_tags(Hn,(function(e){_a=e,t(e)}),(function(e){_a=[],i("div.page.chat div.expanded div.tags").innerHTML=""}))}}function fr(e){var t=document.createElement("span");t.setAttribute("data",e.id),t.innerHTML=n(e.tag),i("div.page.chat div.expanded div.tags").appendChild(t),t.addEventListener("click",(function(e){var t=e.currentTarget;e&&hs("chat tags item",{id:t.getAttribute("data")}),Yl.delete_provider_chat_tag(Hn,t.getAttribute("data"),(function(){i("div.page.chat div.expanded div.tags").removeChild(t),ur("/chat",{type:"action",action:{invoke:"chatupdate",args:[Hn]}})}),(function(e){Ye("Failed to remove this tag","Error")}))}))}function hr(e){if(13==e.keyCode){var n=i("div.page.chat div.expanded input.addtag").value;if(!n)return void t("ignoring empty tag value");e&&gs("enter","chat add tag",{value:n}),Yl.add_provider_chat_tag(Hn,n,(function(e){i("div.page.chat div.expanded input.addtag").value="",fr({id:e.id,tag:n}),ur("/chat",{type:"action",action:{invoke:"chatupdate",args:[Hn]}}),gr()}),(function(e){Ye("Failed to add this tag","Error")}))}}function gr(){Yl.get_chat_tags(Hn,(function(e){e&&e.length>0&&(i("div.page.chat div.header div.tags").innerHTML=(e||[]).map((function(e){return"<span>"+n(e)+"</span>"})).join(""))})),Et&&pr()}function vr(e){if(13==e.keyCode&&(kn=l("editchatuserinfo",!1,kn),Et)){var t=Rn[aa]||{};if(t.email&&"guest-"==t.email.substr(0,6)){var a=i("div.page.chat div.expanded input.editname").value;Yl.set_guest_customer_name(aa,a,(function(){i("div.page.chat div.expanded span.name").innerHTML=n(a),i("div.page.chat div.header div.name").innerHTML=n(a)}),(function(e){Ye("Failed to set customer name","Error")}))}}}function mr(e){let t=null;if(e&&e.delivery&&e.delivery.status){let i=e.delivery[e.delivery.status];i&&i.forEach((e=>{void 0!==e.reason&&e.reason.trim().length>0&&(t=t?t+", "+e.reason.trim():e.reason.trim())}))}return t}function yr(e){Et&&Ln.config&&Ln.config.send_read_receipt&&!(["koopid","webchat"].indexOf(Ca)>0)&&e&&e.ack&&e.id&&"chat"==e.type&&e.data&&e.data.delivery&&e.data.delivery.vendorMsgIds&&so({type:"updatemessage",id:e.id,text:"read",data:{type:"replace",field:"delivery",value:{status:"read",vendorMsgIds:e.data.delivery.vendorMsgIds}}})}function br(e,n,a=null){try{var o=i("div.page.chat div.history #chat-"+e);if(o){Et&&"dialpad"==kt?o.setAttribute("ack",n+"dp"):o.setAttribute("ack",n);var r=null;a&&a.forEach((e=>{void 0!==e.reason&&e.reason.trim().length>0&&(r=r?r+", "+e.reason.trim():e.reason.trim())}));var s=o.getElementsByClassName("ack");if(Et&&s&&s[0]){var c=document.createElement("div");c.className=n,c.innerHTML=n||r;let e=function(e){let t=T.indexOf(e);return t>=0?T.slice(0,t):[]}(n);(null==s[0].firstChild||e.indexOf(s[0].firstChild.className)>-1)&&(Et||"dialpad"==kt||(s[0].innerHTML='<div class="invisible-div"></div>',s[0].appendChild(c)))}}}catch(i){t("No DOM element div.history #chat-"+e+", and type: "+n)}}function wr(e){if(e&&hs("chat title"),Et)xn=l("expandchattitle",!xn,xn);else if(e.currentTarget==i("div.page.chat div.header div.tags")){for(var t=i("div.page.chat div.header div.tags").children,n=[],a=0;a<t.length;++a)n.push(t[a].innerText);Ye(0==n.length?"This conversation is not yet tagged":n.map((function(e){return"#"+e})).join(", "),"Conversation Tags")}}function xr(e){e&&gs("swipeleft","chat title")}function _r(e){e&&gs("swiperight","chat title"),Fs?Fo(e):oo(e)}function kr(e){wi=l("showmenu",!0,wi)}function Tr(e){Et&&(Oi=l("showtodomenu",!0,Oi))}function Er(){i("div.page.chat div.history").innerHTML="",va=null}function Ar(e){return i('div.page.chat div.history > div.snippet:last-child > div.message.typing[senderId="'+e+'"]')}function Lr(e){var t="system";if(va&&e)try{var i=va.lastChild.previousSibling;i.className.split(" ").includes("typing")&&(i=i.previousSibling),(i.className.split(" ").includes("customer")||i.className.split(" ").includes("agent"))&&(t=i.className.split(" ").includes("customer")?"customer":"agent");let n=i.className.split(" ").filter((e=>"hide"!==e)).join(" ");i.className=e.split(" ").includes(t)?n+" hide":n}catch(e){}}function Nr(e,t){let n=i("div.page.chat div.history div.customer[senderid='"+e+"'][id='chat-"+t+"']");if(n){let e=n.getElementsByClassName("translate-button");e[0]&&(e[0].style.display="none",e[0].style.visibility="hidden")}}function Cr(e){return i('div.page.chat div.history > div.snippet:last-child > div.placeholder[id="chat-'+e+'"]')}function Sr(e){va||jr();var t=va.children[va.children.length-1];e.className&&e.className.indexOf(" typing ")<0&&va.removeAttribute("empty"),va.insertBefore(e,t)}function Or(e,i){try{if(i&&e.className&&e.className.indexOf(" typing ")>=0)return void(e.style.visibility="hidden");"lastitem"!=e.className&&va.removeChild(e)}catch(e){t("chat-view-remove-message() failed")}}function Ir(e){va||jr();for(var t=va,i=t.children,n=-1,a=i.length-1;a>=0;--a)if(!i[a].className||i[a].className.indexOf(" typing ")<0){n=a;break}n<0&&n>=i.length&&(n=i.length-1),t.removeAttribute("empty"),t.insertBefore(e,i[n])}function Mr(e,t){var i=document.createElement("div");i.className="feedback-block";const n=document.createElement("div"),a=document.createElement("div");n.className="feedback-header-block",a.className="feedback-header",a.textContent=t?.data?.feedback?.text||"Was this helpful?",n.appendChild(a);var o=document.createElement("div"),r=document.createElement("div");o.className="feedback up",r.className="feedback down",o.setAttribute("data-value",JSON.stringify(e?.feedback_up)),r.setAttribute("data-value",JSON.stringify(e?.feedback_down)),o.setAttribute("data-msg",JSON.stringify(t)),r.setAttribute("data-msg",JSON.stringify(t)),o.addEventListener("click",Hr),r.addEventListener("click",Hr),i.appendChild(n),i.appendChild(o),i.appendChild(r),Ir(i)}function jr(e,t,n){if(function(){if(va){for(var e=va.querySelectorAll("div.typing, div.placeholder"),t=e.length-1;t>=0;--t)va.removeChild(e[t]);va=null}}(),e||t){if(e&&!t)try{"NaN"==(t=""+(parseInt(e)+1))&&(t=null)}catch(e){}}else e="0",t="1";var a=document.createElement("div");a.className="snippet",a.setAttribute("empty","true"),e&&a.setAttribute("previous",e),t&&a.setAttribute("next",t),i("div.page.chat div.history").appendChild(a);var o=document.createElement("div");if(o.className="lastitem",!Et){n&&a.setAttribute("feedback",n);var r=document.createElement("div"),s=document.createElement("div");r.className="feedback up",s.className="feedback down";var c=document.createElement("div");c.className="topic",r.addEventListener("click",Pr),s.addEventListener("click",Pr),o.appendChild(c),o.appendChild(r),o.appendChild(s)}return a.appendChild(o),va=a,a.scrollIntoView(!1),a}function Pr(e){var t=e.currentTarget,i=t.className.indexOf(" up")>=0?"up":"down",n=t.parentNode.parentNode,a=n.getAttribute("next");if(a){var o=n.getAttribute("feedback")==i?null:i;Yl.post_chat_segment_feedback(Hn,a,o,(function(){o?n.setAttribute("feedback",o):n.removeAttribute("feedback")}),(function(e){Ye("Failed to post feedback: "+e,"Error")}))}}function Hr(e){let t=e?.target?.getAttribute("data-value");t=t?JSON.parse(t):null;let i=e?.target?.getAttribute("data-msg");if(i=i?JSON.parse(i):null,t&&i){const c={field:"feedback",type:"replace",value:{feedback:{response:t.body&&t.body.aspect&&t.body.aspect.includes("feedback_up")?"thumbs_up":"thumbs_down"}},dssdata:t};var n={...i,type:"updatemessage",data:c};delete n.senderId,delete n.senderName,so(n,Pn);var a=e.currentTarget,o=a.className.indexOf(" up")>=0?"up":"down",r=a.parentNode.parentNode;if(r.getAttribute("next")){var s=r.getAttribute("feedback")==o?null:o;r.setAttribute("feedback",s)}const l=e.target;l&&(l.style.pointerEvents="none",l.style.backgroundColor="#2222221a",l.style.borderColor="#2222221a");l.parentNode?.childNodes?.forEach((e=>{e.classList.contains("feedback")&&(e.style.pointerEvents="none")}))}}function Rr(){_o({type:"info",text:"Unable to load history, click here to reload",action:{invoke:"chathistory",args:["this"]},className:"reloadhistory"})}function Dr(e){if(void 0!==e.show&&((_n=l("hasworkflow",!!e.show,_n))||(Ea=Aa=null)),e.abortaction?e.show?Ea=e.abortaction:Aa=e.abortaction:Aa=null,"number"==typeof e.step&&e.step>=0&&e.step<10){var t=i("div.workflowcontrol"),n=i("div.workflowcontrol > div.hasmore");t.setAttribute("hasmore",""+(void 0===e.hasmore||!!e.hasmore));var a=e.step,o=parseInt(t.getAttribute("step"));if(a!=o)if(a>o)for(var r=o+1;r<=a;++r){var s=document.createElement("div");t.insertBefore(s,n),r>0&&(t.children[r-1].className="step")}else for(r=o;r>a;--r)t.removeChild(t.children[r]);t.setAttribute("step",a),(s=t.children[a]).className="step last"+(!1===e.required?" optional":""),s.setAttribute("hasdata","true"),s.data=e,s.onclick=function(e){var t=e.currentTarget,i=t.data;if(i)if(t.className.indexOf("last")<0)Se(i.stepaction||{invoke:"send",args:[{type:"hidden",text:"goto step "+(i.name||i.step)}]},["invoke","url","popup"]);else if(t.className.indexOf("optional")>=0){Se(i.skipaction||{invoke:"send",args:[{type:"hidden",text:"skip step "+(i.name||i.step)}]},["invoke","url","popup"])}}}}function Fr(e){Dr({show:!1}),Se(Aa||Ea||{invoke:"send",args:[{type:"hidden",text:"abort"}]},["invoke","url","popup"])}function Ur(e,i){if(void 0!==Ce&&Ce.length>0){var n=Ce.slice(0);Ce.splice(0,Ce.length),t("triggering on-chatpath-complete actions "+JSON.stringify(n)),n.forEach((function(e){Ie(e[0],e[1],"error"!=i)}))}}function zr(e){Wl=l("branding",e||"",Wl)}function qr(e){e.preventDefault(),e.stopPropagation();var t=e.currentTarget.innerText;null==t&&(t=e.currentTarget.textContext),t=t.trim();var n=gn;gn=l("istyping",!1,gn),t=t.trim(),e&&hs("chat send autosuggest",{value:t}),Kn=0,Vn.splice(0,0,t),Vn.length>10&&Vn.splice(10,Vn.length-10),i("div.page.chat div.textarea > textarea").value="",i("div.page.chat div.textarea > textarea").focus(),Oo(),so({type:"chat",text:t,data:{autosuggest:!0,inputbox:!0}}),ys("send",{type:"chat",size:t.length}),n&&so({type:"typing",value:!1}),Sc()}function Jr(){var e=i("div.page.chat > div.autosuggest");e&&(e.innerHTML="",e.setAttribute("state","inactive"))}function Wr(){i("div.page.chat div.targetlang").setAttribute("state","inactive"),i("div.page.chat div.targetlang").innerHTML=""}function Br(e){var t={};t.type=e.type,t.sender=e.senderId,t.senderName=e.senderName,t.ts=e.timestamp,e.action&&(t.action=e.action),e.id&&(t.id=e.id),e.ack&&(t.ack=e.ack),e.style&&(t.style=e.style),e.allow&&(t.allow=e.allow),e.className&&(t.className=e.className);try{t.tz=(new Date).toString().match(/([-\+][0-9]+)\s/)[1]}catch(e){}return"chat"==e.type?(e.htmlText?(t.mediatype="html",t.text=e.htmlText):(t.mediatype="text",t.text=e.text),e.data&&(t.data=e.data)):"typing"==e.type?(t.mediatype="boolean",t.flag=e.value,void 0!==e.text&&(t.text=e.text),e.data&&(t.data=e.data)):"widget"==e.type||"inlinewidget"==e.type?e.src?(t.mediatype="url",t.url=e.src):(t.mediatype="html",t.text=e.htmlText):"htmlwidget"==e.type?(e.src?(t.mediatype="url",t.url=e.src):(t.mediatype="html",t.text=e.htmlText),e.data&&(t.data=e.data),e.replace&&(t.replace=e.replace)):"notification"==e.type?t.message=e.message:"ack"==e.type?(t.text=e.text,t.mediatype="text"):(e.htmlText?(t.mediatype="html",t.text=e.htmlText):e.text?(t.mediatype="text",t.text=e.text):e.blob?(t.mediatype=e.mediatype||"image",t.blob=e.blob):e.url&&(t.mediatype="url",t.url=e.url,t.media=e.media,t.filename=e.filename,t.filetype=e.filetype),e.data&&(t.data=e.data),e.message&&(t.message=e.message)),t}function Gr(e){var t={};return t.type=e.type,t.senderId=e.sender,t.senderName=e.senderName,t.timestamp=e.ts&&"string"==typeof e.ts?parseInt(e.ts):e.ts,e.id&&(t.id=e.id),e.ack&&(t.ack=e.ack),e.action&&(t.action=e.action),e.tz&&(t.tz=e.tz),e.style&&(t.style=e.style),e.allow&&(t.allow=e.allow),e.className&&(t.className=e.className),e.insert&&(t.insert=e.insert),"chat"==e.type?("html"==e.mediatype?t.htmlText=e.text:t.text=e.text,e.data&&(t.data=e.data),e.mediatype&&(t.mediatype=e.mediatype)):"typing"==e.type?(t.value=e.flag,void 0!==e.text&&(t.text=e.text)):"widget"==e.type||"inlinewidget"==e.type?"html"==e.mediatype?t.htmlText=e.text:("url"==e.mediatype||e.url)&&(t.src=e.url):"htmlwidget"==e.type?("html"==e.mediatype?t.htmlText=e.text:("url"==e.mediatype||e.url)&&(t.src=e.url),e.data&&(t.data=e.data),e.replace&&(t.replace=e.replace)):"notification"==e.type?t.message=e.message:"ack"==e.type?t.text=e.text:("html"==e.mediatype?t.htmlText=e.text:"text"==e.mediatype?t.text=e.text:"url"==e.mediatype?(t.url=e.url,t.media=e.media,t.filename=e.filename,t.filetype=e.filetype):e.blob&&(t.mediatype=e.mediatype,t.blob=e.blob),e.data&&(t.data=e.data),e.message&&(t.message=e.message)),e.channelinfo&&(t.channelinfo=e.channelinfo),t}function $r(e){var t=[];t.push(e==Sn?"mine":"yours");var i=Et&&(void 0!==aa&&e==aa||e==Sn)||!Et&&e==Sn;return t.push(i?"customer":"agent"),"dialpad"!=kt&&t.push(!Et&&i||Et&&!i?"right":"left"),t.join(" ")}function Vr(e,a,o){if(o||(o=Yl),!(!e.allow||!Et&&(e.allow.indexOf("customer")>=0||e.allow.indexOf("guest")>=0)||Et&&e.allow.indexOf("agent")>=0))return t("dropping messae as not allowed"),null;if("htmlwidget"==e.type||"updatehtmlwidget"==e.type)return"htmlwidget"==(e=Gr(e)).type?(e.src&&(e.src=Kl.resolve(e.src)),(s=document.createElement("div")).id="widget-"+(e.id||(""+Math.random()).substr(2,8)),i("#"+s.id)&&(t("id "+s.id+" exists, switching to random id."),s.id="widget-"+(""+Math.random()).substr(2,8)),hc(e,!0,!1,s,rd),s):((s=i("#widget-"+e.id))?hc(e,!0,!1,s,rd):t("did not find htmlwidget with id="+e.id),s);if("media"==e.type){let i=null;if(e.data&&e.data.fileurl?"http:"==e.data.fileurl.substr(0,5)||"https:"==e.data.fileurl.substr(0,6)?(i='<a class="download" href="'+e.data.fileurl+'" target="_blank">'+(e.data.filename?e.data.filename:e.data.fileurl)+"</a>",e.data.filecaption&&(i=i+"<br><spam>"+e.data.filecaption+"</spam>")):i='<spam class="alert">Inline media will not be rendered under related conversation</spam>':e.data&&"unsupported"==e.data.media?i='<spam class="alert">File not available, the sender\'s file type is unsupported'+(e.data.filetype?" - "+e.data.filetype:"")+"</spam>":e.data&&"toolarge"==e.data.media?i='<spam class="alert">File not available, the sender\'s file size exceeded the maximum file size limit</spam>':e.data&&"failed"==e.data.media?i='<spam class="alert">File not available, the system encountered an error while downloading the file from sender</spam>':t("incomplete media message in segment"),i){(s=document.createElement("div")).className="info";var r="";if(e.ts)r=(h=new Date(parseInt(e.ts)))instanceof Date&&!isNaN(h)?'<span class="time">'+h.toLocaleTimeString()+"</span>":"";return s.innerHTML='<img src="assets/cleardot.gif" aria-label="Profile Picture" aria-hidden="true" alt=""/><span class="text" dir="auto">'+i+"</span>"+r,o.set_src(s.children[0],e.picture),s}return null}if("location"==e.type){let t=null;if(e.data&&e.data.latitude&&e.data.longitude){let i=null;if(e.data.url)i=anchorme({input:n(e.data.url),options:{attributes:{target:"_blank",rel:"noopener noreferer"},protocol:function(e){return"https://"},truncate:25,middleTruncation:!0}})||i;let a=Le.show_map;if(a&&a.vendor&&"google"==a.vendor&&a.config&&a.config.key&&["static","interactive"].indexOf(a.config.type)>-1&&a.config[a.config.type]){let o=a.config[a.config.type].replace(/{API_KEY}/g,a.config.key).replace(/{LATITUDE}/g,e.data.latitude).replace(/{LONGITUDE}/g,e.data.longitude);t="static"==a.config.type?'<img class="static" src="'+o+'">':'<iframe title="Location" class="interactive" src="'+o+'"></iframe>',e.data.name&&(t+='<span class="name">'+n(e.data.name)+"</span>"),e.data.address&&(t+='<span class="address">'+n(e.data.address)+"</span>"),i&&(t+=i),t='<div class="location">'+t+"</div>"}else t="Latitude: "+n(e.data.latitude)+"<br>Longitude: "+n(e.data.longitude),e.data.name&&(t+="<br>Name: "+n(e.data.name)),e.data.address&&(t+="<br>Address: "+n(e.data.address)),i&&(t+=i),t='<span class="text" dir="auto">'+t+"</span>"}if(t){(s=document.createElement("div")).className="message "+$r(e.sender);r="";if(e.ts)r=(h=new Date(parseInt(e.ts)))instanceof Date&&!isNaN(h)?'<span class="time">'+h.toLocaleTimeString()+"</span>":"";return s.innerHTML='<img src="assets/cleardot.gif" aria-label="Profile Picture" aria-hidden="true" alt=""/>'+t+r,o.set_src(s.children[0],e.picture),s}return null}var s=document.createElement("div");if("whisper"==e.type){if(!e.data.whisper||!e.data.whisper.senderName)return t("missing whisper sender details"),null;e.senderName=e.data.whisper.senderName,e.data.whisper.senderPicture&&(e.picture=e.data.whisper.senderPicture),s.className="message "+(e.position||$r(e.sender))+" "+e.type}else s.className="info"==e.type?"info":"message "+(e.position||$r(e.sender));var c=null;if(!(c=a?(c="html"==e.mediatype?(e.text||"").replace(/<.*?>/g,""):e.text||"").length>80?n(c=(c=c.substr(0,77)).substr(0,c.lastIndexOf(" ")))+"&hellip;":n(c):e.data&&e.data.context&&e.data.context.html?Ao(e.data.context.html):"markdown"==e.mediatype?An.makeHtml(e.text):"html"==e.mediatype?Ao(e.text):n(e.text))||c.length<=0)return t("WARN: chat/info message with empty text"),null;var l=anchorme({input:c,options:{attributes:{target:"_blank",rel:"noopener noreferer"},exclude:function(e){if(console.log("anchorme: "+e),e.startsWith("url="))return!0},protocol:function(e){return anchorme.validate.email(e)?"mailto:":"https://"},truncate:25,middleTruncation:!0}});(p=document.createElement("SPAN")).className="text",p.dir="auto";var d=document.createElement("SPAN");if("dialpad"==kt){let t=null;(h=e.ts&&!isNaN(e.ts)?new Date(parseInt(e.ts)):new Date).toLocaleString();var u=wo(h);"info"!==e.type?p.innerHTML='<div class="user-details"><img src="assets/cleardot.gif" class="avatar" alt="" aria-label="Profile Picture" aria-hidden="true"/><span class="name">'+e.senderName+'</span><span class="timestamp">'+n(u)+'</span><span class="time">'+n(u)+"</span></div><p "+(Et?"":'tabindex="0"')+' class="text" dir="auto">'+c+'</p><span class="ack">'+(Et&&t?t:"")+"</span>":p.innerHTML='<div class="user-details"><span class="timestamp">'+n(u)+'</span><span class="time">'+n(u)+"</span></div><p "+(Et?"":'tabindex="0"')+' class="text" dir="auto">'+c+'</p><span class="ack">'+(Et&&t?t:"")+"</span>",function(e,t){e&&t&&(e.className=(e.className?e.className+" ":"")+t.split(" ").map((function(e){return"chatitem-"+e})).join(" "))}(s,e.className),function(e,t,i){e&&(t.setAttribute("hasstyle","true"),i.setAttribute("style",e))}(e.style,s,s),Sr(s),s.appendChild(p),function(e,t,i){let n=t;Yl.set_src(e.children[0],n)}(s.getElementsByClassName("user-details")[0],e.picture,e.id),(d=document.createElement("SPAN")).className="time"}else{var p,f=document.createElement("IMG");if(f.setAttribute("aria-label","Profile Picture"),f.setAttribute("aria-hidden","true"),f.src="assets/cleardot.gif",s.appendChild(f),(p=document.createElement("SPAN")).className="text",p.dir="auto",p.innerHTML=l||c,s.appendChild(p),(d=document.createElement("SPAN")).className="time",e.ts){var h=new Date(parseInt(e.ts));d.innerHTML=h instanceof Date&&!isNaN(h)?h.toLocaleTimeString():""}}s.appendChild(d);var g=function(e){let t=document.createElement("SPAN");return t.className="translated-text","dialpad"==kt&&(t.className=t.className+" dialpad-translated-text"),t.dir="auto",e&&(t.innerHTML=e.replaceAll("< br>","<br>")),t};if(Et)if(e.data&&e.data.translation){if(e.data.translation.sourcelang!=e.data.translation.translatedlang){let t=e.data.translation.translatedtext||e.data.translation.sourcetext;s.insertBefore(g(t),d)}}else if(Ln.config&&Ln.config.lang_translation&&["voice"].indexOf(Ca)<0&&"chat"==e.type&&s.className.split(" ").includes("customer")){var v=document.createElement("DIV");v.className="translate-button","dialpad"==kt&&(v.className=v.className+" dialpad-translate-button"),v.innerHTML="Translate",v.addEventListener("click",(function(e){s.removeChild(v),Yl.get_translation(Yl.auth.providerId,c,null,(function(e){e&&e.sourcelang&&e.translation?e.sourcelang!=e.translation[0].lang&&e.translation[0].text&&s.insertBefore(g(e.translation[0].text),d):t("segment translation is empty")}),(function(e){t("translation failed")}))})),s.insertBefore(v,d)}return o.set_src(s.children[0],e.picture),s}var Kr="",Yr=!1;An=new showdown.Converter({emoji:!0,simpleLineBreaks:!0,parseImgDimensions:!0,simplifiedAutoLink:!0,openLinksInNewWindow:!0});function Xr(e){for(var i=e.currentTarget.value.toLowerCase(),n=e.currentTarget.parentNode.nextElementSibling.children,a=0;a<n.length;++a){var o=n[a],r=o.search||"";t(r),i&&r.indexOf(i)<0?o.setAttribute("filtered","true"):o.removeAttribute("filtered")}}function Zr(e){i("div.page.chatside div.assign input.search").value="",i("div.page.chatside div.suggestions input.search").value="",i("div.page.chatside div.widgets input.search").value="","timeline"==e?Yl.get_provider_related_chats(aa,Ln.id,(function(e){lastmonyyyy="";var t=[],n={};e.filter((function(e){return e.lastMessage&&e.lastMessage.ts})).sort((function(e,t){var i,n;try{i=parseInt(e.lastMessage.ts)}catch(e){i=0}try{n=parseInt(t.lastMessage.ts)}catch(e){n=0}return i-n})).reverse().forEach((function(e){n[e.chat]=e;var i=e.participants.filter((function(e){return e.id!=aa}));if(i.length>0){var a=new Date(parseInt(e.lastMessage.ts)),o=function(e){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]+" "+e.getFullYear()}(a),r=null;lastmonyyyy&&o==lastmonyyyy?r=t[t.length-1]:(lastmonyyyy=o,r='<div class="item" expanded="false"><div class="month">'+o+"</div></div>",t.push(r));var s=Qr([e.lastMessage])||"",c='<div class="conversation" expanded="false" data-id="'+e.chat+'"><div class="header"><div class="date">'+a.getDate()+'</div><div class="title">'+i[0].name+'</div></div><div class="history">'+s+"</div></div>";r=r.substr(0,r.length-6)+c+"</div>",t.splice(t.length-1,1,r)}})),i("div.page.chatside div.timeline div.content").innerHTML=t.join("\n");for(var a=i("div.page.chatside div.timeline div.content").children,o=0;o<a.length;++o)a[o].children[0].addEventListener("click",(function(e){var t=e.currentTarget.parentNode;t.setAttribute("expanded","true"==t.getAttribute("expanded")?"false":"true")}));for(a=i("div.page.chatside div.timeline div.content").querySelectorAll("div.header"),o=0;o<a.length;++o)a[o].addEventListener("click",(function(e){var t=e.currentTarget.parentNode,i=t.getAttribute("data-id");if("true"==t.getAttribute("expanded")){t.setAttribute("expanded","false");var a=Qr([n[i].lastMessage])||"";t.children[1].innerHTML=a}else t.setAttribute("expanded","true"),Yl.get_chat_messages(i,null,(function(e){var i=Qr(e)||"";t.children[1].innerHTML=i}),(function(e){Ye("Failed to fetch conversation history","Error")}))}));To("last",!0)}),(function(e){Ye("Failed to get related conversations","Error")})):"tags"==e?es():"assign"==e?function(){if(Et)Yl.get_provider_agents(Ln.id,(function(e){i("div.page.chatside div.assign div.content").innerHTML="",e.forEach((function(e){if(e.id!=Yl.auth.user_id){var a=document.createElement("div");a.className="item",a.data=e,a.setAttribute("status",e.status||"unknown"),a.setAttribute("type",e.skills?e.skills.includes("bot")?"bot":e.skills.includes("admin")?"admin":"agent":"agent"),a.search=(e.name+" "+(e.skills||[""]).join(" ")).toLowerCase(),a.innerHTML='<div class="picture"><img src="assets/cleardot.gif"/></div><div class="name">'+n(e.name)+'</div><div class="desc">'+(e.skills||[""]).map((function(e){return"<span>"+n(e)+"</span>"})).join(" | ")+'</div><div class="status"></div>',Yl.set_src(a.children[0].children[0],e.picture),i("div.page.chatside div.assign div.content").appendChild(a),a.addEventListener("click",(function(e){var n=e.currentTarget.data;hs("chat assign",{id:Hn,customer:aa,agentname:n.name,agentid:n.id});let a=i("div.page.chat div.input");if(Et&&a&&"active"!=a.getAttribute("state"))return t("ignore assign/transfer for inactive chat"),void Ye("Assign not supported for inactive chats and search results","Warning");b({title:"Assign chat",message:Qa("chatassign_message").replace(/%s/,n.name),buttons:{Assign:{class:"orange",action:()=>{Yl.do_provider_chat_assign(Hn,aa,n.id,(function(e){Ln&&Sn&&aa&&so({type:"notification",message:{action:{path:"chatwith/"+n.id},type:"action"},allow:["customer","guest"]});Sd("#chats"),is()}),(function(e){Ye("Failed to transfer the conversation","Error"),is()}))}},Cancel:{class:"gray",action:()=>{hs("chat assign cancel",{id:Hn})}}}})}))}}))}),(function(e){Ye("Failed to get agents list","Error")}));else{i("div.page.chatside div.assign div.content").innerHTML="";for(var e=0;e<xa.length;++e){var a=xa[e];if(a.text){var o=last_item=document.createElement("div");o.data=a,o.innerText=n(a.text),i("div.page.chatside div.assign div.content").appendChild(o),o.addEventListener("click",lr)}}}}():"suggestions"==e?Yl.get_provider_canned_messages((function(e){i("div.page.chatside div.suggestions > div.content").innerHTML="";for(var a=0;a<e.length;++a){var o=e[a],r=document.createElement("div");r.data=o,r.search=o.text.toLowerCase(),r.className="item",r.innerHTML=n(o.text),i("div.page.chatside div.suggestions > div.content").appendChild(r),r.addEventListener("click",(function(e){let n=i("div.page.chat div.input");if(Et&&n&&"active"!=n.getAttribute("state"))return t("ignore suggestions for inactive chat"),void Ye("Suggestions not supported for inactive chats and search results","Warning");e&&hs("chatside suggestions item",e.currentTarget.data),"chat"==e.currentTarget.data.type&&(i("div.page.chat div.textarea > textarea").value=e.currentTarget.data.text,i("div.page.chat div.textarea > textarea").focus()),is()}))}}),(function(e){Ye("Failed to get suggestion messages","Error")})):"urlhistory"==e?Yl.get_customer_provider_context(aa,Ln.id,"url-history",(function(e){i("div.page.chatside div.urlhistory div.content").innerHTML="",e.context.forEach((function(e){var t=document.createElement("a");t.setAttribute("target","_blank"),t.setAttribute("href",e.URL),t.innerText=e.title||e.URL,i("div.page.chatside div.urlhistory div.content").appendChild(t)}))}),(function(e){i("div.page.chatside div.urlhistory div.content").innerHTML=""})):"widgets"==e?Yl.get_provider_widgets((function(e){i("div.page.chatside div.widgets > div.content").innerHTML="";for(var t=0;t<e.length;++t){var a=e[t],o=a.icon;o&&"icons/"==o.substr(0,6)?o=Kl.resolve("/kpd-static/database/oldagentapp/"+o.substr(6)):o&&(o=Kl.resolve(o));var r=document.createElement("div");r.data=a,r.search=(a.name+" "+a.description).toLowerCase(),r.className="item",r.innerHTML='<img src="'+o+'"/><span class="title">'+n(a.name)+'</span><span class="description">'+n(a.description)+"</span>",i("div.page.chatside div.widgets > div.content").appendChild(r),r.addEventListener("click",(function(e){rr(e.currentTarget.data),is()}))}}),(function(e){Ye("No widgets configured currently.","Error")})):"useractivity"==e?(as="",i("div.page.chatside div.useractivity div.content").innerHTML="",ga.forEach((function(e){os(e)}))):"customerinfo"==e?Yl.get_customer_business_profile(aa,Kl.myprofile.providerId,(function(e){var a=[{key:"name",value:e.name},{key:"email",value:e.email},{key:"phone",value:e.phone}];for(var o in e)e.hasOwnProperty(o)&&["name","email","phone"].indexOf(o)<0&&"string"==typeof e[o]&&e[o]&&a.push({key:o,value:e[o]});i("div.page.chatside div.customerinfo div.content").innerHTML="",a.forEach((function(e){e.value=n(e.value);var t=document.createElement("div");t.className="info-"+e.key;var a=document.createElement("span");a.innerHTML=e.key,t.appendChild(a);var o=document.createElement("input");o.type="text",o.setAttribute("fieldname",e.key),o.readOnly=!0,o.spellcheck=!1,e.value?o.value=e.value:o.placeholder="Click here to add "+e.key,t.appendChild(o),o.addEventListener("click",(function(e){e.currentTarget.getAttribute("lastvalue")||e.currentTarget.setAttribute("lastvalue",e.currentTarget.value),e.currentTarget.readOnly=!1,e.preventDefault()})),o.addEventListener("focusout",(function(e){if(e.currentTarget.readOnly=!0,null==e.currentTarget.getAttribute("update-status")){let t=e.currentTarget.getAttribute("lastvalue");null!=t&&(e.currentTarget.value=t,e.currentTarget.removeAttribute("lastvalue"))}e.preventDefault()})),o.addEventListener("keyup",(function(e){if(13==e.keyCode){e.currentTarget.setAttribute("update-status","in-progress"),e.currentTarget.readOnly=!0;var t=e.currentTarget.value.trim();if(0==(t=t.length>0&&/email/i.test(e.currentTarget.getAttribute("fieldname"))?t.toLowerCase():t).length||/email/i.test(e.currentTarget.getAttribute("fieldname"))&&!/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/i.test(t))return null!=e.currentTarget.getAttribute("lastvalue")&&(e.currentTarget.value=e.currentTarget.getAttribute("lastvalue")),e.currentTarget.removeAttribute("lastvalue"),e.currentTarget.removeAttribute("update-status"),void(t.length>0&&/email/i.test(e.currentTarget.getAttribute("fieldname"))&&Ye("Invalid email address","Error"));var a={};a[e.currentTarget.getAttribute("fieldname")]=t,Yl.put_customer_business_profile(aa,Kl.myprofile.providerId,{entity:a},(function(e){if(i("div.page.chatside div.customerinfo div.content").hasChildNodes())if("success"==e.code&&e.entity){var t=e.entity;for(var n in t){var a=i("div.page.chatside div.customerinfo div.content div.info-"+n+" > input[fieldname='"+n+"']");a&&(a.removeAttribute("lastvalue"),a.removeAttribute("update-status"),a.value=t[n])}}else{var o=i("div.page.chatside div.customerinfo div.content").childNodes;o&&o.forEach((function(e){/^info\b-*/.test(e.className)&&e.childNodes&&e.childNodes.forEach((function(e){e.getAttribute("fieldname")&&null!=e.getAttribute("lastvalue")&&(e.value=e.getAttribute("lastvalue")),e.removeAttribute("lastvalue"),e.removeAttribute("update-status")}))})),Ye("Failed to set customer info","Error")}}),(function(e){var t=i("div.page.chatside div.customerinfo div.content").childNodes;t&&t.forEach((function(e){/^info\b-*/.test(e.className)&&e.childNodes&&e.childNodes.forEach((function(e){e.getAttribute("fieldname")&&null!=e.getAttribute("lastvalue")&&(e.value=e.getAttribute("lastvalue")),e.removeAttribute("lastvalue"),e.removeAttribute("status")}))})),Ye(e,"Error")})),"name"==e.currentTarget.getAttribute("fieldname")&&Yl.set_guest_customer_name(aa,t,(function(e){if("success"==e.code&&e.entity&&e.entity.name){var t=n(e.entity.name);i("div.page.chat div.expanded span.name").innerHTML=t,i("div.page.chat div.header div.name").innerHTML=t;let a=i("div.container div.list div.item[selected='true'] div.name");a.childNodes[0]&&(a.childNodes[0].data=t),Fa.get(aa)&&(Fa.get(aa).name=t),yo(i("div.container div.list div.item[selected='true'] div.picture.user"),aa);let o=document.querySelectorAll('.chat .history .message.customer[senderid="'+aa+'"] .user-details .name');o.forEach((e=>{e.innerHTML=t})),o=document.querySelectorAll('.chat .history .message.customer[senderid="'+aa+'"] .user-details'),o.forEach((e=>{yo(e,aa)}))}}),(function(e){Ye(e,"Error")}))}else e.preventDefault()})),i("div.page.chatside div.customerinfo div.content").appendChild(t)}));let r=document.createElement("div");r.setAttribute("id","page-chatside-tabs-customerinfo-social-placeholder"),r.setAttribute("style","visibility: hidden; padding: 0px;");let s=document.createElement("div");s.setAttribute("id","page-chatside-tabs-customerinfo-notes-placeholder"),s.setAttribute("style","visibility: hidden; padding: 0px;");let c=document.createElement("div");c.setAttribute("id","page-chatside-tabs-customerinfo-remotelocation-placeholder"),c.setAttribute("style","visibility: hidden; padding: 0px;"),i("div.page.chatside div.customerinfo div.content").appendChild(r),i("div.page.chatside div.customerinfo div.content").appendChild(c),i("div.page.chatside div.customerinfo div.content").appendChild(s),Yl.get_customer_business_profiles(aa,Kl.myprofile.providerId,(function(e){for(const s of e)if(s.hasOwnProperty("channeltype")){var t=document.createElement("div"),n=s.channeltype.toLowerCase().replace(/\s/g,"");t.id="page-chatside-tabs-channeltype-"+n,t.className="channeltype-"+n,t.innerHTML=s.channeltype;var a=document.createElement("div");a.id="page-chatside-tabs-channeltype-content",a.className="channeltype-content",t.appendChild(a);for(const e in s)if(!(["channeltype","businesskey"].indexOf(e)>=0))if("otherdata"==e){const t=s[e];for(const i in t)["screen_name","device","messagereceivingstate"].indexOf(i)>=0&&((o=document.createElement("div")).id="page-chatside-tabs-channeltype-"+e+"-"+i,o.className="channeltype-"+e+"-"+i,o.innerHTML=i+": "+t[i],a.appendChild(o))}else{var o;(o=document.createElement("div")).id="page-chatside-tabs-channeltype-"+e,o.className="channeltype-"+e,o.innerHTML=e+": "+s[e],a.appendChild(o)}i("div.page.chatside div.customerinfo div.content").insertBefore(t,r)}}),(function(e){t(e),i("div.page.chatside div.customerinfo div.content").innerHTML="",Ye("No social identity for user","Error")})),Yl.get_customer_provider_context(aa,Ln.id,"location",(function(e){let t=[],a=e.context[0];if(a&&a.latitude&&a.longitude&&null!=Le.show_map){let e=Le.show_map;if(e.vendor&&"google"==e.vendor&&e.config&&e.config.key&&["static","interactive"].indexOf(e.config.type)>-1&&e.config[e.config.type]){if(a.type){let e=document.createElement("div");e.className="info-location-type",document.createElement("span").innerText=a.type,i("div.page.chatside div.customerinfo div.content").insertBefore(e,c)}let t=document.createElement("div");t.className="info-location";let n=null;return"static"==e.config.type?(n=document.createElement("img"),n.className="static"):(n=document.createElement("iframe"),n.className="interactive"),n.src=e.config[e.config.type].replace(/{API_KEY}/g,e.config.key).replace(/{LATITUDE}/g,a.latitude).replace(/{LONGITUDE}/g,a.longitude),t.appendChild(n),void i("div.page.chatside div.customerinfo div.content").insertBefore(t,c)}}for(var o in a)a.hasOwnProperty(o)&&t.push({key:o,value:a[o]});t.length&&t.forEach((function(e){var t=document.createElement("div");t.className="info-"+n(e.key);var a=document.createElement("span");a.innerHTML=n(e.key),t.appendChild(a);var o=document.createElement("span");o.innerHTML=e.value,t.appendChild(o),i("div.page.chatside div.customerinfo div.content").insertBefore(t,c)}))})),Yl.get_customer_provider_context(aa,Kl.myprofile.providerId,"customerinfo-notes",(function(e){ns(e.context[0],s)}),(function(){ns(null,s)}))}),(function(e){t(e),i("div.page.chatside div.customerinfo div.content").innerHTML="",Ye("Failed to get customer info","Error")})):"actions"==e&&function(){if(i("div.page.chatside div.actions div.content").innerHTML="","inactive"==oa&&["voice"].indexOf(Ca)<0){var e=Object.keys(Rn);if(null!=e&&e.length>0){var n=Yl.auth.user_id;if(e.length>1)for(let t=0;t<e.length;t++){const i=e[t];if(i!=aa){n=i;break}}var a=document.createElement("div");a.className="item",a.innerHTML="Reopen Conversation",a.addEventListener("click",(function(e){hs("chatside action: open-closed-chat",{chatId:Hn,chatCustomerId:aa,chatDropUserId:n}),Kr=l("chattab","",Kr),Yl.do_provider_chat_reopen(Hn,aa,n,(function(e){t("successfully opened conversatoin:"+JSON.stringify(e)),"email"==Ca&&(oa="active",Il(Hn))}),(function(e){t("failed to reopen conversation reason:"+e),Ye(e||"Failed to open conversation","Error")}))})),i("div.page.chatside div.actions div.content").appendChild(a)}}Yl.get_customer_business_profiles(aa,Kl.myprofile.providerId,(function(e){if(e&&e.length>0)for(let s=0;s<e.length;s++){var n=e[s];if(n.channeltype&&["facebook","twitter"].indexOf(n.channeltype)>=0){n.otherdata&&delete n.otherdata.kpdConvMetaData;var a=n.businesskey;n.channeltype="facebook"==n.channeltype?"messenger":"twitter-dm",n.businesskey=a.split(/[-]+/).pop();var o={type:n.channeltype,info:{userChannelId:n.businesskey,userChannelName:n.name,providerChannelId:a.split(/[-]+/).shift().split(/[_]+/).shift(),providerChannelVendor:"messenger"==n.channeltype?"facebook":"twitter"}},r=document.createElement("div");r.className="item",r.innerHTML="Start Private Chat",r.addEventListener("click",(function(e){hs("chatside action: start-private-chat",{pubCustomerId:aa,pvtBusinessProfile:n}),Kr=l("chattab","",Kr),Yl.get_or_create_customer_business_profile(Kl.myprofile.providerId,n.channeltype,n.businesskey,n,(function(e){e&&e.koopidid?Yl.do_provider_chat_initiate(e.koopidid,o,(function(e){null!=e&&"success"==e.code||Ye("Failed to start private chat as the customer is active on another conversation","Error")}),(function(e){t("failed to start private chat reason:"+e),Ye(e||"Failed to start private chat","Error")})):Ye("Failed to get private profile","Error")}),(function(e){t("failed to get private profile reason:"+e),Ye(e||"Failed to get private profile","Error")}))})),i("div.page.chatside div.actions div.content").appendChild(r);break}}}),(function(e){console.log(JSON.stringify(e))}))}()}function Qr(e){return e.map((function(e){if(e.allow&&(Et&&(e.allow.indexOf("customer")>=0||e.allow.indexOf("guest")>=0)||!Et&&e.allow.indexOf("agent")>=0))return t("dropping messae as not allowed"),null;var i=(e.text||"").replace(/<img(.*?)>/g,"");if("chat"==e.type){var n=e.sender==aa?"customer left":"agent right",a="</div>";if((o=new Date(parseInt(e.ts)))instanceof Date&&!isNaN(o))a='<span class="time"> '+o.toLocaleTimeString()+"</span> </div>";return"markdown"==e.mediatype&&(i=An.makeHtml(i)),'<div class="message '+n+'"><span class="text" dir="auto">'+i+"</span>"+a}if("info"==e.type)return'<div class="info"><span class="text" dir="auto">'+i+'</span><span class="time"> '+(o=new Date(parseInt(e.ts))).toLocaleTimeString()+"</span></div>";if("whisper"==e.type){var o;n="agent right whisper",a="</div>";if((o=new Date(parseInt(e.ts)))instanceof Date&&!isNaN(o))a='<span class="time"> '+o.toLocaleTimeString()+"</span> </div>";return'<div class="message '+n+'"><span class="text" dir="auto">'+i+"</span>"+a}return'<div class="other">'+(i||"message type "+e.type)+"</div>"})).join("\n")}function es(){Yl.get_provider_chat_tags(Hn,(function(e){i("div.page.chatside div.tags div.content").innerHTML="",e.forEach((function(e){var t=document.createElement("div");t.className="item",t.data=e,e.chat=Hn,t.innerHTML=n(e.tag),i("div.page.chatside div.tags div.content").appendChild(t),t.addEventListener("click",(function(e){var t=e.currentTarget,n=e.currentTarget.data;Yl.delete_provider_chat_tag(n.chat,n.id,(function(){i("div.page.chatside div.tags div.content").removeChild(t)}),(function(e){Ye("Failed to remove this tag","Error")}))}))}))}),(function(e){Ye("Failed to get tags","Error")}))}function ts(e){if(13==(e.which||e.keyCode)){var t=e.currentTarget.value.trim();e.currentTarget.value="",t&&Yl.add_provider_chat_tag(Hn,t,(function(e){fr({id:e.id,tag:t}),ur("/chat",{type:"action",action:{invoke:"chatupdate",args:[Hn]}}),gr(),es()}),(function(e){Ye("Failed to add this tag","Error")}))}}function is(){"desktop"!=ql&&Kr&&(Kr=l("chattab","",Kr))}function ns(e,t){let n=document.createElement("div");n.className="info-notes",n.setAttribute("id","page-chatside-tabs-customerinfo-notes");let a=document.createElement("div");a.setAttribute("id","quill-notes"),n.appendChild(a),t.replaceWith(n);var o=new Quill("#quill-notes",{modules:{toolbar:[["bold","italic","underline",{list:"ordered"},{list:"bullet"}],[{align:[]},{indent:"-1"},{indent:"+1"}],[{color:[]},{background:[]}]]},scrollingContainer:"#scrolling-container",placeholder:"Type customer notes here...",theme:"snow"});e?o.setContents(e):e="",buttons='<input id="page-chatside-tabs-customerinfo-notes-submit" class="notes-button" type="button" value="Save"/>            <input id="page-chatside-tabs-customerinfo-notes-cancel" class="notes-button" type="button" value="Cancel"/> ';var r=document.createElement("div");r.innerHTML='<input id="page-chatside-tabs-customerinfo-notes-submit" class="notes-button" type="button" value="Save"/>            <input id="page-chatside-tabs-customerinfo-notes-cancel" class="notes-button" type="button" value="Cancel"/> ',n.appendChild(r),i('div.page.chatside div.customerinfo div.info-notes input.notes-button[value="Save"]').addEventListener("click",(function(t){let i=o.getContents();if(i){let t={type:"customerinfo-notes",context:[i]};console.log("customerinfo-notes: "+JSON.stringify(t)),Yl.post_customer_provider_context(aa,Kl.myprofile.providerId,t,(function(){console.log("Saved customerinfo-notes"),e=i}),(function(){console.log("Failed to save customerinfo-notes. Cancelt to restore previously saved note.")}))}})),i('div.page.chatside div.customerinfo div.info-notes input.notes-button[value="Cancel"]').addEventListener("click",(function(t){o.setContents(e)}))}var as="";function os(e){var t=e.data,a=t.timestamp?new Date(t.timestamp):e.timestamp?new Date(e.timestamp):new Date,o=bo(a);as!=o&&(as=o,(r=document.createElement("div")).className="date",r.innerText=o,i("div.page.chatside div.useractivity div.content").appendChild(r));var r,s=wo(a);(r=document.createElement("div")).className="activity",r.innerHTML='<span class="time">'+n(s)+'</span><span class="text">'+("string"==typeof t?t:t.text)+"</span>",i("div.page.chatside div.useractivity div.content").appendChild(r)}function rs(e){var t=i("div.page.chatside div.useractivity div.footer input.input").value;if(t){var a=t,o=t.indexOf(" ");o>=0&&(a=t.substr(0,o),(t=t.substr(o+1).trim())||(t=a));var r={invoke:"parent",args:[{url:a}]};Se({invoke:"send",args:[{type:"notification",allow:["customer","guest"],message:{type:"action",action:r}}]},["invoke"]),Se({invoke:"send",args:[{type:"chat",htmlText:'<a class="action sendurl" action="'+n(JSON.stringify(r))+'">'+n(t)+"</a>"}]},["invoke"])}else Ye("Missing URL to send")}var ss=[],cs=null,ls=null,ds=["callmode","callstate","calltype","enablerecord","enabletranscribe","expandchattitle","frontdoor","hasnotification","hasphone","hassearch","hassms","haswidget","ismultiuser","isprovider","loggedin","mobileforeground","page","presencestate","printable","profilestatus","selectedmessage","selectedphone","selectfiles","showcallmenu","showchatmenu","showhomebutton","showmenu","showpresencemenu","showsearch","showsubscribe","showsuggest","showtodomenu","showwidget","showwidgetclose","windowforeground"];function us(e,t){ks({type:"system",text:e,data:t},!0)}function ps(e,t){ks({type:"data",text:e,data:t})}function fs(e,t,i){ks({type:"property",text:e,data:{old:t,new:i}})}function hs(e,t){ks({type:"action.click",text:e,data:t})}function gs(e,t,i){ks({type:"action"+(e?"."+e:""),text:t,data:i})}function vs(e,t){t.chat=Hn,ks({type:"event",text:e,data:t})}function ms(e){var t=(e||"").match(/\?(.*&)?title=([^&]+)/),i=t?t[2]:null;return(e||"").split("?")[0]+(i?"?title="+i:"")}function ys(e,t){t.chat=Hn,ks({type:"message",text:e,data:t})}function bs(e,t,i){t==Pn?i.chat=Hn:i.path=t,ks({type:"message",text:e,data:i})}function ws(e,t){ks({type:"ack",status:e,data:t})}function xs(e,t,i){var n=t.split("/");n.length>=4&&"notification"==n[0]&&(i.provider=n[1],i.sender=n[2],i.receiver=n[3]),ks({type:"notify",text:e,data:i})}function _s(){ks(void 0,!0)}function ks(e,t){t?null!=cs&&(clearTimeout(cs),cs=null):null==cs&&(cs=setTimeout(Ts,5e3)),e&&ls&&(e.provider=ls);var i=(new Date).getTime(),n=e?i+","+JSON.stringify(e):null;n&&ss.push(n),t&&Ts()}function Ts(e){if(cs=null,void 0!==Cn&&null!=Cn&&Cn.isConnected())for(var t="eventlog/v1/client/"+Sn+"/"+On;ss.length>0;)Cn.send(t,ss.shift(),2,!1)}function Es(e){if(f()&&Et){let t={};try{t={client:Sn||"unknown","deviceid:":On||"unknown",msg:e}}catch(i){t={msg:e,error:"Failed to fill client id and deviceid: "+i}}x({type:"logecho",data:t}),us("logecho",t)}}var As=null,Ls=null,Ns=[],Cs=null,Ss=null;function Os(e){t("netlogger_start value="+e);Ls=e,Cs=window.console||{};var i=function(e,t){if(As&&As.isConnected()){for(var i="netlogger/client/"+Ls+"/"+(Tt&&Yl.auth?Yl.auth.user_id:"guest");Ns.length>0;){var n=Ns.shift();As.send(i+"/"+n.type,""+n.msg,2,!1)}As.send(i+"/"+e,""+t,2,!1)}else Ns.push({type:e,msg:t})};window.console={log:function(e){Cs.log(e),i("log",e)},trace:function(e){Cs.trace(e),i("trace",e)},debug:function(e){Cs.debug(e),i("debug",e)},info:function(e){Cs.info(e),i("info",e)},warn:function(e){Cs.warn(e),i("warn",e)},error:function(e){Cs.error(e),i("error",e)}},(As=new Paho.Client("wss://apac-in.app.koopid.ai/message/",(""+Math.random()).substr(2,10))).connect({onSuccess:function(){console.info("connected")},onFailure:function(){console.error("connection failed")}}),Ye("Netlogger ID is "+Ls,"Info"),Ss&&(clearTimeout(Ss),Ss=null),Ss=setTimeout((function(){Ss=null,Is()}),36e5)}function Is(){Ss&&(clearTimeout(Ss),Ss=null),window.console=Cs;try{As.disconnect()}catch(e){}Cs={},As=null,Ls=null,Ye("Netlogger stopped","Info")}var Ms=!1,js=!1,Ps="offline",Hs=!1,Rs=!1,Ds=!1,Fs="",Us=!1,zs=null,qs=null;function Js(e){Ps=l("profilestatus",e,Ps),i("div.page.profile div.header span.status").innerHTML=n(Ps)}function Ws(e){Hs=l("showsubscribe",!1,Hs)}function Bs(e){e&&hs("profile status"),Yl.get_chatmenu("Presence",qs+"/"+Ps,(function(e){i("div.presencemenu").innerHTML="",e.forEach((function(e){var t=document.createElement("div");t.className="item",t.innerHTML='<span class="icon"></span><span class="title">'+n(e.text)+"</span>",t.data=e,e.action?t.action=e.action:t.className+=" itemgroup",i("div.presencemenu").appendChild(t),t.addEventListener("click",(function(e){hs("presence menu item",e.currentTarget.data),Us=l("showpresencemenu",!1,Us);var t=e.currentTarget.action;t&&(!t.invoke||"widget"!=t.invoke&&"inlinewidget"!=t.invoke?Se(t,["invoke"]):(Gs(),setTimeout((function(){Se(t,["invoke"])}),1e3)))}))})),Us=l("showpresencemenu",!0,Us)}))}function Gs(e){"profile"==page&&zs&&(e&&"click"==e.type&&hs("profile chat input"),Us=l("showpresencemenu",!1,Us),profile=zs,profile_id=qs,zs=null,qs=null,profile.action?Se(profile.action,["path","url"]):Sd("#chatwith/"+profile_id),cc())}var $s=!1,Vs=!0,Ks=!1,Ys=!0,Xs=!1,Zs=!1,Qs="",ec=null,tc=null,ic=["https://app.koopid.io","https://app.koopid.ai",/^https:\/\/koopid\d*.loca.lt$/,/^https:\/\/koopid\d*.jprq.io$/,/^http:\/\/127\.0\.0\.1(:\d+)?$/,/^http:\/\/localhost(:\d+)?$/,/^https?:\/\/.*\.koopid\.io$/,/^https?:\/\/.*\.koopid\.ai$/,/^https?:\/\/.*\.dx\.dialpad\.com$/],nc=[];function ac(){f()&&(ic=[]);var e,o,s=(e="alloworigin",o=[window.location.search.substring(1),td&&td.query_string||""].join("&"),r(e,o));s&&s.length>0&&(ic=s),ec=i("div.page.chat div.widget"),tc=i("div.widget.overlay"),window.addEventListener("message",(function(e){vs("got message event",{data:e.data}),function(e){var o=function(e){var i=ic;Vt&&ei&&ei.config&&ei.config.alloworigins&&(i=ic.slice(0).concat(ei.config.alloworigins));var n=e.origin||e.originalEvent.origin;if(n==window.location.origin||i.indexOf("*")>=0||i.indexOf(n)>=0||n.match(/^https:\/\/koopid\d*.jprq.io$/)||n.match(/^https:\/\/koopid\d*.loca.lt$/)||n.match(/^https:\/\/.*\.dialpad\.com$/)||n.match(/^https:\/\/(?!xn--)[a-z0-9-]+-dot-(uv-beta|uvstaging)\.appspot\.com$/)||n.match(/^https:\/\/dialpadbeta\.com$/)||n.match(/^https:\/\/(uv-beta|uvstaging)\.appspot\.com$/)||document.referrer.startsWith(n));else{for(var a=!1,o=0;o<i.length;++o)if(n.match(i[o])){a=!0;break}if(!a)return t("ignoring received message for wrong origin "+n),null}t("received from widget "+e.data);try{t("widget path="+e.source.location.pathname)}catch(e){}var r=JSON.parse(e.data);if("getprofile"==r.type||"ajax"==r.type)try{var s=ec?ec.querySelector("iframe").contentWindow:null,c=tc?tc.querySelector("iframe").contentWindow:null;if(e.source!==s&&e.source!=c&&e.source.parent!=window)return t("cannot process "+r.type+" because window is not in the same origin"),null}catch(e){return t(e),t("cannot process "+r.type+" because window cannot be accessed, probably not in the same origin"),null}return r}(e);o&&function(e,o){switch(e.type){case"close":lc(),function(e){for(var t=document.querySelectorAll("div.inlinewidget > div > iframe"),i=0;t&&i<t.length;++i)if(e===t[i].contentWindow){var n=t[i].parentNode.parentNode;"true"==n.getAttribute("active")&&!0,n.setAttribute("active","false")}0}(o),fc();break;case"showclose":t("WARN: on-widget-message deprecated: showclose. Use action=invoke/showwidgetclose"),Ks=l("showwidgetclose",!0,Ks);break;case"exit":t("WARN: on-widget-message removed: exit, Use action=invoke/chatclose");break;case"rate":Et||"/widgets/rating/index.html"!=Qs&&"widgets/rating/index.html"!=Qs||Yl.post_chat_rating(Hn,e.value,e.review);break;case"schedule":Et||(t("WARN: on-widget-message deprecated: schedule, Use action=invoke/send/chat/text"),so({type:"chat",text:"I am scheduled at "+e.value}));break;case"getprofile":!function(e,t,i,n){if(Et&&"chat"==page&&"remote.location"==t){var o={type:"notification",message:{type:"action",action:{invoke:"postcontext",args:["location"]}}},r="notification/"+(s={customer:aa,provider:Ln.id,agent:Yl.auth.user_id}).provider+"/"+s.agent+"/"+s.customer+"/postcontext";so(o,r),xs("send profile request",r,{type:"action"}),setTimeout((function(){Yl.get_customer_provider_context(s.customer,s.provider,"location",(function(e){a(n,e.context[0]||{})}),(function(e){a(n,{})}))}),2e3)}else if(Et&&"chat"==page&&"remote.context"==t){var s={customer:aa,provider:Ln.id,agent:Yl.auth.user_id};Yl.get_customer_provider_context(s.customer,s.provider,i,(function(e){a(n,e.context[0]||{})}),(function(e){a(n,{})}))}else if(Et&&"chat"==page&&"remote"==t){var c=Rn[aa];a(n,{id:aa,name:c.name,email:c.email,phone:c.phone})}else a(n,Et||"chat"!=page||"location"!=t?"context"==t?{id:Yl.auth?Yl.auth.user_id:"",appurl:window.location.href,isprovider:Et,provider:Qt,chat:Hn}:Tt?{name:Kl.myprofile.name,email:Kl.myprofile.email,phone:Kl.myprofile.phone}:null:Kl.location)}(0,e.target,e.value,(function(t){var i=JSON.stringify({type:"setprofile",target:e.target,value:t});vs("trigger message event",{data:i}),o.postMessage(i,"*")}));break;case"notify":t("WARN: on-widget-message deprecated: notify, Use action=invoke/notify/text/title"),Ye(e.data.text,e.data.title);break;case"ajax":let p=e.options&&e.options.headers||void 0;Yl.ajax(e.method,Kl.api+e.path,e.data,(function(i){var n={type:"ajax",status:"success",id:e.id,data:i&&i.entity};i&&void 0!==i.entity||(t("WARN: fix this API "+e.method+" "+(Kl.api+e.path)+" to respond with entity attribute containing response."),n.data=i);var a=JSON.stringify(n);vs("trigger message event",{data:a}),o.postMessage(a,"*")}),(function(t){var i=JSON.stringify({type:"ajax",status:"error",id:e.id,data:t});vs("trigger message event",{data:i}),o.postMessage(i,"*")}),void 0,void 0,p);break;case"action":if(!Et&&e.action.path&&lc(!0),!Et&&("send"==e.action.invoke||"received"==e.action.invoke))if("info"==(c=e.action.args&&e.action.args[0]||{}).type&&(c.widgetInfo||c.extrafields))if(c.text&&Qs){var r=Qs.replace(/&state=.*/,"");(r=r+(r.indexOf("?")<0?"?":"&")+"state="+encodeURIComponent(JSON.stringify(c.widgetInfo||c.extrafields))).length>8e3&&(t("WARNING: truncating very long widget URL due to large state"),r=r.substr(0,8e3)),c.htmlText='<a class="action" action="invoke=widget/'+r+'"><table style="border: 0px"><tr><td> <img src="/kpd-client/assets/info-bubble-icon-32.png"></td><td class="infoBubble">'+n(c.text)+"</td></tr></table></a>",delete c.text,t("widget message converted to htmlText="+c.htmlText)}else t("ignoring widgetInfo or extrafield, because data.text="+c.text+" && activewidget="+Qs);Et&&"send"!=e.action.invoke&&"received"!=e.action.invoke||Se(e.action,["path","url","invoke"],void 0,!0);break;case"fingerprint":$t(e,(function(e){var t=JSON.stringify(e);vs("trigger message event",{data:t}),o.postMessage(t,"*")}));break;case"showinfobox":(e.title||e.text)&&(d={title:e.title,text:e.text},i("div.infobox div.title").innerText=d.title||"",i("div.infobox div.text").innerText=d.text||"",Zs=l("showinfobox",!0,Zs));break;case"getclipboard":if(u())cordova.plugins.clipboard.paste((function(e){var t=JSON.stringify({type:"setclipboard",value:e});vs("trigger message event",{data:t}),o.postMessage(t,"*")}),(function(){var e=JSON.stringify({type:"setclipboard",reason:"failed or no content"});vs("trigger message event",{data:e}),o.postMessage(e,"*")}));else{var s=JSON.stringify({type:"setclipboard",reason:"only allowed in mobile app."});vs("trigger message event",{data:s}),o.postMessage(s,"*")}break;case"setpending":t("Set pending received from widget"),Cd(e.value);break;case"presence":t("Setting agent presence state");var c=e.message.data;Yl.set_provider_presence(c.status,(function(){i("div.controls div.header div.presence").innerText=c.status}),(function(e){Ye("failed to set presence state","Warning")}));break;case"chatswitch":if(t((e.id,e.id)),za)return Ye("Chat close in progress, please wait","info",2e3),void us("chat-close-in-progress",{chat_id:Hn,"message.id":e.id});if(Et){let n=e.id.split("/"),a=qa=void 0;try{a=n[1].split("=")[1],qa=Number(a)}catch(e){}i('div.page.chats div.list > div.item[chat="'+n[0]+'"]')||"readonly"==jl||"sessionpanel"==Ml||"toolspanel"==Ml?setTimeout((function(){Hn!=n[0]&&Sd("#chat/"+e.id);try{setTimeout((function(){if(Hn==n[0]&&a){let e=i('div.page.chat div.history div[previous="'+a+'"]');t("on-widget-message-internal: scrolling to segment "+a),To(Number(e.getAttribute("index")),!1,!0)}}),200)}catch(i){t("on-widget-message-internal: failed to scroll to "+e.id)}}),200):t("Switch request to unknown chat id "+e.id)}break;case"logout":t("Logout request from parent app"),Sd("#logout/close");break;case"chatstart":t("Startchat event from parent app"),us("prelaunch-chat-start"),vd();break;case"url-history":t("URL history message "+JSON.stringify(e)),Yl.post_customer_provider_context("this",Ln.id,e,void 0,(function(e){t("post url history failed for id="+Ln.id+" error="+e)}))}var d}(o,e.source)}(e)}),!1),i("div.widget div.button.close").addEventListener("click",(function(e){hs("widget close button"),(Ks||"desktop"==ql||Et)&&lc()})),i("div.page.chat div.header div.button.showwidget").addEventListener("click",(function(e){hs("toggle widget button"),Vs=l("showwidget",!Vs,Vs)})),i("div.infobox").addEventListener("click",(function(e){e.target==i("div.infobox")&&(hs("infobox background"),Zs=l("showinfobox",!1,Zs))}))}function oc(e){if(e){if(unescape(e).indexOf("/../")>=0)return t("WARN: invalid characters in widget path: "+e),!1;var i=Kl.resolve(e);if(i.startsWith(Kl.web||"invalid"))return!!i.substr(Kl.web.length).match(/\/providers\/[a-zA-Z0-9]+\/(widgets|profile)\//)||(t("WARN: widget path is not verified, for state.web: "+i+" "+Kl.web),!1);if(nc.length>0)for(var n=0;n<nc.length;n++)if(i.startsWith(nc[n]))return!0;if(i.startsWith(window.location.origin)||i.startsWith("https://app.koopid.io")||i.startsWith(Kl.web.replace("/static",""))||i.match(/^https:\/\/koopid\d*.loca.lt\//)||i.match(/^https:\/\/koopid\d*.jprq.io\//)||i.match(/^https:\/\/.*\.dialpad\.com/)||i.match(/^https:\/\/(?!xn--)[a-z0-9-]+-dot-(uv-beta|uvstaging)\.appspot\.com/)||i.match(/^https:\/\/dialpadbeta\.com/)||i.match(/^https:\/\/(uv-beta|uvstaging)\.appspot\.com/)){var a=i.match(/https?:\/\/([^\/]*)(.*)/);if(t("Widget path: "+a),a[1].match(/koopid\d*.loca.lt$/)||a[1].match(/koopid\d*.jprq.io$/))return t("WARN: dev setup using localtunnel.  Make sure to upload widget for production use"),!0;if(!a||!a[2].match(/^\/((kpd-widgets\/)|(plugins\/)|((kpd-)?static\/providers\/\w+\/(widgets|profile)\/))/))return t("WARN: widget path is not verified, for same origin: "+i+" "+window.location.origin),!1;if(a[2].startsWith("/plugins/")){var o=a[1].match(/(?:www\.)?(.[^:]+):?\d*/),r=a[2].match(/plugins\/(.*)\//);if(!o||!r||r[1].split(".").length<2||!o[1].endsWith(r[1]))return t("WARN: widget path with plugins path should use subpath of domain"),!1}return!0}}return t("ERROR: Using an unverified widget path: "+e+" .  This needs to be fixed in the workflows as support for unverified paths are being removed for security reasons."),us("widget-validate-path",{text:"ERROR: Using an unverified widget path",path:e}),!1}function rc(e,i,n){var a=[];if(e&&"data:"!=e.substr(0,5)){var o="http:"==e.substr(0,5)||"https:"==e.substr(0,6);(!o||e.indexOf(".localtunnel.me/")>=0)&&(a.push("cusid="+(Yl.auth&&Yl.auth.user_id||"")),a.push("context="+encodeURIComponent(window.location.href))),n&&"inlinewidget"==i&&a.push("zoom="+n),o||(e=Kl.resolve(e))}var r=e+(a.length>0?(-1==e.indexOf("?")?"?":"&")+a.join("&"):"");return t("widget-url "+r),r}function sc(e){lc(),Ks=l("showwidgetclose",!1,Ks),Vs=l("showwidget",!0,Vs);var t=ec,i=ec.querySelector("iframe"),n=!1;if(e.style?(e.style.indexOf("bottom: 0px;")>=0||e.style.indexOf("bottom:0px;")>=0?n=!0:(e.style.indexOf("displaytype: modal;")>=0||e.style.indexOf("displaytype:modal;")>=0)&&(n=!0,e.style=(e.style?e.style+"; ":"")+"top: 0px; bottom: 0px; z-index: 4;"),t.setAttribute("style",e.style)):t.removeAttribute("style"),Ys=l("hastextinput",!n,Ys),e.htmlText)Qs="data:text/html;base64,"+L(e.htmlText),i.src=Qs;else if(e.src){if(Qs=e.src,!oc(e.src))return Ye("Failed to load content from unverified path - "+e.src,"Error"),Qs="",ec&&ec.removeAttribute("style"),void(Ys=l("hastextinput",!0,Ys));if("/widgets/rating/index.html"==e.src||"widgets/rating/index.html"==e.src){var a=Kl.resolve(e.src);Yl.get_chat_rating(Hn,(function(e){var t=[];void 0!==e.rating&&t.push("rating="+encodeURIComponent(e.rating)),void 0!==e.review&&t.push("review="+encodeURIComponent(e.review)),i.src=a+"?"+t.join("&")}),(function(e){i.src=a}))}else i.src=rc(e.src,"widget")}$s=l("haswidget",!0,$s),vs("widget display",{widget:{type:"fullsize",src:ms(e.src)}})}function cc(e){if(void 0===e&&(e=ec),e){var i=e.querySelector("iframe").src;try{e.querySelector("iframe").src="about:blank"}catch(e){t("failed to set src to about:blank")}if("about:blank"!=i&&p("ios"))try{var n=document.createElement("iframe");n.src="about:blank",n.setAttribute("frameborder","0");var a=e.children[0];t("replacing widget iframe with new"),e.children[0].insertBefore(n,a),e.children[0].removeChild(a)}catch(e){t("failed to replace widget iframe")}}}function lc(e){if(!e||Ys){Ks=l("showwidgetclose",!1,Ks),Qs="",$s&&($s=l("haswidget",!1,$s)),cc(),Vs=l("showwidget",!0,Vs),ec&&ec.removeAttribute("style"),Ys=!0}}function dc(e,t){lc(!0);var n=document.createElement("div");n.className="inlinewidget",n.id="widget-"+(e.id||(""+Math.random()).substr(2,8));var a=document.createElement("div");n.appendChild(a),e.style&&(e.style=e.style.replace(/\bmargin-left\s*?:\s*?\S+;/g,""),a.setAttribute("style",e.style));var o=(e.style||"").match(/showclose\s*:\s*(\w+);/);n.setAttribute("showclose",o&&o[1]||"false");var r="";n.setAttribute("active",""+!0),e.htmlText?n.setAttribute("src","data:text/html;base64,"+L(e.htmlText)):e.src&&(n.setAttribute("src",e.src),r=e.src.split("?")[0].replace(/[^a-zA-Z0-9\.\-\_\/]+/g,"."));var s=!document.body.hasAttribute("isprovider")&&Et?"0.5":"";!s&&Ta&&(s=parseFloat(i("div.body").getAttribute("zoom")||"1.0"));var c=document.createElement("iframe");if(c.setAttribute("title","embedded webpage"),c.setAttribute("frameborder","0"),c.setAttribute("allowfullscreen",""),c.setAttribute("allow","camera *; microphone *; autoplay *; payment *; "+(od?"geolocation *;":"")),r&&c.setAttribute("name",r),e.htmlText)c.src="data:text/html;base64,"+L(e.htmlText);else if(e.src){if(!oc(e.src))return Ye("Failed to load content from unverified path - "+e.src,"Error"),null;c.src=rc(e.src,"inlinewidget",s)}if(a.appendChild(c),"true"==n.getAttribute("showclose")){var l=document.createElement("div");l.className="button close",a.appendChild(l),l.addEventListener("click",(function(e){hs("inline widget close button");var t=e.currentTarget.parentNode.parentNode,i=t.children[0].children[0];if(t.setAttribute("active",""+!("true"==t.getAttribute("active"))),"true"==t.getAttribute("active")&&"about:blank"==i.src&&t.hasAttribute("src")){var n=t.getAttribute("src");if(!oc(n))return void Ye("Failed to load content from unverified path - "+n,"Error");i.src=rc(n,"inlinewidget",s)}}))}return Ir(n),vs("widget display",{widget:{type:"inline",src:ms(e.src)}}),n}function uc(){document.querySelectorAll('div.inlinewidget[active="true"]').forEach((e=>{e.setAttribute("active","false")}))}function pc(e){lc(),fc();var t=tc.querySelector("iframe");if(e.htmlText)t.src="data:text/html;base64,"+L(e.htmlText);else if(e.src){if(!oc(e.src))return void Ye("Failed to load content from unverified path - "+e.src,"Error");t.src=rc(e.src,"overlaywidget")}Xs=l("hasoverlay",!0,Xs),vs("overlay display",{widget:{type:"fullsize",src:ms(e.src)}})}function fc(){Qs="",Xs&&(Xs=l("hasoverlay",!1,Xs)),cc(tc)}function hc(e,n,a,o,r){lc(!0),Sc();var s=!o;if(s&&((o=document.createElement("div")).id="widget-"+(e.id||(""+Math.random()).substr(2,8)),i("#"+o.id)&&(t("id "+o.id+" exists, switching to random id."),o.id="widget-"+(""+Math.random()).substr(2,8))),e.src)return setTimeout((function(){o.hasAttribute("active")||(t("fetching HTML widget code from "+e.src),le("GET",e.src,null,(function(i){if(t("fetched HTML widget code from "+e.src),o.hasAttribute("active"))t("ignoring widget as it was already updated");else if(e.htmlText=i,delete e.src,hc(e,n,a,o,r),To("last",500,!1),!a&&r){var s=o.getElementsByTagName("button");s&&s.length>0&&s.item(0).focus()}}),(function(i){t("failed to get html widget from src "+e.src),o.hasAttribute("active")?t("ignoring widget as it was already updated"):(o.className="htmlwidget",o.innerHTML="failed to load HTML widget")}),"text"))}),200),Ir(o),o;var c=null;if(!o||e.htmlText){if(e.htmlText=gc(e.htmlText,e.replace),!(c=vc(e.htmlText)))return o.innerHTML="failed to render this widget",o.className="htmlwidget",s&&Ir(o),o;c.hasAttribute("src")&&o.setAttribute("src",c.getAttribute("src"));var l=c.getAttribute("active");l||(l=e.replace&&e.replace.ACTIVE_FOR_AGENT?""+!n:""+!a),o.setAttribute("active",l)}if(o.data=e.data,yc(c||o,e.data),c){if("div"==c.nodeName.toLowerCase())o.className="htmlwidget"+(c.className&&" "+c.className||""),o.setAttribute("style",e.style||c.getAttribute("style")||""),o.innerHTML=c.innerHTML;else{o.className="htmlwidget";for(var d=document.createElement(c.nodeName.toLowerCase()),u=0;u<c.attributes.length;u++){var p=c.attributes[u];p.specified&&["id","src","active","onclose","onfocus","onblur"].indexOf(p.name)<0&&d.setAttribute(p.name,p.value)}d.innerHTML=c.innerHTML,o.appendChild(d)}["onclose","onfocus","onblur"].forEach((function(e){c.hasAttribute(e)&&o.setAttribute(e,c.getAttribute(e))}))}if(t("sanitized HTML widget\n"+o.outerHTML),s&&Ir(o),mc(o),"false"==o.getAttribute("active"))wc(o);else{var f=i("#"+o.id+" input");f&&f.focus()}return e.src&&vs("widget display",{widget:{type:"html",src:ms(e.src)}}),o}function gc(e,t){if(t&&"object"==typeof t&&void 0!==t.length)for(var i=0;i<t.length;++i)e=e.replace(new RegExp(t[i][0],"g"),t[i][1]);else if(t&&"object"==typeof t)for(var n in t)e=e.replace(new RegExp(n,"g"),t[n]);return e.indexOf("{state.web}")>=0&&(e=e.replace(/\{state\.web\}/g,Kl.web)),e}function vc(e){var i=(new DOMParser).parseFromString(e,"text/html"),n=["input","button","select","option","label","a","span","p","div","br","hr","ul","ol","li","for-each","em","strong","code","del"],a=["name","type","value","class","style","disabled","readonly","checked","size","max","min","step","maxlength","minlength","inputmode","required","pattern","placeholder","selected","exploded","onclick","onenter","onchange","onclose","onblur","onfocus","aria-hidden","aria-label","aria-labelledby","tabindex","href","target"],o=[];if(1!=i.body.children.length)return i.body.children.length>1?t("error: more than one top-level elements, document.body has more than one children"):t("error: document.body has no children, rendering default."),t(e),null;for(var r=i.body.children[0],s=i.createNodeIterator(r,NodeFilter.SHOW_ALL),c=s.nextNode();c;c=s.nextNode())if(c.nodeType!=Node.TEXT_NODE&&c.nodeType!=Node.ELEMENT_NODE||c.nodeType==Node.ELEMENT_NODE&&n.indexOf(c.nodeName.toLowerCase())<0)o.push(c);else if(c.nodeType==Node.ELEMENT_NODE){if(c.className){var l=c.className.split(/\s+/).map((function(e){return e&&"widget-"==e.substr(0,7)?e:"widget-"+e})).join(" ");c.className=l}for(var d=[],u=0;u<c.attributes.length;u++){var p=c.attributes[u];p.specified&&c!==r&&a.indexOf(p.name)<0&&"data-"!=p.name.substr(0,5)&&d.push(p.name)}for(u=0;u<d.length;++u)c.removeAttribute(d[u])}for(u=0;u<o.length;++u){var f=o[u];try{f.parentNode.removeChild(f)}catch(e){}}return r}function mc(e){for(var t=document.createNodeIterator(e,NodeFilter.SHOW_ELEMENT),i=t.nextNode();i;i=t.nextNode()){for(var n=[],a=0;a<i.attributes.length;a++){var o=i.attributes[a];if(o.specified&&"on"==o.name.substr(0,2)){var r=o.name.substr(2),s="data-on"+r,c="data-on"+r+"-function";i===e&&("close"==r&&(i[c]=xc),"onfocus"==o.name&&(i[c]=_c),"onblur"==o.name&&(i[c]=kc)),"onenter"==o.name&&(i[c]=function(t){var i=t.currentTarget;13==(t.which||t.keyCode)&&setTimeout((function(){Tc({currentTarget:i},e)}),0)}),"onchange"==o.name&&(i[c]=function(t){Ec(t,e)}),"onclick"==o.name&&(i[c]=function(t){return t.stopImmediatePropagation(),Ac(t,e),!1}),i[c]&&(i[s]=o.value,n.push(o.name),i.addEventListener("enter"==r?"keydown":r,i[c]))}}for(a=0;a<n.length;++a)i.removeAttribute(n[a])}}function yc(e,i,n){(t("populate-htmlwidget-data data="+JSON.stringify(i)+" prefix="+n),void 0===n&&(n=""),n&&"object"!=typeof i)&&(i&&(i={"":i},"."==n.substr(n.length-1)&&(n=n.substr(0,n.length-1))));for(var a in i){var o=i[a],r=e.querySelector('[name="'+n+a+'"]');if(r){var s=r.nodeName.toLowerCase();if("input"==s)"checkbox"==r.getAttribute("type")||"radio"==r.getAttribute("type")?o&&r.getAttribute("value")&&r.getAttribute("value").split("|")[0]==o||!0===o||"on"==o||"yes"==o?r.setAttribute("checked","true"):r.removeAttribute("checked"):r.setAttribute("value",o);else if("select"==s){r.setAttribute("value",o);for(var c=0;c<r.children.length;++c){var l=r.children[c];"option"==l.nodeName.toLowerCase()&&(l.value==o||l.innerText==o?l.setAttribute("selected","true"):l.removeAttribute("selected"))}}else if("button"==s||"a"==s)!0===o?r.setAttribute("selected","true"):!1===o?r.removeAttribute("selected"):r.hasAttribute("value")?(r.value=o,r.setAttribute("value",o)):r.innerText=o;else if("div"==s&&"object"==typeof o){if(!r.hasAttribute("exploded")){var d=r.getAttribute("value");r.setAttribute("exploded","true"),yc(r,o,n+d+".")}}else if("div"==s){var u=vc(o);u&&u.innerHTML&&(r.innerHTML=u.innerHTML)}else if("for-each"==s&&"object"==typeof o&&void 0!==o.length){if(!r.hasAttribute("exploded")){d=r.getAttribute("value");r.setAttribute("exploded",""+o.length);var p=r.nextSibling;for(c=0;c<o.length;++c){var f=r.cloneNode(!0);yc(f,o[c],n+d+".");for(var h=0;h<f.children.length;++h)r.parentNode.insertBefore(f.children[h],p)}r.innerHTML=""}}else r.hasAttribute("value")?(r.value=o,r.setAttribute("value",o)):0==r.children.length&&(r.innerText=o)}else t("node not found for name="+(n+a))}}function bc(e,i,n){void 0===i&&(i=""),void 0===n&&(n=[]);for(var a={},o=e.querySelectorAll("[name]"),r=0;r<o.length;++r){var s=o[r];if(!(n.indexOf(s)>=0)){n.push(s);var c=s.getAttribute("name"),l=null;i&&c.substr(0,i.length)==i&&(c=c.substr(i.length)),t("collecting {"+c+"}");var d=s.nodeName.toLowerCase();if("input"==d||"select"==d)"checkbox"==s.getAttribute("type")?l="on"==s.value||"true"==s.value||"yes"==s.value?s.checked:s.value.indexOf("|")>=0?s.checked?s.value.split("|",2)[0]:s.value.split("|",2)[1]:s.checked?s.value:"":"input"==d&&"radio"==s.getAttribute("type")?s.checked&&(l=s.value):l=s.value;else if("button"==d||"a"==d)l="true"==s.getAttribute("selected");else if("div"==d&&s.hasAttribute("exploded")){var u=s.getAttribute("value");l=bc(s,i+u+".",n)}else if("for-each"==d&&s.hasAttribute("exploded")){u=s.getAttribute("value");var p=parseInt(s.getAttribute("exploded"));l=[];for(var f=0;f<p;++f)s=s.nextSibling,l.push(bc(s,i+u+".",n))}else l=s.hasAttribute("value")?void 0!==s.value?s.value:s.getAttribute("value"):s.innerText;void 0===a[c]&&(a[c]=l)}}return t(" collected "+JSON.stringify(a)),a}function wc(e){e.setAttribute("active","false");for(var t=document.createNodeIterator(e,NodeFilter.SHOW_ELEMENT),i=t.nextNode();i;i=t.nextNode()){var n=i.nodeName.toLowerCase();if("input"!=n&&"select"!=n&&"button"!=n||i.setAttribute("readonly","true"),"input"==n)"checkbox"==i.getAttribute("type")||"radio"==i.getAttribute("type")?i.checked?i.setAttribute("checked","true"):i.removeAttribute("checked"):i.setAttribute("value",i.value);else if("select"==n){i.setAttribute("value",i.value);for(var a=0;a<i.children.length;++a){var o=i.children[a];"option"==o.nodeName.toLowerCase()&&(o.value==i.value||o.innerText==i.value?o.setAttribute("selected","true"):o.removeAttribute("selected"))}}["focus","blur","click","change","enter"].forEach((function(e){var t=!1;if("click"==e&&"div"==n&&i["data-onclick"]){var a=i.parentNode.parentNode,o=a.getAttribute("name")||"";a.className&&a.className.match(/\bwidget-tabs\b/)&&i["data-onclick"].startsWith(o+"=")&&(t=!0)}!t&&i["data-on"+e]&&(i.removeEventListener("enter"==e?"keydown":e,i["data-on"+e+"-function"]),delete i["data-on"+e+"-function"])}))}}function xc(e){t("on-htmlwidget-close "+e.currentTarget["data-onclose"]),Lc(e.currentTarget,e.currentTarget["data-onclose"])}function _c(e){t("on-htmlwidget-focus "+e.currentTarget["data-onfocus"]),Lc(e.currentTarget,e.currentTarget["data-onfocus"])}function kc(e){t("on-htmlwidget-blur "+e.currentTarget["data-onblur"]),Lc(e.currentTarget,e.currentTarget["data-onblur"])}function Tc(e,i){t("on-htmlwidget-enter "+e.currentTarget["data-onenter"]),Lc(i,e.currentTarget["data-onenter"],e.currentTarget)}function Ec(e,i){t("on-htmlwidget-change "+e.currentTarget["data-onchange"]),Lc(i,e.currentTarget["data-onchange"],e.currentTarget)}function Ac(e,i){t("on-htmlwidget-click "+e.currentTarget["data-onclick"]),Lc(i,e.currentTarget["data-onclick"],e.currentTarget)}function Lc(e,i,n){n||(n=e);var a=i.split(";").filter((function(e){return!!e.trim()})).map((function(t){var i=(t=t.trim()).match(/^(\w+)\((.*)\)$/),a=t.match(/^(\w+)=(.*)$/);if(i){var o=JSON.parse("["+i[2].replace(/"/g,'\\"').replace(/'/g,'"')+"]").map((function(t){return Cc(e,t,n)}));return{function:i[1],arguments:o}}if(a){var r=Cc(e,JSON.parse(a[2].replace(/'/g,'"')),n);return{assignment:[a[1],r]}}return{error:"invalid statement "+t}}));t(JSON.stringify(a));for(var o=0;o<a.length;++o){var r=a[o];if(void 0!==page&&"frontpage"==page)vi(0,0,r);else if(!Nc(e,n,r))break}}function Nc(e,i,n){if(n.assignment){var a=n.assignment[0],o=n.assignment[1],r="this"==a?i:e.querySelector('[name="'+a+'"]'),s=r.nodeName.toLowerCase();if("input"==s||"select"==s)if("checkbox"==r.getAttribute("type"))r.checked="true"==o||!0===o;else if("radio"==r.getAttribute("type")){var l=e.querySelector('input[name="'+a+'"][value="'+o+'"]');l&&(l.click(),l.checked=!0)}else r.value=o;else r.hasAttribute("value")?(void 0!==r.value&&(r.value=o),r.setAttribute("value",o)):t("failed to set "+a+"="+o+", not found")}else if(n.function){var d=n.function,u=n.arguments;if("send"==d){var p={type:u[1]&&["info","chat","hidden","progress"].indexOf(u[1])>=0?u[1]:"chat",text:u[0]};if(1==u.length&&u[0]&&"{"==u[0].substr(0,1))try{var f=JSON.parse(u[0]);f&&void 0!==f.type&&(p=f)}catch(e){}Se({invoke:"send",args:[p]},["invoke"])}else if("clear"==d)u.forEach((function(t){var n="this"==t?i:e.querySelector('[name="'+t+'"]'),a=n.nodeName.toLowerCase();"input"==a||"select"==a?"checkbox"==n.getAttribute("type")||"radio"==n.getAttribute("type")?n.checked=n.hasAttribute("checked"):n.value=n.getAttribute("value"):a.hasAttribute("value")&&n.setAttribute("value","")}));else if("select"==d){o=!0;u.length>0&&"boolean"==typeof u[u.length-1]&&(o=u.pop()),u.forEach((function(t){var n="this"==t?i:e.querySelector('[name="'+t+'"]'),a=n.nodeName.toLowerCase();("input"==a&&"button"==n.getAttribute("type")||"button"==a)&&(n.setAttribute("selected",""+o),function(e,t){var i=e.getAttribute("style");i&&(t?i.match(/\/\*\s*if-selected\s*(.*)?\*\//)&&(i=i.replace(/\/\*\s*if-selected\s*(.*)?\*\//,"/* if-selected */$1"),e.setAttribute("style",i)):i.match(/\/\*\s*if-selected\s*\/(.*)?(\*\/)?/)&&(i=i.replace(/\/\*\s*if-selected\s*\/(.*)?(\*\/)?/,"/* if-selected $1*/"),e.setAttribute("style",i)))}(n,o))}))}else if("validate"==d){var h=[];if(u.forEach((function(t){var n="this"==t?i:e.querySelector('[name="'+t+'"]'),a=n.nodeName.toLowerCase();"input"!=a&&"button"!=a||n.checkValidity()||h.push(n)})),h.length>0)return t("breaking due to invalids="+h),Ye("Invalid values for "+h.map((function(e){return e.name})).join(", "),"Error"),!1}else if("close"==d)wc(e),c({type:"close"},e),e["data-onclose-function"]&&(e.removeEventListener("close",e["data-onclose-function"]),delete e["data-onclose-function"]);else if("save"==d){var g={type:"updatehtmlwidget",id:e.id.substr(7)};if(!u.length||u.indexOf("html")>=0){for(var v=e.querySelectorAll(".widget-tabs > div:nth-child(1) > *"),m=[],y=0;y<v.length;++y){var b=v[y],w=b.parentNode.parentNode.getAttribute("name")||"";!b.hasAttribute("onclick")&&b["data-onclick"]&&b["data-onclick"].startsWith(w+"=")&&(m.push(b),b.setAttribute("onclick",b["data-onclick"]))}g.htmlText=e.outerHTML.replace(/[^A-Za-z 0-9 \.,\?""!@#\$%\^&\*\(\)-_=\+;:<>\/\\\|\}\{\[\]`~]/g,(function(e){return"&#x"+e.charCodeAt(0).toString(16)+";"})),console.log("toremove="+m.length);for(y=0;y<m.length;++y)m[y].removeAttribute("onclick")}u&&u.indexOf("data")>=0&&(g.data=bc(e)),t("sending message\n"+JSON.stringify(g)),so(g),ys("send widget update",{type:g.type})}else"url"==d?u&&1==u.length&&Se({url:u[0]},["url"]):t("unsupported function "+d)}return!0}function Cc(e,i,n){if("string"!=typeof i)return i;var a=i.match(/\{\w+\}/g);if(a)for(var o=0;o<a.length;++o){var r=a[o],s=null,c="this"==(r=r.substr(1,r.length-2))?n:e.querySelector('[name="'+r+'"]');if(c){var l=c.nodeName.toLowerCase();if("input"==l||"select"==l)if("checkbox"==c.getAttribute("type"))s="on"==c.value?c.checked?"on":"off":"true"==c.value?!!c.checked:"yes"==c.value?c.checked?"yes":"no":c.value.indexOf("|")>=0?c.checked?c.value.split("|",2)[0]:c.value.split("|",2)[1]:c.checked?c.value:"";else if("radio"==c.getAttribute("type")){var d=e.querySelector('input[name="'+r+'"]:checked');d&&(s=d.value)}else s=c.value;else"button"==l||"a"==l?s=c.innerText:c.hasAttribute("value")?s=c.value:t("no value for element "+c.outerHTML)}null!=s?i=i.replace(RegExp("{"+r+"}"),s):t("cannot find value for variable "+r)}return i}function Sc(){for(var e=document.querySelectorAll('div.htmlwidget[active="true"]'),t=0;t<e.length;++t)c({type:"blur"},e[t])}var Oc=!1;function Ic(e){var t={offset:{x:0,y:0},end:{x:0,y:0}},n=parseFloat(i("div.body").getAttribute("zoom"));if(!(isNaN(n)||n<.01)){var a=e.currentTarget;if("mousedown"==e.type)t.offset.x=Math.round(e.offsetX),t.offset.y=Math.round(e.offsetY);else if(e.touches.length>0){var o=e.target.getBoundingClientRect();t.offset.x=Math.round(e.touches[0].clientX-o.left),t.offset.y=Math.round(e.touches[0].clientY-o.top)}var r=function(e){if(null!=t){if("mousemove"==e.type||"mouseup"==e.type){var i=a.parentNode.getBoundingClientRect();t.end.x=Math.round(e.clientX-i.left),t.end.y=Math.round(e.clientY-i.top)}else e.touches.length>0&&(t.end.x=Math.round(e.changedTouches[0].clientX),t.end.y=Math.round(e.changedTouches[0].clientY));var o=t.end.x-t.offset.x,s=t.end.y-t.offset.y;a.style.left=Math.round(o/n)+"px",a.style.top=Math.round(s/n)+"px",a.style.right="auto",a.style.bottom="auto","mouseup"!=e.type&&"touchend"!=e.type||(document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",r),document.addEventListener("touchmove",r),document.addEventListener("touchend",r),t=null)}};"mousedown"==e.type?(document.addEventListener("mousemove",r),document.addEventListener("mouseup",r)):(document.addEventListener("touchmove",r),document.addEventListener("touchend",r))}}function Mc(e){var n=i("div.page.dialer input.number").value;"idle"!=Hc?Ye("Already in a call, please terminate existing call first","Error"):n&&n.match(/^\d{8,20}$/)?(t("initiating call to "+n),Pe(["twiliocall",n],(function(){Ye("Please wait while your call is being connected","Info")}),(function(e){Ye("Cannot dial: "+e,"Error")}))):Ye("Cannot dial malformed phone number","Error")}function jc(e){t("terminating call..."),Gc()}function Pc(e){var t=e.currentTarget.getAttribute("data");t&&("active"==Hc&&"twilio"==Rc?$c(t):i("div.page.dialer input.number").value+=t)}var Hc="idle",Rc="",Dc=null,Fc=null,Uc=null,zc=null,qc=null,Jc=null;function Wc(){t("getting twilio-token"),Yl.get_twilio_token((function(e){t(e),t("callstate="+Hc),"twilio"==Rc&&"idle"==Hc?(Twilio.Device.setup(e.token,{debug:!0}),Twilio.Device.ready((function(e){t("Twilio.Device Ready!"),"twilio"==Rc&&"idle"==Hc&&(Hc=l("callstate","ready",Hc),Bc())})),Twilio.Device.offline((function(e){t("Twilio.Device Offline!"),"idle"!=Hc&&("twilio"==Rc&&(Hc=l("callstate","idle",Hc)),setTimeout(Gc,500))})),Twilio.Device.error((function(e){t("Twilio.Device Error: "+e.message),"outgoing"!=Hc&&"active"!=Hc||("twilio"==Rc&&(Hc=l("callstate","ready",Hc)),setTimeout(Gc,500),a(zc,"Error: "+e.message),zc=Uc=Dc=Fc=null)})),Twilio.Device.connect((function(e){t("Successfully established call!"),"twilio"==Rc&&"outgoing"==Hc&&(Hc=l("callstate","active",Hc),t("conn.parameters="+JSON.stringify(e&&e.parameters)),Fc&&$c(Fc.replace(/,/g,"w")),a(Uc,e&&e.parameters&&e.parameters.CallSid),zc=Uc=Dc=Fc=null)})),Twilio.Device.disconnect((function(e){t("Call ended."),"outgoing"!=Hc&&"active"!=Hc||("twilio"==Rc&&(Hc=l("callstate","ready",Hc)),setTimeout(Gc,500),a(zc,"Disconnected"),a(qc),zc=Uc=Dc=Fc=qc=null)})),Twilio.Device.incoming((function(e){t("Incoming connection from "+e.parameters.From),e.reject()}))):"twilio"==Rc&&"ready"==Hc?Bc():a(zc,"Call state is not ready or idle")}),(function(e){Rc=l("calltype","",Rc),a(zc,"Failed to get token: "+e)}))}function Bc(){if("twilio"==Rc&&"ready"==Hc&&Dc){var e=Dc.replace(/^tel:\+/,"");Hc=l("callstate","outgoing",Hc),t("Calling "+e+"...");var i={Target:e};Jc.record&&(i.Record="true"),Twilio.Device.connect(i)}}function Gc(){"twilio"==Rc&&(t("Hanging up..."),Twilio.Device.disconnectAll(),"idle"!=Hc&&(Hc=l("callstate","ready",Hc),setTimeout((function(){a(zc,"Closed"),a(qc),zc=Uc=Dc=Fc=qc=null}),0)),Twilio.Device.destroy(),Rc=l("calltype","",Rc),Hc=l("callstate","idle",Hc))}function $c(e){if(e&&"w"==e.substr(0,1)){var i=e.match(/^(w+)(.*)/);return t("waiting for "+500*i[1].length),void setTimeout((function(){$c(i[2])}),500*i[1].length)}if("active"==Hc&&"twilio"==Rc){var n=Twilio.Device.activeConnection();n?(t("sending digits "+e),n.sendDigits(e)):t("no active connection found, ignored  send digits")}}var Vc=!1,Kc=!1,Yc=null,Xc=null,Zc=null,Qc=null,el=null,tl=null,il=null;function nl(e,i,n,o){"idle"!=Hc?(Ye("previous call is not yet cleaned up","error"),a(o,"Previous call is not yet cleaned up")):"https:"==window.location.protocol||"http:"==window.location.protocol&&("localhost"==window.location.hostname||"127.0.0.1"==window.location.hostname)||("gopher:"==window.location.protocol||"file:"==window.location.protocol)&&u()?function(e,i){"idle"==Hc?(Yc=e,il=i,Rc=l("calltype","webrtc",Rc),Hc=l("callstate","inviting",Hc),Xc=(""+Math.random()).substr(2,8),Zc=0,fl(),pl(Yc,{type:"invite",callid:Xc,params:i||{}})):t("webrtccall: failed to send invite, not idle: "+Hc)}(e,i):(t("WebRTC call not supported on window.location.protocol="+window.location.protocol+", use https:"),Ye("In app call is supported only on secure web app","error"),a(o,"In app call is supported only on secure web app"))}function al(e,i,n,a){if("idle"==Hc)if("https:"==window.location.protocol||"http:"==window.location.protocol&&("localhost"==window.location.hostname||"127.0.0.1"==window.location.hostname)||("gopher:"==window.location.protocol||"file:"==window.location.protocol)&&u()){Yc=e,Xc=n,il=a,Rc=l("calltype","webrtc",Rc),Hc=l("callstate","invited",Hc),Zc=0,fl();var o={webrtccall:{type:"incoming",callid:n,senderId:e,senderName:i}},r="Incoming "+(a.video?"video":"voice")+" call. "+(a.subject||"")+" Click to answer or close to decline";Xe(!0,!0,i,r,0,!0,"webrtccall-"+e,o,!1)}else t("WebRTC call not supported on window.location.protocol="+window.location.protocol+", use https:"),Ye("Ignoring received in app call on insecure web app","error"),pl(e,{type:"decline",callid:n,reason:"not supported"});else if(Xc==n)t("webrtccall: ignoring duplicate invite");else{if(Yc==e)return ul(),Ye("Another call from same person, disconnecting previous","Warning"),void setTimeout((function(){al(e,i,n,a)}),1e3);pl(Yc,{type:"decline",callid:n,reason:"busy here"});o={webrtccall:{type:"missed",callid:n,senderId:e,senderName:i,params:a}},r="Missed call. "+(a.subject||"")+" Click to callback or close to ignore";Xe(!0,!0,i,r,0,!0,"webrtccall-"+e,o,!1)}}function ol(e){t("webrtccall: send-bye "+e),"idle"!=Hc&&"webrtc"==Rc?(t("webrtccall: close the peer connection"),"inviting"==Hc?(fl("missed",!0),pl(Yc,{type:"cancel",callid:Xc}),Hc=l("callstate","idle",Hc),Vc=l("hasvideo",!1,Vc)):(Hc=l("callstate","idle",Hc),Vc=l("hasvideo",!1,Vc),fl("completed",!0)),pl(Yc,{type:"bye",callid:Xc,reason:e||""}),ul()):"webrtc"==Rc&&t("webrtccall: cannot send bye in "+Hc)}function rl(e,i){var n=Xc,o=Yc,r=function(r){if("active"==Hc&&"webrtc"==Rc&&n==Xc&&o==Yc){var s=(Qc=r).getAudioTracks();s.length>0&&t("webrtccall: using audio device "+s[0].label);var c=Qc.getVideoTracks();c.length>0?t("webrtccall: using video device "+c[0].label):Vc&&(Vc=l("hasvideo",!1,Vc)),il.record&&xl(r),il.transcribe&&(d=void 0,u=_l,void 0===window.webkitSpeechRecognition||bl||((bl=new webkitSpeechRecognition).lang=d||"en-US",bl.continuous=!0,bl.interimResults=!0,bl.onstart=function(){t("speech_recognition.onstart()")},bl.onresult=function(e){for(var i="",n="",o=e.resultIndex;o<e.results.length;++o)e.results[o].isFinal?i+=e.results[o][0].transcript:n+=e.results[o][0].transcript;t("speech_recognition.onresult() "+i+(n?"|"+n:"")),a(u,i,n)},bl.onerror=function(e){t("speech_recognition.onerror() event.error="+e.error),"no-speech"!=e.error&&bl&&(bl.abort(),bl=null)},bl.onend=function(){t("speech_recognition.onend() restarting"),bl&&(bl.lang=d||"en-US",bl.start())},bl.start(),t("speech_recognition_start()"))),a(e)}else t("webrtccall: ignoring getusermedia, original call does not exist"),"active"==Hc&&"webrtc"==Rc||r.getTracks().forEach((function(e){e.stop()})),a(i,"invalid call");var d,u},s=function(e){t("webrtccall: getUserMedia() error: "+e.name),t(e),a(i,"failed")},c=function(){var e={audio:!0,video:!!Vc};u()&&navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(e,r,s):navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(e).then(r).catch(s):(t("webrtccall: no getUserMedia"),a(i,"failed: no get-user-media"))};if(u()&&p("android")){var d=cordova.plugins.permissions,f=[d.CAMERA,d.RECORD_AUDIO];d.hasPermission(f,(function(e){e.hasPermission?c():d.requestPermissions(f,(function(e){e.hasPermission?c():(t("camera or microphone permission is not on"),a(i,"no permission"))}))}),(function(){t("camera or microphone permission is not on"),a(i,"no permission")}))}else c()}function sl(e){t("webrtccall: creating peer connection object"),window.RTCPeerConnection?el=new RTCPeerConnection(null,{optional:[]}):window.webkitRTCPeerConnection&&(el=new webkitRTCPeerConnection(null,{optional:[]})),el.onicecandidate=function(e){e.candidate&&pl(Yc,{type:"signal",data:e.candidate})},el.onaddstream=function(e){if(t("webrtccall: onaddstream"),Vc)try{i("div.videos > div.video.remote video").srcObject=e.stream}catch(n){try{i("div.videos > div.video.remote video").src=(URL.createObjectURL||webkitURL.createObjectURL)(e.stream)}catch(e){t("exception: "+n+" and "+e)}}else{var n=i("#webrtc-audio");n||((n=document.createElement("audio")).id="webrtc-audio",n.autoplay=!0,document.body.appendChild(n));try{n.srcObject=e.stream}catch(i){try{n.src=(URL.createObjectURL||webkitURL.createObjectURL)(e.stream)}catch(e){t("exception: "+i+" and "+e)}}}il.record&&xl(e.stream)},el.onremovestream=function(e){t("webrtccall: onremovestream")},il.transcribe&&!il.persistent&&(e?cl(el.createDataChannel("data")):el.ondatachannel=function(e){cl(e.channel)})}function cl(e){tl=e,e.onopen=function(e){t("datachannel: onopen")},e.onclose=function(e){t("datachannel: onclose")},e.onclose=function(e){t("datachannel: onclose")},e.onmessage=function(e){var i;t("datachannel: onmessage"),i=e.data,tl&&(i=JSON.parse(i),hl("received",{type:"chat",senderId:Yc,htmlText:"<i>"+n(i.text)+"</i>"}))}}function ll(){if(i("div.body")){var e=i("div.videos > div.video.local video"),t=i("div.videos > div.video.local");if(e){var n=e.videoWidth,a=e.videoHeight,o=i("div.videos").offsetWidth,r=(i("div.videos").offsetHeight,n>=a?o/2:o/3),s=a/n*r;t.style.width=Math.round(r)+"px",t.style.height=Math.round(s)+"px"}}}function dl(){if(t("webrtccall: adding local stream to peer connection"),Vc)try{i("div.videos > div.video.local video").srcObject=Qc,setTimeout(ll,1e3)}catch(e){try{i("div.videos > div.video.local video").src=(URL.createObjectURL||webkitURL.createObjectURL)(Qc),setTimeout(ll,1e3)}catch(i){t("exception: "+e+" and "+i)}}try{Qc.getTracks().forEach((function(e){el.addTrack(e,Qc)}))}catch(e){el.addStream(Qc)}}function ul(){if(t("webrtccall: webrtc-close()"),t("speech_recognition_stop()"),bl&&(bl.abort(),bl=null),function(){t("webrtccall: close recording");var e=Xc,i=(il||{}).chat;!function(e,i){if(yl){for(var n in t("webrtc_stop_recording()"),yl)yl[n].recorder&&(yl[n].recorder.stop(),delete yl[n].recorder);if(e){var o=0,r={};for(var n in yl)o++,r[n]={is_local:!!Qc&&Qc.id==n,audio_chunks:yl[n].audio_chunks};if(0==o)return void a(e,r);var s=function(e,i,n){var o=new FileReader;o.readAsDataURL(i),o.onloadend=function(){t("saved recording for streamid="+e),a(n,e,i,o.result)},o.onerror=function(){t("failed to get dataurl from blob"),a(n,e,i,"")}};setTimeout((function(){for(var i in r){var n=r[i].audio_chunks,c=new Blob(n,{type:wl.length>0?wl[0]:"audio/wav"});t("creating blob for streamid="+i+" chunks="+n.length+" size="+c.size),s(i,c,(function(t,i,n){o--,n&&(r[t].blob=i,r[t].dataurl=n),0==o&&a(e,r)}))}}),200)}setTimeout((function(){for(var e in yl)delete yl[e]}),500)}else t("webrtc_stop_recording() no media recorder"),a(i,"no media recorder")}((function(n){t("webrtccall: stopped recording"),t(n);var a=[];for(var o in n)a.push({dataurl:n[o].dataurl,is_local:n[o].is_local});var r="Voice call recording is not stored on the server, but is available for download here "+a.map((function(t,i){var n=wl.length>0?wl[0]:"audio/wav";return'<a href="'+t.dataurl+'" type="'+n.split(";")[0]+'" target="_blank" download="'+(t.is_local?"my-voice":"their-voice")+"-"+e+"."+n.split(";")[0].split("/")[1]+'">'+(t.is_local?"my voice":"their voice")+"</a>"})).join(", ");setTimeout((function(){hl("received",{type:"info",htmlText:r},i)}),0)}),(function(e){t("webrtcall: failed to get recording: "+e)}))}(),Rc=l("calltype","",Rc),Hc=l("callstate","idle",Hc),Vc=l("hasvideo",!1,Vc),Yc=null,Xc=null,il=null,null!=tl){try{tl.close()}catch(e){}tl=null}if(null!=el){try{el.close()}catch(e){}el=null}null!=Qc&&(Qc.getTracks().forEach((function(e){e.stop()})),Qc=null);var e=i("#webrtc-audio");e&&document.body.removeChild(e)}function pl(e,i){try{var n="notification///"+e+"/webrtccall",a=Br({type:"notification",timestamp:(new Date).getTime(),senderId:Sn,senderName:Kl.myprofile?Kl.myprofile.name:Yl.auth.email,message:{webrtccall:i}});t("webrtccall: webrtc-send "+n+" "+JSON.stringify(a).substr(0,200)),Cn.send(n,Q(n,a),2,!1)}catch(e){t(e)}}function fl(e,i){t("webrtc-set-placeholder endstatus="+e+" callstate="+Hc+" storehistory="+i+" callid="+Xc);var n=Zc?new Date(Zc):new Date,a=Math.round(((new Date).getTime()-Zc)/1e3),o='<div class="info-call" data-type="webrtccall" data-callid="'+Xc+'">Voice call on <span class="date">'+n.toUTCString()+"</span>"+("completed"==e?' <span class="duration">'+a+" seconds</span>":"")+' <span class="endstatus">'+(e||Hc)+"</span></div>";hl(i?"send":"received",{type:i?"info":"placeholder",id:"call-"+Xc,htmlText:o})}function hl(e,i,n){"chat"==page&&Hn==n||(il||{}).chat?("received"==e||"send"==e)&&Me({invoke:e,args:[i]}):t("ignoring webrtc-add-to-chat-history not in original chat: "+page+" "+Hn+" != "+(n||(il||{}).chat))}var gl=!1,vl=!1,ml=!1,yl={},bl=null,wl=[];function xl(e){if(void 0!==window.MediaRecorder&&void 0===yl[e.id]){if(t("webrtc_start_recording() create recorder for stream"),0==(wl=["audio/webm;codecs=opus","audio/ogg;codecs=opus","audio/wav"].filter((function(e){return MediaRecorder.isTypeSupported(e)}))).length)return void t("webrtc_start_recording() no mime type supported, not recording.");var i=new MediaRecorder(e,{mimeType:wl[0]});yl[e.id]={recorder:i,audio_chunks:[]},i.audio_chunks=yl[e.id].audio_chunks,i.ondataavailable=function(e){var t=e.currentTarget;e.data.size>0&&t.audio_chunks.push(e.data)};try{i.start()}catch(i){t("webrtc_start_recording() failed: "+i),delete yl[e.id]}}else t("webrtc_start_recording() no media recorder")}function _l(e,t){if(i("div.page.chat div.input textarea").value=t||"",e)if(tl){hl("received",{type:"chat",senderId:Sn,htmlText:"<i>"+n(e)+"</i>"});var a={type:"chat",text:e};tl.send(JSON.stringify(a))}else hl("send",{type:"chat",htmlText:"<i>"+n(e)+"</i>"})}function kl(e){"loading"==email_scripts_state&&setTimeout((function(){kl(e)}),2e3),function(t,i){email_scripts_state="loading";let n=document.createElement(i);n.async=1,n.type="text/javascript",n.src="assets/nylas/components-email.js",n.onload=function(){email_scripts_state="loaded",Il(e)};let a=t.getElementsByTagName("head")[0];a.appendChild(n),n=document.createElement(i),n.async=1,n.type="text/javascript",n.src="assets/nylas/components-composer.js",a.appendChild(n)}(document,"script")}function Tl(e){if(Ma&&Ma.lastEmail){El(!1);let e=[Ma.customerContact],t=Al(Ma.ComposerComponentId,Ma.lastEmail,e,null);Sl(t)}}function El(e){let t=document.getElementById("page-chat-input-reply");t&&(t.style.visibility=!0===e?"visible":"hidden",t.style.display=!0===e?"block":"none")}function Al(e,i,n,a){let o=function(){let e={show_reply:"active"===oa&&!("readonly"==jl),show_reply_all:"active"===oa&&!("readonly"==jl)};Cl(Ll(Ma.EmailComponentId,Ma.threadId,e))},r=document.createElement("nylas-composer");r.setAttribute("id",e),r.setAttribute("show_header",!0),r.setAttribute("show_subject",!0),r.setAttribute("show_from",!0),r.setAttribute("show_cc",!1),r.setAttribute("show_bcc",!1),r.setAttribute("show_minimize_button",!1),r.setAttribute("show_editor_toolbar",!0),Et&&"dialpad"==kt&&r.setAttribute("theme",Kl.web+"/providers/0/widgets/common/email-agent/css/dp-nylas.css"),r.setAttribute("message_id",i.id),r.afterSendSuccess=async e=>{t("afterSendSuccess: response:"+e),Ma.showComposer=!1,r.close(),Ma.showComposer=!1,o()},r.afterSendError=async e=>{t("afterSendError: error:"+e),Ma.showComposer=!1,r.close(),Ye("Failed to send email","Error",6e4),o()},r.addEventListener("composerClosed",(e=>{o()}));let s=new RegExp("^re: ","i").test(i.subject)?i.subject:"Re: "+i.subject,c="<br><br>"+function(e){let t="";if(e&&e.date&&e.from&&e.body){let i=new Date(1e3*e.date);t+="On "+i.toLocaleDateString(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric"})+" at "+i.getHours()+":"+i.getMinutes(),e.from.forEach((e=>{t+=" , "+e.name+' &lt;<a href="mailto:'+e.email+'">'+e.email+"</a>&gt;"})),t+=" wrote:",t='<div><div dir="ltr">'+t+'</div><blockquote style="margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex">'+e.body+"</div>"}return t}(i),l={to:n,subject:s,reply_to_message_id:i.id,body:c};return a&&(l.cc=a),r.value=l,r}function Ll(e,i,n){let a=document.createElement("nylas-email");return a.setAttribute("id",e),a.setAttribute("thread_id",i),a.setAttribute("show_expanded_email_view_onload",!0),a.setAttribute("show_contact_avatar",!1),a.setAttribute("show_reply",!0===n.show_reply),a.setAttribute("show_reply_all",!0===n.show_reply_all),a.setAttribute("show_thread_actions",!0===Le["show-email-thread-actions"]),Et&&"dialpad"==kt&&a.setAttribute("theme",Kl.web+"/providers/0/widgets/common/email-agent/css/dp-nylas.css"),a.addEventListener("messageClicked",(function(e){t("Message.clicked: ")})),a.addEventListener("replyClicked",(function(e){t("Reply.clicked: "),El(!1);let i=Al(Ma.ComposerComponentId,e.detail.message,e.detail.message.from,null);Ma.showComposer=!0,Sl(i)})),a.addEventListener("replyAllClicked",(function(e){if(t("ReplyAll.clicked: "),!Ma.AccountEmailId)return void t("WARN: missing business email id");El(!1);var i=e.detail.message.from.concat(e.detail.message.to).filter((function(e){return e.email.toLowerCase()!=Ma.AccountEmailId.toLowerCase()})),n=e.detail.message.cc.filter((function(e){return e.email.toLowerCase()!=Ma.AccountEmailId.toLowerCase()}));let a=Al(Ma.ComposerComponentId,e.detail.message,i,n);Ma.showComposer=!0,Sl(a)})),a.addEventListener("threadLoaded",(function(e){let i=Nl(),n=i.getElementsByClassName("email-loading-view");n&&n.length>0&&i.removeChild(n[0]),t("threadLoaded: thread.id:"+e.detail.id),Ma=Ma||{};var a=e.detail;Ma.threadId=a.id,Ma.lastEmail=a.messages[a.messages.length-1],"active"===oa&&El(!0)})),a}function Nl(){let e=i("div.page.chat div.snippet #pages-chat-history-snippet-email");return null==e&&(e=document.createElement("div"),e.setAttribute("id","pages-chat-history-snippet-email"),Ir(e)),e}function Cl(e,t=!0){let i=Nl();(0==i.getElementsByTagName("nylas-composer").length||t)&&(Ma.showComposer=!1,i.innerHTML='<div class="d-d-flex d-fd-column d-p24 skeleton email-loading-view"><div class="animate d-h24 d-w216 d-mb24"></div><div class="d-d-flex d-ai-center d-mb24"><div class="animate d-h48 d-w48 d-bar-circle d-mr12"></div><div class="animate d-h16 d-w102"></div></div><div class="d-d-flex d-fd-column d-ai-start d-mb24 d-w100p"><div class="animate d-h16 d-w100p d-mb12"></div><div class="animate d-h16 d-w100p d-mb12"></div><div class="animate d-h16 d-w100p d-mb12"></div><div class="animate d-h16 d-w50p"></div></div><div class="d-d-flex d-fd-column d-ai-start d-w100p"><div class="animate d-h16 d-w100p d-mb12"></div><div class="animate d-h16 d-w100p d-mb12"></div><div class="animate d-h16 d-w100p d-mb12"></div><div class="animate d-h16 d-w50p"></div></div></div>',i.appendChild(e))}email_scripts_state="unloaded";var Sl=function(e){Ma.showComposer=!0;let t=Nl();t.innerHTML="",t.appendChild(e)};function Ol(e){let i=Fa.get(aa);if("email"!=i?.channeltype)return t("attempting to retrie business profile for user id:"+aa),void setTimeout((()=>{Yl.get_customer_business_profiles(aa,Yl.auth.providerId,(function(i){if(i&&i.length>0){let n=!1;i.forEach((e=>{!1===n&&e.channeltype&&"email"===e.channeltype&&(Fa.set(aa,e,300),n=!0)})),n?Ol(e):t("missing email business profile for user id:"+aa)}}),(function(e){t("error retrieving business profile for user id:"+aa)}))}),1e3);(Ma=Ma||{}).customerContact={name:i.name,email:i.email};let n={show_reply:"active"===oa&&!("readonly"==jl),show_reply_all:"active"===oa&&!("readonly"==jl)};Cl(Ll(Ma.EmailComponentId,i.businesskey,n),!1),bi({input:!1,attach:!1})}function Il(e){"loaded"==email_scripts_state?e==Hn&&(Ma?Ol(e):Yl.get_channel_properties(Yl.auth.providerId,Ca,Sa,Ia,(function(i){i&&i.EmailComponentId&&i.ComposerComponentId?((Ma=Ma||{}).EmailComponentId=i.EmailComponentId,Ma.ComposerComponentId=i.ComposerComponentId,i.AccountEmailId&&(Ma.AccountEmailId=i.AccountEmailId),Ol(e)):t("Unable to get email context for user "+aa)}),(function(e){t("Failed to get channel properties")}))):kl(e)}var Ml,jl,page="",Pl=!1,Hl=!1,Rl=!1,Dl=!0,Fl=!1,Ul=!1,zl="none",ql="phone",Jl=!1,Wl="",Bl=!0,Gl=!0,$l=0,Vl=!1,Kl=null,Yl=null,Xl=null,Zl=!0,Ql=null,ed=[],td=null,id="",nd=!1,ad=!0,od=!1,rd=!1,sd="",cd="",ld=!1,dd=!1,ud=!1,pd=["login","accesslogin","reset-password","forgot-password","login-token","login-password","signup","signup-token","connect-settings","end-of-login","user-profile","business-profile","change-password","import-contacts","welcome","frontpage","search","contacts","chats","chat-results","chat","chatwith","alerts","profile","settings","dialer"],fd={"bot-icon":"bot-icon.png","notify-icon":"icon-notify.png"};function hd(){t("initialize(), historylength: "+($l=window.history.length)),"true"==o("loadscreen")&&function(){t("loadscreen()");try{var e=localStorage["koopid.save-screen"];if(e){delete localStorage["koopid.save-screen"],e=function(e,t){return e=e.replace(/"(blob:[^"]+)"/g,(function(e,i,n,a){return'"'+(t[i]||"assets/cleardot.gif")+'"'}))}(e,JSON.parse(localStorage["koopid.save-screen-dataurl"]||"{}")),delete localStorage["koopid.save-screen-dataurl"];var i=document.createElement("div");i.setAttribute("class","saved-screen"),i.setAttribute("style","position: fixed; width: 100%; height: 100%; left: 0px; top: 0px; z-index: 10;");var n=document.createElement("iframe");n.setAttribute("frameborder","0"),n.setAttribute("style","position: absolute; width: 100%; height: 100%; left: 0px; top: 0px;"),i.appendChild(n),document.body.appendChild(i),n.contentDocument.write(e);var a=parseInt(localStorage["koopid.save-screen-scroll"]);n.contentDocument.querySelector("div.page.chat div.history").scrollTop=a,n.contentDocument.querySelector("div.page.chat div.input textarea").value="",n.contentDocument.querySelector("div.page.chat div.input textarea").focus();for(var o=n.contentDocument.querySelector("body"),r=o.getAttributeNames(),s=0;s<r.length;++s){var c=r[s];c&&c.startsWith("disable-")&&document.body.setAttribute(c,o.getAttribute(c))}}}catch(e){console.error(e)}}();var e=o("splashscreen");if("false"==e)i("div.body").style.backgroundImage="none";else if(u())i("div.body").style.backgroundImage="";else{var r=o("frontdoor")||o("provider")||o("login-providerId");if(r){var s=e&&"true"!=e&&(e.match(/^[a-zA-Z0-9_\-\.]+$/)||e.startsWith("/kpd-static/"))?e:"splashscreen.png",c=s.startsWith("/kpd-static")?"url('"+s+"')":"url('/kpd-static/providers/"+r+"/images/"+s+"')"+(e?"":", url('/kpd-static/providers/0/images/splashscreen.png')");i("div.body").style.backgroundImage=c,i("div.body div.page.welcome").style.backgroundImage=c,"agent"!=kd("localstore")&&(i("div.pages div.page.login").style.backgroundImage=c)}else i("div.body").style.backgroundImage=""}Dl=l("initialhidden",!0,Dl),Id(!1);let d=kd("launchmode");d=["native","webview","embedded","preload"].indexOf(d)<0?"native":d,Xl=l("launchmode",d,Xl);var h=o("usezoom");("true"==h||"false"!=h&&u()&&p("ios"))&&(Ta=!0);try{!function(){bd();try{chrome.app.window.current().onBoundsChanged.addListener(bd)}catch(e){window.addEventListener("orientationchange",(function(e){setTimeout((function(){bd(!0)}),200)}))}p()&&md(!0)}()}catch(e){t(e),Ye(e.message,"error")}if(p("ios")&&(document.addEventListener("touchmove",(function(e){1==Rl&&"profile"!=page&&"frontpage"!=page&&!$s&&e.scale&&1!==e.scale&&(t("disabled touchmove on iOS"),e.preventDefault())}),!1),i("div.pages").style.position="fixed",u()&&(i("div.widget.default > div").style.overflow=i("div.widget.overlay > div").style.overflow="auto",i("div.widget.default > div").style.webkitOverflowScrolling=i("div.widget.overlay > div").style.webkitOverflowScrolling="touch")),p()||(i("div.page.chat > div.widget.default > div:nth-of-type(1)").style.position="absolute"),u()&&Rl){var g=0;window.addEventListener("click",(function(e){var t=g,n=(g=(new Date).getTime())-t;n>=0&&n<500&&(i("div.page").scrollIntoView(),page&&i("div.page."+page)&&i("div.page."+page).scrollIntoView())}))}addEventListener("propertyChange",(function(e){t(e.property+" "+e.oldValue+"=>"+e.newValue),"loggedin"==e.property&&e.newValue&&ps("user profile",{user:{name:Kl.myprofile.name,type:Et?"agent":"guest-"==Kl.myprofile.email.substr(0,6)?"guest":"customer"},device:{app:u(),mobile:p(),embedded:f(),protocol:window.location.protocol,screen:window.innerWidth+"x"+window.innerHeight},browser:navigator.userAgent}),ds.indexOf(e.property)>=0&&fs(e.property,e.oldValue,e.newValue)})),"webview"!=Xl&&addEventListener("beforeunload",zd,!1),"true"==o("disableinput","false")&&bi({input:!1,attach:!1});let v=o("brandname");v&&t("starting client with custom branding "+v),Ml=l("brandname",v||"",Ml);let m=o("agentview");var y;m&&(jl=l("agentview",m,jl)),t("Initialize(): calling getManifest()"),y=function(e){t("Initialize():getManifest -> returned"),t(e),e?((td=e||{})&&td.version&&(i("div.page.connect-settings span.version").innerHTML=n("App Version: "+td.version)),u()||(nd=!0),function(){var e=function(){console.log("toggle netlogger"),gs("longpress","netlogger hotspot"),Ls?Is():Os(i("div.page.connect-settings input.text.message").value)};i("div.page.connect-settings div.hotspot").addEventListener("click",e);var t=kd("netlogger");t&&"false"!=t&&Os(t)}(),gd()):Ye("Attempting to reload app manifest.","Warning",2e3)},t("getManifest() called"),window.chrome&&chrome.runtime&&chrome.runtime.getManifest?_d(y):(t("Invoking ajax in getManifest()"),le("GET","manifest.json",null,(function(e){a(y,e)}),(function(e){t("failed to getManifest "+e),a(y)}),void 0,void 0,void 0,void 0))}function gd(){if(t("initialize_continue"),td&&nd&&!dd){t("Initialize_continue() continuing with initialization..."),dd=!0,function(){var e=f();Fl=l("isembeddedapp",e,Fl),e=u(),Ul=l("ismobileapp",e,Ul),(e=kd("callmode"))&&(En=l("callmode",e,En));(e=kd("enablerecord"))&&(gl=l("enablerecord","true"==e,gl));(e=kd("enabletranscribe"))&&(vl=l("enabletranscribe","true"==e,vl));(e=kd("enablevideo"))&&(ml=l("enablevideo","true"==e,ml))}(),Jd(),u()&&"undefined"!=typeof FirebasePlugin&&"undefined"!=typeof device?(window.FirebasePlugin.getToken((function(e){t("firebase device token="+e),ot(e)}),(function(e){t("failed to get token: "+e)})),window.FirebasePlugin.onTokenRefresh((function(e){t("firebase device token="+e),ot(e)}),(function(e){t("failed to refresh token: "+e)})),window.FirebasePlugin.onNotificationOpen((function(e){t("on firebase notification "+JSON.stringify(e)),(e.action||e.chat)&&(Tt?(rt(e),setTimeout((function(){}),200)):qe.push(e))}),(function(e){t("failed to open notification: "+e)}))):t("not installing firebase notification"),Wd(),"true"==kd("animation")?Rl=l("animation0",!0,Rl):i("div.pages").style.position="","false"==kd("branding")&&function(){for(var e=0;e<10&&e<document.styleSheets.length;++e){var i=document.styleSheets[e].href||"",n=i.split("/").pop();if(i.indexOf("login/index.css")>=0||n.indexOf("index-")>=0){t("koopid-branding found "+n);var a=document.styleSheets[e].cssRules||document.styleSheets[e].rules||new Array;for(var o in a)try{console.log(a[o].selectorText+" "+a[o].style["background-image"]),"div.page.login div.hotspot"==a[o].selectorText&&a[o].style["background-image"].indexOf("assets/logo-512x256.png")>=0&&(a[o].style["background-image"]="none",t("remove koopid-branding style"))}catch(e){}break}}}();var e=kd("resize");let c=["auto","fit","mobile","none","scale"];if(e&&c.indexOf(e)<0&&(e="none"),p()?zl=l("layoutresize",zl?"fit":"mobile"):(zl=l("layoutresize",e||"auto",zl),e&&"none"==e||md("fit"==e||"mobile"==e)),"none"!=zl&&"mobile"!=zl&&"scale"!=zl||!i("#desktopcss")||(i("#desktopcss").disabled=!0),bd("fit"==zl||"mobile"==zl),"mock"==kd("fingerprint")&&(Ot=!0),"true"==kd("uselocation")&&(od=!0),"true"==kd("accessibility")&&(rd=!0),(Pa=o("channelid"))&&Pa.match(/^[a-zA-Z0-9]+$/)?t("Starting chat with channel "+Pa):Pa=null,Zl=l("stickysession","true"==kd("retainsession",!0)),ud=!1,t("Starting client in a sticky session mode: "+Zl),us("stickysession-start",{text:"Started client in stickysession mode",stickysession:Zl}),se=!0,re=!0,!(Qt=kd("provider")||kd("frontdoor")||o("login-providerId"))){var n=kd("username");if(n&&n.startsWith("provider/")){var r=n.split("/")[1];r&&(Qt=r)}}ls=Qt||null,s=function(){Wd(),Jd(),ac();let e=o("provider",o("login-providerId"));if("customer"==o("localstore")&&e&&"string"==typeof On){if(p()&&Zl&&f())return t("ignore sticky session for mobile browser if launched in embedded mode"),void x({type:"chat-closed",id:Hn,participant:""},"*");Yl.get_active_chats(e,On,(function(e){if(f()&&Zl&&e&&e.activecount<1)return t("No active sessions for this client.  Closing the client."),void x({type:"chat-closed",id:Hn,participant:""},"*");vd()}),(function(e){t("Error in getting session count for this user.  Close this client."),Zl||vd()}))}else t("Not a customer session.. continuing with initialization"),vd()},window.onhashchange=jd,Kl=new de,Yl=new pe,Kl.load("device",(function(e){Kl.load("connect",(function(n){Kl.upgrade(n),Kl.update(n),t("init_state:state.load(connect): hasfingerprint =>"+Kl.fingerprint),Lt=l("hasfingerprint",!!Kl.fingerprint,Lt),xd(),function(){var e=kd("autoconfig");if(e){var i=null;"true"==e?window.location.hostname?(t("autoconfig to web"),i=Kl.auto_settings()):(t("autoconfig to app"),i=Kl.auto_settings("app.koopid.io")):"vm"==e&&window.location.hostname?(t("autoconfig to vm "+window.location.hostname),i=Kl.auto_settings(window.location.hostname)):"cloud"==e?(t("autoconfig to cloud"),i=Kl.auto_settings("app.koopid.io")):(e.match(/^((\d+\.\d+\.\d+\.\d+)|(localhost))(:\d+)?$/)||e.match(/^[a-z0-9\.\-\_]+(:\d+)?$/)||e.match(/^https?:\/\/.*/))&&(t("autoconfig to "+e),i=Kl.auto_settings(e)),i&&(Kl.update(i),Kl.store("connect",i))}}(),Yl.configure((function(n){null!=Le["client-start-input-disabled"]&&bi({input:!Le["client-start-input-disabled"],attach:!Le["client-start-input-disabled"]}),Yl.getEncryptionConfig((function(r){e&&e.id&&"null"!==e.id.trim()&&"undefined"!==e.id.trim()&&""!==e.id.trim()?On=(On=e.id).replace(/[-_ ]/g,""):(On||((On=o("deviceid"))&&""!==On.trim()||(On=y()),On=On.replace(/[-_ ]/g,"")),Kl.store("device",{id:On},!0));try{let e=o("referrer");e&&""!==e.trim()||(e=document.referrer||window.location.ancestorOrigins[0]),In=e}catch(e){}!0===n?St=!0:Qt||Id(!0);var c=function(){a(s)};if(kd("username")){Kl.store("idp_login");var l=kd("username"),d=kd("password");!l||d||"guest"!=l&&"guest-"!=l.substr(0,6)||(d="guest"),l&&(d?(t("using query params for login username="+l),i("div.page.login input.text.email").value=l,i("div.page.login input.text.password").value=d,i("div.page.forgot-password input.text.email").value=l,ad=!0,window.location.hash=""):(ad=!1,Kl.load("login",(function(e){e&&e.username&&e.password&&e.username===l?(t("Given username "+l+" matches  stored username.  Attempting to autologin"),i("div.page.login input.text.email").value=l,i("div.page.login input.text.password").value=e.password,i("div.page.forgot-password input.text.email").value=l,ad=!0):(t("Username is not same as previous one. username: "+l),i("div.page.login input.text.email").value=l,i("div.page.login input.text.password").value="",i("div.page.forgot-password input.text.email").value=l)})))),c()}else{let e=o("email"),n=o("authtoken");if(e&&n){Kl.store("login"),Kl.store("idp_token",{idp_email:e,idp_authtoken:n}),ad=!0,window.location.hash="";let t=new URLSearchParams(window.location.search);t.delete("email"),t.delete("authtoken"),window.history.replaceState({},document.title,window.location.origin+window.location.pathname+"?"+t.toString()),c()}else Kl.load("idp_login",(function(e){if(e)ad=!0,window.location.hash="",c();else{var n=function(){Kl.load("login",(function(e){e&&e.username&&e.password?(i("div.page.login input.text.email").value=e.username,i("div.page.login input.text.password").value=e.password,i("div.page.forgot-password input.text.email").value=e.username,ad=!0):"customer"==kd("localstore")?(t("Using a default login for customer since the localstore is customer"),i("div.page.login input.text.email").value="guest",i("div.page.login input.text.password").value="guest",i("div.page.forgot-password input.text.email").value="guest",ad=!0,window.location.hash=""):(t("No login data found"),ad=!1),c()}))};o=function(){n()},r=function(e){ad=!1,c()},!Lt||Pt?a(o):Gt((function(){a(o)}),(function(e){console.log("Failed to verify - "+e),i("div.page.login input.text.email").value="",i("div.page.login input.text.password").value="",a(r,e)}))}var o,r}))}}),o("login-providerId")||0)}),Ed,!u()&&o("clientkey")||void 0,Qt,Ad,Ld,"guest"==kd("username"),Pa)}))}),!0)}else t("returning from initialize_continue -> already initialized");var s}function vd(){Rt(),Qt||Nd((function(){})),function(){var e=new Date;e.getFullYear()>2016&&(i("div.footer span.copyright-year").innerText="2016-"+e.getFullYear());i("div.footer div.for-mobile").addEventListener("click",(function(e){h(e.currentTarget.getAttribute("data"))}))}(),function(){i("div.controls div.header div.logo").addEventListener("click",(function(){"desktop"==ql&&["chat","profile","chatwith","frontpage"].indexOf(page)<0&&(hs("header logo"),ni=null,Kt=l("frontpage",!1,Kt),yi(0),setTimeout((function(){"chats"!=page&&"contacts"!=page&&"alerts"!=page||i("div.page."+page+" > div.title").click()}),0))})),i("div.header div.settings").addEventListener("click",(function(){hs("settings button"),wi=l("showmenu",!wi,wi),xi=l("showsuggest",!1,xi)})),i("div.header div.button.directory").addEventListener("click",(function(){})),i("div.header div.button.dialer").addEventListener("click",(function(){Sd("#dialer",!0)})),i("div.header div.button.alerts").addEventListener("click",(function(){hs("alerts button"),Et?Oi=l("showtodomenu",!0,Oi):Sd("#alerts",!0)})),i("div.header div.button.contacts").addEventListener("click",(function(){Et&&(hs("contacts button"),Sd("#contacts",!0))})),i("div.header div.button.chats").addEventListener("click",(function(){hs("chats button"),Sd("#chats",!0)}));var e=function(n){t("hidedropdown called"),i("div.body div.pages").removeEventListener("click",e),Xt&&(Xt=l("showdropdown","",Xt))};i("div.header div.profile.picture").addEventListener("click",(function(){hs("profile picture dropdown");var t=Xt;Xt=l("showdropdown","profile"==Xt?"":"profile",Xt),t||i("div.body div.pages").addEventListener("click",e)})),i("div.header div.presence").addEventListener("click",(function(){hs("presence dropdown");var t=Xt;Xt=l("showdropdown","status"==Xt?"":"status",Xt),t||i("div.body div.pages").addEventListener("click",e)})),i("div.body > div.content div.page.container.chats > div.title > div.state").addEventListener("click",(function(t){hs("chatstate dropdown");var n=Xt;Xt=l("showdropdown","chatstate"==Xt?"":"chatstate",Xt),n||i("div.body div.pages").addEventListener("click",e),t.stopImmediatePropagation()})),i("div.controls div.dropdownmenu.profilemenu > span.logout").addEventListener("click",(function(){if(action=function(){Sd("#logout/close")},hs("profile menu item logout"),Et){let t="";active_conversations=document.querySelectorAll('div.page.chats div.list div[state="active"]'),t=1==active_conversations.length?"You have one active conversation.":active_conversations.length>1?"You have "+active_conversations.length+" active conversations.":"You are about to exit agent view. ",t+=" Logout?",b({title:"Logout",message:t,buttons:{Logout:{class:"orange",action:action},Cancel:{class:"gray",action:e}}})}else action()}));for(var n=i("div.controls div.dropdownmenu.statusmenu").children,a=0;a<n.length;++a)n[a].addEventListener("click",(function(e){var t=e.currentTarget.getAttribute("data");hs("status menu item",{value:t}),Xt=l("showdropdown","",Xt),Yl.set_provider_presence(t,(function(){i("div.controls div.header div.presence").innerText=t,x({type:"presence",message:{data:{userid:Yl.auth.user_id,status:t}}},"*")}),(function(e){Ye("failed to set presence state","Warning")}))}));var o=i("div.body > div.content div.page.container.chats > div.title > div.dropdownmenu.statemenu").children;for(a=0;a<o.length;++a)o[a].addEventListener("click",(function(e){var t=e.currentTarget.getAttribute("data");hs("state menu item",{value:t}),Xt=l("showdropdown","",Xt),i("div.body > div.content div.page.container.chats > div.title > div.state").innerText=t,Yi=l("showchatsofstate",t,Yi)}));var r=i("div.page.chatside > div.navbar").children;for(a=0;a<r.length;++a){var s=r[a];"person"!=s.className&&s.addEventListener("click",(function(e){e.stopImmediatePropagation(),e.preventDefault();var t=e.currentTarget.className;return Zr(Kr=l("chattab",Kr==t?"":t,Kr)),!1}))}i("div.mainmenu").addEventListener("click",(function(e){"desktop"==ql&&e.currentTarget==e.target&&(hs("menu sidepanel hide"),Zt=l("showleftpanel",!Zt,Zt))})),i("div.mainmenu div.item.home").addEventListener("click",(function(e){hs("menu home item"),wi=l("showmenu",!1,wi),Sd(Vt?"#frontpage/"+Qt:Et?"#chats":"#welcome")})),i("div.mainmenu div.item.profile").addEventListener("click",(function(e){hs("menu profile item"),wi=l("showmenu",!1,wi),Sd("#user-profile")})),i("div.mainmenu div.item.chats").addEventListener("click",(function(e){hs("menu chats item"),wi=l("showmenu",!1,wi),"desktop"==ql&&(hs("menu sidepanel show"),Zt=l("showleftpanel",!0,Zt)),setTimeout((function(){i("div.header div.button.chats").click()}),300)})),i("div.mainmenu div.item.contacts").addEventListener("click",(function(e){hs("menu contacts item"),wi=l("showmenu",!1,wi),setTimeout((function(){i("div.header div.button.contacts").click()}),300)})),i("div.mainmenu div.item.directory").addEventListener("click",(function(e){hs("menu directory item"),wi=l("showmenu",!1,wi),setTimeout((function(){i("div.header div.button.directory").click()}),300)})),i("div.mainmenu div.item.dialer").addEventListener("click",(function(e){wi=l("showmenu",!1,wi),setTimeout((function(){i("div.header div.button.dialer").click()}),300)})),i("div.mainmenu div.item.payments").addEventListener("click",(function(e){hs("menu payments item"),wi=l("showmenu",!1,wi),Ye("This feature is not implemented","Error")})),i("div.mainmenu div.item.alerts").addEventListener("click",(function(e){hs("menu alerts item"),wi=l("showmenu",!1,wi),setTimeout((function(){i("div.header div.button.alerts").click()}),300)})),i("div.mainmenu div.item.support").addEventListener("click",(function(e){hs("menu support item"),wi=l("showmenu",!1,wi),Ye("This feature is not implemented","Error")})),i("div.mainmenu div.item.settings").addEventListener("click",(function(e){hs("menu settings item"),wi=l("showmenu",!1,wi),Ye("This feature is not implemented","Error")})),i("div.mainmenu div.item.account").addEventListener("click",(function(e){hs("menu account item"),wi=l("showmenu",!1,wi),setTimeout((function(){Sd("#change-password")}),300)})),i("div.mainmenu div.item.logout").addEventListener("click",(function(e){hs("menu logout item"),wi=l("showmenu",!1,wi),setTimeout((function(){Sd("#logout/close")}),300)}));var c=document.querySelectorAll("div.mainmenu div.item.subitem.presence");for(a=0;a<c.length;++a)c[a].addEventListener("click",(function(e){hs("menu presence sub-item",{value:e.currentTarget.getAttribute("data")});var t=e.currentTarget.getAttribute("data");Yl.set_provider_presence(t,(function(){i("div.controls div.header div.presence").innerText=t,x({type:"presence",message:{data:{userid:Yl.auth.user_id,status:t}}},"*"),wi=l("showmenu",!1,wi)}),(function(e){Ye("failed to set presence state","Warning")}))}));for(c=document.querySelectorAll("div.mainmenu div.item.subitem.chats"),a=0;a<c.length;++a)c[a].addEventListener("click",(function(e){hs("menu chats sub-item",{value:e.currentTarget.getAttribute("data")});var t=e.currentTarget.getAttribute("data");Xt=l("showdropdown","",Xt),i("div.body > div.content div.page.container.chats > div.title > div.state").innerText=t,Yi=l("showchatsofstate",t,Yi),wi=l("showmenu",!1,wi),en(i("div.header input.text.search").value)}));i("div.page.frontpage div.button.minimize.container").addEventListener("click",(function(e){x({type:"minimize"},"*")})),i("div.page.frontpage div.button.chatclose.container").addEventListener("click",(function(e){x({type:"close"},"*")}))}(),di((function(){Qt&&Nd((function(){}))})),Ke(),Ai(),i("div.page.contacts > div.title").addEventListener("click",(function(e){var t="";Hi&&(t=""+Hi);var n=i("div.header input.text.search").value;n&&(t+="?filter="+n),Fi(!0,t)})),i("div.page.chats > div.title").addEventListener("click",(function(e){en(i("div.header input.text.search").value)})),i("div.page.profile div.header span.status").addEventListener("click",Bs),i("div.page.profile div.header span.icon").addEventListener("click",Bs),i("div.fullsize.mask").addEventListener("click",Ws),i("div.page.profile div.input div.button.attach").addEventListener("click",Gs),i("div.page.profile div.textarea > textarea").addEventListener("click",Gs),i("div.page.profile div.textarea > textarea").addEventListener("focus",Gs),Ja(),function(){i("div.page.dialer div.startcall").addEventListener("click",Mc),i("div.page.dialer div.endcall").addEventListener("click",jc);for(var e=document.querySelectorAll("div.page.dialer div.dialpad > div > div"),t=0;t<e.length&&t<12;++t)e[t].addEventListener("click",Pc)}(),i("div.videos div.button.resize").addEventListener("click",(function(e){Kc=l("minimizevideo",!Kc,Kc)})),i("div.videos div.button.close").addEventListener("click",(function(e){ol()})),p()?i("div.videos div.video.local").addEventListener("touchstart",Ic):i("div.videos div.video.local").addEventListener("mousedown",Ic),function(){for(var e=i("div.page.chatside > div.navbar").children,t=0;t<e.length;++t){var n=e[t];"person"!=n.className&&n.addEventListener("click",(function(e){e.stopImmediatePropagation(),e.preventDefault();var t=e.currentTarget.className;return Zr(Kr=l("chattab",Kr==t?"":t,Kr)),!1}))}i("div.page.chatside > div.navbar > div.person").addEventListener("click",Uo),i("div.page.chatside > div.navbar").addEventListener("click",(function(e){Kr=l("chattab","",Kr)})),i("div.page.chatside div.emailtranscript input.button").addEventListener("click",(function(e){var t=Ln.id,i=Yl.auth.user_id;Yl.send_provider_transcript_email(Hn,t,i,aa,(function(){Ye("Conversation transcript was sent via email","Info"),is()}),(function(e){Ye("Failed to send email","Error"),is()}))})),i("div.page.chatside div.tags input.search").addEventListener("keyup",ts),i("div.page.chatside div.assign input.search").addEventListener("input",Xr),i("div.page.chatside div.suggestions input.search").addEventListener("input",Xr),i("div.page.chatside div.phone input.button.phone").addEventListener("click",zo),i("div.page.chatside div.phone input.button.hangup").addEventListener("click",Jo),i('div.page.chatside span.link[data="callconnect"]').addEventListener("click",Go),i('div.page.chatside span.link[data="twiliocall"]').addEventListener("click",Go),i('div.page.chatside span.link[data="webrtccall"]').addEventListener("click",Go),i('div.page.chatside span.link[data="enablerecord"]').addEventListener("click",$o),i('div.page.chatside span.link[data="enabletranscribe"]').addEventListener("click",Vo),i('div.page.chatside span.link[data="enablevideo"]').addEventListener("click",Ko),i("div.page.chatside div.widgets input.search").addEventListener("input",Xr),i("div.page.chatside div.settings input.button.save").addEventListener("click",Xo),i("div.page.chatside div.settings input.button.exit").addEventListener("click",Qo),i("div.page.chatside div.settings input.button.minimize").addEventListener("click",er),i("div.page.chatside div.settings input.button.closesegment").addEventListener("click",ir),i("div.page.chatside div.settings input.button.email").addEventListener("click",tr),i("div.page.chatside div.useractivity div.footer input.sendurl").addEventListener("click",rs)}(),f()&&Et&&(x({type:"pollingthread",data:{status:"start"}}),setInterval((function(){try{us("pollingthread",{chat:Hn,chat_paths:jn,"api.auth":Yl.auth&&Yl.auth.user_id?Yl.auth.user_id:"unknown"})}catch(e){us("pollingthread",{error:"Failed to fill data: "+e})}}),12e4))}function md(e){window.addEventListener("resize",(function(n){t("resized"),Hl&&(Id(!1),null!=Ql&&clearTimeout(Ql),Ql=setTimeout((function(){Ql=null,Id(!0,!0)}),200)),bd(e),setTimeout((function(){Rl&&page&&i("div.page."+page)&&window.innerWidth<window.innerHeight&&i("div.page."+page).scrollIntoView()}),0)}))}window.onload=function(){hd()};var yd=0;function bd(e){var n=960,a=window.innerWidth,o=window.innerHeight;u()||!p("ios")||navigator.plugins&&0!=navigator.plugins.length||(0==yd&&a==window.screen.availWidth&&(yd=window.screen.availHeight-o),t("KPX-1209: size changed from "+a+"x"+o+" to "+(a=window.screen.availWidth)+"x"+(o=window.screen.availHeight-yd)+" delta: "+yd));e||p()&&a<o||f()?(n=Math.ceil(o/a*640),i("div.body").style.height=n+"px",wd("div.page.viewsize","height",n+"px")):(i("div.body").style.height="",wd("div.page.viewsize","height",n+"px"));var r=640/n,s=Math.min(a,r*o),c=Math.min(o,a/r),d=Math.min(s/640,c/n),h=(a-s)/2/d,g=(o-c)/2/d;i("div.body").setAttribute("zoom",""+d),Ta?(i("div.body").style.left=h+"px",i("div.body").style.top=g+"px",i("div.body").style.zoom=""+d,i("div.body").style.webkitTransform=i("div.body").style.mozTransform=i("div.body").style.transform="",i("div.widget.default > div").style.webkitTransform=i("div.widget.default > div").style.mozTransform=i("div.widget.default > div").style.transform="",i("div.widget.default > div").style.width=i("div.widget.default > div").style.height=null,i("div.widget.overlay > div").style.webkitTransform=i("div.widget.overlay > div").style.mozTransform=i("div.widget.overlay > div").style.transform="",i("div.widget.overlay > div").style.width=i("div.widget.overlay > div").style.height=null):(i("div.body").style.webkitTransform=i("div.body").style.mozTransform=i("div.body").style.transform="scale("+d+") translateX("+h+"px) translateY("+g+"px)",i("div.body").style.webkitTransformOrigin=i("div.body").style.mozTransformOrigin=i("div.body").style.transformOrigin="0 0",i("div.widget.default > div").style.webkitTransform=i("div.widget.default > div").style.mozTransform=i("div.widget.default > div").style.transform="scale("+1/d+")",i("div.widget.default > div").style.width=i("div.widget.default > div").style.height=100*d+"%",i("div.widget.overlay > div").style.webkitTransform=i("div.widget.overlay > div").style.mozTransform=i("div.widget.overlay > div").style.transform="scale("+1/d+")",i("div.widget.overlay > div").style.width=i("div.widget.overlay > div").style.height=100*d+"%",i("div.body").style.left=i("div.body").style.top=null,i("div.body").style.zoom="");var v=("auto"==zl||"fit"==zl)&&a>=800&&o>=400?"desktop":a>=720&&o>=720?"tablet":"phone";v!=ql&&(ql=l("layoutsize",v,ql)),t("windows-boundschanged("+e+") layout="+ql+" WxH="+a+"x"+o+" wxh="+s+"x"+c+" zoom="+d+" x,y="+h+","+g)}function wd(e,i,n){for(var a=0;a<4&&a<document.styleSheets.length;++a){var o=(document.styleSheets[a].href||"").split("/").pop();if(o.indexOf("pages.css")>=0||o.indexOf("index-")>=0){t("change-style found "+o);var r=document.styleSheets[a].cssRules||document.styleSheets[a].rules||new Array;for(var s in r)r[s].selectorText==e&&(r[s].style[i]=n,t("change-style "+e+" { "+i+": "+n+"}"));break}}}function xd(){od&&function(e,i){if(navigator.geolocation&&navigator.geolocation.getCurrentPosition){i||(i={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e4});var n=function(){document.removeEventListener("click",n),navigator.geolocation.getCurrentPosition((function(i){t("get_location()"),t(i);var n=Math.round(1e5*i.coords.latitude)/1e5,o=Math.round(1e5*i.coords.longitude)/1e5;result={latitude:n,longitude:o},a(e,result)}),(function(i){t("get_location() failed"),t(i),a(e)}),i)};document.addEventListener("click",n)}}((function(e){if(e){var i=JSON.parse(JSON.stringify(Kl.location));Kl.location.latitude=e.latitude,Kl.location.longitude=e.longitude,fs("location",i,Kl.location)}else t("failed to get geo-location")}))}function _d(e){t("getManifestFromRuntime() called");var i=chrome.runtime.getManifest();i?(t("getManifestFromRuntime() succeeded"),t(i),a(e,i)):(t("Failed to get manifest. Retrying in 500ms"),setTimeout((function(){_d(e)}),500))}function kd(e,t){var i=td&&td.query_string;return"*"==e?i?s().concat(s(i)):s():o(e,i?o(e,t,i):t)}var Td=function(e,t){e=(e||"").split(".").map((function(e){try{return parseInt(e)}catch(t){return e}})),t=(t||"").split(".").map((function(e){try{return parseInt(e)}catch(t){return e}}));for(var i=0;i<e.length||i<t.length;++i){if(i<e.length&&i<t.length){if(e[i]==t[i])continue;return e[i]<t[i]?-1:1}if(i>=e.length&&i<t.length)return-1;if(i<e.length&&i>=t.length)return 1}return 0};function Ed(e,t,i){if(e&&td&&td.version){var n=null;Td(e.min,e.max)>0?n="Server version misconfigured. "+e.min+"-"+e.max:(Td(td.version,e.min)<0||Td(td.version,e.max)>0)&&(n="Version incompatible. App "+td.version+" not compatible with server "+e.min+"-"+e.max),n?!u()&&void 0!==Kl&&window.location.origin&&Kl.api.substr(0,window.location.origin.length)==window.location.origin?(Ye(n,"Warning"),a(t,i)):(Ye(n,"Error",6e4),Qt||a(t,n)):a(t,i)}else Qt?Ye(e?"We are having trouble loading your experience. Please refresh your connection or try again later..":"We are having trouble loading your experience. Please refresh your connection or try again later.","Error",6e4):a(t,i)}function Ad(e){Le=e||{}}function Ld(e){if(e[Ml])fd=e[Ml];else if(e?.branding?.client?.cssvariables){fd["bot-icon"]=e.branding.client.cssvariables["--bot-icon"]||"bot-icon.png",fd["notify-icon"]=e.branding.client.cssvariables["--brand-logo"],fd["brand-logo"]=e.branding.client.cssvariables["--brand-logo"]||void 0,e?.branding?.client?.customcss&&(fd.customcss=e.branding.client.customcss.url);try{Object.entries(e.branding.client.cssvariables).forEach((([e,t])=>{fd[e]=t}))}catch(e){}}else fd={};fd["bot-icon"]=fd["bot-icon"]||"bot-icon.png",fd["notify-icon"]=fd["notify-icon"]||"icon-notify.png"}function Nd(e){var i=kd("printable");i&&function(e,i){let n=window[e];if(n!==i){window[e]=i;let a=null!=i?typeof i:i;if(null==a||"boolean"==a||"number"==a||"string"==a&&i.length<256)try{document.body.setAttribute(e,""+i)}catch(e){t("ignore exception "+e.message)}c({type:"propertyChange",property:e,oldValue:n,newValue:i})}}("printable","true"==i||"false"!=i&&i),cd||(t("target_hash="+(cd=window.location.hash.replace(/%20/g," ")||"#landing")),cd&&0==cd.indexOf("#profile/")&&(t("setting profilesplash=true"),Rs=!0));var n="false"!=kd("auto","true"),a=cd.split("/").pop().substr(1);if(t("hash first="+a),pd.indexOf(a)>=0&&pd.indexOf(a)<pd.indexOf("end-of-login"))Sd(cd,!0),cd="";else if("logout"==a)remaining=cd.substr(8),cd="",Ud(),Ut(void 0,remaining);else{if(n&&ad)return ld=!0,Sd("#login",!0),void Ft(void 0,(function(){ld=!1}),(function(i){ld=!1,t("login failed... exiting"),x({type:"chat-closed",id:0,participant:0},"*"),e(i)}));Et||"agent"==kd("localstore")||"readonly"==kd("localstore")?Sd("#login",!0):(t("Ignore #login.  target_hash="+cd),Sd("#welcome",!0))}Id(!0)}function Cd(e){Pl=l("pending",e,Pl)}function Sd(e,i,n){t("set-hash("+e+", "+i+", "+n+")");var a=window.location.hash.replace(/%20/g," ").split("/")[0],r=e.split("/")[0];if(t("on set-hash: old: "+a+", first: "+r),(("#chat"==r||"#chatwith"==r||"#profile"==r||"#frontpage"==r)&&"#chat"!=a&&"#chatwith"!=a&&"#profile"!=a||"#change-password"==r&&"#change-password"!=a)&&function(){var e=window.location.hash;t("pushing to history: "+e),"#loggedin"==e&&(e="#landing");var i=o("home");i&&i.startsWith("chatwith/")?t("ignoring history_push "+e+" as URL contains home="+i):(ed.push(e),t("history: "+ed))}(),e=e.replace(/\s/g,"%20"),i&&window.location.hash==e)sd="",jd(null,window.location.hash);else if(n||f()){try{window.history.replaceState(void 0,void 0,e)}catch(e){}jd(null,e)}else window.location.hash=e}function Od(){ed.length>0&&(window.location.hash=ed.pop())}function Id(e,t){e&&!0!==t?setTimeout((function(){"false"!=kd("animation")&&(Hl=l("animation",e,Hl)),e&&Dl&&(Dl=l("initialhidden",!1,Dl),i("div.body").style.backgroundImage="",x({type:"appinit"},"*"),qd())}),t||500):("false"!=kd("animation")&&(Hl=l("animation",e,Hl)),e&&Dl&&(Dl=l("initialhidden",!1,Dl),i("div.body").style.backgroundImage="",x({type:"appinit"},"*"),qd()))}function Md(e){id||(id=e,document.getElementsByTagName("title")[0].innerHTML=n(id.replace(/\-/g," ")))}function jd(e,r){var s=sd;sd=r||window.location.hash.replace(/%20/g," "),Es("on_hashchange: old"+s+" new="+sd);var c,d=o("home");if(d&&d.startsWith("chatwith/")&&s.startsWith("#chat/")&&!(sd.startsWith("#chatwith/")||sd.startsWith("#chat/")||sd.startsWith("#user-profile")||sd.startsWith("#alerts")||sd.startsWith("#logout")||sd.startsWith("#form")||sd.startsWith("#chats")))t("hash-change "+s+"=>"+sd),t("on_hashchange: URL contains home="+d+". User is not allowed to move away."),t("historylength_on_entry: "+$l+", current: "+window.history.length),Vl=!0,window.history.go($l-window.history.length);else if("#login"==sd&&1==Vl)Vl=!1,Ut(!0),Sd("#welcome");else if(s!=sd){t("hash-change "+s+"=>"+sd);var u=sd.split("/")[0].substr(1);!function(e,i){var n=(e||"").substr(1).split("/")[0],a=(i||"").substr(1).split("/")[0];((Vt||!Kt)&&["chat","profile","chatwith","frontpage"].indexOf(n)>=0&&["chat","profile","chatwith","frontpage"].indexOf(a)<0||!Vt&&["chat","profile","chatwith","frontpage","chats","contacts","alerts"].indexOf(n)>=0&&["chat","profile","chatwith","frontpage","chats","contacts","alerts"].indexOf(a)<0)&&(t("unload-customcss-after "+e+"=>"+i),ni=null,Kt=l("frontpage",!1,Kt),yi())}(s,sd);var p=sd.substr(u.length+2),h=s.split("/")[0].substr(1);if(Xs&&s&&(s.startsWith("#login")||s.startsWith("#frontpage"))&&(Xs=l("hasoverlay",!1,Xs),fc()),pd.indexOf(u)>=0)page=l("page",u,page),pd.indexOf(u)<pd.indexOf("end-of-login")&&(Tt?(Ud(),Ut(!0)):Tt=l("loggedin",!1,Tt)),"search"==u?p.match(/\sin\sconversations$/)?Sd("#chats/"+p.substr(0,p.length-" in conversations".length)):Et?Sd("#chats/"+p):Ci(p):"chatwith"==u?p&&function(e,t){var i=e.split("/");if(i.length>0){var n=i.shift();Gn=n,0==i.length?(Cd(!0),Yl.get_chat_path_with(n,(function(e){Cd(!1);var t=e[0];$n={chat_id:t.id,path:t.path},Sd("#chat/"+t.id,void 0,!0)}),(function(e){Cd(!1),"string"==typeof e&&e.toLowerCase().search("please")>=0?Ye(e,"Info",1e4):Ye("failed to get chat context - "+e,"Error"),a(t),Ur(0,"cannot fetch target "+n)}))):Sd("#chat/"+i[0],void 0,!0)}else Ur(0,"no argument for chatwith")}(p,(function(){"#loggedin"!=s&&Sd(s)})):"chats"==u?(Hn&&on(Hn),Hn=null,Pn=null,qa=void 0,en(p)):"chat"==u?p?eo(p):Sd("#chats"):"contacts"==u?Fi("#contacts"!=s.substr(0,9),p||""):"profile"==u?function(e){var t=e?e.split("/")[0]:"";qs=t;var a=function(e){zs=e,Yl.set_src(i("div.page.profile div.content div.picture img"),e.picture||""),i("div.page.profile div.header div.name").innerHTML=n(e.name||""),i("div.page.profile div.header span.title").innerHTML=n(e.title||e.html||"what is the provider name?"),Js(e.status||"offline"),Ms=l("hasphone",!!e.phone,Ms),js=l("hassms",!!e.sms,js);var t=e.web||"about:blank";t&&"http:"!=t.substr(0,5)&&"https:"!=t.substr(0,6)&&(t="about:blank"==t?t:Kl.resolve(t)),Rs&&"about:blank"!=t&&(t=t+(t.indexOf("?")<0?"?":"&")+"showsplash=true",Rs=!1),oc(t)?i("div.page.profile iframe").src=t:Ye("Failed to load content from unverified path - "+t,"Error"),cr("profile",e.id);var a=e.providerId||e.id;if(mi(a),"desktop"==ql&&a&&!i("#contacts-result-"+a)){var o=a;Ri&&(o+="?filter="+Ri),Fi(!0,o)}};Yl.get_customer_profile(t,(function(e){e.id=t,a(e)}),(function(i){Yl.get_provider_profile(t,(function(e){e.id=t,a(e)}),(function(t){Ye("Get profile failed for "+e+": "+t,"Error")}))}))}(p||""):"frontpage"==u?hi(p||""):"alerts"==u?s.substr(0,7):"dialer"==u?(c=p||"",Oc&&(i("div.page.dialer input.number").value=c||"",c&&i("div.page.dialer div.startcall").click())):"login"==page&&!ld&&ei&&ei.config&&ei.config.loginpage&&(Xs=l("hasoverlay",!0,Xs),pc({src:ei.config.loginpage})),"#login"==s&&Xs&&fc();else if("logout"==u)cd="",Ud(),Ut(void 0,p);else if("loggedin"==u)if(Wa(),"#welcome"==cd&&Vt&&(cd=""),cd){if(Et)Id(!0,1e3),i("link#customcss").onload=i("link#customcss").onerror=function(){Id(!0)},Sd(cd),cd="";else{let e=cd;Yl.get_chat_paths((function(n){if(n.length<=1)f()&&Zl&&(e=void 0,x({type:"chat-closed",id:Hn,participant:""},"*"));else for(let i of n)if(!i.path.startsWith("notification/")&&i.path.startsWith("ProviderRoom")){e="#chat/"+i.id,Zl=l("stickysession",!0,Zl),us("stickysession-start",{text:"continuing to ongoing sessoin","chat-path":e}),t("Setting stickysession and switching to ongoing session "+i.id);break}e&&(Id(!0,1e3),i("link#customcss").onload=i("link#customcss").onerror=function(){Id(!0)},Sd(e),cd="")}))}(pd.indexOf(h)<0||pd.indexOf(h)<pd.indexOf("end-of-login"))&&setTimeout((function(){Hd()}),500)}else Id(!0),(pd.indexOf(h)<0||pd.indexOf(h)<pd.indexOf("end-of-login"))&&Hd(),Sd("#landing",void 0,!0);else"landing"==u&&(Et?Sd("#chats"):Vt?d&&d.startsWith("chatwith/")?(t("on_hashchange: URL contains home="+d+". User is not allowed to move away."),Sd("#"+d)):Sd(ii):Sd("#welcome"))}}function Pd(){return"assets/logo-48.png"}function Hd(){if(Tt){t("on_loggedin: "+Qt);var e=Et&&(!0===Le["show-customer-activity"]||!1!==Le["send-url-from-agent"]);Yr=l("hasuseractivity",e,Yr),Et&&(Ii.splice(0,Ii.length),Mi(),i("div.todomenu").innerHTML=""),!Qt&&u()&&function(e){var t="";try{t=localStorage["koopid.frontdoor"]||""}catch(e){}navigator.notification.prompt("Please enter a numeric provider ID to configure this app, or leave blank to avoid provider specific configuration",(function(t){if(1==t.buttonIndex){try{localStorage["koopid.frontdoor"]=t.input1}catch(e){}Qt=t.input1}else try{delete localStorage["koopid.frontdoor"]}catch(e){}a(e)}),"Configure Provider",void 0,t)}((function(){t("on_loggedin: frontdoor_id set to "+Qt),Et||(Qt?(di((function(){t("fontdoor configured from on_loggedin() for provider: "+Qt),Sd("#frontpage/"+Qt)})),ls=Qt,Yl.configure((function(e){t("on_loggedin: Re-read client featues. ")}),void 0,void 0,Qt,Ad,Ld,!0)):Ye("Customer login on this app not associated with a provider is deprecated. Please contact support to get another URL, or supply provider= parameter.","Warning",3e4))})),function(){if(Ve||u()&&"undefined"!=typeof device&&(Ve=device.uuid),Ve&&$e&&Yl.add_device_binding(Ve,$e),qe.length>0){t("process pending notifications "+JSON.stringify(qe));for(var e=0;e<qe.length;++e)rt(qe[e]);qe.splice(0,qe.length),setTimeout((function(){}),200)}u()&&"undefined"!=typeof device&&"iOS"==device.platform&&"undefined"!=typeof FirebasePlugin&&FirebasePlugin.hasPermission&&(t("checking for firebase notification permission"),FirebasePlugin.hasPermission((function(e){e.isEnabled||(t("requesting firebase notification permission"),FirebasePlugin.grantPermission())})))}(),setTimeout((function(){var e=kd("action");if(e)if(t("processing action="+(e=decodeURIComponent(e))),e&&"{"==e.substr(0,1)){var i=ee("action",e,!0);!i.expires||(new Date).getTime()<i.expires?(delete i.expires,Se(i,["path","url","popup","invoke"])):t("cannot run action from param, as it is expired")}else Yl.resolve_action(e,(function(e){Se(e,["path","url","popup","invoke"])}),(function(i){t("failed to resolve action from param "+e+": "+i)}));var n=Ne.slice(0);Ne.splice(0,Ne.length);for(var a=0;a<n.length;++a)Se(n[a],["path","url"])}),0),function(){for(var e in Zi)dn(e)}(),Kr=l("chattab","",Kr);var n=0===Object.keys(Le).length?2e3:0;setTimeout((function(){Et||!0!==Le["use-customer-ip-location"]||(Kl.iplocation={IP:"not known"},Yl.get_my_iplocation((function(e){Kl.iplocation=e}))),Et&&(!0===Le["require-agent-name"]&&setTimeout(Dd,10),!0===Le["enable-dialpad-self-service"]&&"readonly"!=jl&&(void 0===window.kare?Yl.get_dialpad_selfservice_config(Qt,(function(e){var i,n,a;e&&e.appid&&e.baseurl?(window.GLR={isBeta:!!e.isbeta,appId:e.appid},i=window,n=document,(a=document.createElement("script")).async=1,a.type="text/javascript",a.src="https://"+e.baseurl+"/latest.js",i.GLR=i.GLR||{},n.getElementsByTagName("head")[0].appendChild(a)):t("Invalid dialpad self-service configuration: "+JSON.stringify(e))}),(function(e){t("Unable to configure dialpad self service. Error: "+e)})):window.kare.showLauncher()));var e="icon-notify.png";Le["notify-icon-name"]&&""!==Le["notify-icon-name"]&&(e=Le["notify-icon-name"]),fd["notify-icon"]&&""!==fd["notify-icon"]&&(e=fd["notify-icon"]);var i;(i=new Image).onload=function(){e=i.src},i.onerror=function(){e="assets/logo-48.png"},i.src=fd["notify-icon"].startsWith("/kpd-static/")?fd["notify-icon"]:Kl.web+"/providers/"+Qt+"/images/"+e,!Et||u()||f()||"readonly"==jl||addEventListener("beforeunload",(function(e){Et&&(e.preventDefault(),e.returnValue="Logout before unloading")}))}),n)}}var Rd=null;function Dd(){if(Et)if(u()){navigator.notification.prompt("Please enter your name:",(function(e){1==e.buttonIndex&&Fd(e.input1)}),"Agent Name",["Ok","Cancel"],"Bob")}else{var e=o("agentname");e||(e=prompt("Please enter your name:","Bob")),e&&Fd(e)}}function Fd(e){Rd=e,Kl.myprofile.name=Rd;var t=Kl.myprofile.name+" <"+Kl.myprofile.email+">";i("div.controls div.header div.identity").innerText=t,i("div.controls div.header div.identity").setAttribute("title",t)}function Ud(){Tt&&(Ve&&$e&&Yl.remove_device_binding(Ve,$e),Gc(),ol()),Es("on_before_logout"),Et&&!0===Le["enable-dialpad-self-service"]&&"object"==typeof window.kare&&"function"==typeof window.kare.close&&(window.kare.close(),window.kare.hideLauncher(),window.kare=void 0)}function zd(e,i){try{if(Hn&&Ln&&Yl.post_chat_status(Hn,"stopped"),Tt&&!Et&&ud&&(i=i||!0),Es("on_before_unload: useraction = "+i),Tt&&"guest-"==Kl.myprofile.email.substr(0,6))Ut(!0,void 0,i);else if(Tt&&null!=Cn&&Cn.isConnected()){if(!u())try{Yl.logout(void 0,void 0,!0,i)}catch(e){}try{_s()}catch(e){}}}catch(e){t("ignore beforeunload exception: "+e)}}function qd(){try{var e=parseInt(localStorage["koopid.save-screen-scroll"]||"0");delete localStorage["koopid.save-screen-scroll"],i("div.page.chat div.history").scrollTop=e}catch(e){}var t=i("div.saved-screen");t&&setTimeout((function(){document.body.removeChild(t)}),300)}function Jd(){window.plugins&&window.plugins.webintent&&(window.plugins.webintent.getUri((function(e){t("webintent uri="+e),e&&Bd(e)})),window.plugins.webintent.onNewIntent((function(e){t("webintent new uri="+e),e&&Bd(e)})));var e=kd("target");e&&Bd(e)}function Wd(){var e=kd("home");e&&(Ds=l("showhomebutton",!0,Ds),Fs="#"+e);var t=kd("title");t&&Md(t)}function Bd(e){t("set-target "+e);var i=e.split(":"),n=i.shift(),a=i.join(":");"web+koopid"==n||"koopid"==n?(a&&"//"==a.substr(0,2)&&(a=a.substr(2)),a&&"#"==a.substr(0,1)&&(Tt?Sd(a):(t("setting target-hash "+a),cd=a))):pd.indexOf(e.split("/")[0])>pd.indexOf("end-of-login")?((a="#"+e)&&0==a.indexOf("#profile/")&&(t("setting profilesplash=true"),Rs=!0),Tt?Sd(a):(t("setting target-hash "+a),cd=a)):t("ignoring target scheme "+n)}window.handleOpenURL=function(e){t("urlhandler "+e),Bd(e=decodeURIComponent(e))},document.addEventListener("deviceready",(function(e){t("deviceReady received..."),nd=!0,window.open=cordova.InAppBrowser.open,document.addEventListener("pause",(function(e){t("document.onpause"),Bl=l("mobileforeground",!1,Bl),Pt&&(Pt=!1),Za(!1)})),document.addEventListener("resume",(function(e){t("document.onresume"),Bl=l("mobileforeground",!0,Bl),xd(),Za(!0),t("loggedin: "+Tt+", hasfingerprint: "+Lt+", fingerprint_valid: "+Pt),Tt&&Lt&&!Pt&&Jt((function(){Gt((function(){}),(function(e){Ye("Failed to verify - "+e,"Error"),i("div.page.login input.text.email").value="",i("div.page.login input.text.password").value="",Wt(),Sd("#logout")}))}),(function(e){Ye("Failed to verify - "+e,"Error"),i("div.page.login input.text.email").value="",i("div.page.login input.text.password").value="",Wt(),Sd("#logout")}))})),document.addEventListener("backbutton",(function(e){hs("device back button"),t("document.onbackbutton"),Od()})),dd||!td?(t("calling initialize() from on_deviceready()"),dd=!1,hd()):(dd=!1,gd())}),!1);var Gd=null,$d=function(){t("before-print orig="+Gd+" value="+Jl),null!==Gd||Jl||(Gd=Jl,Jl=l("printable","text",Jl))},Vd=function(){t("after-print orig="+Gd+" value="+Jl),null!==Gd&&(Jl=l("printable",Gd,Jl),Gd=null)};window.matchMedia&&window.matchMedia("print").addListener((function(e){e.matches?$d():Vd()}));window.onerror=function(e,t,i,n,a){let o="Error: "+e+", url: "+t+", line: "+i+" ";o+=n?", column: "+n:"",o+=a?", error: "+a:"",Es(o);return!0},window.onbeforeprint=$d,window.onafterprint=Vd}("undefined"==typeof koopid?koopid={}:koopid);
