/**
 * @license
 * (c) Copyright 2017-2018 Koopid Inc.
 * All rights reserved.
 */
function KoopidEmbed(){this.ts=null,this.providerId=0,this.providerEmail=null,this.deviceType="desktop",this.chattimer=null,this.entryTime=null,this.historyExpiry=3600,this.server=window.location.origin,this.forcepopout=!1,this.clientid=(""+Math.random()).substr(2),this.retainsession=!1,this.chatting=!1,this.participant=null,this.isbot=!1,this.appinit=!1,this.window_title="",this.window_url="",this.user_context=null,this.entrytag_url=null,this.preload=!1}function log(message){"function"==typeof consolelog&&console.log(message)}function kpde_callit(){var args=Array.prototype.slice.call(arguments,0),value=args.shift();value&&"[object Function]"=={}.toString.call(value)?value.apply(null,args):value&&void 0!==window[value]&&window[value].apply(null,args)}KoopidEmbed.source=document.currentScript&&document.currentScript.src||"",KoopidEmbed.prototype.apiURL=function(path){if(KoopidEmbed.source){var result=KoopidEmbed.source.match("^(.*)(/static/common/js/koopid-embed.*js)$");if(result&&result[1])return result[1]+"/api"+path}return this.server+"/KoopidServer/api"+path},KoopidEmbed.prototype.withParams=function(url,params){if(params){var list=[];for(var s in params)list.push(s+(null!==params[s]?"="+encodeURIComponent(params[s]):""));url+=list.length>0?"?"+list.join("&"):""}return url},KoopidEmbed.prototype.withRandom=function(url){return url?url+(url.indexOf("?")>=0?"&":"?")+"r="+(""+Math.random()).substr(2):url},KoopidEmbed.prototype.ajax=function(method,url,data,success_callback,error_callback,options){var response_type,request_type,headers,timeout,nocredentials;options&&(void 0!==options.response_type&&(response_type=options.response_type),void 0!==options.request_type&&(request_type=options.request_type),void 0!==options.headers&&(headers=options.headers),void 0!==options.timeout&&(timeout=options.timeout),!1===options.withCredentials&&(nocredentials=!0)),void 0===timeout&&(timeout=1e4);var request=new XMLHttpRequest;if(void 0!==success_callback||void 0!==error_callback){var timer=null;timeout&&timeout>0&&(timer=setTimeout(function(){4!=request.readyState&&(request.abort(),kpde_callit(error_callback,"408 Request Timeout"))},timeout)),request.onreadystatechange=function(){if(4==request.readyState)if(null!=timer&&(clearTimeout(timer),timer=null),request.status>=200&&request.status<300){if(void 0!==response_type)return log("koopid-embed.js: ajax - response received"),void kpde_callit(success_callback,request.response);log("koopid-embed.js: ajax - response "+(request.responseText&&request.responseText.substr(0,100)));var response={};try{request.responseText&&(response=JSON.parse(request.responseText))}catch(e){return log("koopid-embed.js: ajax - error parsing response as JSON: "+e+"\nresponseText="+request.responseText),void kpde_callit(error_callback,"failed to parse response")}response.error?kpde_callit(error_callback,response.error.info||"received error"):kpde_callit(success_callback,response)}else{var status="N/A",statusText="N/A";try{status=request.status}catch(e){}try{statusText=request.statusText}catch(e){}if(0==status&&!statusText){var hostname=url.match(/^https?:\/\/([^\/]+)/im);status="",statusText="failed "+(hostname&&hostname[1]||url)}kpde_callit(error_callback,status+" "+statusText)}}}if(response_type&&("xml"==response_type?(request.response_type="document",request.overrideMimeType("text/xml")):request.responseType=response_type),request.open(method,url,!0),nocredentials||(request.withCredentials=!0),response_type&&"json"==response_type&&request.setRequestHeader("Accept","application/json"),headers&&headers.length>0&&headers.length%2==0)for(var i=0;i<headers.length;i+=2)request.setRequestHeader(headers[i],headers[i+1]);return data?request_type&&"application/json"!=request_type?"ignore"!=request_type&&request.setRequestHeader("Content-Type",request_type):(request.setRequestHeader("Content-Type","application/json"),data=JSON.stringify(data),log("koopid-embed.js: ajax - request "+url.substr(0,100)+"\n"+data.substr(0,100))):log("koopid-embed.js: ajax - request "+url.substr(0,100)),request.send("GET"==method?null:data||""),request},KoopidEmbed.prototype.store=function(name,value){if(void 0!==value&&null!==value)try{localStorage["koopid."+name]=JSON.stringify(value)}catch(e){alert("localStorage failed")}else try{delete localStorage["koopid."+name]}catch(e){}},KoopidEmbed.prototype.load=function(name){return JSON.parse(localStorage["koopid."+name]||"null")},KoopidEmbed.prototype.trackUrl=function(){var url=window.location.href,title=document.title,duration=Math.round((new Date).getTime()/1e3-this.entryTime);log("koopid-embed.js: Adding History for "+url+" with Title "+title+" Duration "+duration),this.addUrlHistory(url,title,duration,this.providerEmail),log("koopid-embed.js: "+JSON.stringify(this.getUrlHistory()))},KoopidEmbed.prototype.getUrlHistory=function(){return this.load("url_tracker")},KoopidEmbed.prototype.getUrlHistoryIndexForProvider=function(historyArray,providerEmail){for(let i=0;i<historyArray.length;i++){var history=historyArray[i];if(null!=history.provider&&history.provider==providerEmail)return i}return-1},KoopidEmbed.prototype.addUrlHistory=function(url,title,duration,providerEmail){var indexProv,foundUrl=!1,currTime=Math.round((new Date).getTime()/1e3),historyArray=this.getUrlHistory();if(historyArray||(historyArray=new Array),(indexProv=this.getUrlHistoryIndexForProvider(historyArray,providerEmail))<0)historyArray.push({type:"url-history",provider:providerEmail,context:[{URL:url,title:title,duration:[duration],count:1,lastTime:currTime}]});else{var this_=this;historyArray[indexProv].context.forEach(function(item){item.lastTime+this_.historyExpiry<currTime&&(log("koopid-embed.js: Cleaning up old entries in URL tracker"),item.duration=[],item.count=item.lastTime=0),item.URL==url&&(foundUrl=!0,item.duration.push(duration),item.count+=1,item.lastTime=currTime)}),foundUrl||historyArray[indexProv].context.push({URL:url,title:title,duration:[duration],count:1,lastTime:currTime})}this.store("url_tracker",historyArray)},KoopidEmbed.prototype.on_send_history=function(providerEmail){var indexProv;log("Sending History to Client");Math.round((new Date).getTime()/1e3);var historyArray=this.getUrlHistory();if(historyArray||(historyArray=new Array),(indexProv=this.getUrlHistoryIndexForProvider(historyArray,providerEmail))<0)log("No URL history to send");else{var data=historyArray[indexProv];log("sending to kpd-client"+JSON.stringify(data)),document.getElementById("kpd_chat").querySelector("iframe").contentWindow.postMessage(JSON.stringify(data),"*")}},KoopidEmbed.prototype.storeUrlHistoryForProvider=function(providerEmail,provId){var historyArray=this.getUrlHistory();historyArray?(indexProv=this.getUrlHistoryIndexForProvider(historyArray,providerEmail),-1!=indexProv?(log("koopid-embed.js: Storing URL History for Provider "+provId+" History "+JSON.stringify(historyArray[indexProv])),this.store("url_tracker_"+provId,historyArray[indexProv])):log("koopid-embed.js: No URL history to store for provider "+providerEmail)):log("koopid-embed.js: No URL history to store for provider "+providerEmail)},KoopidEmbed.prototype.sendSMS=function(phone,body,success_callback,error_callback){var u=this.apiURL("/SMS"),data1={to:phone,body:body};this.ajax("POST",u,data1,function(response){kpde_callit(success_callback,response)},function(error){kpde_callit(error_callback,error)})},KoopidEmbed.prototype.sendEmail=function(subject,body,recipient,success_callback,error_callback){var u=this.apiURL("/Email"),data1={to:recipient,from:"support@koopid.io",subject:subject,body:body};this.ajax("POST",u,data1,function(response){kpde_callit(success_callback,response)},function(error){kpde_callit(error_callback,error)})},KoopidEmbed.prototype.getLang=function(){return void 0!=navigator.languages?navigator.languages[0]:void 0!=navigator.language?navigator.language:void 0!=navigator.browserLanguage?navigator.browserLanguage:null};var kpde_isMobile_Android=function(){return navigator.userAgent.match(/Android/i)},kpde_isMobile_iOS=function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)};KoopidEmbed.prototype.getDeviceType=function(){return kpde_isMobile_Android()?"Android":kpde_isMobile_iOS()?"iOS":"web"},KoopidEmbed.prototype.getEntryTagUrl=function(providerId,tag,msg,assign,params,success_callback,error_callback){var this_=this,etu=this.apiURL("/Customization/EntryTag/"+providerId+"/"+tag);let p={device:this.getDeviceType()};assign&&(p.assign=assign),params&&(p.addparams=params),etu=this.withParams(etu,p),this.ajax("GET",etu,null,function(value){if("success"==value.code){var url=this_.server+value.entity.url;msg&&(url+="&send="+msg),this_.providerId=value.entity.providerId,kpde_callit(success_callback,url)}else kpde_callit(error_callback,value.reason)},error_callback)},KoopidEmbed.prototype.getProvider=function(email,success_callback,error_callback){var etu=this.apiURL("/Provider"),data={filter:{email:email},deep:2};etu=this.withParams(etu,{data:JSON.stringify(data)}),o.ajax("GET",etu,null,function(value){kpde_callit(success_callback,value.entity[0])},error_callback)},KoopidEmbed.prototype.getProviderConfig=function(providerid,success_callback,error_callback){if(providerid){var this_=this;this.preload_client=!1;var etu=this.apiURL("/Config?providerid="+providerid+"&fields=branding");this.ajax("GET",etu,null,function(value){value.entity&&(value.entity.feature&&(this_.preload=!1,this_.retainsession=value.entity.feature["retain-session"]),this_.brandingconfig=value.entity.brandingconfig),kpde_callit(success_callback,value.entity)},error_callback)}else error_callback("provider email or provider id not set")},KoopidEmbed.prototype.initEntryTags=function(){let this_=this;this.getProviderConfig(this.providerEmail||this.providerId,function(){for(var elements=document.querySelectorAll("#kpd_koopidtag, .kpd_koopidtag"),i=0;elements&&i<elements.length;++i)this_.initKoopidTag(elements[i],this_);for(elements=document.querySelectorAll("#kpd_smstag, .kpd_smstag"),i=0;elements&&i<elements.length;++i)this_.initSmsTag(elements[i],this_);for(elements=document.querySelectorAll("#kpd_emailtag, .kpd_emailtag"),i=0;elements&&i<elements.length;++i)this_.initEmailTag(elements[i],this_)},function(error){log("Error: "+error)})},KoopidEmbed.prototype.initPrelaunchChat=function(element,this_,chatclick){var ked=this_,providerEmail=element.getAttribute("data-kpdprovemail")||ked.providerEmail,tag=element.getAttribute("data-kpdtag"),assign=element.getAttribute("data-kpdwfvars"),extraparams=element.getAttribute("data-kpdextraparams"),msg=element.getAttribute("data-kpdmsg"),params=element.getAttribute("data-kpdparams"),scb=element.getAttribute("data-kpdsuccesscb"),ecb=element.getAttribute("data-kpderrorcb"),embedded="true"==element.getAttribute("data-kpdembedded"),guest="true"==element.getAttribute("data-kpdguest"),disableinput="true"==element.getAttribute("data-disableinput"),brandname=element.getAttribute("data-kpdbrandname");ked.forcepopout="true"==element.getAttribute("data-kpdforcepopout"),ked.retainsession=void 0==ked.retainsession?"true"==element.getAttribute("data-retainsession"):ked.retainsession;let splashscreen,clientid=ked.load("clientid"),entrytag_url=ked.load("entrytag_url")||null;if(brandname&&ked.brandingconfig&&(splashscreen=ked.brandingconfig[brandname].splashscreen),ked.retainsession&&clientid&&clientid!=ked.clientid&&entrytag_url)ked.startStickySessionIfExists(ked);else{if(params&&"?"==params.substr(0,1)){let tagurl=ked.server+"/kpd-client/index.html"+params;return tagurl+="&retainsession="+(chatclick?"false":"true"),brandname&&(tagurl+="&brandname="+brandname),splashscreen&&(tagurl+="&splashscreen="+splashscreen),ked.onChatClick(tagurl,!0,embedded,ked,chatclick),void kpde_callit(scb)}ked.getEntryTagUrl(providerEmail,tag,msg,assign,extraparams,function(tagurl){guest&&(tagurl+="&username=guest"),params&&(tagurl+=("&"==params.substr(0,1)?"":"&")+params),disableinput&&(tagurl+="&disableinput="+disableinput),tagurl+="&provider="+ked.providerId,tagurl+="&retainsession="+(chatclick?"false":"true"),ked.preload&&(tagurl+="&launchmode=preload"),brandname&&(tagurl+="&brandname="+brandname),splashscreen&&(tagurl+="&splashscreen="+splashscreen),ked.onChatClick(tagurl,!1,embedded,ked,chatclick),kpde_callit(scb)},ecb)}},KoopidEmbed.prototype.initKoopidTag=function(element,this_){var enableproactivechat="true"==element.getAttribute("data-kpdproactive"),chattimeout=1e4;if(enableproactivechat){var chattimer=1e3*parseInt(element.getAttribute("data-kpdproactivetimer")||"");isNaN(chattimer)||(chattimeout=chattimer)}this_.retainsession=void 0==this_.retainsession?"true"==element.getAttribute("data-retainsession"):this_.retainsession,this_.forcepopout="true"==element.getAttribute("data-forcepopout"),this_.forcepopout&&(this_.retainsession=!1),void 0===this_.preload&&(this_.preload="true"==element.getAttribute("data-preload")&&"true"==element.getAttribute("data-kpdembedded")),this_.preload||this_.retainsession?this_.initPrelaunchChat(element,this):document.querySelectorAll("#kpd_koopidtag, .kpd_koopidtag").length>0&&document.querySelectorAll("#kpd_koopidtag, .kpd_koopidtag").forEach(function(el){el.style.visibility="visible"}),element.addEventListener("click",function(){let windowstate=document.getElementById("kpd_chat").getAttribute("enabled"),iframe=kpd_chat.querySelector("iframe");this_.preload&&"false"==windowstate&&iframe?(iframe.contentWindow.postMessage('{"type": "chatstart"}',"*"),document.getElementById("kpd_chat").setAttribute("enabled","true")):this_.initPrelaunchChat(this,this_,!0)}),enableproactivechat&&(this.chattimer=setTimeout(function(){this_.chattimer=null,"false"==document.getElementById("kpd_chat").getAttribute("enabled")&&element.click()},chattimeout))},KoopidEmbed.prototype.initSmsTag=function(element,this_){element.addEventListener("click",function(){var providerEmail=this.getAttribute("data-kpdprovemail")||this_.providerEmail,tag=this.getAttribute("data-kpdtag"),assign=element.getAttribute("data-kpdwfvars"),params=element.getAttribute("data-kpdextraparams"),msg=this.getAttribute("data-kpdmsg"),phone=this.getAttribute("data-kpdphone");if(phone||(phone=prompt("Please enter the phone number","1xxxyyyyyyy")),phone&&"1xxxyyyyyyy"!=phone){var scb=this.getAttribute("data-kpdsuccesscb"),ecb=this.getAttribute("data-kpderrorcb");this_.getEntryTagUrl(providerEmail,tag,msg,assign,params,function(url){var body="Please click to Launch Koopid "+encodeURIComponent(url);this_.sendSMS(phone,body,scb,ecb)},function(error){log("koopid-embed.js: Get entry tag failed for send SMS"+error),kpde_callit(ecb,error)})}})},KoopidEmbed.prototype.initEmailTag=function(element,this_){element.addEventListener("click",function(){var providerEmail=this.getAttribute("data-kpdprovemail")||this_.providerEmail,tag=this.getAttribute("data-kpdtag"),assign=element.getAttribute("data-kpdwfvars"),params=element.getAttribute("data-kpdextraparams"),email=this.getAttribute("data-kpdcustemail");if(email||(email=prompt("Please enter the Email address","user@domain")),email&&"user@domain"!=email){var scb=this.getAttribute("data-kpdsuccesscb"),ecb=this.getAttribute("data-kpderrorcb"),templateUrl=this.getAttribute("data-kpdtemplateurl"),subject=this.getAttribute("data-kpdemailsubject"),msg=this.getAttribute("data-kpdmsg");this_.ajax("GET",templateUrl,null,function(template){this_.getEntryTagUrl(providerEmail,tag,msg,assign,params,function(tagUrl){var body=template.replace(/%%%CONTEXT%%%/,tagUrl);this_.sendEmail(subject,body,email,scb,ecb)},function(error){log("koopid-embed.js: sendEmail - get entry tag - "+error),kpde_callit(ecb,error)})},function(error){log("koopid-embed.js: sendEmail - get email template - "+error),kpde_callit(ecb,error)},{response_type:"html"})}})},KoopidEmbed.prototype.createSendParam=function(data,text,type){return void 0===text&&(text="assign"),void 0===type&&(type="hidden"),encodeURIComponent(JSON.stringify({type:type||"hidden",text:text||void 0,data:data||void 0}))},KoopidEmbed.prototype.createKpdChat=function(){let this_=this;var chatdiv=document.createElement("div");chatdiv.id="kpd_chat",chatdiv.setAttribute("enabled",!1);var minimize=document.createElement("div");minimize.className="kpd_button kpd_minimize",chatdiv.appendChild(minimize),minimize.addEventListener("click",function(event){var currentstate=chatdiv.getAttribute("enabled");this_.changeClientState(this_,chatdiv,"true"==currentstate?"minimized":"true")}),document.getElementsByTagName("body")[0].appendChild(chatdiv),window.addEventListener("message",function(event){var kpd_chat=document.getElementById("kpd_chat"),iframe=kpd_chat.querySelector("iframe");if(log("Received message from client "+("string"==typeof event.data?event.data:JSON.stringify(event.data))),iframe&&iframe.src&&iframe.src.substr(0,event.origin.length)==event.origin){var data=void 0;try{"close"==(data="string"==typeof event.data?JSON.parse(event.data):event.data).type||"chat-closed"==data.type||"chatstop"==data.type?(this_.preload=!1,"chatstop"!=data.type&&(iframe=document.getElementById("kpd_chat").querySelector("iframe"),this_.changeClientState(this_,document.getElementById("kpd_chat"),"false"),setTimeout(function(){iframe.onload=function(){},iframe.src="about:blank",iframe.id="",setTimeout(function(){document.getElementById("kpd_chat").removeChild(iframe),this_.preload&&this_.initPrelaunchChat(document.querySelector("#kpd_koopidtag, .kpd_koopidtag"),this_)},500)},1500)),this_.chatting=!1,this_.isbot=!1,this_.on_chat_closed(this_)):"minimize"==data.type?kpd_chat.querySelector(".kpd_button.kpd_minimize").click():"appinit"==data.type?this_.on_chat_loaded(this_):"chatstart"==data.type?this_.on_chat_started(this_,data.id,data.participant):"send-history"==data.type&&this_.on_send_history(this_,this.providerEmail)}catch(e){return void log("koopid-embed.js: ignore unknown message -> "+event.data)}}else win&&!win.closed&&win.close();log("koopid-embed.js: received event"),log(event)}),window.addEventListener("storage",function(e){e.key&&e.key.includes("clientid")&&(log("Storage Event: "+e.key+" is changing."),this_.load("clientid")!=this_.clientid&&(log("Client is opened elsewhere.  Closing mine..."),iframe=document.getElementById("kpd_chat").querySelector("iframe"),this_.changeClientState(this_,document.getElementById("kpd_chat"),"false"),setTimeout(function(){iframe.onload=function(){log("Closing iframe source as the client is opened elsewhere...")},iframe.src="about:blank",iframe.id="",setTimeout(function(){document.getElementById("kpd_chat").removeChild(iframe)},500)},1500)))},!1)},KoopidEmbed.prototype.onChatClick=function(url,nochange,embedded,kpderef,chatclick){this.chattimer&&(clearTimeout(this.chattimer),this.chattimer=null);var iframe;window.location;(nochange||(url+="&autoconfig=true",url+="&trackhistory=true"),embedded)?(log("onChatClick: "+url+" "+nochange+" "+embedded+" "+kpderef+" "+chatclick),"false"==document.getElementById("kpd_chat").getAttribute("enabled")?((iframe=document.getElementById("kpd_chat").querySelector("iframe"))&&(iframe.onload=function(){},iframe.src="about:blank",iframe.id="",document.getElementById("kpd_chat").removeChild(iframe)),(iframe=document.createElement("iframe")).id="kpd_iframe",iframe.src=url,iframe.setAttribute("frameborder","0"),iframe.setAttribute("allowfullscreen",""),iframe.setAttribute("allow","geolocation *; camera *; microphone *"),iframe.onload=function(){setTimeout(function(){"minimized"==kpderef.load("state")?document.getElementById("kpd_chat").setAttribute("enabled","false"):kpderef.preload||kpderef.retainsession&&!chatclick?document.getElementById("kpd_chat").setAttribute("enabled","false"):document.getElementById("kpd_chat").setAttribute("enabled","true"),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(iframe.setAttribute("style","width: 1px; height: 1px;"),setTimeout(function(){iframe.setAttribute("style","min-width: 100%; min-height: 100%;")},1e3)),document.querySelectorAll("#kpd_koopidtag, .kpd_koopidtag").length>0&&document.querySelectorAll("#kpd_koopidtag, .kpd_koopidtag").forEach(function(el){el.style.visibility="visible"})},500)},document.getElementById("kpd_chat").appendChild(iframe)):"minimized"==document.getElementById("kpd_chat").getAttribute("enabled")?kpderef.changeClientState(kpderef,document.getElementById("kpd_chat"),"true"):(iframe=document.getElementById("kpd_chat").querySelector("iframe"),kpderef.changeClientState(kpderef,document.getElementById("kpd_chat"),"false"),iframe&&setTimeout(function(){iframe.onload=function(){log("Unloading client")},iframe.src="about:blank",iframe.id="",document.getElementById("kpd_chat").removeChild(iframe),kpderef.on_chat_closed(kpderef),kpderef.preload&&kpderef.initPrelaunchChat(document.querySelector("#kpd_koopidtag, .kpd_koopidtag"),kpderef)},500))):this.launchClient(url)};var win=void 0;KoopidEmbed.prototype.launchClient=function(url_or_params){var url1,url2;if("object"==typeof url_or_params?void 0===url_or_params.resize?(url_or_params.resize="fit",url1=this.withParams("/kpd-client/index.html",url_or_params),url_or_params.resize="auto",url2=this.withParams("/kpd-client/index.html",url_or_params)):url1=url2=this.withParams("/kpd-client/index.html",url_or_params):url_or_params.search(/[&\?]resize=/)<0?(url1=url_or_params.replace(/\?/,"?resize=fit&"),url2=url_or_params.replace(/\?/,"?resize=auto&")):url1=url2=url_or_params,log("Launching popout window on user agent: "+navigator.userAgent),void 0===win||win.closed)if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&this.forcepopout){log("Using iOS hack to force open the window");var kpdpopout=document.getElementById("kpd_chat").querySelector("#kpd_popout");void 0==kpdpopout&&((kpdpopout=document.createElement("a")).setAttribute("id","kpd_popout"),document.getElementById("kpd_chat").appendChild(kpdpopout),kpdpopout.setAttribute("href",url1),kpdpopout.setAttribute("style","position: absolute;top: 0;display: none"),kpdpopout.setAttribute("target","_blank")),kpdpopout.click()}else(win=window.open(url1,"_blank","width=420,height=640,location=no,resizable=no,menubar=no"))?win.focus():(log("could not open the popup window."),window.location.href=url2);else win.focus()},KoopidEmbed.prototype.initialize=function(providerEmail){if(this.entryTime)log("koopid-embed.js: Koopid System is already initialized for provider "+this.providerEmail);else{if(this.providerEmail=providerEmail||document.body.getAttribute("provider-email")||null,this.providerId=document.body.getAttribute("provider-id")||0,!this.providerEmail&&!this.providerId){log("koopid-embed.js: missing provider email.  Checking all elements");var kpdelm=document.querySelector("[data-kpdprovemail]");kpdelm&&(this.providerEmail=kpdelm.getAttribute("data-kpdprovemail")||null),(kpdelm=document.querySelector("[data-kpdprovid]"))&&(this.providerId=kpdelm.getAttribute("data-kpdprovid")||0),this.providerEmail||this.providerId||console.warn('koopid-embed.js: missing provider email and provider id during initialize, use <body provider-email="info@provider.domain"> or <body provider-id="1234">')}(this.providerEmail||this.providerId)&&log("koopid-embed.js: Initializing koopid system"),script=document.getElementsByTagName("script");for(var i=0;i<script.length;i++)if(script[i].src.match(/koopid-embed.(min\.)?js$/)){let scriptpath=new URL(script[i].src).origin;this.server.match(scriptpath)||console.warn("koopid-embed.js: The script is downloaded from "+scriptpath+" where as kpde server is initialized to: "+this.server);break}var this_=this;this.startStickySessionIfExists(this),this.createKpdChat(),this.initEntryTags(),this.entryTime=(new Date).getTime()/1e3,this_.trackUrl(),window.addEventListener("beforeunload",function(event){log("koopid-embed.js: Before unloading"),this_.trackUrl()})}},KoopidEmbed.prototype.initializeProvider=function(providerEmail){return this.initialize(providerEmail)};var kpde=new KoopidEmbed;window.onload=function(){kpde.initialize()},KoopidEmbed.prototype.startStickySessionIfExists=function(kpdeobject){try{kpdeobject.clearStickySession(kpdeobject);var this_=kpdeobject;if(this_.chatting=this_.load("chatting")||!1,this_.participant=this_.load("participant")||!1,"null"==this_.participant&&(this_.participant=null),this_.isbot="true"==this_.load("isbot"),this_.entrytag_url=this_.load("entrytag_url")||null,this_.entrytag_url=this_.entrytag_url&&"undefined"==this_.entrytag_url?void 0:this_.entrytag_url,this_.user_context=this_.getUserContext(),log("koopid-embed.js: chatting: "+this_.chatting+", participant: "+this_.participant+", isbot: "+this_.isbot),this_.retainsession)setTimeout(function(){let kpd_chat=document.querySelector("div#kpd_chat");kpd_chat&&(kpd_chat.style.visibility="hidden"),this_.retainsession=!0,this_.start_chat(this_.chatting,this_.entrytag_url)},500);else{log("koopid-embed.js: no ongoing chat sessions.  Click on chat button to start a new session");try{this_.store("state")}catch(e){log("Unable to clear koopid.state")}}}catch(e){log("koopid-embed.js: No ongoing chat sessions.  Click on chat button to start a new session")}},KoopidEmbed.prototype.start_chat=function(chatting,entrytag_url){var url=entrytag_url;url+="&loadscreen=true&target=chat/"+this.chatting,this.participant?(url+="&username="+encodeURIComponent(this.participant),null!=this.user_context?url=url+"&ooredoo-context="+encodeURIComponent(this.user_context):log("User context not defined"),this.onChatClick(url,!0,!0,this),this.load("scb")&&kpde_callit(this.load("scb"))):this.on_chat_closed(this)},KoopidEmbed.prototype.on_chat_loaded=function(this_){var div=document.querySelector("div#kpd_chat");let state="true";"minimized"==this_.load("state")&&(state="minimized"),this_.changeClientState(this_,div,state),div.style.visibility="visible"},KoopidEmbed.prototype.on_chat_started=function(this_,chat_id,participant_email){this_.chatting=chat_id,this_.participant=participant_email;try{this_.store("chatting",""+chat_id),this_.store("participant",""+participant_email),this_.store("clientid",this_.clientid)}catch(e){}this_.on_send_history(this_.providerEmail)},KoopidEmbed.prototype.on_chat_closed=function(this_){log("on_chat_closed: clearing all house keeping data for session stickiness");try{this_.store("chatting")}catch(e){log("Unable to clear koopid.chatting")}try{this_.store("participant")}catch(e){log("Unable to clear koopid.participlant")}try{this_.store("isbot")}catch(e){log("Unable to clear koopid.isbot")}try{this_.store("entrytag_url")}catch(e){log("Unable to clear stored entrytag URL")}try{this_.store("scb")}catch(e){log("Unable to clear koopid.scb")}try{this_.store("clientid")}catch(e){log("Unable to clear koopid.clientid")}let div=document.querySelector("div#kpd_chat");div&&(this_.changeClientState(this_,div,"false"),div.style.visibility="");try{this_.store("state")}catch(e){log("Unable to clear koopid.state")}},KoopidEmbed.prototype.getUserContext=function(){var context=this.load("usercontext");return"null"==context||void 0==context?null:context},KoopidEmbed.prototype.clearStickySession=function(this_){try{this_.store("chatting")}catch(e){log("Unable to clear koopid.chatting")}try{this_.store("participant")}catch(e){log("Unable to clear koopid.participlant")}try{this_.store("isbot")}catch(e){log("Unable to clear koopid.isbot")}try{this_.store("entrytag_url")}catch(e){log("Unable to clear stored entrytag URL")}},KoopidEmbed.prototype.changeClientState=function(this_,div,state){div.setAttribute("enabled",state),this_.store("state",state)};